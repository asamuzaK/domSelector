var L=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var M=(E,c)=>{for(var e in c)L(E,e,{get:c[e],enumerable:!0})},P=(E,c,e,o)=>{if(c&&typeof c=="object"||typeof c=="function")for(let l of R(c))!I.call(E,l)&&l!==e&&L(E,l,{get:()=>c[l],enumerable:!(o=O(c,l))||o.enumerable});return E};var D=E=>P(L({},"__esModule",{value:!0}),E);var U={};M(U,{Finder:()=>W});module.exports=D(U);var g=require("./matcher.js"),y=require("./parser.js"),N=require("./utility.js"),n=require("./constant.js");const S="next",x="prev";class W{#i;#n;#w;#t;#f;#c;#u;#o;#b;#r;#e;#d;#_;#m;#k;#s;#y;#h;#N;#p;#a;#l;constructor(c){this.#l=c,this.#n=new WeakMap,this.#f=new WeakMap,this.#b=new WeakMap,this.#k=new WeakMap,this.#c=null,this.#u=null,this.#r=null,this._registerEventListeners()}onError(c,e){if(!(e?.noexcept??this.#_))if(c instanceof DOMException||c instanceof this.#l.DOMException)if(c.name===n.NOT_SUPPORTED_ERR)this.#a&&console.warn(c.message);else throw new this.#l.DOMException(c.message,c.name);else throw c.name in this.#l?new this.#l[c.name](c.message):c}setup(c,e,o={}){const{noexcept:l,warn:a}=o;return this.#_=!!l,this.#a=!!a,this.#e=e,[this.#t,this.#s,this.#h]=(0,N.resolveContent)(e),this.#y=c,[this.#i,this.#d]=this._correspond(c),this.#b=new WeakMap,this.#p=new WeakMap,this.#N=null,this}_registerEventListeners(){const c={capture:!0,passive:!0},e=[],o=["focus","focusin"];for(const r of o)e.push(this.#l.addEventListener(r,f=>{this.#u=f},c));const l=["keydown","keyup"];for(const r of l)e.push(this.#l.addEventListener(r,f=>{const{key:b}=f;n.KEY_MODIFIER.includes(b)||(this.#c=f)},c));const a=["mouseover","mousedown","mouseup","click","mouseout"];for(const r of a)e.push(this.#l.addEventListener(r,f=>{this.#c=f},c));return e}_correspond(c){const e=[];this.#w=!1,this.#o=!1;let o;if(this.#f.has(this.#t)){const l=this.#f.get(this.#t);if(l&&l.has(`${c}`)){const a=l.get(`${c}`);o=a.ast,this.#w=a.descendant,this.#o=a.invalidate}}if(o){const l=o.length;for(let a=0;a<l;a++)o[a].dir=null,o[a].filtered=!1,o[a].find=!1,e[a]=[]}else{let l;try{l=(0,y.parseSelector)(c)}catch(u){this.onError(u)}const{branches:a,info:r}=(0,y.walkAST)(l),{hasHasPseudoFunc:f,hasLogicalPseudoFunc:b,hasNthChildOfSelector:h,hasStatePseudoClass:i}=r;let t=f||i||!!(b&&h),s=!1,d=0;o=[];for(const[...u]of a){const w=[];let p=u.shift();if(p&&p.type!==n.COMBINATOR){const k=new Set;for(;p;){let _=p.name;if(p.type===n.COMBINATOR){const[v]=u;if(v.type===n.COMBINATOR)throw new DOMException(`Invalid selector ${c}`,n.SYNTAX_ERR);_==="+"||_==="~"?t=!0:s=!0,w.push({combo:p,leaves:(0,y.sortAST)(k)}),k.clear()}else p&&(_&&typeof _=="string"&&(_=(0,y.unescapeSelector)(_),typeof _=="string"&&_!==p.name&&(p.name=_),/[|:]/.test(_)&&(p.namespace=!0)),k.add(p));if(u.length)p=u.shift();else{w.push({combo:null,leaves:(0,y.sortAST)(k)}),k.clear();break}}}o.push({branch:w,dir:null,filtered:!1,find:!1}),e[d]=[],d++}let m;this.#f.has(this.#t)?m=this.#f.get(this.#t):m=new Map,m.set(`${c}`,{ast:o,descendant:s,invalidate:t}),this.#f.set(this.#t,m),this.#w=s,this.#o=t}return[o,e]}_createTreeWalker(c,e={}){const{force:o=!1,whatToShow:l=n.WALKER_FILTER}=e;let a;return o?a=this.#t.createTreeWalker(c,l):this.#p.has(c)?a=this.#p.get(c):(a=this.#t.createTreeWalker(c,l),this.#p.set(c,a)),a}_prepareQuerySelectorWalker(){return this.#m=this._createTreeWalker(this.#e),this.#m}_collectNthChild(c,e,o){const{a:l,b:a,reverse:r,selector:f}=c,{parentNode:b}=e,h=new Set;let i;if(f){if(this.#n.has(f))i=this.#n.get(f);else{const{branches:s}=(0,y.walkAST)(f);i=s,this.#o||this.#n.set(f,i)}const{branches:t}=(0,y.walkAST)(f);i=t}if(b){const t=this._createTreeWalker(b,{force:!0});let s=t.firstChild();const d=new Set;let m=0;if(i)for(;s;){if((0,N.isVisible)(s)){let u;for(const w of i)if(u=this._matchLeaves(w,s,o),!u)break;u&&d.add(s)}m++,s=t.nextSibling()}else for(;s;)m++,s=t.nextSibling();if(l===0){if(a>0&&a<=m){if(d.size){s=(0,N.traverseNode)(b,t),r?s=t.lastChild():s=t.firstChild();let u=0;for(;s;){if(d.has(s)){if(u===a-1){h.add(s);break}u++}r?s=t.previousSibling():s=t.nextSibling()}}else if(!f){s=(0,N.traverseNode)(b,t),r?s=t.lastChild():s=t.firstChild();let u=0;for(;s;){if(u===a-1){h.add(s);break}r?s=t.previousSibling():s=t.nextSibling(),u++}}}}else{let u=a-1;if(l>0)for(;u<0;)u+=l;if(u>=0&&u<m){s=(0,N.traverseNode)(b,t),r?s=t.lastChild():s=t.firstChild();let w=0,p=l>0?0:a-1;for(;s&&(s&&u>=0&&u<m);)d.size?d.has(s)&&(p===u&&(h.add(s),u+=l),l>0?p++:p--):w===u&&(f||h.add(s),u+=l),r?s=t.previousSibling():s=t.nextSibling(),w++}}if(r&&h.size>1){const u=[...h];return new Set(u.reverse())}}else if(e===this.#s&&l+a===1)if(i){let t;for(const s of i)if(t=this._matchLeaves(s,e,o),t)break;t&&h.add(e)}else h.add(e);return h}_collectNthOfType(c,e){const{a:o,b:l,reverse:a}=c,{localName:r,namespaceURI:f,parentNode:b,prefix:h}=e,i=new Set;if(b){const t=this._createTreeWalker(b);let s=(0,N.traverseNode)(b,t);s=t.firstChild();let d=0;for(;s;)d++,s=t.nextSibling();if(o===0){if(l>0&&l<=d){s=(0,N.traverseNode)(b,t),a?s=t.lastChild():s=t.firstChild();let m=0;for(;s;){const{localName:u,namespaceURI:w,prefix:p}=s;if(u===r&&p===h&&w===f){if(m===l-1){i.add(s);break}m++}a?s=t.previousSibling():s=t.nextSibling()}}}else{let m=l-1;if(o>0)for(;m<0;)m+=o;if(m>=0&&m<d){s=(0,N.traverseNode)(b,t),a?s=t.lastChild():s=t.firstChild();let u=o>0?0:l-1;for(;s;){const{localName:w,namespaceURI:p,prefix:k}=s;if(w===r&&k===h&&p===f){if(u===m&&(i.add(s),m+=o),m<0||m>=d)break;o>0?u++:u--}a?s=t.previousSibling():s=t.nextSibling()}}}if(a&&i.size>1){const m=[...i];return new Set(m.reverse())}}else e===this.#s&&o+l===1&&i.add(e);return i}_matchAnPlusB(c,e,o,l){const{nth:{a,b:r,name:f},selector:b}=c,h=new Map;if(f?(f==="even"?(h.set("a",2),h.set("b",0)):f==="odd"&&(h.set("a",2),h.set("b",1)),o.indexOf("last")>-1&&h.set("reverse",!0)):(typeof a=="string"&&/-?\d+/.test(a)?h.set("a",a*1):h.set("a",0),typeof r=="string"&&/-?\d+/.test(r)?h.set("b",r*1):h.set("b",0),o.indexOf("last")>-1&&h.set("reverse",!0)),o==="nth-child"||o==="nth-last-child"){b&&h.set("selector",b);const i=Object.fromEntries(h);return this._collectNthChild(i,e,l)}else if(o==="nth-of-type"||o==="nth-last-of-type"){const i=Object.fromEntries(h);return this._collectNthOfType(i,e)}return new Set}_matchHasPseudoFunc(c,e,o){if(Array.isArray(c)&&c.length){const l=[...c],[a]=l,{type:r}=a;let f;r===n.COMBINATOR?f=l.shift():f={name:" ",type:n.COMBINATOR};const b=[];for(;l.length;){const[t]=l,{type:s}=t;if(s===n.COMBINATOR)break;b.push(l.shift())}const h={combo:f,leaves:b};o.dir=S;const i=this._matchCombinator(h,e,o);if(i.size){if(l.length){let t=!1;for(const s of i)if(t=this._matchHasPseudoFunc(l,s,o),t)break;return t}return!0}}return!1}_matchLogicalPseudoFunc(c,e,o){const{astName:l,branches:a,twigBranches:r}=c,f=(o.isShadowRoot||this.#h)&&e.nodeType===n.DOCUMENT_FRAGMENT_NODE;if(l==="has"){let b;for(const h of a)if(b=this._matchHasPseudoFunc(h,e,o),b)break;if(b)if(f){if(this.#N)return e}else return e}else{if(f){let i;for(const t of a)if(t.length>1){i=!0;break}else if(l==="not"){const[{type:s}]=t;if(s!==n.PS_CLASS_SELECTOR){i=!0;break}}if(i)return null}o.forgive=l==="is"||l==="where";const b=r.length;let h;for(let i=0;i<b;i++){const t=r[i],s=t.length-1,{leaves:d}=t[s];if(h=this._matchLeaves(d,e,o),h&&s>0){let m=new Set([e]);for(let u=s-1;u>=0;u--){const w=t[u],p=[];o.dir=x;for(const k of m){const _=this._matchCombinator(w,k,o);_.size&&p.push(..._)}if(p.length)u===0?h=!0:m=new Set(p);else{h=!1;break}}}if(h)break}if(l==="not")return h?null:e;if(h)return e}return null}_matchPseudoClassSelector(c,e,o){const{children:l,name:a}=c,{localName:r,parentNode:f}=e,{forgive:b,warn:h=this.#a}=o,i=new Set;if(Array.isArray(l)&&n.KEY_LOGICAL.includes(a)){if(!l.length&&a!=="is"&&a!=="where"){const d=(0,y.generateCSS)(c);throw new DOMException(`Invalid selector ${d}`,n.SYNTAX_ERR)}let t;if(this.#n.has(c))t=this.#n.get(c);else{const{branches:d}=(0,y.walkAST)(c);if(a==="has"){let m;for(const u of l){const w=(0,y.findAST)(u,p=>n.KEY_LOGICAL.includes(p.name)&&(0,y.findAST)(p,k=>k.name==="has")?p:null);if(w){const p=w.name;if(p==="is"||p==="where"){m=!0;break}else{const k=(0,y.generateCSS)(c);throw new DOMException(`Invalid selector ${k}`,n.SYNTAX_ERR)}}}if(m)return i;t={astName:a,branches:d}}else{const m=[];for(const[...u]of d){const w=[],p=new Set;let k=u.shift();for(;k;)if(k.type===n.COMBINATOR?(w.push({combo:k,leaves:[...p]}),p.clear()):k&&p.add(k),u.length)k=u.shift();else{w.push({combo:null,leaves:[...p]}),p.clear();break}m.push(w)}t={astName:a,branches:d,twigBranches:m},this.#o||this.#n.set(c,t)}}const s=this._matchLogicalPseudoFunc(t,e,o);s&&i.add(s)}else if(Array.isArray(l))if(/^nth-(?:last-)?(?:child|of-type)$/.test(a)){if(l.length!==1){const d=(0,y.generateCSS)(c);throw new DOMException(`Invalid selector ${d}`,n.SYNTAX_ERR)}const[t]=l;return this._matchAnPlusB(t,e,a,o)}else switch(a){case"dir":{if(l.length!==1){const d=(0,y.generateCSS)(c);throw new DOMException(`Invalid selector ${d}`,n.SYNTAX_ERR)}const[t]=l;(0,g.matchDirectionPseudoClass)(t,e)&&i.add(e);break}case"lang":{if(!l.length){const s=(0,y.generateCSS)(c);throw new DOMException(`Invalid selector ${s}`,n.SYNTAX_ERR)}let t;for(const s of l)if(t=(0,g.matchLanguagePseudoClass)(s,e),t)break;t&&i.add(e);break}case"state":{if((0,N.isCustomElement)(e)){const[{value:t}]=l;if(t)if(e[t])i.add(e);else for(const s in e){const d=e[s];if(d instanceof this.#l.ElementInternals){d?.states?.has(t)&&i.add(e);break}}}break}case"current":case"nth-col":case"nth-last-col":{if(h)throw new DOMException(`Unsupported pseudo-class :${a}()`,n.NOT_SUPPORTED_ERR);break}case"host":case"host-context":break;case"contains":{if(h)throw new DOMException(`Unknown pseudo-class :${a}()`,n.NOT_SUPPORTED_ERR);break}default:if(!b)throw new DOMException(`Unknown pseudo-class :${a}()`,n.SYNTAX_ERR)}else switch(a){case"any-link":case"link":{(r==="a"||r==="area")&&e.hasAttribute("href")&&i.add(e);break}case"local-link":{if((r==="a"||r==="area")&&e.hasAttribute("href")){const{href:t,origin:s,pathname:d}=new URL(this.#t.URL),m=new URL(e.getAttribute("href"),t);m.origin===s&&m.pathname===d&&i.add(e)}break}case"visited":break;case"hover":{const{target:t,type:s}=this.#c??{};/^(?:click|mouse(?:down|over|up))$/.test(s)&&e.contains(t)&&i.add(e);break}case"active":{const{buttons:t,target:s,type:d}=this.#c??{};d==="mousedown"&&t&n.BIT_01&&e.contains(s)&&i.add(e);break}case"target":{const{hash:t}=new URL(this.#t.URL);e.id&&t===`#${e.id}`&&this.#t.contains(e)&&i.add(e);break}case"target-within":{const{hash:t}=new URL(this.#t.URL);if(t){const s=t.replace(/^#/,"");let d=this.#t.getElementById(s);for(;d;){if(d===e){i.add(e);break}d=d.parentNode}}break}case"scope":{this.#e.nodeType===n.ELEMENT_NODE?!this.#h&&e===this.#e&&i.add(e):e===this.#t.documentElement&&i.add(e);break}case"focus":{e===this.#t.activeElement&&(0,N.isFocusableArea)(e)&&i.add(e);break}case"focus-visible":{if(e===this.#t.activeElement&&(0,N.isFocusableArea)(e)){let t;if((0,N.isFocusVisible)(e))t=!0;else if(this.#u){const{relatedTarget:s,target:d}=this.#u;if(d===e)if((0,N.isFocusVisible)(s))t=!0;else if(this.#c){const{key:m,target:u,type:w}=this.#c;u===s?(this.#r===null||d===this.#r)&&(t=!0):m==="Tab"?(w==="keydown"&&u!==e||w==="keyup"&&u===e)&&(u===d?(this.#r===null||u===this.#r&&s===null)&&(t=!0):t=!0):m&&(w==="keydown"||w==="keyup")&&u===e&&(t=!0)}else(s===null||s===this.#r)&&(t=!0)}t?(this.#r=e,i.add(e)):this.#r===e&&(this.#r=null)}break}case"focus-within":{let t,s=this.#t.activeElement;if((0,N.isFocusableArea)(s))for(;s;){if(s===e){t=!0;break}s=s.parentNode}t&&i.add(e);break}case"open":case"closed":{(r==="details"||r==="dialog")&&(e.hasAttribute("open")?a==="open"&&i.add(e):a==="closed"&&i.add(e));break}case"disabled":case"enabled":{if([...n.KEY_FORM_FOCUS,"fieldset","optgroup","option"].includes(r)||(0,N.isCustomElement)(e,{formAssociated:!0})){let s;if(e.disabled||e.hasAttribute("disabled"))s=!0;else if(e.localName==="option")f.localName==="optgroup"&&(f.disabled||f.hasAttribute("disabled"))&&(s=!0);else if(e.localName!=="optgroup"){let d=f;for(;d;)if(d.localName==="fieldset"&&(d.disabled||d.hasAttribute("disabled"))){let m=d.firstElementChild;for(;m&&m.localName!=="legend";)m=m.nextElementSibling;m&&m.contains(e)||(s=!0);break}else{if(d.localName==="form")break;if(d.parentNode?.nodeType===n.ELEMENT_NODE){if(d.parentNode.localName==="form")break;d=d.parentNode}else break}}s?a==="disabled"&&i.add(e):a==="enabled"&&i.add(e)}break}case"read-only":case"read-write":{let t,s;switch(r){case"textarea":{e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled")?t=!0:s=!0;break}case"input":{(!e.type||n.KEY_INPUT_EDIT.includes(e.type))&&(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled")?t=!0:s=!0);break}default:(0,N.isContentEditable)(e)?s=!0:t=!0}t?a==="read-only"&&i.add(e):a==="read-write"&&s&&i.add(e);break}case"placeholder-shown":{let t;if(e.placeholder?t=e.placeholder:e.hasAttribute("placeholder")&&(t=e.getAttribute("placeholder")),typeof t=="string"&&!/[\r\n]/.test(t)){let s;r==="textarea"?s=e:r==="input"&&(e.hasAttribute("type")?[...n.KEY_INPUT_TEXT,"number"].includes(e.getAttribute("type"))&&(s=e):s=e),s&&e.value===""&&i.add(e)}break}case"checked":{const t=e.getAttribute("type");(e.checked&&r==="input"&&(t==="checkbox"||t==="radio")||e.selected&&r==="option")&&i.add(e);break}case"indeterminate":{if(e.indeterminate&&r==="input"&&e.type==="checkbox"||r==="progress"&&!e.hasAttribute("value"))i.add(e);else if(r==="input"&&e.type==="radio"&&!e.hasAttribute("checked")){const t=e.name;let s=e.parentNode;for(;s&&s.localName!=="form";)s=s.parentNode;s||(s=this.#t.documentElement);const d=this._createTreeWalker(s);let m=(0,N.traverseNode)(s,d);m=d.firstChild();let u;for(;m&&!(m.localName==="input"&&m.getAttribute("type")==="radio"&&(m.hasAttribute("name")?m.getAttribute("name")===t&&(u=!!m.checked):u=!!m.checked,u));)m=d.nextNode();u||i.add(e)}break}case"default":{const t=["checkbox","radio"],s=["button","reset"],d=["image","submit"],m=e.getAttribute("type");if(r==="button"&&!(e.hasAttribute("type")&&s.includes(m))||r==="input"&&e.hasAttribute("type")&&d.includes(m)){let u=e.parentNode;for(;u&&u.localName!=="form";)u=u.parentNode;if(u){const w=this._createTreeWalker(u);let p=(0,N.traverseNode)(u,w);for(p=w.firstChild();p;){const k=p.localName,_=p.getAttribute("type");let v;if(k==="button"?v=!(p.hasAttribute("type")&&s.includes(_)):k==="input"&&(v=p.hasAttribute("type")&&d.includes(_)),v){p===e&&i.add(e);break}p=w.nextNode()}}}else(r==="input"&&e.hasAttribute("type")&&t.includes(m)&&e.hasAttribute("checked")||r==="option"&&e.hasAttribute("selected"))&&i.add(e);break}case"valid":case"invalid":{const t=[...n.KEY_FORM_FOCUS,"form"];if(t.includes(r)){let s;e.checkValidity()&&(e.maxLength>=0?e.maxLength>=e.value.length&&(s=!0):s=!0),s?a==="valid"&&i.add(e):a==="invalid"&&i.add(e)}else if(r==="fieldset"){const s=this._createTreeWalker(e);let d=(0,N.traverseNode)(e,s);d=s.firstChild();let m;if(!d)m=!0;else for(;d&&!(t.includes(d.localName)&&(d.checkValidity()?d.maxLength>=0?m=d.maxLength>=d.value.length:m=!0:m=!1,!m));)d=s.nextNode();m?a==="valid"&&i.add(e):a==="invalid"&&i.add(e)}break}case"in-range":case"out-of-range":{const t=[...n.KEY_INPUT_DATE,"number","range"],s=e.getAttribute("type");if(r==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&t.includes(s)){const d=e.validity.rangeUnderflow||e.validity.rangeOverflow;(a==="out-of-range"&&d||a==="in-range"&&!d&&(e.hasAttribute("min")||e.hasAttribute("max")||s==="range"))&&i.add(e)}break}case"required":case"optional":{let t;if(r==="select"||r==="textarea")t=e;else if(r==="input")if(e.hasAttribute("type")){const s=[...n.KEY_INPUT_EDIT,"checkbox","file","radio"],d=e.getAttribute("type");s.includes(d)&&(t=e)}else t=e;t&&(e.required||e.hasAttribute("required")?a==="required"&&i.add(e):a==="optional"&&i.add(e));break}case"root":{e===this.#t.documentElement&&i.add(e);break}case"empty":{if(e.hasChildNodes()){const t=this._createTreeWalker(e,{force:!0,whatToShow:n.SHOW_ALL});let s=t.firstChild(),d;for(;s&&(d=s.nodeType!==n.ELEMENT_NODE&&s.nodeType!==n.TEXT_NODE,!!d);)s=t.nextSibling();d&&i.add(e)}else i.add(e);break}case"first-child":{(f&&e===f.firstElementChild||e===this.#s)&&i.add(e);break}case"last-child":{(f&&e===f.lastElementChild||e===this.#s)&&i.add(e);break}case"only-child":{(f&&e===f.firstElementChild&&e===f.lastElementChild||e===this.#s)&&i.add(e);break}case"first-of-type":{if(f){const[t]=this._collectNthOfType({a:0,b:1},e);t&&i.add(t)}else e===this.#s&&i.add(e);break}case"last-of-type":{if(f){const[t]=this._collectNthOfType({a:0,b:1,reverse:!0},e);t&&i.add(t)}else e===this.#s&&i.add(e);break}case"only-of-type":{if(f){const[t]=this._collectNthOfType({a:0,b:1},e);if(t===e){const[s]=this._collectNthOfType({a:0,b:1,reverse:!0},e);s===e&&i.add(e)}}else e===this.#s&&i.add(e);break}case"defined":{e.hasAttribute("is")||r.includes("-")?(0,N.isCustomElement)(e)&&i.add(e):(e instanceof this.#l.HTMLElement||e instanceof this.#l.SVGElement)&&i.add(e);break}case"popover-open":{e.popover&&(0,N.isVisible)(e)&&i.add(e);break}case"host":case"host-context":break;case"after":case"before":case"first-letter":case"first-line":{if(h)throw new DOMException(`Unsupported pseudo-element ::${a}`,n.NOT_SUPPORTED_ERR);break}case"autofill":case"blank":case"buffering":case"current":case"fullscreen":case"future":case"modal":case"muted":case"past":case"paused":case"picture-in-picture":case"playing":case"seeking":case"stalled":case"user-invalid":case"user-valid":case"volume-locked":case"-webkit-autofill":{if(h)throw new DOMException(`Unsupported pseudo-class :${a}`,n.NOT_SUPPORTED_ERR);break}default:if(a.startsWith("-webkit-")){if(h)throw new DOMException(`Unsupported pseudo-class :${a}`,n.NOT_SUPPORTED_ERR)}else if(!b)throw new DOMException(`Unknown pseudo-class :${a}`,n.SYNTAX_ERR)}return i}_matchShadowHostPseudoClass(c,e){const{children:o,name:l}=c;if(Array.isArray(o)){if(o.length!==1){const h=(0,y.generateCSS)(c);throw new DOMException(`Invalid selector ${h}`,n.SYNTAX_ERR)}const{branches:a}=(0,y.walkAST)(o[0]),[r]=a,[...f]=r,{host:b}=e;if(l==="host"){let h;for(const i of f){const{type:t}=i;if(t===n.COMBINATOR){const s=(0,y.generateCSS)(c);throw new DOMException(`Invalid selector ${s}`,n.SYNTAX_ERR)}if(h=this._matchSelector(i,b).has(b),!h)break}return h?e:null}else if(l==="host-context"){let h=b,i;for(;h;){for(const t of f){const{type:s}=t;if(s===n.COMBINATOR){const d=(0,y.generateCSS)(c);throw new DOMException(`Invalid selector ${d}`,n.SYNTAX_ERR)}if(i=this._matchSelector(t,h).has(h),!i)break}if(i)break;h=h.parentNode}return i?e:null}throw new DOMException(`Invalid selector :${l}`,n.SYNTAX_ERR)}else{if(l==="host")return e;throw new DOMException(`Invalid selector :${l}`,n.SYNTAX_ERR)}}_matchSelector(c,e,o={}){const{type:l}=c,a=(0,y.unescapeSelector)(c.name),r=new Set;if(e.nodeType===n.ELEMENT_NODE)switch(l){case n.ATTR_SELECTOR:{(0,g.matchAttributeSelector)(c,e)&&r.add(e);break}case n.ID_SELECTOR:{e.id===a&&r.add(e);break}case n.CLASS_SELECTOR:{e.classList.contains(a)&&r.add(e);break}case n.PS_CLASS_SELECTOR:return this._matchPseudoClassSelector(c,e,o);case n.TYPE_SELECTOR:{(0,g.matchTypeSelector)(c,e,o)&&r.add(e);break}case n.PS_ELEMENT_SELECTOR:default:(0,g.matchPseudoElementSelector)(a,l,o)}else if(this.#h&&l===n.PS_CLASS_SELECTOR&&e.nodeType===n.DOCUMENT_FRAGMENT_NODE){if(n.KEY_LOGICAL.includes(a))return o.isShadowRoot=!0,this._matchPseudoClassSelector(c,e,o);if(a==="host"||a==="host-context"){const f=this._matchShadowHostPseudoClass(c,e,o);f&&(this.#N=!0,r.add(f))}}return r}_matchLeaves(c,e,o){let l;if(this.#o?l=this.#b.get(c):l=this.#k.get(c),l&&l.has(e)){const{matched:a}=l.get(e);return a}else{let a=!0;const r=[...n.KEY_FORM_FOCUS,"fieldset","form"],f=["any-link","defined","dir","link"];e.nodeType===n.ELEMENT_NODE&&r.includes(e.localName)&&(a=!1);let b;for(const h of c){switch(h.type){case n.ATTR_SELECTOR:case n.ID_SELECTOR:{a=!1;break}case n.PS_CLASS_SELECTOR:{f.includes(h.name)&&(a=!1);break}default:}if(b=this._matchSelector(h,e,o).has(e),!b)break}return a&&(l||(l=new WeakMap),l.set(e,{matched:b}),this.#o?this.#b.set(c,l):this.#k.set(c,l)),b}}_findDescendantNodes(c,e,o){const[l,...a]=c,r=a.length>0,{type:f}=l,b=(0,y.unescapeSelector)(l.name),h=new Set;let i=!1;if(this.#h||e.nodeType!==n.ELEMENT_NODE)i=!0;else switch(f){case n.PS_ELEMENT_SELECTOR:{(0,g.matchPseudoElementSelector)(b,f,o);break}case n.ID_SELECTOR:{if(this.#s.nodeType===n.ELEMENT_NODE)i=!0;else{const t=this.#s.getElementById(b);t&&t!==e&&e.contains(t)&&(r?this._matchLeaves(a,t,o)&&h.add(t):h.add(t))}break}default:i=!0}if(i){const t=this._createTreeWalker(e);let s=(0,N.traverseNode)(e,t);for(s=t.firstChild();s;)this._matchLeaves(c,s,o)&&h.add(s),s=t.nextNode()}return h}_matchCombinator(c,e,o){const{combo:l,leaves:a}=c,{name:r}=l,{parentNode:f}=e,{dir:b}=o,h=new Set;if(b===S)switch(r){case"+":{const i=e.nextElementSibling;i&&this._matchLeaves(a,i,o)&&h.add(i);break}case"~":{if(f){let i=e.nextElementSibling;for(;i;)this._matchLeaves(a,i,o)&&h.add(i),i=i.nextElementSibling}break}case">":{let i=e.firstElementChild;for(;i;)this._matchLeaves(a,i,o)&&h.add(i),i=i.nextElementSibling;break}case" ":default:{const i=this._findDescendantNodes(a,e,o);if(i.size)return i}}else switch(r){case"+":{const i=e.previousElementSibling;i&&this._matchLeaves(a,i,o)&&h.add(i);break}case"~":{if(f){let i=f.firstElementChild;for(;i&&i!==e;)this._matchLeaves(a,i,o)&&h.add(i),i=i.nextElementSibling}break}case">":{f&&this._matchLeaves(a,f,o)&&h.add(f);break}case" ":default:{const i=[];let t=f;for(;t;)this._matchLeaves(a,t,o)&&i.push(t),t=t.parentNode;if(i.length)return new Set(i.reverse())}}return h}_findWalker(c,e,o={}){const{force:l,targetType:a}=o,r=this.#m,f=[];let b=(0,N.traverseNode)(e,r,!!l);if(b)for((b.nodeType!==n.ELEMENT_NODE||b===e&&b!==this.#s)&&(b=r.nextNode());b&&!(this._matchLeaves(c,b,{warn:this.#a})&&(f.push(b),a!==n.TARGET_ALL));)b=r.nextNode();return f}_matchSelf(c){const e=[];let o=!1;return this._matchLeaves(c,this.#e,{warn:this.#a})&&(e.push(this.#e),o=!0),[e,o]}_findLineal(c,e){const{complex:o}=e,l=[];let a=!1,r=this._matchLeaves(c,this.#e,{warn:this.#a});if(r&&(l.push(this.#e),a=!0),!r||o){let f=this.#e.parentNode;for(;f&&(r=this._matchLeaves(c,f,{warn:this.#a}),r&&(l.push(f),a=!0),f.parentNode);)f=f.parentNode}return[l,a]}_findEntryNodes(c,e,o){const{leaves:l}=c,[a,...r]=l,f=r.length>0,{name:b,type:h}=a;let i=[],t=!1,s=!1;switch(h){case n.PS_ELEMENT_SELECTOR:{(0,g.matchPseudoElementSelector)(b,h,{warn:this.#a});break}case n.ID_SELECTOR:{if(e===n.TARGET_SELF)[i,t]=this._matchSelf(l);else if(e===n.TARGET_LINEAL)[i,t]=this._findLineal(l,{complex:o});else if(e===n.TARGET_FIRST&&this.#s.nodeType!==n.ELEMENT_NODE){const d=this.#s.getElementById(b);d&&(f?this._matchLeaves(r,d,{warn:this.#a})&&(i.push(d),t=!0):(i.push(d),t=!0))}else i=this._findWalker(l,this.#e,{targetType:e}),i.length&&(t=!0);break}case n.CLASS_SELECTOR:{e===n.TARGET_SELF?[i,t]=this._matchSelf(l):e===n.TARGET_LINEAL?[i,t]=this._findLineal(l,{complex:o}):(i=this._findWalker(l,this.#e,{targetType:e}),i.length&&(t=!0));break}case n.TYPE_SELECTOR:{e===n.TARGET_SELF?[i,t]=this._matchSelf(l):e===n.TARGET_LINEAL?[i,t]=this._findLineal(l,{complex:o}):(i=this._findWalker(l,this.#e,{targetType:e}),i.length&&(t=!0));break}default:if(e!==n.TARGET_LINEAL&&(b==="host"||b==="host-context")){let d;if(this.#h&&this.#e.nodeType===n.DOCUMENT_FRAGMENT_NODE?d=this._matchShadowHostPseudoClass(a,this.#e):f&&this.#e.nodeType===n.ELEMENT_NODE&&(d=this._matchShadowHostPseudoClass(a,this.#e.shadowRoot)),d){let m;if(f){for(const u of r)if(/^host(?:-context)?$/.test(u.name)?m=this._matchShadowHostPseudoClass(u,d)===d:u.name==="has"?m=this._matchPseudoClassSelector(u,d,{}).has(d):m=!1,!m)break}else m=!0;m&&(i.push(d),t=!0)}}else e===n.TARGET_SELF?[i,t]=this._matchSelf(l):e===n.TARGET_LINEAL?[i,t]=this._findLineal(l,{complex:o}):e===n.TARGET_FIRST?(i=this._findWalker(l,this.#e,{targetType:e}),i.length&&(t=!0)):s=!0}return{compound:f,filtered:t,nodes:i,pending:s}}_collectNodes(c){const e=this.#i.values();if(c===n.TARGET_ALL||c===n.TARGET_FIRST){const o=new Set;let l=0;for(const{branch:a}of e){const r=a.length,f=r>1,b=a[0];let h,i;if(f){const{combo:u,leaves:[{name:w,type:p}]}=b,k=a[r-1],{leaves:[{name:_,type:v}]}=k;if(h=S,i=b,this.#y.includes(":scope")||v===n.PS_ELEMENT_SELECTOR||v===n.ID_SELECTOR)h=x,i=k;else if(w==="*"&&p===n.TYPE_SELECTOR)h=x,i=k;else if(_==="*"&&v===n.TYPE_SELECTOR)h=S,i=b;else if(r===2){const{name:C}=u;(C==="+"||C==="~")&&(h=x,i=k)}}else h=x,i=b;const{compound:t,filtered:s,nodes:d,pending:m}=this._findEntryNodes(i,c,f);d.length?(this.#i[l].find=!0,this.#d[l]=d):m&&o.add(new Map([["index",l],["twig",i]])),this.#i[l].dir=h,this.#i[l].filtered=s||!t,l++}if(o.size){let a,r;this.#e!==this.#s&&this.#e.nodeType===n.ELEMENT_NODE?(a=this.#e,r=this.#m):(a=this.#s,r=this._createTreeWalker(a));let f=(0,N.traverseNode)(a,r);for(;f;){let b=!1;if(this.#e.nodeType===n.ELEMENT_NODE?f===this.#e?b=!0:b=this.#e.contains(f):b=!0,b)for(const h of o){const{leaves:i}=h.get("twig");if(this._matchLeaves(i,f,{warn:this.#a})){const s=h.get("index");this.#i[s].filtered=!0,this.#i[s].find=!0,this.#d[s].push(f)}}f!==r.currentNode&&(f=(0,N.traverseNode)(f,r)),f=r.nextNode()}}}else{let o=0;for(const{branch:l}of e){const a=l[l.length-1],r=l.length>1,{compound:f,filtered:b,nodes:h}=this._findEntryNodes(a,c,r);h.length&&(this.#i[o].find=!0,this.#d[o]=h),this.#i[o].dir=x,this.#i[o].filtered=b||!f,o++}}return[this.#i,this.#d]}_getCombinedNodes(c,e,o){const l=[];for(const a of e){const r=this._matchCombinator(c,a,{dir:o,warn:this.#a});r.size&&l.push(...r)}return l.length?new Set(l):new Set}_matchNodeNext(c,e,o){const{combo:l,index:a}=o,{combo:r,leaves:f}=c[a],b={combo:l,leaves:f},h=this._getCombinedNodes(b,e,S);if(h.size)if(a===c.length-1){const[i]=(0,N.sortNodes)(h);return i}else return this._matchNodeNext(c,h,{combo:r,index:a+1});return null}_matchNodePrev(c,e,o){const{index:l}=o,a=c[l],r=new Set([e]),f=this._getCombinedNodes(a,r,x);if(f.size){if(l===0)return e;{let b;for(const h of f)if(b=this._matchNodePrev(c,h,{index:l-1}),b)break;if(b)return e}}return null}find(c){(c===n.TARGET_ALL||c===n.TARGET_FIRST)&&this._prepareQuerySelectorWalker();const[[...e],o]=this._collectNodes(c),l=e.length;let a,r=new Set;for(let f=0;f<l;f++){const{branch:b,dir:h,find:i}=e[f],t=b.length;if(t&&i){const s=o[f],d=s.length,m=t-1;if(m===0)if((c===n.TARGET_ALL||c===n.TARGET_FIRST)&&this.#e.nodeType===n.ELEMENT_NODE)for(let u=0;u<d;u++){const w=s[u];if(w!==this.#e&&this.#e.contains(w)&&(r.add(w),c===n.TARGET_FIRST))break}else if(c===n.TARGET_ALL)if(r.size){const u=[...r];r=new Set([...u,...s]),a=!0}else r=new Set(s);else{const[u]=s;r.add(u)}else if(c===n.TARGET_ALL)if(h===S){const{combo:u}=b[0];let w=u;for(const p of s){let k=new Set([p]);for(let _=1;_<t;_++){const{combo:v,leaves:C}=b[_],A={combo:w,leaves:C};if(k=this._getCombinedNodes(A,k,h),k.size)if(_===m)if(r.size){const T=[...r];r=new Set([...T,...k]),a=!0,w=u}else r=k,w=u;else w=v;else break}}}else for(const u of s){let w=new Set([u]);for(let p=m-1;p>=0;p--){const k=b[p];if(w=this._getCombinedNodes(k,w,h),w.size)p===0&&(r.add(u),t>1&&r.size>1&&(a=!0));else break}}else if(c===n.TARGET_FIRST&&h===S){const{combo:u}=b[0];let w;for(const p of s)if(w=this._matchNodeNext(b,new Set([p]),{combo:u,index:1}),w){r.add(w);break}if(!w){const{leaves:p}=b[0],[k]=s;let[_]=this._findWalker(p,k,{targetType:c});for(;_;){if(w=this._matchNodeNext(b,new Set([_]),{combo:u,index:1}),w){r.add(w);break}[_]=this._findWalker(p,_,{targetType:c,force:!0})}}}else{let u;for(const w of s)if(u=this._matchNodePrev(b,w,{index:m-1}),u){r.add(w);break}if(!u&&c===n.TARGET_FIRST){const{leaves:w}=b[m],[p]=s;let[k]=this._findWalker(w,p,{targetType:c});for(;k;){if(u=this._matchNodePrev(b,k,{index:m-1}),u){r.add(k);break}[k]=this._findWalker(w,k,{targetType:c,force:!0})}}}}}return c===n.TARGET_FIRST?(r.delete(this.#e),r.size>1&&(r=new Set((0,N.sortNodes)(r)))):c===n.TARGET_ALL&&(r.delete(this.#e),a&&r.size>1&&(r=new Set((0,N.sortNodes)(r)))),r}}0&&(module.exports={Finder});
//# sourceMappingURL=finder.js.map
