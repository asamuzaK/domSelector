var j=Object.create;var W=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var G=Object.getOwnPropertyNames;var q=Object.getPrototypeOf,V=Object.prototype.hasOwnProperty;var X=(T,a)=>{for(var e in a)W(T,e,{get:a[e],enumerable:!0})},H=(T,a,e,n)=>{if(a&&typeof a=="object"||typeof a=="function")for(let i of G(a))!V.call(T,i)&&i!==e&&W(T,i,{get:()=>a[i],enumerable:!(n=B(a,i))||n.enumerable});return T};var Y=(T,a,e)=>(e=T!=null?j(q(T)):{},H(a||!T||!T.__esModule?W(e,"default",{value:T,enumerable:!0}):e,T)),K=T=>H(W({},"__esModule",{value:!0}),T);var Q={};X(Q,{Finder:()=>J});module.exports=K(Q);var z=Y(require("is-potential-custom-element-name"),1),A=require("./dom-util.js"),D=require("./matcher.js"),v=require("./parser.js"),h=require("./constant.js");const C="next",O="prev",L="all",$="first",R="lineal",P="self",I=h.SHOW_DOCUMENT|h.SHOW_DOCUMENT_FRAGMENT|h.SHOW_ELEMENT;class J{#a;#l;#t;#r;#e;#n;#b;#c;#s;#h;#o;#d;#i;#f;constructor(){this.#l=new WeakMap}_onError(a){if(!this.#b)if(a instanceof DOMException||this.#f&&a instanceof this.#f.DOMException)if(a.name===h.NOT_SUPPORTED_ERR)this.#i&&console.warn(a.message);else throw this.#f?new this.#f.DOMException(a.message,a.name):a;else throw a}_setup(a,e,n={}){const{noexcept:i,warn:t}=n;return this.#b=!!i,this.#i=!!t,this.#e=e,[this.#f,this.#t,this.#s]=(0,A.prepareDOMObjects)(e),this.#h=(0,A.isInShadowTree)(e),[this.#a,this.#n]=this._correspond(a),this.#c=new WeakMap,e}_correspond(a){const e=[];let n,i=this.#t&&this.#l.get(this.#t);if(i&&i.has(`${a}`)&&(n=i.get(a)),n){const t=n.length;for(let c=0;c<t;c++)n[c].dir=null,n[c].filtered=!1,n[c].find=!1,e[c]=[]}else{let t;try{t=(0,v.parseSelector)(a)}catch(f){this._onError(f)}const c=(0,v.walkAST)(t);n=[];let o=0;for(const[...f]of c){const r=[];let s=f.shift();if(s&&s.type!==h.COMBINATOR){const l=new Set;for(;s;){if(s.type===h.COMBINATOR){const[u]=f;if(u.type===h.COMBINATOR){const d=`Invalid selector ${a}`;throw new DOMException(d,h.SYNTAX_ERR)}r.push({combo:s,leaves:(0,v.sortAST)(l)}),l.clear()}else s&&l.add(s);if(f.length)s=f.shift();else{r.push({combo:null,leaves:(0,v.sortAST)(l)}),l.clear();break}}}n.push({branch:r,dir:null,filtered:!1,find:!1}),e[o]=[],o++}this.#t&&(i||(i=new Map),i.set(`${a}`,n),this.#l.set(this.#t,i))}return[n,e]}_prepareTreeWalkers(a){return this.#d=this.#t.createTreeWalker(this.#s,I),this.#r=this.#t.createTreeWalker(a,I),this.#o=!1,[this.#d,this.#r]}_traverse(a={},e=this.#d){let n,i=e.currentNode;if(a.nodeType===h.ELEMENT_NODE&&i===a)n=i;else{if(i!==e.root)for(;i&&!(i===e.root||a.nodeType===h.ELEMENT_NODE&&i===a);)i=e.parentNode();if(a.nodeType===h.ELEMENT_NODE)for(;i;){if(i===a){n=i;break}i=e.nextNode()}else n=i}return n??null}_collectNthChild(a,e,n){const{a:i,b:t,reverse:c,selector:o}=a,{parentNode:f}=e;let r=new Set,s;if(o&&(this.#l.has(o)?s=this.#l.get(o):(s=(0,v.walkAST)(o),this.#l.set(o,s))),f){const l=this.#t.createTreeWalker(f,I);let u=0,d=l.firstChild();for(;d;)u++,d=l.nextSibling();d=this._traverse(f,l);const g=new Set;if(s)for(d=this._traverse(f,l),d=l.firstChild();d;){let m;for(const _ of s)if(m=this._matchLeaves(_,d,n),!m)break;m&&g.add(d),d=l.nextSibling()}if(i===0){if(t>0&&t<=u){if(g.size){let m=0;for(d=this._traverse(f,l),c?d=l.lastChild():d=l.firstChild();d;){if(g.has(d)){if(m===t-1){r.add(d);break}m++}c?d=l.previousSibling():d=l.nextSibling()}}else if(!o){let m=0;for(d=this._traverse(f,l),c?d=l.lastChild():d=l.firstChild();d;){if(m===t-1){r.add(d);break}c?d=l.previousSibling():d=l.nextSibling(),m++}}}}else{let m=t-1;if(i>0)for(;m<0;)m+=i;if(m>=0&&m<u){let _=0,k=i>0?0:t-1;for(d=this._traverse(f,l),c?d=l.lastChild():d=l.firstChild();d&&(d&&m>=0&&m<u);)g.size?g.has(d)&&(k===m&&(r.add(d),m+=i),i>0?k++:k--):_===m&&(o||r.add(d),m+=i),c?d=l.previousSibling():d=l.nextSibling(),_++}}if(c&&r.size>1){const m=[...r];r=new Set(m.reverse())}}else if(e===this.#s&&i+t===1)if(s){let l;for(const u of s)if(l=this._matchLeaves(u,e,n),l)break;l&&r.add(e)}else r.add(e);return r}_collectNthOfType(a,e){const{a:n,b:i,reverse:t}=a,{localName:c,parentNode:o,prefix:f}=e;let r=new Set;if(o){const s=this.#t.createTreeWalker(o,I);let l=0,u=s.firstChild();for(;u;)l++,u=s.nextSibling();if(n===0){if(i>0&&i<=l){let d=0;for(u=this._traverse(o,s),t?u=s.lastChild():u=s.firstChild();u;){const{localName:g,prefix:m}=u;if(g===c&&m===f){if(d===i-1){r.add(u);break}d++}t?u=s.previousSibling():u=s.nextSibling()}}}else{let d=i-1;if(n>0)for(;d<0;)d+=n;if(d>=0&&d<l){let g=n>0?0:i-1;for(u=this._traverse(o,s),t?u=s.lastChild():u=s.firstChild();u;){const{localName:m,prefix:_}=u;if(m===c&&_===f){if(g===d&&(r.add(u),d+=n),d<0||d>=l)break;n>0?g++:g--}t?u=s.previousSibling():u=s.nextSibling()}}}if(t&&r.size>1){const d=[...r];r=new Set(d.reverse())}}else e===this.#s&&n+i===1&&r.add(e);return r}_matchAnPlusB(a,e,n,i){const{nth:{a:t,b:c,name:o},selector:f}=a,r=(0,v.unescapeSelector)(o),s=new Map;r?(r==="even"?(s.set("a",2),s.set("b",0)):r==="odd"&&(s.set("a",2),s.set("b",1)),n.indexOf("last")>-1&&s.set("reverse",!0)):(typeof t=="string"&&/-?\d+/.test(t)?s.set("a",t*1):s.set("a",0),typeof c=="string"&&/-?\d+/.test(c)?s.set("b",c*1):s.set("b",0),n.indexOf("last")>-1&&s.set("reverse",!0));let l=new Set;if(s.has("a")&&s.has("b")){if(/^nth-(?:last-)?child$/.test(n)){f&&s.set("selector",f);const u=Object.fromEntries(s),d=this._collectNthChild(u,e,i);d.size&&(l=d)}else if(/^nth-(?:last-)?of-type$/.test(n)){const u=Object.fromEntries(s),d=this._collectNthOfType(u,e);d.size&&(l=d)}}return l}_matchDirectionPseudoClass(a,e){const n=(0,v.unescapeSelector)(a.name),i=(0,A.getDirectionality)(e);let t;return n===i&&(t=e),t??null}_matchLanguagePseudoClass(a,e){const n=(0,v.unescapeSelector)(a.name);let i;if(n==="*")if(e.hasAttribute("lang"))e.getAttribute("lang")&&(i=e);else{let t=e.parentNode;for(;t&&t.nodeType===h.ELEMENT_NODE;){if(t.hasAttribute("lang")){t.getAttribute("lang")&&(i=e);break}t=t.parentNode}}else if(n){const t=`(?:-${h.ALPHA_NUM})*`;if(new RegExp(`^(?:\\*-)?${h.ALPHA_NUM}${t}$`,"i").test(n)){let o;if(n.indexOf("-")>-1){const[f,r,...s]=n.split("-");let l;f==="*"?l=`${h.ALPHA_NUM}${t}`:l=`${f}${t}`;const u=`-${r}${t}`,d=s.length;let g="";if(d)for(let m=0;m<d;m++)g+=`-${s[m]}${t}`;o=new RegExp(`^${l}${u}${g}$`,"i")}else o=new RegExp(`^${n}${t}$`,"i");if(e.hasAttribute("lang"))o.test(e.getAttribute("lang"))&&(i=e);else{let f=e.parentNode;for(;f&&f.nodeType===h.ELEMENT_NODE;){if(f.hasAttribute("lang")){const r=f.getAttribute("lang");o.test(r)&&(i=e);break}f=f.parentNode}}}}return i??null}_matchHasPseudoFunc(a,e,n={}){let i;if(Array.isArray(a)&&a.length){const[t]=a,{type:c}=t;let o;c===h.COMBINATOR?o=a.shift():o={name:" ",type:h.COMBINATOR};const f=[];for(;a.length;){const[l]=a,{type:u}=l;if(u===h.COMBINATOR)break;f.push(a.shift())}const r={combo:o,leaves:f};n.dir=C;const s=this._matchCombinator(r,e,n);if(s.size)if(a.length){for(const l of s)if(i=this._matchHasPseudoFunc(Object.assign([],a),l,n),i)break}else i=!0}return!!i}_matchLogicalPseudoFunc(a,e,n={}){const{astName:i="",branches:t=[],selector:c="",twigBranches:o=[]}=a;let f;if(i==="has")if(c.includes(":has("))f=null;else{let r;for(const s of t)if(r=this._matchHasPseudoFunc(Object.assign([],s),e,n),r)break;r&&(f=e)}else{const r=/^(?:is|where)$/.test(i);n.forgive=r;const s=o.length;let l;for(let u=0;u<s;u++){const d=o[u],g=d.length-1,{leaves:m}=d[g];if(l=this._matchLeaves(m,e,n),l&&g>0){let _=new Set([e]);for(let k=g-1;k>=0;k--){const N=d[k],b=[];n.dir=O;for(const w of _){const p=this._matchCombinator(N,w,n);p.size&&b.push(...p)}if(b.length)k===0?l=!0:_=new Set(b);else{l=!1;break}}}if(l)break}i==="not"?l||(f=e):l&&(f=e)}return f??null}_matchPseudoClassSelector(a,e,n={}){const{children:i}=a,{localName:t,parentNode:c}=e,{forgive:o,warn:f=this.#i}=n,r=(0,v.unescapeSelector)(a.name);let s=new Set;if(h.REG_LOGICAL_PSEUDO.test(r)){let l;if(this.#l.has(a))l=this.#l.get(a);else{const d=(0,v.walkAST)(a),g=[],m=[];for(const[..._]of d){for(const w of _){const p=(0,v.generateCSS)(w);g.push(p)}const k=[],N=new Set;let b=_.shift();for(;b;)if(b.type===h.COMBINATOR?(k.push({combo:b,leaves:[...N]}),N.clear()):b&&N.add(b),_.length)b=_.shift();else{k.push({combo:null,leaves:[...N]}),N.clear();break}m.push(k)}l={astName:r,branches:d,twigBranches:m,selector:g.join(",")},this.#l.set(a,l)}const u=this._matchLogicalPseudoFunc(l,e,n);u&&s.add(u)}else if(Array.isArray(i)){const[l]=i;if(/^nth-(?:last-)?(?:child|of-type)$/.test(r)){const u=this._matchAnPlusB(l,e,r,n);u.size&&(s=u)}else if(r==="dir"){const u=this._matchDirectionPseudoClass(l,e);u&&s.add(u)}else if(r==="lang"){const u=this._matchLanguagePseudoClass(l,e);u&&s.add(u)}else switch(r){case"current":case"nth-col":case"nth-last-col":{if(f){const u=`Unsupported pseudo-class :${r}()`;throw new DOMException(u,h.NOT_SUPPORTED_ERR)}break}case"host":case"host-context":break;default:if(!o){const u=`Unknown pseudo-class :${r}()`;throw new DOMException(u,h.SYNTAX_ERR)}}}else{const l=/^a(?:rea)?$/,u=/^(?:(?:fieldse|inpu|selec)t|button|opt(?:group|ion)|textarea)$/,d=/^(?:(?:inpu|selec)t|button|form|textarea)$/,g=/^d(?:etails|ialog)$/,m=/^(?:checkbox|radio)$/,_=/^(?:date(?:time-local)?|month|time|week)$/,k=/(?:(?:rang|tim)e|date(?:time-local)?|month|number|week)$/,N=/^(?:(?:emai|te|ur)l|number|password|search|text)$/;switch(r){case"any-link":case"link":{l.test(t)&&e.hasAttribute("href")&&s.add(e);break}case"local-link":{if(l.test(t)&&e.hasAttribute("href")){const{href:b,origin:w,pathname:p}=new URL(this.#t.URL),y=new URL(e.getAttribute("href"),b);y.origin===w&&y.pathname===p&&s.add(e)}break}case"visited":break;case"target":{const{hash:b}=new URL(this.#t.URL);e.id&&b===`#${e.id}`&&this.#t.contains(e)&&s.add(e);break}case"target-within":{const{hash:b}=new URL(this.#t.URL);if(b){const w=b.replace(/^#/,"");let p=this.#t.getElementById(w);for(;p;){if(p===e){s.add(e);break}p=p.parentNode}}break}case"scope":{this.#e.nodeType===h.ELEMENT_NODE?e===this.#e&&s.add(e):e===this.#t.documentElement&&s.add(e);break}case"focus":{e===this.#t.activeElement&&s.add(e);break}case"focus-within":{let b=this.#t.activeElement;for(;b;){if(b===e){s.add(e);break}b=b.parentNode}break}case"open":{g.test(t)&&e.hasAttribute("open")&&s.add(e);break}case"closed":{g.test(t)&&!e.hasAttribute("open")&&s.add(e);break}case"disabled":{if(u.test(t)||(0,z.default)(t))if(e.disabled||e.hasAttribute("disabled"))s.add(e);else{let b=c;for(;b&&b.localName!=="fieldset";)b=b.parentNode;b&&c.localName!=="legend"&&b.hasAttribute("disabled")&&s.add(e)}break}case"enabled":{(u.test(t)||(0,z.default)(t))&&!(e.disabled&&e.hasAttribute("disabled"))&&s.add(e);break}case"read-only":{switch(t){case"textarea":{(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&s.add(e);break}case"input":{(!e.type||_.test(e.type)||N.test(e.type))&&(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&s.add(e);break}default:(0,A.isContentEditable)(e)||s.add(e)}break}case"read-write":{switch(t){case"textarea":{e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled")||s.add(e);break}case"input":{(!e.type||_.test(e.type)||N.test(e.type))&&!(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&s.add(e);break}default:(0,A.isContentEditable)(e)&&s.add(e)}break}case"placeholder-shown":{let b;t==="textarea"?b=e:t==="input"&&(e.hasAttribute("type")?N.test(e.getAttribute("type"))&&(b=e):b=e),b&&e.value===""&&e.hasAttribute("placeholder")&&e.getAttribute("placeholder").trim().length&&s.add(e);break}case"checked":{(e.checked&&t==="input"&&e.hasAttribute("type")&&m.test(e.getAttribute("type"))||e.selected&&t==="option")&&s.add(e);break}case"indeterminate":{if(e.indeterminate&&t==="input"&&e.type==="checkbox"||t==="progress"&&!e.hasAttribute("value"))s.add(e);else if(t==="input"&&e.type==="radio"&&!e.hasAttribute("checked")){const b=e.name;let w=e.parentNode;for(;w&&w.localName!=="form";)w=w.parentNode;w||(w=this.#t.documentElement);let p;const y=w.getElementsByTagName("input"),E=y.length;if(E)for(let x=0;x<E;x++){const S=y[x];if(S.getAttribute("type")==="radio"&&(b?S.getAttribute("name")===b&&(p=!!S.checked):S.hasAttribute("name")||(p=!!S.checked),p))break}p||s.add(e)}break}case"default":{const b=/^(?:button|reset)$/,w=/^(?:image|submit)$/;if(t==="button"&&!(e.hasAttribute("type")&&b.test(e.getAttribute("type")))||t==="input"&&e.hasAttribute("type")&&w.test(e.getAttribute("type"))){let p=e.parentNode;for(;p&&p.localName!=="form";)p=p.parentNode;if(p){const y=this.#t.createTreeWalker(p,h.SHOW_ELEMENT);let E=y.firstChild();for(;E;){const x=E.localName;let S;if(x==="button"?S=!(E.hasAttribute("type")&&b.test(E.getAttribute("type"))):x==="input"&&(S=E.hasAttribute("type")&&w.test(E.getAttribute("type"))),S){E===e&&s.add(e);break}E=y.nextNode()}}}else if(t==="input"&&e.hasAttribute("type")&&m.test(e.getAttribute("type"))&&(e.checked||e.hasAttribute("checked")))s.add(e);else if(t==="option"){let p=!1,y=c;for(;y&&y.localName!=="datalist";){if(y.localName==="select"){(y.multiple||y.hasAttribute("multiple"))&&(p=!0);break}y=y.parentNode}if(p)(e.selected||e.hasAttribute("selected"))&&s.add(e);else{const E=new Set,x=this.#t.createTreeWalker(c,h.SHOW_ELEMENT);let S=x.firstChild();for(;S;){if(S.selected||S.hasAttribute("selected")){E.add(S);break}S=x.nextSibling()}E.size&&E.has(e)&&s.add(e)}}break}case"valid":{if(d.test(t))e.checkValidity()&&s.add(e);else if(t==="fieldset"){let b;const w=this.#t.createTreeWalker(e,h.SHOW_ELEMENT);let p=w.firstChild();for(;p&&!(d.test(p.localName)&&(b=p.checkValidity(),!b));)p=w.nextNode();b&&s.add(e)}break}case"invalid":{if(d.test(t))e.checkValidity()||s.add(e);else if(t==="fieldset"){let b;const w=this.#t.createTreeWalker(e,h.SHOW_ELEMENT);let p=w.firstChild();for(;p&&!(d.test(p.localName)&&(b=p.checkValidity(),!b));)p=w.nextNode();b||s.add(e)}break}case"in-range":{t==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&k.test(e.getAttribute("type"))&&!(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&(e.hasAttribute("min")||e.hasAttribute("max")||e.getAttribute("type")==="range")&&s.add(e);break}case"out-of-range":{t==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&k.test(e.getAttribute("type"))&&(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&s.add(e);break}case"required":{let b;if(/^(?:select|textarea)$/.test(t))b=e;else if(t==="input")if(e.hasAttribute("type")){const w=e.getAttribute("type");(w==="file"||m.test(w)||_.test(w)||N.test(w))&&(b=e)}else b=e;b&&(e.required||e.hasAttribute("required"))&&s.add(e);break}case"optional":{let b;if(/^(?:select|textarea)$/.test(t))b=e;else if(t==="input")if(e.hasAttribute("type")){const w=e.getAttribute("type");(w==="file"||m.test(w)||_.test(w)||N.test(w))&&(b=e)}else b=e;b&&!(e.required||e.hasAttribute("required"))&&s.add(e);break}case"root":{e===this.#t.documentElement&&s.add(e);break}case"empty":{if(e.hasChildNodes()){let b;const w=this.#t.createTreeWalker(e,h.SHOW_ALL);let p=w.firstChild();for(;p&&(b=p.nodeType!==h.ELEMENT_NODE&&p.nodeType!==h.TEXT_NODE,!!b);)p=w.nextSibling();b&&s.add(e)}else s.add(e);break}case"first-child":{(c&&e===c.firstElementChild||e===this.#s)&&s.add(e);break}case"last-child":{(c&&e===c.lastElementChild||e===this.#s)&&s.add(e);break}case"only-child":{(c&&e===c.firstElementChild&&e===c.lastElementChild||e===this.#s)&&s.add(e);break}case"first-of-type":{if(c){const[b]=this._collectNthOfType({a:0,b:1},e);b&&s.add(b)}else e===this.#s&&s.add(e);break}case"last-of-type":{if(c){const[b]=this._collectNthOfType({a:0,b:1,reverse:!0},e);b&&s.add(b)}else e===this.#s&&s.add(e);break}case"only-of-type":{if(c){const[b]=this._collectNthOfType({a:0,b:1},e);if(b===e){const[w]=this._collectNthOfType({a:0,b:1,reverse:!0},e);w===e&&s.add(e)}}else e===this.#s&&s.add(e);break}case"host":case"host-context":break;case"after":case"before":case"first-letter":case"first-line":{if(f){const b=`Unsupported pseudo-element ::${r}`;throw new DOMException(b,h.NOT_SUPPORTED_ERR)}break}case"active":case"autofill":case"blank":case"buffering":case"current":case"defined":case"focus-visible":case"fullscreen":case"future":case"hover":case"modal":case"muted":case"past":case"paused":case"picture-in-picture":case"playing":case"seeking":case"stalled":case"user-invalid":case"user-valid":case"volume-locked":case"-webkit-autofill":{if(f){const b=`Unsupported pseudo-class :${r}`;throw new DOMException(b,h.NOT_SUPPORTED_ERR)}break}default:if(r.startsWith("-webkit-")){if(f){const b=`Unsupported pseudo-class :${r}`;throw new DOMException(b,h.NOT_SUPPORTED_ERR)}}else if(!o){const b=`Unknown pseudo-class :${r}`;throw new DOMException(b,h.SYNTAX_ERR)}}}return s}_matchShadowHostPseudoClass(a,e){const{children:n}=a,i=(0,v.unescapeSelector)(a.name);let t;if(Array.isArray(n)){const[c]=(0,v.walkAST)(n[0]),[...o]=c,{host:f}=e;if(i==="host"){let r;for(const s of o){const{type:l}=s;if(l===h.COMBINATOR){const d=`Invalid selector ${(0,v.generateCSS)(a)}`;throw new DOMException(d,h.SYNTAX_ERR)}if(r=this._matchSelector(s,f).has(f),!r)break}r&&(t=e)}else if(i==="host-context"){let r,s=f;for(;s;){for(const l of o){const{type:u}=l;if(u===h.COMBINATOR){const g=`Invalid selector ${(0,v.generateCSS)(a)}`;throw new DOMException(g,h.SYNTAX_ERR)}if(r=this._matchSelector(l,s).has(s),!r)break}if(r)break;s=s.parentNode}r&&(t=e)}}else if(i==="host")t=e;else{const c=`Invalid selector :${i}`;throw new DOMException(c,h.SYNTAX_ERR)}return t??null}_matchSelector(a,e,n){const{type:i}=a,t=(0,v.unescapeSelector)(a.name);let c=new Set;if(e.nodeType===h.ELEMENT_NODE)switch(i){case h.SELECTOR_PSEUDO_CLASS:{const o=this._matchPseudoClassSelector(a,e,n);o.size&&(c=o);break}case h.SELECTOR_PSEUDO_ELEMENT:{(0,D.matchPseudoElementSelector)(t,n);break}default:{const o=(0,D.matchSelector)(a,e,n);o&&c.add(o)}}else if(this.#h&&i===h.SELECTOR_PSEUDO_CLASS&&e.nodeType===h.DOCUMENT_FRAGMENT_NODE){if(t!=="has"&&h.REG_LOGICAL_PSEUDO.test(t)){const o=this._matchPseudoClassSelector(a,e,n);o.size&&(c=o)}else if(h.REG_SHADOW_HOST.test(t)){const o=this._matchShadowHostPseudoClass(a,e,n);o&&c.add(o)}}return c}_matchLeaves(a,e,n){let i;if(this.#c.has(a)){const t=this.#c.get(a);if(t.has(e))i=t.get(e);else{for(const c of a)if(i=this._matchSelector(c,e,n).has(e),!i)break;t.set(e,i),this.#c.set(a,t)}}else{for(const c of a)if(i=this._matchSelector(c,e,n).has(e),!i)break;const t=new WeakMap;t.set(e,i),this.#c.set(a,t)}return!!i}_matchHTMLCollection(a,e={}){const{compound:n,filterLeaves:i}=e;let t=new Set;const c=a.length;if(c)if(n)for(let o=0;o<c;o++){const f=a[o];this._matchLeaves(i,f,e)&&t.add(f)}else{const o=[].slice.call(a);t=new Set(o)}return t}_findDescendantNodes(a,e,n){const[i,...t]=a,{type:c}=i,o=(0,v.unescapeSelector)(i.name),f=t.length>0;let r=new Set,s=!1;if(this.#h)s=!0;else switch(c){case h.SELECTOR_ID:{if(this.#s.nodeType===h.ELEMENT_NODE)s=!0;else{const l=this.#s.getElementById(o);l&&l!==e&&e.contains(l)&&(f?this._matchLeaves(t,l,n)&&r.add(l):r.add(l))}break}case h.SELECTOR_CLASS:{const l=e.getElementsByClassName(o);r=this._matchHTMLCollection(l,{compound:f,filterLeaves:t});break}case h.SELECTOR_TYPE:{if(this.#t.contentType==="text/html"&&!/[*|]/.test(o)){const l=e.getElementsByTagName(o);r=this._matchHTMLCollection(l,{compound:f,filterLeaves:t})}else s=!0;break}case h.SELECTOR_PSEUDO_ELEMENT:{(0,D.matchPseudoElementSelector)(o,n);break}default:s=!0}return{nodes:r,pending:s}}_matchCombinator(a,e,n={}){const{combo:i,leaves:t}=a,{name:c}=i,{dir:o}=n;let f=new Set;if(o===C)switch(c){case"+":{const r=e.nextElementSibling;r&&this._matchLeaves(t,r,n)&&f.add(r);break}case"~":{const{parentNode:r}=e;if(r){const s=this.#t.createTreeWalker(r,h.SHOW_ELEMENT);let l=this._traverse(e,s);for(l===e&&(l=s.nextSibling());l;)this._matchLeaves(t,l,n)&&f.add(l),l=s.nextSibling()}break}case">":{const r=this.#t.createTreeWalker(e,h.SHOW_ELEMENT);let s=r.firstChild();for(;s;)this._matchLeaves(t,s,n)&&f.add(s),s=r.nextSibling();break}case" ":default:{const{nodes:r,pending:s}=this._findDescendantNodes(t,e);if(r.size)f=r;else if(s){const l=this.#t.createTreeWalker(e,h.SHOW_ELEMENT);let u=l.nextNode();for(;u;)this._matchLeaves(t,u,n)&&f.add(u),u=l.nextNode()}}}else switch(c){case"+":{const r=e.previousElementSibling;r&&this._matchLeaves(t,r,n)&&f.add(r);break}case"~":{const r=this.#t.createTreeWalker(e.parentNode,h.SHOW_ELEMENT);let s=r.firstChild();for(;s&&s!==e;)this._matchLeaves(t,s,n)&&f.add(s),s=r.nextSibling();break}case">":{const r=e.parentNode;r&&this._matchLeaves(t,r,n)&&f.add(r);break}case" ":default:{const r=[];let s=e.parentNode;for(;s;)this._matchLeaves(t,s,n)&&r.push(s),s=s.parentNode;r.length&&(f=new Set(r.reverse()))}}return f}_findNode(a,e={}){const{node:n}=e;let i,t=this._traverse(n,this.#r);if(t)for(t.nodeType!==h.ELEMENT_NODE?t=this.#r.nextNode():t===n&&t!==this.#s&&(t=this.#r.nextNode());t;){let c;if(this.#e.nodeType===h.ELEMENT_NODE?t===this.#e?c=!0:c=this.#e.contains(t):c=!0,c&&this._matchLeaves(a,t,{warn:this.#i})){i=t;break}t=this.#r.nextNode()}return i??null}_matchSelf(a){const e=[];let n=!1;return this._matchLeaves(a,this.#e)&&(e.push(this.#e),n=!0),[e,n]}_findLineal(a,e={}){const{complex:n,compound:i,filterLeaves:t}=e,c=[];let o=!1,f=this._matchLeaves([a],this.#e);if(f&&!i&&!n?(c.push(this.#e),o=!0):f&&i&&!n&&(f=this._matchLeaves(t,this.#e),f&&(c.push(this.#e),o=!0)),!f||n){f&&(c.push(this.#e),i||(o=!0));let r=this.#e.parentNode;for(;r&&(f=this._matchLeaves([a],r),f&&(c.push(r),i||(o=!0)),r.parentNode);)r=r.parentNode}return[c,o]}_findFirst(a){const e=[];let n=!1;const i=this._findNode(a,{node:this.#e});return i&&(e.push(i),n=!0),[e,n]}_findFromHTMLCollection(a,e={}){const{compound:n,filterLeaves:i}=e;let t=[],c=!1;const o=a.length;if(o)if(this.#e.nodeType===h.ELEMENT_NODE)for(let f=0;f<o;f++){const r=a[f];(r===this.#e||(0,A.isInclusive)(r,this.#e))&&(n?this._matchLeaves(i,r,{warn:this.#i})&&(t.push(r),c=!0):(t.push(r),c=!0))}else t=[].slice.call(a),n||(c=!0);return[t,c]}_findEntryNodes(a,e,n){const{leaves:i}=a,[t,...c]=i,{type:o}=t,f=(0,v.unescapeSelector)(t.name),r=c.length>0;let s=[],l=!1,u=!1;switch(o){case h.SELECTOR_PSEUDO_ELEMENT:{(0,D.matchPseudoElementSelector)(f,{warn:this.#i});break}case h.SELECTOR_ID:{if(e===P)[s,l]=this._matchSelf(i);else if(e===R)[s,l]=this._findLineal(t,{complex:n,compound:r,filterLeaves:c});else if(e===$&&this.#s.nodeType!==h.ELEMENT_NODE){const d=this.#s.getElementById(f);d&&(r?this._matchLeaves(c,d,{warn:this.#i})&&(s.push(d),l=!0):(s.push(d),l=!0))}else u=!0;break}case h.SELECTOR_CLASS:{if(e===P)[s,l]=this._matchSelf(i);else if(e===R)[s,l]=this._findLineal(t,{complex:n,compound:r,filterLeaves:c});else if(e===$)[s,l]=this._findFirst(i);else if(this.#s.nodeType===h.DOCUMENT_NODE){const d=this.#s.getElementsByClassName(f);[s,l]=this._findFromHTMLCollection(d,{compound:r,filterLeaves:c})}else u=!0;break}case h.SELECTOR_TYPE:{if(e===P)[s,l]=this._matchSelf(i);else if(e===R)[s,l]=this._findLineal(t,{complex:n,compound:r,filterLeaves:c});else if(this.#t.contentType==="text/html"&&this.#s.nodeType===h.DOCUMENT_NODE&&!/[*|]/.test(f)){const d=this.#s.getElementsByTagName(f);[s,l]=this._findFromHTMLCollection(d,{compound:r,filterLeaves:c})}else u=!0;break}default:if(e!==R&&h.REG_SHADOW_HOST.test(f)){if(this.#h&&this.#e.nodeType===h.DOCUMENT_FRAGMENT_NODE){const d=this._matchShadowHostPseudoClass(t,this.#e);d&&(s.push(d),l=!0)}}else e===P?[s,l]=this._matchSelf(i):e===R?[s,l]=this._findLineal(t,{complex:n,compound:r,filterLeaves:c}):e===$?[s,l]=this._findFirst(i):u=!0}return{compound:r,filtered:l,nodes:s,pending:u}}_getEntryTwig(a,e){const n=a.length,i=n>1,t=a[0];let c,o;if(i){const{combo:f,leaves:[{name:r,type:s}]}=t,l=a[n-1],{leaves:[{name:u,type:d}]}=l;if(d===h.SELECTOR_PSEUDO_ELEMENT||d===h.SELECTOR_ID)c=O,o=l;else if(s===h.SELECTOR_PSEUDO_ELEMENT||s===h.SELECTOR_ID)c=C,o=t;else if(e===L)if(r==="*"&&s===h.SELECTOR_TYPE)c=O,o=l;else if(u==="*"&&d===h.SELECTOR_TYPE)c=C,o=t;else if(n===2){const{name:g}=f;/^[+~]$/.test(g)?(c=O,o=l):(c=C,o=t)}else c=C,o=t;else if(u==="*"&&d===h.SELECTOR_TYPE)c=C,o=t;else if(r==="*"&&s===h.SELECTOR_TYPE)c=O,o=l;else{let g,m;for(const{combo:_,leaves:[k]}of a){const{type:N}=k,b=(0,v.unescapeSelector)(k.name);if(N===h.SELECTOR_PSEUDO_CLASS&&b==="dir"){g=!1;break}if(_&&!m){const{name:w}=_;/^[+~]$/.test(w)&&(g=!0,m=!0)}}g?(c=C,o=t):(c=O,o=l)}}else c=O,o=t;return{complex:i,dir:c,twig:o}}_collectNodes(a){const e=this.#a.values();if(a===L||a===$){const n=new Set;let i=0;for(const{branch:t}of e){const{complex:c,dir:o,twig:f}=this._getEntryTwig(t,a),{compound:r,filtered:s,nodes:l,pending:u}=this._findEntryNodes(f,a,c);l.length?(this.#a[i].find=!0,this.#n[i]=l):u&&n.add(new Map([["index",i],["twig",f]])),this.#a[i].dir=o,this.#a[i].filtered=s||!r,i++}if(n.size){let t,c;this.#e!==this.#s&&this.#e.nodeType===h.ELEMENT_NODE?(t=this.#e,c=this.#r):(t=this.#s,c=this.#d);let o=this._traverse(t,c);for(;o;){let f=!1;if(this.#e.nodeType===h.ELEMENT_NODE?o===this.#e?f=!0:f=this.#e.contains(o):f=!0,f)for(const r of n){const{leaves:s}=r.get("twig");if(this._matchLeaves(s,o,{warn:this.#i})){const u=r.get("index");this.#a[u].filtered=!0,this.#a[u].find=!0,this.#n[u].push(o)}}o=c.nextNode()}}}else{let n=0;for(const{branch:i}of e){const t=i[i.length-1],c=i.length>1,{compound:o,filtered:f,nodes:r}=this._findEntryNodes(t,a,c);r.length&&(this.#a[n].find=!0,this.#n[n]=r),this.#a[n].dir=O,this.#a[n].filtered=f||!o,n++}}return[this.#a,this.#n]}_matchNodes(a){const[...e]=this.#a,n=e.length;let i=new Set;for(let t=0;t<n;t++){const{branch:c,dir:o,filtered:f,find:r}=e[t],s=c.length;if(s&&r){const l=this.#n[t],u=l.length,d=s-1;if(d===0){const{leaves:[,...g]}=c[0];if((a===L||a===$)&&this.#e.nodeType===h.ELEMENT_NODE)for(let m=0;m<u;m++){const _=l[m];if(_!==this.#e&&this.#e.contains(_)&&(i.add(_),a!==L))break}else if(g.length)for(let m=0;m<u;m++){const _=l[m];if((f||this._matchLeaves(g,_,{warn:this.#i}))&&(i.add(_),a!==L))break}else if(a===L)if(i.size){const m=[...i];i=new Set([...m,...l]),this.#o=!0}else i=new Set([...l]);else{const[m]=[...l];i.add(m)}}else if(o===C){let{combo:g,leaves:m}=c[0];const[,..._]=m;let k;for(let N=0;N<u;N++){const b=l[N];if(f||this._matchLeaves(_,b,{warn:this.#i})){let p=new Set([b]);for(let y=1;y<s;y++){const{combo:E,leaves:x}=c[y],S=[];for(const M of p){const U={combo:g,leaves:x},F=this._matchCombinator(U,M,{dir:o,warn:this.#i});F.size&&S.push(...F)}if(S.length)if(y===d){if(a===L){if(i.size){const M=[...i];i=new Set([...M,...S])}else i=new Set([...S]);this.#o=!0}else{const[M]=(0,A.sortNodes)(S);i.add(M)}k=!0}else g=E,p=new Set(S),k=!1;else{k=!1;break}}}else k=!1;if(k&&a!==L)break}if(!k&&a===$){const[N]=[...l];let b=this._findNode(m,{node:N});for(;b;){let w=new Set([b]);for(let p=1;p<s;p++){const{combo:y,leaves:E}=c[p],x=[];for(const S of w){const M={combo:g,leaves:E},U=this._matchCombinator(M,S,{dir:o,warn:this.#i});U.size&&x.push(...U)}if(x.length)if(p===d){const[S]=(0,A.sortNodes)(x);i.add(S),k=!0}else g=y,w=new Set(x),k=!1;else{k=!1;break}}if(k)break;b=this._findNode(m,{node:b}),w=new Set([b])}}}else{const{leaves:g}=c[d];let m;for(let _=0;_<u;_++){const k=l[_];let N=new Set([k]);for(let b=d-1;b>=0;b--){const w=c[b],p=[];for(const y of N){const E=this._matchCombinator(w,y,{dir:o,warn:this.#i});E.size&&p.push(...E)}if(p.length)b===0?(i.add(k),m=!0,a===L&&s>1&&i.size>1&&(this.#o=!0)):(N=new Set(p),m=!1);else{m=!1;break}}if(m&&a!==L)break}if(!m&&a===$){const[_]=[...l];let k=this._findNode(g,{node:_});for(;k;){let N=new Set([k]);for(let b=d-1;b>=0;b--){const w=c[b],p=[];for(const y of N){const E=this._matchCombinator(w,y,{dir:o,warn:this.#i});E.size&&p.push(...E)}if(p.length)b===0?(i.add(k),m=!0):(N=new Set(p),m=!1);else{m=!1;break}}if(m)break;k=this._findNode(g,{node:k}),N=new Set([k])}}}}}return i}_find(a){return this._collectNodes(a),this._matchNodes(a)}matches(a,e,n){let i;try{if(this.#e=this._setup(a,e,n),e.nodeType!==h.ELEMENT_NODE){const c=`Unexpected node ${e.nodeName}`;throw new TypeError(c)}const t=this._find(P);t.size&&(i=t.has(this.#e))}catch(t){this._onError(t)}return!!i}closest(a,e,n){let i;try{if(this.#e=this._setup(a,e,n),e.nodeType!==h.ELEMENT_NODE){const o=`Unexpected node ${e.nodeName}`;throw new TypeError(o)}const t=this._find(R);let c=this.#e;for(;c;){if(t.has(c)){i=c;break}if(c.parentNode)c=c.parentNode;else break}}catch(t){this._onError(t)}return i??null}querySelector(a,e,n){let i;try{this.#e=this._setup(a,e,n),this._prepareTreeWalkers(e);const t=this._find($);t.delete(this.#e),t.size&&([i]=(0,A.sortNodes)(t))}catch(t){this._onError(t)}return i??null}querySelectorAll(a,e,n){let i;try{this.#e=this._setup(a,e,n),this._prepareTreeWalkers(e);const t=this._find(L);t.delete(this.#e),t.size&&(this.#o?i=(0,A.sortNodes)(t):i=[...t])}catch(t){this._onError(t)}return i??[]}}0&&(module.exports={Finder});
//# sourceMappingURL=finder.js.map
