var W=Object.create;var P=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var j=Object.getPrototypeOf,G=Object.prototype.hasOwnProperty;var q=(E,a)=>{for(var e in a)P(E,e,{get:a[e],enumerable:!0})},U=(E,a,e,n)=>{if(a&&typeof a=="object"||typeof a=="function")for(let l of B(a))!G.call(E,l)&&l!==e&&P(E,l,{get:()=>a[l],enumerable:!(n=H(a,l))||n.enumerable});return E};var z=(E,a,e)=>(e=E!=null?W(j(E)):{},U(a||!E||!E.__esModule?P(e,"default",{value:E,enumerable:!0}):e,E)),V=E=>U(P({},"__esModule",{value:!0}),E);var Y={};q(Y,{Finder:()=>X});module.exports=V(Y);var I=z(require("is-potential-custom-element-name"),1),F=z(require("nwsapi"),1),C=require("./dom-util.js"),$=require("./matcher.js"),y=require("./parser.js"),b=require("./constant.js");const T="next",O="prev",M="all",A="first",R="lineal",D="self";class X{#a;#l;#t;#o;#f;#e;#h;#w;#c;#n;#m;#s;#d;#b;#r;#u;#i;#p;constructor(a){this.#p=a,this.#f=a.document,this.#l=new WeakMap,this.#m=new WeakMap,this.#c=(0,F.default)({document:a.document,DOMException:a.DOMException}),this.#c.configure({LOGERRORS:!1})}_onError(a){if(!this.#w)if(a instanceof DOMException||a instanceof this.#p.DOMException)if(a.name===b.NOT_SUPPORTED_ERR)this.#i&&console.warn(a.message);else throw new this.#p.DOMException(a.message,a.name);else throw a}_setup(a,e,n={}){const{noexcept:l,warn:s}=n;return this.#w=!!l,this.#i=!!s,this.#e=e,[this.#t,this.#s,this.#r]=(0,C.resolveContent)(e),this.#d=(0,C.isInShadowTree)(e),[this.#a,this.#h]=this._correspond(a),this.#u=new WeakMap,e}_correspond(a){const e=[];this.#o=!1;let n;if(this.#t){const l=this.#l.get(this.#t);if(l&&l.has(`${a}`)){const s=l.get(`${a}`);this.#o=s.descendant,n=s.ast}}if(n){const l=n.length;for(let s=0;s<l;s++)n[s].collected=!1,n[s].dir=null,n[s].filtered=!1,n[s].find=!1,e[s]=[]}else{let l;try{l=(0,y.parseSelector)(a)}catch(d){this._onError(d)}const s=(0,y.walkAST)(l);let c=!1,r=0;n=[];for(const[...d]of s){const f=[];let t=d.shift();if(t&&t.type!==b.COMBINATOR){const i=new Set;for(;t;){if(t.type===b.COMBINATOR){const[o]=d;if(o.type===b.COMBINATOR){const _=`Invalid selector ${a}`;throw new DOMException(_,b.SYNTAX_ERR)}const m=t.name;/^[\s>]$/.test(m)&&(c=!0),f.push({combo:t,leaves:(0,y.sortAST)(i)}),i.clear()}else if(t){let{name:o}=t;o&&typeof o=="string"&&(o=(0,y.unescapeSelector)(o),typeof o=="string"&&o!==t.name&&(t.name=o),/[|:]/.test(o)&&(t.namespace=!0)),i.add(t)}if(d.length)t=d.shift();else{f.push({combo:null,leaves:(0,y.sortAST)(i)}),i.clear();break}}}n.push({branch:f,collected:!1,dir:null,filtered:!1,find:!1}),e[r]=[],r++}if(this.#t){let d;this.#l.has(this.#t)?d=this.#l.get(this.#t):d=new Map,d.set(`${a}`,{ast:n,descendant:c}),this.#l.set(this.#t,d)}this.#o=c}return[n,e]}_createTreeWalker(a){let e;return this.#u.has(a)?e=this.#u.get(a):(e=this.#f.createTreeWalker(a,b.WALKER_FILTER),this.#u.set(a,e)),e}_prepareQuerySelectorWalker(){return this.#n=this._createTreeWalker(this.#e),this.#b=!1,this.#n}_traverse(a,e=this.#r){let n=e.currentNode,l;if(n===a)l=n;else if(n.contains(a))for(n=e.nextNode();n;){if(n===a){l=n;break}n=e.nextNode()}else{if(n!==e.root)for(;n&&!(n===e.root||n===a);)n=e.parentNode();if(a?.nodeType===b.ELEMENT_NODE)for(;n;){if(n===a){l=n;break}n=e.nextNode()}else l=n}return l??null}_collectNthChild(a,e,n){const{a:l,b:s,reverse:c,selector:r}=a,{parentNode:d}=e,f=new Set;let t;if(r&&(this.#l.has(r)?t=this.#l.get(r):(t=(0,y.walkAST)(r),this.#l.set(r,t))),d){const i=this.#r;let o=this._traverse(d,i);o=i.firstChild();let m=0;for(;o;)m++,o=i.nextSibling();o=this._traverse(d,i);const _=new Set;if(t)for(o=i.firstChild();o;){let u;for(const N of t)if(u=this._matchLeaves(N,o,n),!u)break;u&&_.add(o),o=i.nextSibling()}if(l===0){if(s>0&&s<=m){if(_.size){o=this._traverse(d,i),c?o=i.lastChild():o=i.firstChild();let u=0;for(;o;){if(_.has(o)){if(u===s-1){f.add(o);break}u++}c?o=i.previousSibling():o=i.nextSibling()}}else if(!r){o=this._traverse(d,i),c?o=i.lastChild():o=i.firstChild();let u=0;for(;o;){if(u===s-1){f.add(o);break}c?o=i.previousSibling():o=i.nextSibling(),u++}}}}else{let u=s-1;if(l>0)for(;u<0;)u+=l;if(u>=0&&u<m){o=this._traverse(d,i),c?o=i.lastChild():o=i.firstChild();let N=0,k=l>0?0:s-1;for(;o&&(o&&u>=0&&u<m);)_.size?_.has(o)&&(k===u&&(f.add(o),u+=l),l>0?k++:k--):N===u&&(r||f.add(o),u+=l),c?o=i.previousSibling():o=i.nextSibling(),N++}}if(c&&f.size>1){const u=[...f];return new Set(u.reverse())}}else if(e===this.#s&&l+s===1)if(t){let i;for(const o of t)if(i=this._matchLeaves(o,e,n),i)break;i&&f.add(e)}else f.add(e);return f}_collectNthOfType(a,e){const{a:n,b:l,reverse:s}=a,{localName:c,parentNode:r,prefix:d}=e,f=new Set;if(r){const t=this.#r;let i=this._traverse(r,t);i=t.firstChild();let o=0;for(;i;)o++,i=t.nextSibling();if(n===0){if(l>0&&l<=o){i=this._traverse(r,t),s?i=t.lastChild():i=t.firstChild();let m=0;for(;i;){const{localName:_,prefix:u}=i;if(_===c&&u===d){if(m===l-1){f.add(i);break}m++}s?i=t.previousSibling():i=t.nextSibling()}}}else{let m=l-1;if(n>0)for(;m<0;)m+=n;if(m>=0&&m<o){i=this._traverse(r,t),s?i=t.lastChild():i=t.firstChild();let _=n>0?0:l-1;for(;i;){const{localName:u,prefix:N}=i;if(u===c&&N===d){if(_===m&&(f.add(i),m+=n),m<0||m>=o)break;n>0?_++:_--}s?i=t.previousSibling():i=t.nextSibling()}}}if(s&&f.size>1){const m=[...f];return new Set(m.reverse())}}else e===this.#s&&n+l===1&&f.add(e);return f}_matchAnPlusB(a,e,n,l){const{nth:{a:s,b:c,name:r},selector:d}=a,f=new Map;if(r?(r==="even"?(f.set("a",2),f.set("b",0)):r==="odd"&&(f.set("a",2),f.set("b",1)),n.indexOf("last")>-1&&f.set("reverse",!0)):(typeof s=="string"&&/-?\d+/.test(s)?f.set("a",s*1):f.set("a",0),typeof c=="string"&&/-?\d+/.test(c)?f.set("b",c*1):f.set("b",0),n.indexOf("last")>-1&&f.set("reverse",!0)),/^nth-(?:last-)?child$/.test(n)){d&&f.set("selector",d);const t=Object.fromEntries(f);return this._collectNthChild(t,e,l)}else if(/^nth-(?:last-)?of-type$/.test(n)){const t=Object.fromEntries(f);return this._collectNthOfType(t,e)}return new Set}_matchHasPseudoFunc(a,e,n={}){let l;if(Array.isArray(a)&&a.length){const[s]=a,{type:c}=s;let r;c===b.COMBINATOR?r=a.shift():r={name:" ",type:b.COMBINATOR};const d=[];for(;a.length;){const[i]=a,{type:o}=i;if(o===b.COMBINATOR)break;d.push(a.shift())}const f={combo:r,leaves:d};n.dir=T;const t=this._matchCombinator(f,e,n);if(t.size)if(a.length){for(const i of t)if(l=this._matchHasPseudoFunc(Object.assign([],a),i,n),l)break}else l=!0}return!!l}_matchLogicalPseudoFunc(a,e,n={}){const{astName:l="",branches:s=[],selector:c="",twigBranches:r=[]}=a;let d;if(l==="has")if(c.includes(":has("))d=null;else{let f;for(const t of s)if(f=this._matchHasPseudoFunc(Object.assign([],t),e,n),f)break;f&&(d=e)}else{const f=/^(?:is|where)$/.test(l);n.forgive=f;const t=r.length;let i;for(let o=0;o<t;o++){const m=r[o],_=m.length-1,{leaves:u}=m[_];if(i=this._matchLeaves(u,e,n),i&&_>0){let N=new Set([e]);for(let k=_-1;k>=0;k--){const g=m[k],h=[];n.dir=O;for(const p of N){const w=this._matchCombinator(g,p,n);w.size&&h.push(...w)}if(h.length)k===0?i=!0:N=new Set(h);else{i=!1;break}}}if(i)break}l==="not"?i||(d=e):i&&(d=e)}return d??null}_matchPseudoClassSelector(a,e,n={}){const{children:l,name:s}=a,{localName:c,parentNode:r}=e,{forgive:d,warn:f=this.#i}=n,t=new Set;if(b.REG_LOGICAL_PSEUDO.test(s)){let i;if(this.#l.has(a))i=this.#l.get(a);else{const m=(0,y.walkAST)(a),_=[],u=[];for(const[...N]of m){for(const p of N){const w=(0,y.generateCSS)(p);_.push(w)}const k=[],g=new Set;let h=N.shift();for(;h;)if(h.type===b.COMBINATOR?(k.push({combo:h,leaves:[...g]}),g.clear()):h&&g.add(h),N.length)h=N.shift();else{k.push({combo:null,leaves:[...g]}),g.clear();break}u.push(k)}i={astName:s,branches:m,twigBranches:u,selector:_.join(",")},this.#l.set(a,i)}const o=this._matchLogicalPseudoFunc(i,e,n);o&&t.add(o)}else if(Array.isArray(l))if(/^nth-(?:last-)?(?:child|of-type)$/.test(s)){const[i]=l;return this._matchAnPlusB(i,e,s,n)}else switch(s){case"dir":case"lang":{const i=$.matcher.matchSelector(a,e);i&&t.add(i);break}case"current":case"nth-col":case"nth-last-col":{if(f){const i=`Unsupported pseudo-class :${s}()`;throw new DOMException(i,b.NOT_SUPPORTED_ERR)}break}case"host":case"host-context":break;default:if(!d){const i=`Unknown pseudo-class :${s}()`;throw new DOMException(i,b.SYNTAX_ERR)}}else{const i=/^a(?:rea)?$/,o=/^(?:(?:fieldse|inpu|selec)t|button|opt(?:group|ion)|textarea)$/,m=/^(?:(?:inpu|selec)t|button|form|textarea)$/,_=/^d(?:etails|ialog)$/,u=/^(?:checkbox|radio)$/,N=/^(?:date(?:time-local)?|month|time|week)$/,k=/(?:(?:rang|tim)e|date(?:time-local)?|month|number|week)$/,g=/^(?:(?:emai|te|ur)l|number|password|search|text)$/;switch(s){case"any-link":case"link":{i.test(c)&&e.hasAttribute("href")&&t.add(e);break}case"local-link":{if(i.test(c)&&e.hasAttribute("href")){const{href:h,origin:p,pathname:w}=new URL(this.#t.URL),S=new URL(e.getAttribute("href"),h);S.origin===p&&S.pathname===w&&t.add(e)}break}case"visited":break;case"target":{const{hash:h}=new URL(this.#t.URL);e.id&&h===`#${e.id}`&&this.#t.contains(e)&&t.add(e);break}case"target-within":{const{hash:h}=new URL(this.#t.URL);if(h){const p=h.replace(/^#/,"");let w=this.#t.getElementById(p);for(;w;){if(w===e){t.add(e);break}w=w.parentNode}}break}case"scope":{this.#e.nodeType===b.ELEMENT_NODE?!this.#d&&e===this.#e&&t.add(e):e===this.#t.documentElement&&t.add(e);break}case"focus":{if(e===this.#t.activeElement){let h=e,p=!0;for(;h;){if(h.disabled||h.hasAttribute("disabled")||h.hidden||h.hasAttribute("hidden")){p=!1;break}else if(h.hasAttribute("style")){const{display:w,visibility:S}=h.style;if(p=!(w==="none"||S==="hidden"),!p)break}if(h.parentNode&&h.parentNode.nodeType===b.ELEMENT_NODE)h=h.parentNode;else break}p&&t.add(e)}break}case"focus-within":{let h=this.#t.activeElement,p;for(;h;){if(h===e){p=!0;break}h=h.parentNode}if(p){let w=e,S=!0;for(;w;){if(w.disabled||w.hasAttribute("disabled")||w.hidden||w.hasAttribute("hidden")){S=!1;break}else if(w.hasAttribute("style")){const{display:v,visibility:L}=w.style;if(S=!(v==="none"||L==="hidden"),!S)break}if(w.parentNode&&w.parentNode.nodeType===b.ELEMENT_NODE)w=w.parentNode;else break}S&&t.add(e)}break}case"open":{_.test(c)&&e.hasAttribute("open")&&t.add(e);break}case"closed":{_.test(c)&&!e.hasAttribute("open")&&t.add(e);break}case"disabled":{if(o.test(c)||(0,I.default)(c))if(e.disabled||e.hasAttribute("disabled"))t.add(e);else{let h=r;for(;h&&h.localName!=="fieldset";)h=h.parentNode;h&&r.localName!=="legend"&&h.hasAttribute("disabled")&&t.add(e)}break}case"enabled":{(o.test(c)||(0,I.default)(c))&&!(e.disabled&&e.hasAttribute("disabled"))&&t.add(e);break}case"read-only":{switch(c){case"textarea":{(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}case"input":{(!e.type||N.test(e.type)||g.test(e.type))&&(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}default:(0,C.isContentEditable)(e)||t.add(e)}break}case"read-write":{switch(c){case"textarea":{e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled")||t.add(e);break}case"input":{(!e.type||N.test(e.type)||g.test(e.type))&&!(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}default:(0,C.isContentEditable)(e)&&t.add(e)}break}case"placeholder-shown":{let h;c==="textarea"?h=e:c==="input"&&(e.hasAttribute("type")?g.test(e.getAttribute("type"))&&(h=e):h=e),h&&e.value===""&&e.hasAttribute("placeholder")&&e.getAttribute("placeholder").trim().length&&t.add(e);break}case"checked":{(e.checked&&c==="input"&&e.hasAttribute("type")&&u.test(e.getAttribute("type"))||e.selected&&c==="option")&&t.add(e);break}case"indeterminate":{if(e.indeterminate&&c==="input"&&e.type==="checkbox"||c==="progress"&&!e.hasAttribute("value"))t.add(e);else if(c==="input"&&e.type==="radio"&&!e.hasAttribute("checked")){const h=e.name;let p=e.parentNode;for(;p&&p.localName!=="form";)p=p.parentNode;p||(p=this.#t.documentElement);const w=p.getElementsByTagName("input"),S=w.length;let v;for(let L=0;L<S;L++){const x=w[L];if(x.getAttribute("type")==="radio"&&(h?x.getAttribute("name")===h&&(v=!!x.checked):x.hasAttribute("name")||(v=!!x.checked),v))break}v||t.add(e)}break}case"default":{const h=/^(?:button|reset)$/,p=/^(?:image|submit)$/;if(c==="button"&&!(e.hasAttribute("type")&&h.test(e.getAttribute("type")))||c==="input"&&e.hasAttribute("type")&&p.test(e.getAttribute("type"))){let w=e.parentNode;for(;w&&w.localName!=="form";)w=w.parentNode;if(w){const S=this.#r;let v=this._traverse(w,S);for(v=S.firstChild();v&&w.contains(v);){const L=v.localName;let x;if(L==="button"?x=!(v.hasAttribute("type")&&h.test(v.getAttribute("type"))):L==="input"&&(x=v.hasAttribute("type")&&p.test(v.getAttribute("type"))),x){v===e&&t.add(e);break}v=S.nextNode()}}}else if(c==="input"&&e.hasAttribute("type")&&u.test(e.getAttribute("type"))&&(e.checked||e.hasAttribute("checked")))t.add(e);else if(c==="option"){let w=r,S=!1;for(;w&&w.localName!=="datalist";){if(w.localName==="select"){(w.multiple||w.hasAttribute("multiple"))&&(S=!0);break}w=w.parentNode}if(S)(e.selected||e.hasAttribute("selected"))&&t.add(e);else{const v=new Set,L=this.#r;let x=this._traverse(r,L);for(x=L.firstChild();x;){if(x.selected||x.hasAttribute("selected")){v.add(x);break}x=L.nextSibling()}v.size&&v.has(e)&&t.add(e)}}break}case"valid":{if(m.test(c))e.checkValidity()&&t.add(e);else if(c==="fieldset"){const h=this.#r;let p=this._traverse(e,h);p=h.firstChild();let w;for(;p&&e.contains(p)&&!(m.test(p.localName)&&(w=p.checkValidity(),!w));)p=h.nextNode();w&&t.add(e)}break}case"invalid":{if(m.test(c))e.checkValidity()||t.add(e);else if(c==="fieldset"){const h=this.#r;let p=this._traverse(e,h);p=h.firstChild();let w;for(;p&&e.contains(p)&&!(m.test(p.localName)&&(w=p.checkValidity(),!w));)p=h.nextNode();w||t.add(e)}break}case"in-range":{c==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&k.test(e.getAttribute("type"))&&!(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&(e.hasAttribute("min")||e.hasAttribute("max")||e.getAttribute("type")==="range")&&t.add(e);break}case"out-of-range":{c==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&k.test(e.getAttribute("type"))&&(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&t.add(e);break}case"required":{let h;if(/^(?:select|textarea)$/.test(c))h=e;else if(c==="input")if(e.hasAttribute("type")){const p=e.getAttribute("type");(p==="file"||u.test(p)||N.test(p)||g.test(p))&&(h=e)}else h=e;h&&(e.required||e.hasAttribute("required"))&&t.add(e);break}case"optional":{let h;if(/^(?:select|textarea)$/.test(c))h=e;else if(c==="input")if(e.hasAttribute("type")){const p=e.getAttribute("type");(p==="file"||u.test(p)||N.test(p)||g.test(p))&&(h=e)}else h=e;h&&!(e.required||e.hasAttribute("required"))&&t.add(e);break}case"root":{e===this.#t.documentElement&&t.add(e);break}case"empty":{if(e.hasChildNodes()){const h=this.#f.createTreeWalker(e,b.SHOW_ALL);let p=h.firstChild(),w;for(;p&&(w=p.nodeType!==b.ELEMENT_NODE&&p.nodeType!==b.TEXT_NODE,!!w);)p=h.nextSibling();w&&t.add(e)}else t.add(e);break}case"first-child":{(r&&e===r.firstElementChild||e===this.#s)&&t.add(e);break}case"last-child":{(r&&e===r.lastElementChild||e===this.#s)&&t.add(e);break}case"only-child":{(r&&e===r.firstElementChild&&e===r.lastElementChild||e===this.#s)&&t.add(e);break}case"first-of-type":{if(r){const[h]=this._collectNthOfType({a:0,b:1},e);h&&t.add(h)}else e===this.#s&&t.add(e);break}case"last-of-type":{if(r){const[h]=this._collectNthOfType({a:0,b:1,reverse:!0},e);h&&t.add(h)}else e===this.#s&&t.add(e);break}case"only-of-type":{if(r){const[h]=this._collectNthOfType({a:0,b:1},e);if(h===e){const[p]=this._collectNthOfType({a:0,b:1,reverse:!0},e);p===e&&t.add(e)}}else e===this.#s&&t.add(e);break}case"host":case"host-context":break;case"after":case"before":case"first-letter":case"first-line":{if(f){const h=`Unsupported pseudo-element ::${s}`;throw new DOMException(h,b.NOT_SUPPORTED_ERR)}break}case"active":case"autofill":case"blank":case"buffering":case"current":case"defined":case"focus-visible":case"fullscreen":case"future":case"hover":case"modal":case"muted":case"past":case"paused":case"picture-in-picture":case"playing":case"seeking":case"stalled":case"user-invalid":case"user-valid":case"volume-locked":case"-webkit-autofill":{if(f){const h=`Unsupported pseudo-class :${s}`;throw new DOMException(h,b.NOT_SUPPORTED_ERR)}break}default:if(s.startsWith("-webkit-")){if(f){const h=`Unsupported pseudo-class :${s}`;throw new DOMException(h,b.NOT_SUPPORTED_ERR)}}else if(!d){const h=`Unknown pseudo-class :${s}`;throw new DOMException(h,b.SYNTAX_ERR)}}}return t}_matchShadowHostPseudoClass(a,e){const{children:n,name:l}=a;let s;if(Array.isArray(n)){const[c]=(0,y.walkAST)(n[0]),[...r]=c,{host:d}=e;if(l==="host"){let f;for(const t of r){const{type:i}=t;if(i===b.COMBINATOR){const m=`Invalid selector ${(0,y.generateCSS)(a)}`;throw new DOMException(m,b.SYNTAX_ERR)}if(f=this._matchSelector(t,d).has(d),!f)break}f&&(s=e)}else if(l==="host-context"){let f=d,t;for(;f;){for(const i of r){const{type:o}=i;if(o===b.COMBINATOR){const _=`Invalid selector ${(0,y.generateCSS)(a)}`;throw new DOMException(_,b.SYNTAX_ERR)}if(t=this._matchSelector(i,f).has(f),!t)break}if(t)break;f=f.parentNode}t&&(s=e)}}else if(l==="host")s=e;else{const c=`Invalid selector :${l}`;throw new DOMException(c,b.SYNTAX_ERR)}return s??null}_matchSelector(a,e,n){const{type:l}=a,s=new Set;if(a.name===b.EMPTY)return s;const c=(0,y.unescapeSelector)(a.name);if(typeof c=="string"&&c!==a.name&&(a.name=c),e.nodeType===b.ELEMENT_NODE)switch(l){case b.SELECTOR_PSEUDO_ELEMENT:{$.matcher.matchPseudoElementSelector(c,n);break}case b.SELECTOR_ID:{e.id===c&&s.add(e);break}case b.SELECTOR_CLASS:{e.classList.contains(c)&&s.add(e);break}case b.SELECTOR_PSEUDO_CLASS:return this._matchPseudoClassSelector(a,e,n);default:{const r=$.matcher.matchSelector(a,e,n);r&&s.add(r)}}else if(this.#d&&l===b.SELECTOR_PSEUDO_CLASS&&e.nodeType===b.DOCUMENT_FRAGMENT_NODE){if(c!=="has"&&b.REG_LOGICAL_PSEUDO.test(c))return this._matchPseudoClassSelector(a,e,n);if(b.REG_SHADOW_HOST.test(c)){const r=this._matchShadowHostPseudoClass(a,e,n);r&&s.add(r)}}return s}_matchLeaves(a,e,n){const{attributes:l,localName:s,nodeType:c}=e;let r=this.#m.get(a),d;if(r&&r.has(e)){const{attr:f,matched:t}=r.get(e);l?.length===f&&(d=t)}if(typeof d!="boolean"){const f=/^(?:(?:fieldse|inpu|selec)t|button|form|textarea)$/;let t;c===b.ELEMENT_NODE&&f.test(s)?t=!1:t=!0;for(const i of a){const{name:o,type:m}=i;if(m===b.SELECTOR_PSEUDO_CLASS&&o==="dir"&&(t=!1),d=this._matchSelector(i,e,n).has(e),!d)break}t&&(r||(r=new WeakMap),r.set(e,{attr:l?.length,matched:d}),this.#m.set(a,r))}return!!d}_matchHTMLCollection(a,e={}){const{compound:n,filterLeaves:l}=e,s=new Set,c=a.length;if(c)if(n)for(let r=0;r<c;r++){const d=a[r];this._matchLeaves(l,d,e)&&s.add(d)}else{const r=[].slice.call(a);return new Set(r)}return s}_findDescendantNodes(a,e,n){const[l,...s]=a,c=s.length>0,{type:r}=l,d=(0,y.unescapeSelector)(l.name);typeof d=="string"&&d!==l.name&&(l.name=d);let f=new Set,t=!1;if(this.#d)t=!0;else switch(r){case b.SELECTOR_PSEUDO_ELEMENT:{$.matcher.matchPseudoElementSelector(d,n);break}case b.SELECTOR_ID:{if(this.#s.nodeType===b.ELEMENT_NODE)t=!0;else{const i=this.#s.getElementById(d);i&&i!==e&&e.contains(i)&&(c?this._matchLeaves(s,i,n)&&f.add(i):f.add(i))}break}case b.SELECTOR_CLASS:{const i=e.getElementsByClassName(d);f=this._matchHTMLCollection(i,{compound:c,filterLeaves:s});break}case b.SELECTOR_TYPE:{if(this.#t.contentType==="text/html"&&!/[*|]/.test(d)){const i=e.getElementsByTagName(d);f=this._matchHTMLCollection(i,{compound:c,filterLeaves:s})}else t=!0;break}default:t=!0}return{nodes:f,pending:t}}_matchCombinator(a,e,n={}){const{combo:l,leaves:s}=a,{name:c}=l,{parentNode:r}=e,{dir:d}=n,f=new Set;if(d===T)switch(c){case"+":{const t=e.nextElementSibling;t&&this._matchLeaves(s,t,n)&&f.add(t);break}case"~":{if(r){const t=this._createTreeWalker(r);let i=this._traverse(e,t);for(i=t.nextSibling();i;)this._matchLeaves(s,i,n)&&f.add(i),i=t.nextSibling()}break}case">":{const t=this._createTreeWalker(e);let i=this._traverse(e,t);for(i=t.firstChild();i;)this._matchLeaves(s,i,n)&&f.add(i),i=t.nextSibling();break}case" ":default:{const{nodes:t,pending:i}=this._findDescendantNodes(s,e);if(t.size)return t;if(i){const o=this._createTreeWalker(e);let m=this._traverse(e,o);for(m=o.nextNode();m&&e.contains(m);)this._matchLeaves(s,m,n)&&f.add(m),m=o.nextNode()}}}else switch(c){case"+":{const t=e.previousElementSibling;t&&this._matchLeaves(s,t,n)&&f.add(t);break}case"~":{if(r){const t=this._createTreeWalker(r);let i=this._traverse(r,t);for(i=t.firstChild();i&&i!==e;)this._matchLeaves(s,i,n)&&f.add(i),i=t.nextSibling()}break}case">":{r&&this._matchLeaves(s,r,n)&&f.add(r);break}case" ":default:{const t=[];let i=r;for(;i;)this._matchLeaves(s,i,n)&&t.push(i),i=i.parentNode;if(t.length)return new Set(t.reverse())}}return f}_findNode(a,e){const{node:n}=e;let l=this._traverse(n,this.#n),s;if(l)for(l.nodeType!==b.ELEMENT_NODE?l=this.#n.nextNode():l===n&&l!==this.#s&&(l=this.#n.nextNode());l;){if(this._matchLeaves(a,l,{warn:this.#i})){s=l;break}l=this.#n.nextNode()}return s??null}_matchSelf(a){const e=[],n=this._matchLeaves(a,this.#e,{warn:this.#i});let l=!1;return n&&(e.push(this.#e),l=!0),[e,l]}_findLineal(a,e={}){const{complex:n}=e,l=[];let s=this._matchLeaves(a,this.#e,{warn:this.#i}),c=!1;if(s&&(l.push(this.#e),c=!0),!s||n){let r=this.#e.parentNode;for(;r&&(s=this._matchLeaves(a,r,{warn:this.#i}),s&&(l.push(r),c=!0),r.parentNode);)r=r.parentNode}return[l,c]}_findFirst(a){const e=[],n=this._findNode(a,{node:this.#e});let l=!1;return n&&(e.push(n),l=!0),[e,l]}_findFromHTMLCollection(a,e={}){const{complex:n,compound:l,filterLeaves:s,targetType:c}=e;let r=[],d=!1,f=!1;const t=a.length;if(t)if(this.#e.nodeType===b.ELEMENT_NODE)for(let i=0;i<t;i++){const o=a[i];if(o!==this.#e&&(this.#e.contains(o)||o.contains(this.#e))){if(l){if(this._matchLeaves(s,o,{warn:this.#i})&&(r.push(o),d=!0,c===A))break}else if(r.push(o),d=!0,c===A)break}}else if(n)if(l)for(let i=0;i<t;i++){const o=a[i];if(this._matchLeaves(s,o,{warn:this.#i})&&(r.push(o),d=!0,c===A))break}else r=[].slice.call(a),d=!0,f=!0;else if(l)for(let i=0;i<t;i++){const o=a[i];if(this._matchLeaves(s,o,{warn:this.#i})&&(r.push(o),d=!0,c===A))break}else r=[].slice.call(a),d=!0,f=!0;return[r,d,f]}_findEntryNodes(a,e,n){const{leaves:l}=a,[s,...c]=l,r=c.length>0,{name:d,type:f}=s;let t=[],i=!1,o=!1,m=!1;switch(f){case b.SELECTOR_PSEUDO_ELEMENT:{$.matcher.matchPseudoElementSelector(d,{warn:this.#i});break}case b.SELECTOR_ID:{if(e===D)[t,o]=this._matchSelf(l);else if(e===R)[t,o]=this._findLineal(l,{complex:n});else if(e===A&&this.#s.nodeType!==b.ELEMENT_NODE){const _=this.#s.getElementById(d);_&&(r?this._matchLeaves(c,_,{warn:this.#i})&&(t.push(_),o=!0):(t.push(_),o=!0))}else e===A?[t,o]=this._findFirst(l):m=!0;break}case b.SELECTOR_CLASS:{if(e===D)[t,o]=this._matchSelf(l);else if(e===R)[t,o]=this._findLineal(l,{complex:n});else if(this.#s.nodeType===b.DOCUMENT_NODE){const _=this.#s.getElementsByClassName(d);_.length&&([t,o,i]=this._findFromHTMLCollection(_,{complex:n,compound:r,filterLeaves:c,targetType:e}))}else e===A?[t,o]=this._findFirst(l):m=!0;break}case b.SELECTOR_TYPE:{if(e===D)[t,o]=this._matchSelf(l);else if(e===R)[t,o]=this._findLineal(l,{complex:n});else if(this.#t.contentType==="text/html"&&this.#s.nodeType===b.DOCUMENT_NODE&&!/[*|]/.test(d)){const _=this.#s.getElementsByTagName(d);_.length&&([t,o,i]=this._findFromHTMLCollection(_,{complex:n,compound:r,filterLeaves:c,targetType:e}))}else e===A?[t,o]=this._findFirst(l):m=!0;break}default:if(e!==R&&b.REG_SHADOW_HOST.test(d)){if(this.#d&&this.#e.nodeType===b.DOCUMENT_FRAGMENT_NODE){const _=this._matchShadowHostPseudoClass(s,this.#e);_&&(t.push(_),o=!0)}}else e===D?[t,o]=this._matchSelf(l):e===R?[t,o]=this._findLineal(l,{complex:n}):e===A?[t,o]=this._findFirst(l):m=!0}return{collected:i,compound:r,filtered:o,nodes:t,pending:m}}_getEntryTwig(a,e){const n=a.length,l=n>1,s=a[0];let c,r;if(l){const{combo:d,leaves:[{name:f,type:t}]}=s,i=a[n-1],{leaves:[{name:o,type:m}]}=i;if(m===b.SELECTOR_PSEUDO_ELEMENT||m===b.SELECTOR_ID)c=O,r=i;else if(t===b.SELECTOR_PSEUDO_ELEMENT||t===b.SELECTOR_ID)c=T,r=s;else if(e===M)if(f==="*"&&t===b.SELECTOR_TYPE)c=O,r=i;else if(o==="*"&&m===b.SELECTOR_TYPE)c=T,r=s;else if(n===2){const{name:_}=d;/^[+~]$/.test(_)?(c=O,r=i):(c=T,r=s)}else c=T,r=s;else if(o==="*"&&m===b.SELECTOR_TYPE)c=T,r=s;else if(f==="*"&&t===b.SELECTOR_TYPE)c=O,r=i;else{let _;for(const{combo:u,leaves:[N]}of a){const{name:k,type:g}=N;if(g===b.SELECTOR_PSEUDO_CLASS&&k==="dir"){_=!1;break}if(!_&&u){const{name:h}=u;/^[+~]$/.test(h)&&(_=!0)}}_?(c=T,r=s):(c=O,r=i)}}else c=O,r=s;return{complex:l,dir:c,twig:r}}_collectNodes(a){const e=this.#a.values();if(a===M||a===A){const n=new Set;let l=0;for(const{branch:s}of e){const{complex:c,dir:r,twig:d}=this._getEntryTwig(s,a),{collected:f,compound:t,filtered:i,nodes:o,pending:m}=this._findEntryNodes(d,a,c);o.length?(this.#a[l].find=!0,this.#h[l]=o):m&&n.add(new Map([["index",l],["twig",d]])),this.#a[l].collected=f,this.#a[l].dir=r,this.#a[l].filtered=i||!t,l++}if(n.size){let s,c;this.#e!==this.#s&&this.#e.nodeType===b.ELEMENT_NODE?(s=this.#e,c=this.#n):(s=this.#s,c=this.#r);let r=this._traverse(s,c);for(;r;){let d=!1;if(this.#e.nodeType===b.ELEMENT_NODE?r===this.#e?d=!0:d=this.#e.contains(r):d=!0,d)for(const f of n){const{leaves:t}=f.get("twig");if(this._matchLeaves(t,r,{warn:this.#i})){const o=f.get("index");this.#a[o].filtered=!0,this.#a[o].find=!0,this.#h[o].push(r)}}r!==c.currentNode&&(r=this._traverse(r,c)),r=c.nextNode()}}}else{let n=0;for(const{branch:l}of e){const s=l[l.length-1],c=l.length>1,{compound:r,filtered:d,nodes:f}=this._findEntryNodes(s,a,c);f.length&&(this.#a[n].find=!0,this.#h[n]=f),this.#a[n].dir=O,this.#a[n].filtered=d||!r,n++}}return[this.#a,this.#h]}_getCombinedNodes(a,e,n){const l=[];for(const s of e){const c=this._matchCombinator(a,s,{dir:n,warn:this.#i});c.size&&l.push(...c)}return l.length?new Set(l):new Set}_matchNodeNext(a,e,n){const{combo:l,index:s}=n,{combo:c,leaves:r}=a[s],d={combo:l,leaves:r},f=this._getCombinedNodes(d,e,T);let t;if(f.size)if(s===a.length-1){const[i]=(0,C.sortNodes)(f);t=i}else t=this._matchNodeNext(a,f,{combo:c,index:s+1});return t??null}_matchNodePrev(a,e,n){const{index:l}=n,s=a[l],c=new Set([e]),r=this._getCombinedNodes(s,c,O);let d;if(r.size){if(l===0)d=e;else for(const f of r)if(this._matchNodePrev(a,f,{index:l-1}))return e}return d??null}_matchNodes(a){const[[...e],n]=this._collectNodes(a),l=e.length;let s=new Set;for(let c=0;c<l;c++){const{branch:r,collected:d,dir:f,find:t}=e[c],i=r.length;if(i&&t){const o=n[c],m=o.length,_=i-1;if(_===0)if((a===M||a===A)&&this.#e.nodeType===b.ELEMENT_NODE)for(let u=0;u<m;u++){const N=o[u];if(N!==this.#e&&this.#e.contains(N)&&(s.add(N),a!==M))break}else if(a===M)if(s.size){const u=[...s];s=new Set([...u,...o]),this.#b=!0}else s=new Set(o);else{const[u]=o;s.add(u)}else if(a===M)if(f===T){let{combo:u}=r[0];for(const N of o){let k=new Set([N]);for(let g=1;g<i;g++){const{combo:h,leaves:p}=r[g],w={combo:u,leaves:p};if(k=this._getCombinedNodes(w,k,f),k.size)if(g===_)if(s.size){const S=[...s];s=new Set([...S,...k]),this.#b=!0}else s=k;else u=h;else break}}}else for(const u of o){let N=new Set([u]);for(let k=_-1;k>=0;k--){const g=r[k];if(N=this._getCombinedNodes(g,N,f),N.size)k===0&&(s.add(u),i>1&&s.size>1&&(this.#b=!0));else break}}else if(a===A&&f===T){const{combo:u}=r[0];let N;for(const k of o)if(N=this._matchNodeNext(r,new Set([k]),{combo:u,index:1}),N){s.add(N);break}if(!N&&!d){const{leaves:k}=r[0],[g]=o;let h=this._findNode(k,{node:g});for(;h;){if(N=this._matchNodeNext(r,new Set([h]),{combo:u,index:1}),N){s.add(N);break}h=this._findNode(k,{node:h})}}}else{let u;for(const N of o)if(u=this._matchNodePrev(r,N,{index:_-1}),u){s.add(N);break}if(!u&&!d&&a===A){const{leaves:N}=r[_],[k]=o;let g=this._findNode(N,{node:k});for(;g;){if(u=this._matchNodePrev(r,g,{index:_-1}),u){s.add(g);break}g=this._findNode(N,{node:g})}}}}}return s}_find(a){return(a===M||a===A)&&this._prepareQuerySelectorWalker(),this._matchNodes(a)}matches(a,e,n){let l;try{if(e?.nodeType!==b.ELEMENT_NODE){const s=`Unexpected node ${e?.nodeName}`;throw new TypeError(s)}(0,y.filterSelector)(a)?l=this.#c.match(a,e):(this._setup(a,e,n),l=this._find(D).size)}catch(s){this._onError(s)}return!!l}closest(a,e,n){let l;try{if(e?.nodeType!==b.ELEMENT_NODE){const s=`Unexpected node ${e?.nodeName}`;throw new TypeError(s)}if((0,y.filterSelector)(a))l=this.#c.closest(a,e);else{this._setup(a,e,n);const s=this._find(R);if(s.size){let c=this.#e;for(;c;){if(s.has(c)){l=c;break}c=c.parentNode}}}}catch(s){this._onError(s)}return l??null}querySelector(a,e,n){let l;try{if(this._setup(a,e,n),this.#f===this.#t&&!this.#o&&(0,y.filterSelector)(a))l=this.#c.first(a,e);else{const s=this._find(A);s.delete(this.#e),s.size&&([l]=(0,C.sortNodes)(s))}}catch(s){this._onError(s)}return l??null}querySelectorAll(a,e,n){let l;try{if(this._setup(a,e,n),this.#f===this.#t&&!this.#o&&(0,y.filterSelector)(a))l=this.#c.select(a,e);else{const s=this._find(M);s.delete(this.#e),s.size&&(this.#b?l=(0,C.sortNodes)(s):l=[...s])}}catch(s){this._onError(s)}return l??[]}}0&&(module.exports={Finder});
//# sourceMappingURL=finder.js.map
