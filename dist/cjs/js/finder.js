var W=Object.create;var P=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var Y=Object.getPrototypeOf,q=Object.prototype.hasOwnProperty;var V=(y,l)=>{for(var e in l)P(y,e,{get:l[e],enumerable:!0})},I=(y,l,e,n)=>{if(l&&typeof l=="object"||typeof l=="function")for(let r of j(l))!q.call(y,r)&&r!==e&&P(y,r,{get:()=>l[r],enumerable:!(n=B(l,r))||n.enumerable});return y};var U=(y,l,e)=>(e=y!=null?W(Y(y)):{},I(l||!y||!y.__esModule?P(e,"default",{value:y,enumerable:!0}):e,y)),X=y=>I(P({},"__esModule",{value:!0}),y);var Q={};V(Q,{Finder:()=>K});module.exports=X(Q);var M=U(require("is-potential-custom-element-name"),1),$=U(require("@asamuzakjp/nwsapi"),1),S=require("./dom-util.js"),O=require("./matcher.js"),k=require("./parser.js"),c=require("./constant.js");const v="next",x="prev",L="all",g="first",C="lineal",R="self";class K{#a;#r;#c;#t;#h;#d;#p;#e;#b;#N;#f;#o;#w;#s;#u;#m;#n;#_;#i;#l;constructor(l){this.#l=l,this.#d=l.document,this.#r=new WeakMap,this.#w=new WeakMap,this.#f=(0,$.default)({document:l.document,DOMException:l.DOMException}),this.#f.configure({LOGERRORS:!1})}_onError(l){if(!this.#N)if(l instanceof DOMException||l instanceof this.#l.DOMException)if(l.name===c.NOT_SUPPORTED_ERR)this.#i&&console.warn(l.message);else throw new this.#l.DOMException(l.message,l.name);else throw l}_setup(l,e,n={}){const{event:r,noexcept:a,warn:f}=n;return this.#N=!!a,this.#i=!!f,this.#p=this._setEvent(r),this.#e=e,[this.#t,this.#s,this.#n]=(0,S.resolveContent)(e),this.#u=(0,S.isInShadowTree)(e),[this.#a,this.#b]=this._correspond(l),this.#_=new WeakMap,e}_setEvent(l){return l instanceof this.#l.MouseEvent||l instanceof this.#l.KeyboardEvent?l:null}_correspond(l){const e=[];this.#c=!1,this.#h=!1;let n;if(this.#t){const r=this.#r.get(this.#t);if(r&&r.has(`${l}`)){const a=r.get(`${l}`);this.#c=a.complex,this.#h=a.descendant,n=a.ast}}if(n){const r=n.length;for(let a=0;a<r;a++)n[a].collected=!1,n[a].dir=null,n[a].filtered=!1,n[a].find=!1,e[a]=[]}else{let r;try{r=(0,k.parseSelector)(l)}catch(d){this._onError(d)}const{branches:a,complex:f}=(0,k.walkAST)(r,!0);let o=!1,b=0;n=[];for(const[...d]of a){const s=[];let t=d.shift();if(t&&t.type!==c.COMBINATOR){const i=new Set;for(;t;){if(t.type===c.COMBINATOR){const[h]=d;if(h.type===c.COMBINATOR){const u=`Invalid selector ${l}`;throw new DOMException(u,c.SYNTAX_ERR)}const m=t.name;/^[\s>]$/.test(m)&&(o=!0),s.push({combo:t,leaves:(0,k.sortAST)(i)}),i.clear()}else if(t){let{name:h}=t;h&&typeof h=="string"&&(h=(0,k.unescapeSelector)(h),typeof h=="string"&&h!==t.name&&(t.name=h),/[|:]/.test(h)&&(t.namespace=!0)),i.add(t)}if(d.length)t=d.shift();else{s.push({combo:null,leaves:(0,k.sortAST)(i)}),i.clear();break}}}n.push({branch:s,collected:!1,dir:null,filtered:!1,find:!1}),e[b]=[],b++}if(this.#t){let d;this.#r.has(this.#t)?d=this.#r.get(this.#t):d=new Map,d.set(`${l}`,{ast:n,complex:f,descendant:o}),this.#r.set(this.#t,d)}this.#c=f,this.#h=o}return[n,e]}_createTreeWalker(l){let e;return this.#_.has(l)?e=this.#_.get(l):(e=this.#d.createTreeWalker(l,c.WALKER_FILTER),this.#_.set(l,e)),e}_prepareQuerySelectorWalker(){return this.#o=this._createTreeWalker(this.#e),this.#m=!1,this.#o}_traverse(l,e=this.#n){let n=e.currentNode,r;if(n===l)r=n;else if(n.contains(l))for(n=e.nextNode();n;){if(n===l){r=n;break}n=e.nextNode()}else{if(n!==e.root)for(;n&&!(n===e.root||n===l);)n=e.parentNode();if(l?.nodeType===c.ELEMENT_NODE)for(;n;){if(n===l){r=n;break}n=e.nextNode()}else r=n}return r??null}_collectNthChild(l,e,n){const{a:r,b:a,reverse:f,selector:o}=l,{parentNode:b}=e,d=new Set;let s;if(o)if(this.#r.has(o))s=this.#r.get(o);else{const{branches:t}=(0,k.walkAST)(o);s=t,this.#r.set(o,s)}if(b){const t=this.#n;let i=this._traverse(b,t);i=t.firstChild();let h=0;for(;i;)h++,i=t.nextSibling();i=this._traverse(b,t);const m=new Set;if(s)for(i=t.firstChild();i;){let u;for(const p of s)if(u=this._matchLeaves(p,i,n),!u)break;u&&m.add(i),i=t.nextSibling()}if(r===0){if(a>0&&a<=h){if(m.size){i=this._traverse(b,t),f?i=t.lastChild():i=t.firstChild();let u=0;for(;i;){if(m.has(i)){if(u===a-1){d.add(i);break}u++}f?i=t.previousSibling():i=t.nextSibling()}}else if(!o){i=this._traverse(b,t),f?i=t.lastChild():i=t.firstChild();let u=0;for(;i;){if(u===a-1){d.add(i);break}f?i=t.previousSibling():i=t.nextSibling(),u++}}}}else{let u=a-1;if(r>0)for(;u<0;)u+=r;if(u>=0&&u<h){i=this._traverse(b,t),f?i=t.lastChild():i=t.firstChild();let p=0,_=r>0?0:a-1;for(;i&&(i&&u>=0&&u<h);)m.size?m.has(i)&&(_===u&&(d.add(i),u+=r),r>0?_++:_--):p===u&&(o||d.add(i),u+=r),f?i=t.previousSibling():i=t.nextSibling(),p++}}if(f&&d.size>1){const u=[...d];return new Set(u.reverse())}}else if(e===this.#s&&r+a===1)if(s){let t;for(const i of s)if(t=this._matchLeaves(i,e,n),t)break;t&&d.add(e)}else d.add(e);return d}_collectNthOfType(l,e){const{a:n,b:r,reverse:a}=l,{localName:f,parentNode:o,prefix:b}=e,d=new Set;if(o){const s=this.#n;let t=this._traverse(o,s);t=s.firstChild();let i=0;for(;t;)i++,t=s.nextSibling();if(n===0){if(r>0&&r<=i){t=this._traverse(o,s),a?t=s.lastChild():t=s.firstChild();let h=0;for(;t;){const{localName:m,prefix:u}=t;if(m===f&&u===b){if(h===r-1){d.add(t);break}h++}a?t=s.previousSibling():t=s.nextSibling()}}}else{let h=r-1;if(n>0)for(;h<0;)h+=n;if(h>=0&&h<i){t=this._traverse(o,s),a?t=s.lastChild():t=s.firstChild();let m=n>0?0:r-1;for(;t;){const{localName:u,prefix:p}=t;if(u===f&&p===b){if(m===h&&(d.add(t),h+=n),h<0||h>=i)break;n>0?m++:m--}a?t=s.previousSibling():t=s.nextSibling()}}}if(a&&d.size>1){const h=[...d];return new Set(h.reverse())}}else e===this.#s&&n+r===1&&d.add(e);return d}_matchAnPlusB(l,e,n,r){const{nth:{a,b:f,name:o},selector:b}=l,d=new Map;if(o?(o==="even"?(d.set("a",2),d.set("b",0)):o==="odd"&&(d.set("a",2),d.set("b",1)),n.indexOf("last")>-1&&d.set("reverse",!0)):(typeof a=="string"&&/-?\d+/.test(a)?d.set("a",a*1):d.set("a",0),typeof f=="string"&&/-?\d+/.test(f)?d.set("b",f*1):d.set("b",0),n.indexOf("last")>-1&&d.set("reverse",!0)),/^nth-(?:last-)?child$/.test(n)){b&&d.set("selector",b);const s=Object.fromEntries(d);return this._collectNthChild(s,e,r)}else if(/^nth-(?:last-)?of-type$/.test(n)){const s=Object.fromEntries(d);return this._collectNthOfType(s,e)}return new Set}_matchHasPseudoFunc(l,e,n={}){let r;if(Array.isArray(l)&&l.length){const[a]=l,{type:f}=a;let o;f===c.COMBINATOR?o=l.shift():o={name:" ",type:c.COMBINATOR};const b=[];for(;l.length;){const[t]=l,{type:i}=t;if(i===c.COMBINATOR)break;b.push(l.shift())}const d={combo:o,leaves:b};n.dir=v;const s=this._matchCombinator(d,e,n);if(s.size)if(l.length){for(const t of s)if(r=this._matchHasPseudoFunc(Object.assign([],l),t,n),r)break}else r=!0}return!!r}_matchLogicalPseudoFunc(l,e,n={}){const{astName:r="",branches:a=[],selector:f="",twigBranches:o=[]}=l;let b;if(r==="has")if(f.includes(":has("))b=null;else{let d;for(const s of a)if(d=this._matchHasPseudoFunc(Object.assign([],s),e,n),d)break;d&&(b=e)}else{const d=/^(?:is|where)$/.test(r);n.forgive=d;const s=o.length;let t;for(let i=0;i<s;i++){const h=o[i],m=h.length-1,{leaves:u}=h[m];if(t=this._matchLeaves(u,e,n),t&&m>0){let p=new Set([e]);for(let _=m-1;_>=0;_--){const w=h[_],N=[];n.dir=x;for(const A of p){const E=this._matchCombinator(w,A,n);E.size&&N.push(...E)}if(N.length)_===0?t=!0:p=new Set(N);else{t=!1;break}}}if(t)break}r==="not"?t||(b=e):t&&(b=e)}return b??null}_matchPseudoClassSelector(l,e,n={}){const{children:r,name:a}=l,{localName:f,parentNode:o}=e,{forgive:b,warn:d=this.#i}=n,s=new Set;if(c.REG_LOGICAL_PSEUDO.test(a)){let t;if(this.#r.has(l))t=this.#r.get(l);else{const{branches:h}=(0,k.walkAST)(l),m=[],u=[];for(const[...p]of h){for(const A of p){const E=(0,k.generateCSS)(A);m.push(E)}const _=[],w=new Set;let N=p.shift();for(;N;)if(N.type===c.COMBINATOR?(_.push({combo:N,leaves:[...w]}),w.clear()):N&&w.add(N),p.length)N=p.shift();else{_.push({combo:null,leaves:[...w]}),w.clear();break}u.push(_)}t={astName:a,branches:h,twigBranches:u,selector:m.join(",")},this.#r.set(l,t)}const i=this._matchLogicalPseudoFunc(t,e,n);i&&s.add(i)}else if(Array.isArray(r))if(/^nth-(?:last-)?(?:child|of-type)$/.test(a)){const[t]=r;return this._matchAnPlusB(t,e,a,n)}else switch(a){case"dir":case"lang":{const t=O.matcher.matchSelector(l,e);t&&s.add(t);break}case"current":case"nth-col":case"nth-last-col":{if(d){const t=`Unsupported pseudo-class :${a}()`;throw new DOMException(t,c.NOT_SUPPORTED_ERR)}break}case"host":case"host-context":break;default:if(!b){const t=`Unknown pseudo-class :${a}()`;throw new DOMException(t,c.SYNTAX_ERR)}}else switch(a){case"any-link":case"link":{c.REG_ANCHOR.test(f)&&e.hasAttribute("href")&&s.add(e);break}case"local-link":{if(c.REG_ANCHOR.test(f)&&e.hasAttribute("href")){const{href:t,origin:i,pathname:h}=new URL(this.#t.URL),m=new URL(e.getAttribute("href"),t);m.origin===i&&m.pathname===h&&s.add(e)}break}case"visited":break;case"hover":{const{target:t,type:i}=this.#p??{};(i==="mouseover"||i==="pointerover")&&e.contains(t)&&s.add(e);break}case"active":{const{buttons:t,target:i,type:h}=this.#p??{};(h==="mousedown"||h==="pointerdown")&&t&c.BIT_01&&e.contains(i)&&s.add(e);break}case"target":{const{hash:t}=new URL(this.#t.URL);e.id&&t===`#${e.id}`&&this.#t.contains(e)&&s.add(e);break}case"target-within":{const{hash:t}=new URL(this.#t.URL);if(t){const i=t.replace(/^#/,"");let h=this.#t.getElementById(i);for(;h;){if(h===e){s.add(e);break}h=h.parentNode}}break}case"scope":{this.#e.nodeType===c.ELEMENT_NODE?!this.#u&&e===this.#e&&s.add(e):e===this.#t.documentElement&&s.add(e);break}case"focus":case"focus-visible":{const{target:t,type:i}=this.#p??{};if(e===this.#t.activeElement&&e.tabIndex>=0&&(a==="focus"||i==="keydown"&&e.contains(t))){let h=e,m=!0;for(;h;){if(h.disabled||h.hasAttribute("disabled")||h.hidden||h.hasAttribute("hidden")){m=!1;break}else{const{display:u,visibility:p}=this.#l.getComputedStyle(h);if(m=!(u==="none"||p==="hidden"),!m)break}if(h.parentNode&&h.parentNode.nodeType===c.ELEMENT_NODE)h=h.parentNode;else break}m&&s.add(e)}break}case"focus-within":{let t,i=this.#t.activeElement;if(i.tabIndex>=0)for(;i;){if(i===e){t=!0;break}i=i.parentNode}if(t){let h=e,m=!0;for(;h;){if(h.disabled||h.hasAttribute("disabled")||h.hidden||h.hasAttribute("hidden")){m=!1;break}else{const{display:u,visibility:p}=this.#l.getComputedStyle(h);if(m=!(u==="none"||p==="hidden"),!m)break}if(h.parentNode&&h.parentNode.nodeType===c.ELEMENT_NODE)h=h.parentNode;else break}m&&s.add(e)}break}case"open":{c.REG_INTERACT.test(f)&&e.hasAttribute("open")&&s.add(e);break}case"closed":{c.REG_INTERACT.test(f)&&!e.hasAttribute("open")&&s.add(e);break}case"disabled":{if(c.REG_FORM_CTRL.test(f)||(0,M.default)(f))if(e.disabled||e.hasAttribute("disabled"))s.add(e);else{let t=o;for(;t&&t.localName!=="fieldset";)t=t.parentNode;t&&o.localName!=="legend"&&t.hasAttribute("disabled")&&s.add(e)}break}case"enabled":{(c.REG_FORM_CTRL.test(f)||(0,M.default)(f))&&!(e.disabled&&e.hasAttribute("disabled"))&&s.add(e);break}case"read-only":{switch(f){case"textarea":{(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&s.add(e);break}case"input":{(!e.type||c.REG_TYPE_DATE.test(e.type)||c.REG_TYPE_TEXT.test(e.type))&&(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&s.add(e);break}default:(0,S.isContentEditable)(e)||s.add(e)}break}case"read-write":{switch(f){case"textarea":{e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled")||s.add(e);break}case"input":{(!e.type||c.REG_TYPE_DATE.test(e.type)||c.REG_TYPE_TEXT.test(e.type))&&!(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&s.add(e);break}default:(0,S.isContentEditable)(e)&&s.add(e)}break}case"placeholder-shown":{let t;f==="textarea"?t=e:f==="input"&&(e.hasAttribute("type")?c.REG_TYPE_TEXT.test(e.getAttribute("type"))&&(t=e):t=e),t&&e.value===""&&e.hasAttribute("placeholder")&&e.getAttribute("placeholder").trim().length&&s.add(e);break}case"checked":{(e.checked&&f==="input"&&e.hasAttribute("type")&&c.REG_TYPE_CHECK.test(e.getAttribute("type"))||e.selected&&f==="option")&&s.add(e);break}case"indeterminate":{if(e.indeterminate&&f==="input"&&e.type==="checkbox"||f==="progress"&&!e.hasAttribute("value"))s.add(e);else if(f==="input"&&e.type==="radio"&&!e.hasAttribute("checked")){const t=e.name;let i=e.parentNode;for(;i&&i.localName!=="form";)i=i.parentNode;i||(i=this.#t.documentElement);const h=i.getElementsByTagName("input"),m=h.length;let u;for(let p=0;p<m;p++){const _=h[p];if(_.getAttribute("type")==="radio"&&(t?_.getAttribute("name")===t&&(u=!!_.checked):_.hasAttribute("name")||(u=!!_.checked),u))break}u||s.add(e)}break}case"default":{if(f==="button"&&!(e.hasAttribute("type")&&c.REG_TYPE_RESET.test(e.getAttribute("type")))||f==="input"&&e.hasAttribute("type")&&c.REG_TYPE_SUBMIT.test(e.getAttribute("type"))){let t=e.parentNode;for(;t&&t.localName!=="form";)t=t.parentNode;if(t){const i=this.#n;let h=this._traverse(t,i);for(h=i.firstChild();h&&t.contains(h);){const m=h.localName;let u;if(m==="button"?u=!(h.hasAttribute("type")&&c.REG_TYPE_RESET.test(h.getAttribute("type"))):m==="input"&&(u=h.hasAttribute("type")&&c.REG_TYPE_SUBMIT.test(h.getAttribute("type"))),u){h===e&&s.add(e);break}h=i.nextNode()}}}else if(f==="input"&&e.hasAttribute("type")&&c.REG_TYPE_CHECK.test(e.getAttribute("type"))&&(e.checked||e.hasAttribute("checked")))s.add(e);else if(f==="option"){let t=o,i=!1;for(;t&&t.localName!=="datalist";){if(t.localName==="select"){(t.multiple||t.hasAttribute("multiple"))&&(i=!0);break}t=t.parentNode}if(i)(e.selected||e.hasAttribute("selected"))&&s.add(e);else{const h=new Set,m=this.#n;let u=this._traverse(o,m);for(u=m.firstChild();u;){if(u.selected||u.hasAttribute("selected")){h.add(u);break}u=m.nextSibling()}h.size&&h.has(e)&&s.add(e)}}break}case"valid":{if(c.REG_FORM_VALID.test(f))e.checkValidity()&&s.add(e);else if(f==="fieldset"){const t=this.#n;let i=this._traverse(e,t);i=t.firstChild();let h;for(;i&&e.contains(i)&&!(c.REG_FORM_VALID.test(i.localName)&&(h=i.checkValidity(),!h));)i=t.nextNode();h&&s.add(e)}break}case"invalid":{if(c.REG_FORM_VALID.test(f))e.checkValidity()||s.add(e);else if(f==="fieldset"){const t=this.#n;let i=this._traverse(e,t);i=t.firstChild();let h;for(;i&&e.contains(i)&&!(c.REG_FORM_VALID.test(i.localName)&&(h=i.checkValidity(),!h));)i=t.nextNode();h||s.add(e)}break}case"in-range":{f==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&c.REG_TYPE_RANGE.test(e.getAttribute("type"))&&!(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&(e.hasAttribute("min")||e.hasAttribute("max")||e.getAttribute("type")==="range")&&s.add(e);break}case"out-of-range":{f==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&c.REG_TYPE_RANGE.test(e.getAttribute("type"))&&(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&s.add(e);break}case"required":{let t;if(/^(?:select|textarea)$/.test(f))t=e;else if(f==="input")if(e.hasAttribute("type")){const i=e.getAttribute("type");(i==="file"||c.REG_TYPE_CHECK.test(i)||c.REG_TYPE_DATE.test(i)||c.REG_TYPE_TEXT.test(i))&&(t=e)}else t=e;t&&(e.required||e.hasAttribute("required"))&&s.add(e);break}case"optional":{let t;if(/^(?:select|textarea)$/.test(f))t=e;else if(f==="input")if(e.hasAttribute("type")){const i=e.getAttribute("type");(i==="file"||c.REG_TYPE_CHECK.test(i)||c.REG_TYPE_DATE.test(i)||c.REG_TYPE_TEXT.test(i))&&(t=e)}else t=e;t&&!(e.required||e.hasAttribute("required"))&&s.add(e);break}case"root":{e===this.#t.documentElement&&s.add(e);break}case"empty":{if(e.hasChildNodes()){const t=this.#d.createTreeWalker(e,c.SHOW_ALL);let i=t.firstChild(),h;for(;i&&(h=i.nodeType!==c.ELEMENT_NODE&&i.nodeType!==c.TEXT_NODE,!!h);)i=t.nextSibling();h&&s.add(e)}else s.add(e);break}case"first-child":{(o&&e===o.firstElementChild||e===this.#s)&&s.add(e);break}case"last-child":{(o&&e===o.lastElementChild||e===this.#s)&&s.add(e);break}case"only-child":{(o&&e===o.firstElementChild&&e===o.lastElementChild||e===this.#s)&&s.add(e);break}case"first-of-type":{if(o){const[t]=this._collectNthOfType({a:0,b:1},e);t&&s.add(t)}else e===this.#s&&s.add(e);break}case"last-of-type":{if(o){const[t]=this._collectNthOfType({a:0,b:1,reverse:!0},e);t&&s.add(t)}else e===this.#s&&s.add(e);break}case"only-of-type":{if(o){const[t]=this._collectNthOfType({a:0,b:1},e);if(t===e){const[i]=this._collectNthOfType({a:0,b:1,reverse:!0},e);i===e&&s.add(e)}}else e===this.#s&&s.add(e);break}case"defined":{const t=e.getAttribute("is");t?(0,M.default)(t)&&this.#l.customElements.get(t)&&s.add(e):(0,M.default)(f)?this.#l.customElements.get(f)&&s.add(e):(e instanceof this.#l.HTMLElement||e instanceof this.#l.SVGElement)&&s.add(e);break}case"popover-open":{if(e.popover){const{display:t}=this.#l.getComputedStyle(e);t!=="none"&&s.add(e)}break}case"host":case"host-context":break;case"after":case"before":case"first-letter":case"first-line":{if(d){const t=`Unsupported pseudo-element ::${a}`;throw new DOMException(t,c.NOT_SUPPORTED_ERR)}break}case"autofill":case"blank":case"buffering":case"current":case"fullscreen":case"future":case"modal":case"muted":case"past":case"paused":case"picture-in-picture":case"playing":case"seeking":case"stalled":case"user-invalid":case"user-valid":case"volume-locked":case"-webkit-autofill":{if(d){const t=`Unsupported pseudo-class :${a}`;throw new DOMException(t,c.NOT_SUPPORTED_ERR)}break}default:if(a.startsWith("-webkit-")){if(d){const t=`Unsupported pseudo-class :${a}`;throw new DOMException(t,c.NOT_SUPPORTED_ERR)}}else if(!b){const t=`Unknown pseudo-class :${a}`;throw new DOMException(t,c.SYNTAX_ERR)}}return s}_matchShadowHostPseudoClass(l,e){const{children:n,name:r}=l;let a;if(Array.isArray(n)){const{branches:f}=(0,k.walkAST)(n[0]),[o]=f,[...b]=o,{host:d}=e;if(r==="host"){let s;for(const t of b){const{type:i}=t;if(i===c.COMBINATOR){const m=`Invalid selector ${(0,k.generateCSS)(l)}`;throw new DOMException(m,c.SYNTAX_ERR)}if(s=this._matchSelector(t,d).has(d),!s)break}s&&(a=e)}else if(r==="host-context"){let s=d,t;for(;s;){for(const i of b){const{type:h}=i;if(h===c.COMBINATOR){const u=`Invalid selector ${(0,k.generateCSS)(l)}`;throw new DOMException(u,c.SYNTAX_ERR)}if(t=this._matchSelector(i,s).has(s),!t)break}if(t)break;s=s.parentNode}t&&(a=e)}}else if(r==="host")a=e;else{const f=`Invalid selector :${r}`;throw new DOMException(f,c.SYNTAX_ERR)}return a??null}_matchSelector(l,e,n){const{type:r}=l,a=new Set;if(l.name===c.EMPTY)return a;const f=(0,k.unescapeSelector)(l.name);if(typeof f=="string"&&f!==l.name&&(l.name=f),e.nodeType===c.ELEMENT_NODE)switch(r){case c.SELECTOR_PSEUDO_ELEMENT:{O.matcher.matchPseudoElementSelector(f,n);break}case c.SELECTOR_ID:{e.id===f&&a.add(e);break}case c.SELECTOR_CLASS:{e.classList.contains(f)&&a.add(e);break}case c.SELECTOR_PSEUDO_CLASS:return this._matchPseudoClassSelector(l,e,n);default:{const o=O.matcher.matchSelector(l,e,n);o&&a.add(o)}}else if(this.#u&&r===c.SELECTOR_PSEUDO_CLASS&&e.nodeType===c.DOCUMENT_FRAGMENT_NODE){if(f!=="has"&&c.REG_LOGICAL_PSEUDO.test(f))return this._matchPseudoClassSelector(l,e,n);if(c.REG_SHADOW_HOST.test(f)){const o=this._matchShadowHostPseudoClass(l,e,n);o&&a.add(o)}}return a}_matchLeaves(l,e,n){const{attributes:r,localName:a,nodeType:f}=e;let o=this.#w.get(l),b;if(o&&o.has(e)){const{attr:d,matched:s}=o.get(e);r?.length===d&&(b=s)}if(typeof b!="boolean"){let d;f===c.ELEMENT_NODE&&c.REG_FORM.test(a)?d=!1:d=!0;for(const s of l){const{name:t,type:i}=s;if(i===c.SELECTOR_PSEUDO_CLASS&&t==="dir"&&(d=!1),b=this._matchSelector(s,e,n).has(e),!b)break}d&&(o||(o=new WeakMap),o.set(e,{attr:r?.length,matched:b}),this.#w.set(l,o))}return!!b}_matchHTMLCollection(l,e={}){const{compound:n,filterLeaves:r}=e,a=new Set,f=l.length;if(f)if(n)for(let o=0;o<f;o++){const b=l[o];this._matchLeaves(r,b,e)&&a.add(b)}else{const o=[].slice.call(l);return new Set(o)}return a}_findDescendantNodes(l,e,n){const[r,...a]=l,f=a.length>0,{type:o}=r,b=(0,k.unescapeSelector)(r.name);typeof b=="string"&&b!==r.name&&(r.name=b);let d=new Set,s=!1;if(this.#u)s=!0;else switch(o){case c.SELECTOR_PSEUDO_ELEMENT:{O.matcher.matchPseudoElementSelector(b,n);break}case c.SELECTOR_ID:{if(this.#s.nodeType===c.ELEMENT_NODE)s=!0;else{const t=this.#s.getElementById(b);t&&t!==e&&e.contains(t)&&(f?this._matchLeaves(a,t,n)&&d.add(t):d.add(t))}break}case c.SELECTOR_CLASS:{const t=e.getElementsByClassName(b);d=this._matchHTMLCollection(t,{compound:f,filterLeaves:a});break}case c.SELECTOR_TYPE:{if(this.#t.contentType==="text/html"&&!/[*|]/.test(b)){const t=e.getElementsByTagName(b);d=this._matchHTMLCollection(t,{compound:f,filterLeaves:a})}else s=!0;break}default:s=!0}return{nodes:d,pending:s}}_matchCombinator(l,e,n={}){const{combo:r,leaves:a}=l,{name:f}=r,{parentNode:o}=e,{dir:b}=n,d=new Set;if(b===v)switch(f){case"+":{const s=e.nextElementSibling;s&&this._matchLeaves(a,s,n)&&d.add(s);break}case"~":{if(o){const s=this._createTreeWalker(o);let t=this._traverse(e,s);for(t=s.nextSibling();t;)this._matchLeaves(a,t,n)&&d.add(t),t=s.nextSibling()}break}case">":{const s=this._createTreeWalker(e);let t=this._traverse(e,s);for(t=s.firstChild();t;)this._matchLeaves(a,t,n)&&d.add(t),t=s.nextSibling();break}case" ":default:{const{nodes:s,pending:t}=this._findDescendantNodes(a,e);if(s.size)return s;if(t){const i=this._createTreeWalker(e);let h=this._traverse(e,i);for(h=i.nextNode();h&&e.contains(h);)this._matchLeaves(a,h,n)&&d.add(h),h=i.nextNode()}}}else switch(f){case"+":{const s=e.previousElementSibling;s&&this._matchLeaves(a,s,n)&&d.add(s);break}case"~":{if(o){const s=this._createTreeWalker(o);let t=this._traverse(o,s);for(t=s.firstChild();t&&t!==e;)this._matchLeaves(a,t,n)&&d.add(t),t=s.nextSibling()}break}case">":{o&&this._matchLeaves(a,o,n)&&d.add(o);break}case" ":default:{const s=[];let t=o;for(;t;)this._matchLeaves(a,t,n)&&s.push(t),t=t.parentNode;if(s.length)return new Set(s.reverse())}}return d}_findNode(l,e){const{node:n}=e;let r=this._traverse(n,this.#o),a;if(r)for(r.nodeType!==c.ELEMENT_NODE?r=this.#o.nextNode():r===n&&r!==this.#s&&(r=this.#o.nextNode());r;){if(this._matchLeaves(l,r,{warn:this.#i})){a=r;break}r=this.#o.nextNode()}return a??null}_matchSelf(l){const e=[],n=this._matchLeaves(l,this.#e,{warn:this.#i});let r=!1;return n&&(e.push(this.#e),r=!0),[e,r]}_findLineal(l,e={}){const{complex:n}=e,r=[];let a=this._matchLeaves(l,this.#e,{warn:this.#i}),f=!1;if(a&&(r.push(this.#e),f=!0),!a||n){let o=this.#e.parentNode;for(;o&&(a=this._matchLeaves(l,o,{warn:this.#i}),a&&(r.push(o),f=!0),o.parentNode);)o=o.parentNode}return[r,f]}_findFirst(l){const e=[],n=this._findNode(l,{node:this.#e});let r=!1;return n&&(e.push(n),r=!0),[e,r]}_findFromHTMLCollection(l,e={}){const{complex:n,compound:r,filterLeaves:a,targetType:f}=e;let o=[],b=!1,d=!1;const s=l.length;if(s)if(this.#e.nodeType===c.ELEMENT_NODE)for(let t=0;t<s;t++){const i=l[t];if(i!==this.#e&&(this.#e.contains(i)||i.contains(this.#e))){if(r){if(this._matchLeaves(a,i,{warn:this.#i})&&(o.push(i),b=!0,f===g))break}else if(o.push(i),b=!0,f===g)break}}else if(n)if(r)for(let t=0;t<s;t++){const i=l[t];if(this._matchLeaves(a,i,{warn:this.#i})&&(o.push(i),b=!0,f===g))break}else o=[].slice.call(l),b=!0,d=!0;else if(r)for(let t=0;t<s;t++){const i=l[t];if(this._matchLeaves(a,i,{warn:this.#i})&&(o.push(i),b=!0,f===g))break}else o=[].slice.call(l),b=!0,d=!0;return[o,b,d]}_findEntryNodes(l,e,n){const{leaves:r}=l,[a,...f]=r,o=f.length>0,{name:b,type:d}=a;let s=[],t=!1,i=!1,h=!1;switch(d){case c.SELECTOR_PSEUDO_ELEMENT:{O.matcher.matchPseudoElementSelector(b,{warn:this.#i});break}case c.SELECTOR_ID:{if(e===R)[s,i]=this._matchSelf(r);else if(e===C)[s,i]=this._findLineal(r,{complex:n});else if(e===g&&this.#s.nodeType!==c.ELEMENT_NODE){const m=this.#s.getElementById(b);m&&(o?this._matchLeaves(f,m,{warn:this.#i})&&(s.push(m),i=!0):(s.push(m),i=!0))}else e===g?[s,i]=this._findFirst(r):h=!0;break}case c.SELECTOR_CLASS:{if(e===R)[s,i]=this._matchSelf(r);else if(e===C)[s,i]=this._findLineal(r,{complex:n});else if(this.#s.nodeType===c.DOCUMENT_NODE){const m=this.#s.getElementsByClassName(b);m.length&&([s,i,t]=this._findFromHTMLCollection(m,{complex:n,compound:o,filterLeaves:f,targetType:e}))}else e===g?[s,i]=this._findFirst(r):h=!0;break}case c.SELECTOR_TYPE:{if(e===R)[s,i]=this._matchSelf(r);else if(e===C)[s,i]=this._findLineal(r,{complex:n});else if(this.#t.contentType==="text/html"&&this.#s.nodeType===c.DOCUMENT_NODE&&!/[*|]/.test(b)){const m=this.#s.getElementsByTagName(b);m.length&&([s,i,t]=this._findFromHTMLCollection(m,{complex:n,compound:o,filterLeaves:f,targetType:e}))}else e===g?[s,i]=this._findFirst(r):h=!0;break}default:if(e!==C&&c.REG_SHADOW_HOST.test(b)){if(this.#u&&this.#e.nodeType===c.DOCUMENT_FRAGMENT_NODE){const m=this._matchShadowHostPseudoClass(a,this.#e);m&&(s.push(m),i=!0)}}else e===R?[s,i]=this._matchSelf(r):e===C?[s,i]=this._findLineal(r,{complex:n}):e===g?[s,i]=this._findFirst(r):h=!0}return{collected:t,compound:o,filtered:i,nodes:s,pending:h}}_collectNodes(l){const e=this.#a.values();if(l===L||l===g){const n=new Set;let r=0;for(const{branch:a}of e){const f=a.length,o=f>1,b=a[0];let d,s;if(o){const{combo:p,leaves:[{name:_,type:w}]}=b,N=a[f-1],{leaves:[{name:A,type:E}]}=N;if(E===c.SELECTOR_PSEUDO_ELEMENT||E===c.SELECTOR_ID)d=x,s=N;else if(w===c.SELECTOR_PSEUDO_ELEMENT||w===c.SELECTOR_ID)d=v,s=b;else if(l===L)if(_==="*"&&w===c.SELECTOR_TYPE)d=x,s=N;else if(A==="*"&&E===c.SELECTOR_TYPE)d=v,s=b;else if(f===2){const{name:T}=p;/^[+~]$/.test(T)?(d=x,s=N):(d=v,s=b)}else d=v,s=b;else if(A==="*"&&E===c.SELECTOR_TYPE)d=v,s=b;else if(_==="*"&&w===c.SELECTOR_TYPE)d=x,s=N;else{let T;for(const{combo:D,leaves:[G]}of a){const{name:z,type:F}=G;if(F===c.SELECTOR_PSEUDO_CLASS&&z==="dir"){T=!1;break}if(!T&&D){const{name:H}=D;/^[+~]$/.test(H)&&(T=!0)}}T?(d=v,s=b):(d=x,s=N)}}else d=x,s=b;const{collected:t,compound:i,filtered:h,nodes:m,pending:u}=this._findEntryNodes(s,l,o);m.length?(this.#a[r].find=!0,this.#b[r]=m):u&&n.add(new Map([["index",r],["twig",s]])),this.#a[r].collected=t,this.#a[r].dir=d,this.#a[r].filtered=h||!i,r++}if(n.size){let a,f;this.#e!==this.#s&&this.#e.nodeType===c.ELEMENT_NODE?(a=this.#e,f=this.#o):(a=this.#s,f=this.#n);let o=this._traverse(a,f);for(;o;){let b=!1;if(this.#e.nodeType===c.ELEMENT_NODE?o===this.#e?b=!0:b=this.#e.contains(o):b=!0,b)for(const d of n){const{leaves:s}=d.get("twig");if(this._matchLeaves(s,o,{warn:this.#i})){const i=d.get("index");this.#a[i].filtered=!0,this.#a[i].find=!0,this.#b[i].push(o)}}o!==f.currentNode&&(o=this._traverse(o,f)),o=f.nextNode()}}}else{let n=0;for(const{branch:r}of e){const a=r[r.length-1],f=r.length>1,{compound:o,filtered:b,nodes:d}=this._findEntryNodes(a,l,f);d.length&&(this.#a[n].find=!0,this.#b[n]=d),this.#a[n].dir=x,this.#a[n].filtered=b||!o,n++}}return[this.#a,this.#b]}_getCombinedNodes(l,e,n){const r=[];for(const a of e){const f=this._matchCombinator(l,a,{dir:n,warn:this.#i});f.size&&r.push(...f)}return r.length?new Set(r):new Set}_matchNodeNext(l,e,n){const{combo:r,index:a}=n,{combo:f,leaves:o}=l[a],b={combo:r,leaves:o},d=this._getCombinedNodes(b,e,v);let s;if(d.size)if(a===l.length-1){const[t]=(0,S.sortNodes)(d);s=t}else s=this._matchNodeNext(l,d,{combo:f,index:a+1});return s??null}_matchNodePrev(l,e,n){const{index:r}=n,a=l[r],f=new Set([e]),o=this._getCombinedNodes(a,f,x);let b;if(o.size){if(r===0)b=e;else for(const d of o)if(this._matchNodePrev(l,d,{index:r-1}))return e}return b??null}_find(l){(l===L||l===g)&&this._prepareQuerySelectorWalker();const[[...e],n]=this._collectNodes(l),r=e.length;let a=new Set;for(let f=0;f<r;f++){const{branch:o,collected:b,dir:d,find:s}=e[f],t=o.length;if(t&&s){const i=n[f],h=i.length,m=t-1;if(m===0)if((l===L||l===g)&&this.#e.nodeType===c.ELEMENT_NODE)for(let u=0;u<h;u++){const p=i[u];if(p!==this.#e&&this.#e.contains(p)&&(a.add(p),l!==L))break}else if(l===L)if(a.size){const u=[...a];a=new Set([...u,...i]),this.#m=!0}else a=new Set(i);else{const[u]=i;a.add(u)}else if(l===L)if(d===v){let{combo:u}=o[0];for(const p of i){let _=new Set([p]);for(let w=1;w<t;w++){const{combo:N,leaves:A}=o[w],E={combo:u,leaves:A};if(_=this._getCombinedNodes(E,_,d),_.size)if(w===m)if(a.size){const T=[...a];a=new Set([...T,..._]),this.#m=!0}else a=_;else u=N;else break}}}else for(const u of i){let p=new Set([u]);for(let _=m-1;_>=0;_--){const w=o[_];if(p=this._getCombinedNodes(w,p,d),p.size)_===0&&(a.add(u),t>1&&a.size>1&&(this.#m=!0));else break}}else if(l===g&&d===v){const{combo:u}=o[0];let p;for(const _ of i)if(p=this._matchNodeNext(o,new Set([_]),{combo:u,index:1}),p){a.add(p);break}if(!p&&!b){const{leaves:_}=o[0],[w]=i;let N=this._findNode(_,{node:w});for(;N;){if(p=this._matchNodeNext(o,new Set([N]),{combo:u,index:1}),p){a.add(p);break}N=this._findNode(_,{node:N})}}}else{let u;for(const p of i)if(u=this._matchNodePrev(o,p,{index:m-1}),u){a.add(p);break}if(!u&&!b&&l===g){const{leaves:p}=o[m],[_]=i;let w=this._findNode(p,{node:_});for(;w;){if(u=this._matchNodePrev(o,w,{index:m-1}),u){a.add(w);break}w=this._findNode(p,{node:w})}}}}}return a}matches(l,e,n){let r;try{if(e?.nodeType!==c.ELEMENT_NODE){const a=`Unexpected node ${e?.nodeName}`;throw new TypeError(a)}(0,k.filterSelector)(l,{complex:this.#c,descendant:!0})?r=this.#f.match(l,e):(this._setup(l,e,n),r=this._find(R).size)}catch(a){this._onError(a)}return!!r}closest(l,e,n){let r;try{if(e?.nodeType!==c.ELEMENT_NODE){const a=`Unexpected node ${e?.nodeName}`;throw new TypeError(a)}if((0,k.filterSelector)(l,{complex:this.#c,descendant:!0}))r=this.#f.closest(l,e);else{this._setup(l,e,n);const a=this._find(C);if(a.size){let f=this.#e;for(;f;){if(a.has(f)){r=f;break}f=f.parentNode}}}}catch(a){this._onError(a)}return r??null}querySelector(l,e,n){let r;try{if(this._setup(l,e,n),this.#d===this.#t&&!this.#h&&(0,k.filterSelector)(l,{complex:this.#c,descendant:!1}))r=this.#f.first(l,e);else{const a=this._find(g);a.delete(this.#e),a.size&&([r]=(0,S.sortNodes)(a))}}catch(a){this._onError(a)}return r??null}querySelectorAll(l,e,n){let r;try{if(this._setup(l,e,n),this.#d===this.#t&&!this.#h&&(0,k.filterSelector)(l,{complex:this.#c,descendant:!1}))r=this.#f.select(l,e);else{const a=this._find(L);a.delete(this.#e),a.size&&(this.#m?r=(0,S.sortNodes)(a):r=[...a])}}catch(a){this._onError(a)}return r??[]}}0&&(module.exports={Finder});
//# sourceMappingURL=finder.js.map
