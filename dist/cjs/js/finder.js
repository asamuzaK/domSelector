var A=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var H=Object.getOwnPropertyNames;var z=Object.prototype.hasOwnProperty;var B=(x,n)=>{for(var e in n)A(x,e,{get:n[e],enumerable:!0})},Y=(x,n,e,o)=>{if(n&&typeof n=="object"||typeof n=="function")for(let r of H(n))!z.call(x,r)&&r!==e&&A(x,r,{get:()=>n[r],enumerable:!(o=G(n,r))||o.enumerable});return x};var j=x=>Y(A({},"__esModule",{value:!0}),x);var Z={};B(Z,{Finder:()=>J});module.exports=j(Z);var P=require("./matcher.js"),g=require("./parser.js"),_=require("./utility.js"),c=require("./constant.js");const v="next",S="prev",V="Tab",R=/^a(?:rea)?$/,K=/^(?:button|fieldset|input|optgroup|option|select|textarea)$/,O=/^(?:button|form|input|select|textarea)$/,q=/^(?:details|dialog)$/,M=/^host(?:-context)?$/,C=/^(?:checkbox|radio)$/,X=/^(?:date(?:time-local)?|month|number|range|time|week)$/,I=/^(?:button|reset)$/,$=/^(?:image|submit)$/,Q=/^(?:email|number|password|search|tel|text|url)$/;class J{#l;#r;#w;#t;#f;#n;#k;#c;#b;#h;#e;#d;#g;#m;#_;#s;#u;#N;#o;#p;#i;#a;constructor(n){this.#a=n,this.#h=new P.Matcher,this.#r=new WeakMap,this.#f=new WeakMap,this.#b=new WeakMap,this.#_=new WeakMap,this.#n=null,this.#k=null,this._registerEventListeners()}onError(n,e){if(!(e?.noexcept??this.#g))if(n instanceof DOMException||n instanceof this.#a.DOMException)if(n.name===c.NOT_SUPPORTED_ERR)this.#i&&console.warn(n.message);else throw new this.#a.DOMException(n.message,n.name);else throw n.name in this.#a?new this.#a[n.name](n.message):n}setup(n,e,o={}){const{event:r,noexcept:a,warn:l}=o;return this.#g=!!a,this.#i=!!l,this.#e=e,[this.#t,this.#s,this.#o]=(0,_.resolveContent)(e),this.#u=(0,_.isInShadowTree)(e),[this.#l,this.#d]=this._correspond(n),this.#b=new WeakMap,this.#p=new WeakMap,this.#N=null,this._setEvent(r),this}_registerEventListeners(){const n={capture:!0,passive:!0},e=[],o=["mouseover","mousedown","mouseup","mouseout"];for(const a of o)e.push(this.#a.addEventListener(a,l=>{this.#n=l},n));const r=["keydown","keyup"];for(const a of r)e.push(this.#a.addEventListener(a,l=>{l.key===V&&(this.#n=l)},n));return e.push(this.#a.addEventListener("focusin",a=>{this.#k=a},n)),e}_setEvent(n){return(n instanceof this.#a.KeyboardEvent||n instanceof this.#a.MouseEvent)&&(this.#n=n),this.#n}_correspond(n){const e=[];this.#w=!1,this.#c=!1;let o;if(this.#f.has(this.#t)){const r=this.#f.get(this.#t);if(r&&r.has(`${n}`)){const a=r.get(`${n}`);o=a.ast,this.#w=a.descendant,this.#c=a.invalidate}}if(o){const r=o.length;for(let a=0;a<r;a++)o[a].collected=!1,o[a].dir=null,o[a].filtered=!1,o[a].find=!1,e[a]=[]}else{let r;try{r=(0,g.parseSelector)(n)}catch(b){this.onError(b)}const{branches:a,info:l}=(0,g.walkAST)(r),{hasHasPseudoFunc:f,hasLogicalPseudoFunc:u,hasNthChildOfSelector:d}=l;let i=f||!!(u&&d),t=!1,s=0;o=[];for(const[...b]of a){const p=[];let m=b.shift();if(m&&m.type!==c.COMBINATOR){const w=new Set;for(;m;){if(m.type===c.COMBINATOR){const[k]=b;if(k.type===c.COMBINATOR)throw new DOMException(`Invalid selector ${n}`,c.SYNTAX_ERR);const N=m.name;/^[\s>]$/.test(N)?t=!0:i=!0,p.push({combo:m,leaves:(0,g.sortAST)(w)}),w.clear()}else if(m){let{name:k}=m;k&&typeof k=="string"&&(k=(0,g.unescapeSelector)(k),typeof k=="string"&&k!==m.name&&(m.name=k),/[|:]/.test(k)&&(m.namespace=!0)),w.add(m)}if(b.length)m=b.shift();else{p.push({combo:null,leaves:(0,g.sortAST)(w)}),w.clear();break}}}o.push({branch:p,collected:!1,dir:null,filtered:!1,find:!1}),e[s]=[],s++}let h;this.#f.has(this.#t)?h=this.#f.get(this.#t):h=new Map,h.set(`${n}`,{ast:o,descendant:t,invalidate:i}),this.#f.set(this.#t,h),this.#w=t,this.#c=i}return[o,e]}_createTreeWalker(n){let e;return this.#p.has(n)?e=this.#p.get(n):(e=this.#t.createTreeWalker(n,c.WALKER_FILTER),this.#p.set(n,e)),e}_prepareQuerySelectorWalker(){return this.#m=this._createTreeWalker(this.#e),this.#m}_collectNthChild(n,e,o){const{a:r,b:a,reverse:l,selector:f}=n,{parentNode:u}=e,d=new Set;let i;if(f){if(this.#r.has(f))i=this.#r.get(f);else{const{branches:s}=(0,g.walkAST)(f);i=s,this.#c||this.#r.set(f,i)}const{branches:t}=(0,g.walkAST)(f);i=t}if(u){const t=this.#o;let s=(0,_.traverseNode)(u,t);s=t.firstChild();let h=0;for(;s;)h++,s=t.nextSibling();const b=new Set;if(i)for(s=(0,_.traverseNode)(u,t),s=t.firstChild();s;){if((0,_.isVisible)(s)){let p;for(const m of i)if(p=this._matchLeaves(m,s,o),!p)break;p&&b.add(s)}s=t.nextSibling()}if(r===0){if(a>0&&a<=h){if(b.size){s=(0,_.traverseNode)(u,t),l?s=t.lastChild():s=t.firstChild();let p=0;for(;s;){if(b.has(s)){if(p===a-1){d.add(s);break}p++}l?s=t.previousSibling():s=t.nextSibling()}}else if(!f){s=(0,_.traverseNode)(u,t),l?s=t.lastChild():s=t.firstChild();let p=0;for(;s;){if(p===a-1){d.add(s);break}l?s=t.previousSibling():s=t.nextSibling(),p++}}}}else{let p=a-1;if(r>0)for(;p<0;)p+=r;if(p>=0&&p<h){s=(0,_.traverseNode)(u,t),l?s=t.lastChild():s=t.firstChild();let m=0,w=r>0?0:a-1;for(;s&&(s&&p>=0&&p<h);)b.size?b.has(s)&&(w===p&&(d.add(s),p+=r),r>0?w++:w--):m===p&&(f||d.add(s),p+=r),l?s=t.previousSibling():s=t.nextSibling(),m++}}if(l&&d.size>1){const p=[...d];return new Set(p.reverse())}}else if(e===this.#s&&r+a===1)if(i){let t;for(const s of i)if(t=this._matchLeaves(s,e,o),t)break;t&&d.add(e)}else d.add(e);return d}_collectNthOfType(n,e){const{a:o,b:r,reverse:a}=n,{localName:l,namespaceURI:f,parentNode:u,prefix:d}=e,i=new Set;if(u){const t=this.#o;let s=(0,_.traverseNode)(u,t);s=t.firstChild();let h=0;for(;s;)h++,s=t.nextSibling();if(o===0){if(r>0&&r<=h){s=(0,_.traverseNode)(u,t),a?s=t.lastChild():s=t.firstChild();let b=0;for(;s;){const{localName:p,namespaceURI:m,prefix:w}=s;if(p===l&&w===d&&m===f){if(b===r-1){i.add(s);break}b++}a?s=t.previousSibling():s=t.nextSibling()}}}else{let b=r-1;if(o>0)for(;b<0;)b+=o;if(b>=0&&b<h){s=(0,_.traverseNode)(u,t),a?s=t.lastChild():s=t.firstChild();let p=o>0?0:r-1;for(;s;){const{localName:m,namespaceURI:w,prefix:k}=s;if(m===l&&k===d&&w===f){if(p===b&&(i.add(s),b+=o),b<0||b>=h)break;o>0?p++:p--}a?s=t.previousSibling():s=t.nextSibling()}}}if(a&&i.size>1){const b=[...i];return new Set(b.reverse())}}else e===this.#s&&o+r===1&&i.add(e);return i}_matchAnPlusB(n,e,o,r){const{nth:{a,b:l,name:f},selector:u}=n,d=new Map;if(f?(f==="even"?(d.set("a",2),d.set("b",0)):f==="odd"&&(d.set("a",2),d.set("b",1)),o.indexOf("last")>-1&&d.set("reverse",!0)):(typeof a=="string"&&/-?\d+/.test(a)?d.set("a",a*1):d.set("a",0),typeof l=="string"&&/-?\d+/.test(l)?d.set("b",l*1):d.set("b",0),o.indexOf("last")>-1&&d.set("reverse",!0)),/^nth-(?:last-)?child$/.test(o)){u&&d.set("selector",u);const i=Object.fromEntries(d);return this._collectNthChild(i,e,r)}else if(/^nth-(?:last-)?of-type$/.test(o)){const i=Object.fromEntries(d);return this._collectNthOfType(i,e)}return new Set}_matchHasPseudoFunc(n,e,o){let r;if(Array.isArray(n)&&n.length){const a=n.map(s=>s),[l]=a,{type:f}=l;let u;f===c.COMBINATOR?u=a.shift():u={name:" ",type:c.COMBINATOR};const d=[];for(;a.length;){const[s]=a,{type:h}=s;if(h===c.COMBINATOR)break;d.push(a.shift())}const i={combo:u,leaves:d};o.dir=v;const t=this._matchCombinator(i,e,o);if(t.size)if(a.length){for(const s of t)if(r=this._matchHasPseudoFunc(a,s,o),r)break}else r=!0}return!!r}_matchLogicalPseudoFunc(n,e,o){const{astName:r,branches:a,twigBranches:l}=n,{isShadowRoot:f}=o;let u;if(r==="has"){let d;for(const i of a)if(d=this._matchHasPseudoFunc(i,e,o),d)break;d&&(f?this.#N&&(u=e):u=e)}else{if(f){for(const s of a)if(s.length>1)return null}const d=/^(?:is|where)$/.test(r);o.forgive=d;const i=l.length;let t;for(let s=0;s<i;s++){const h=l[s],b=h.length-1,{leaves:p}=h[b];if(t=this._matchLeaves(p,e,o),t&&b>0){let m=new Set([e]);for(let w=b-1;w>=0;w--){const k=h[w],N=[];o.dir=S;for(const E of m){const y=this._matchCombinator(k,E,o);y.size&&N.push(...y)}if(N.length)w===0?t=!0:m=new Set(N);else{t=!1;break}}}if(t)break}r==="not"?t||(u=e):t&&(u=e)}return u??null}_matchPseudoClassSelector(n,e,o){const{children:r,name:a}=n,{localName:l,parentNode:f}=e,{forgive:u,warn:d=this.#i}=o,i=new Set;if(c.REG_LOGICAL.test(a)){let t;if(this.#r.has(n))t=this.#r.get(n);else{const{branches:h}=(0,g.walkAST)(n);if(a==="has"){for(const b of r){const p=(0,g.findAST)(b,m=>c.REG_LOGICAL.test(m.name)&&(0,g.findAST)(m,w=>w.name==="has")?m:null);if(p){if(/^(?:is|where)$/.test(p.name))return i;{const m=(0,g.generateCSS)(n);throw new DOMException(`Invalid selector ${m}`,c.SYNTAX_ERR)}}}t={astName:a,branches:h}}else{const b=[];for(const[...p]of h){const m=[],w=new Set;let k=p.shift();for(;k;)if(k.type===c.COMBINATOR?(m.push({combo:k,leaves:[...w]}),w.clear()):k&&w.add(k),p.length)k=p.shift();else{m.push({combo:null,leaves:[...w]}),w.clear();break}b.push(m)}t={astName:a,branches:h,twigBranches:b},this.#c||this.#r.set(n,t)}}const s=this._matchLogicalPseudoFunc(t,e,o);s&&i.add(s)}else if(Array.isArray(r))if(/^nth-(?:last-)?(?:child|of-type)$/.test(a)){const[t]=r;return this._matchAnPlusB(t,e,a,o)}else switch(a){case"dir":case"lang":{const t=this.#h.matchSelector(n,e,o,!0);t&&i.add(t);break}case"state":{if((0,_.isCustomElement)(e)){const[{value:t}]=r;if(t)if(e[t])i.add(e);else for(const s in e){const h=e[s];if(h instanceof this.#a.ElementInternals){h?.states?.has(t)&&i.add(e);break}}}break}case"current":case"nth-col":case"nth-last-col":{if(d)throw new DOMException(`Unsupported pseudo-class :${a}()`,c.NOT_SUPPORTED_ERR);break}case"host":case"host-context":break;case"contains":{if(d)throw new DOMException(`Unknown pseudo-class :${a}()`,c.NOT_SUPPORTED_ERR);break}default:if(!u)throw new DOMException(`Unknown pseudo-class :${a}()`,c.SYNTAX_ERR)}else switch(a){case"any-link":case"link":{R.test(l)&&e.hasAttribute("href")&&i.add(e);break}case"local-link":{if(R.test(l)&&e.hasAttribute("href")){const{href:t,origin:s,pathname:h}=new URL(this.#t.URL),b=new URL(e.getAttribute("href"),t);b.origin===s&&b.pathname===h&&i.add(e)}break}case"visited":break;case"hover":{const{target:t,type:s}=this.#n??{};/^(?:mouse|pointer)(?:down|over|up)$/.test(s)&&e.contains(t)&&i.add(e);break}case"active":{const{buttons:t,target:s,type:h}=this.#n??{};/(?:mouse|pointer)down/.test(h)&&t&c.BIT_01&&e.contains(s)&&i.add(e);break}case"target":{const{hash:t}=new URL(this.#t.URL);e.id&&t===`#${e.id}`&&this.#t.contains(e)&&i.add(e);break}case"target-within":{const{hash:t}=new URL(this.#t.URL);if(t){const s=t.replace(/^#/,"");let h=this.#t.getElementById(s);for(;h;){if(h===e){i.add(e);break}h=h.parentNode}}break}case"scope":{this.#e.nodeType===c.ELEMENT_NODE?!this.#u&&e===this.#e&&i.add(e):e===this.#t.documentElement&&i.add(e);break}case"focus":{e===this.#t.activeElement&&e.tabIndex>=0&&(0,_.isFocusable)(e)&&i.add(e);break}case"focus-visible":{if(e===this.#t.activeElement&&e.tabIndex>=0){let t;if((0,_.isFocusVisible)(e))t=!0;else{const{target:s,type:h}=this.#n??{},{target:b,relatedTarget:p}=this.#k??{};(/^key(?:down|up)$/.test(h)&&e.contains(s)||p&&(0,_.isFocusVisible)(p)&&e.contains(b))&&(t=!0)}t&&(0,_.isFocusable)(e)&&i.add(e)}break}case"focus-within":{let t,s=this.#t.activeElement;if(s.tabIndex>=0)for(;s;){if(s===e){t=!0;break}s=s.parentNode}t&&(0,_.isFocusable)(e)&&i.add(e);break}case"open":case"closed":{q.test(l)&&(e.hasAttribute("open")?a==="open"&&i.add(e):a==="closed"&&i.add(e));break}case"disabled":case"enabled":{if(K.test(l)||(0,_.isCustomElement)(e,{formAssociated:!0})){let t;if(e.disabled||e.hasAttribute("disabled"))t=!0;else if(e.localName==="option")f.localName==="optgroup"&&(f.disabled||f.hasAttribute("disabled"))&&(t=!0);else if(e.localName!=="optgroup"){let s=f;for(;s;)if(s.localName==="fieldset"&&(s.disabled||s.hasAttribute("disabled"))){const h=this.#o;let b=(0,_.traverseNode)(s,h);for(b=h.firstChild();b&&b.localName!=="legend";)b=h.nextSibling();b&&b.contains(e)||(t=!0);break}else{if(s.localName==="form")break;if(s.parentNode?.nodeType===c.ELEMENT_NODE){if(s.parentNode.localName==="form")break;s=s.parentNode}else break}}t?a==="disabled"&&i.add(e):a==="enabled"&&i.add(e)}break}case"read-only":case"read-write":{let t,s;switch(l){case"textarea":{e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled")?t=!0:s=!0;break}case"input":{(!e.type||c.REG_INPUT_TYPE.test(e.type))&&(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled")?t=!0:s=!0);break}default:(0,_.isContentEditable)(e)?s=!0:t=!0}t?a==="read-only"&&i.add(e):a==="read-write"&&s&&i.add(e);break}case"placeholder-shown":{let t;if(e.placeholder?t=e.placeholder:e.hasAttribute("placeholder")&&(t=e.getAttribute("placeholder")),typeof t=="string"&&!/[\r\n]/.test(t)){let s;l==="textarea"?s=e:l==="input"&&(e.hasAttribute("type")?Q.test(e.getAttribute("type"))&&(s=e):s=e),s&&e.value===""&&i.add(e)}break}case"checked":{(e.checked&&l==="input"&&e.hasAttribute("type")&&C.test(e.getAttribute("type"))||e.selected&&l==="option")&&i.add(e);break}case"indeterminate":{if(e.indeterminate&&l==="input"&&e.type==="checkbox"||l==="progress"&&!e.hasAttribute("value"))i.add(e);else if(l==="input"&&e.type==="radio"&&!e.hasAttribute("checked")){const t=e.name;let s=e.parentNode;for(;s&&s.localName!=="form";)s=s.parentNode;s||(s=this.#t.documentElement);const h=s.getElementsByTagName("input"),b=h.length;let p;for(let m=0;m<b;m++){const w=h[m];if(w.getAttribute("type")==="radio"&&(t?w.getAttribute("name")===t&&(p=!!w.checked):w.hasAttribute("name")||(p=!!w.checked),p))break}p||i.add(e)}break}case"default":{if(l==="button"&&!(e.hasAttribute("type")&&I.test(e.getAttribute("type")))||l==="input"&&e.hasAttribute("type")&&$.test(e.getAttribute("type"))){let t=e.parentNode;for(;t&&t.localName!=="form";)t=t.parentNode;if(t){const s=this.#o;let h=(0,_.traverseNode)(t,s);for(h=s.firstChild();h&&t.contains(h);){const b=h.localName;let p;if(b==="button"?p=!(h.hasAttribute("type")&&I.test(h.getAttribute("type"))):b==="input"&&(p=h.hasAttribute("type")&&$.test(h.getAttribute("type"))),p){h===e&&i.add(e);break}h=s.nextNode()}}}else(l==="input"&&e.hasAttribute("type")&&C.test(e.getAttribute("type"))&&e.hasAttribute("checked")||l==="option"&&e.hasAttribute("selected"))&&i.add(e);break}case"valid":case"invalid":{if(O.test(l)){let t;e.checkValidity()&&(e.maxLength>=0?e.maxLength>=e.value.length&&(t=!0):t=!0),t?a==="valid"&&i.add(e):a==="invalid"&&i.add(e)}else if(l==="fieldset"){const t=this.#o;let s=(0,_.traverseNode)(e,t);s=t.firstChild();let h;if(!s)h=!0;else for(;s&&e.contains(s)&&!(O.test(s.localName)&&(s.checkValidity()?s.maxLength>=0?h=s.maxLength>=s.value.length:h=!0:h=!1,!h));)s=t.nextNode();h?a==="valid"&&i.add(e):a==="invalid"&&i.add(e)}break}case"in-range":case"out-of-range":{if(l==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&X.test(e.getAttribute("type"))){let t;!(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&(e.hasAttribute("min")||e.hasAttribute("max")||e.getAttribute("type")==="range")&&(t=!0),t?a==="in-range"&&i.add(e):a==="out-of-range"&&i.add(e)}break}case"required":case"optional":{let t;if(/^(?:select|textarea)$/.test(l))t=e;else if(l==="input")if(e.hasAttribute("type")){const s=e.getAttribute("type");(s==="file"||C.test(s)||c.REG_INPUT_TYPE.test(s))&&(t=e)}else t=e;t&&(e.required||e.hasAttribute("required")?a==="required"&&i.add(e):a==="optional"&&i.add(e));break}case"root":{e===this.#t.documentElement&&i.add(e);break}case"empty":{if(e.hasChildNodes()){const t=this.#t.createTreeWalker(e,c.SHOW_ALL);let s=t.firstChild(),h;for(;s&&(h=s.nodeType!==c.ELEMENT_NODE&&s.nodeType!==c.TEXT_NODE,!!h);)s=t.nextSibling();h&&i.add(e)}else i.add(e);break}case"first-child":{(f&&e===f.firstElementChild||e===this.#s)&&i.add(e);break}case"last-child":{(f&&e===f.lastElementChild||e===this.#s)&&i.add(e);break}case"only-child":{(f&&e===f.firstElementChild&&e===f.lastElementChild||e===this.#s)&&i.add(e);break}case"first-of-type":{if(f){const[t]=this._collectNthOfType({a:0,b:1},e);t&&i.add(t)}else e===this.#s&&i.add(e);break}case"last-of-type":{if(f){const[t]=this._collectNthOfType({a:0,b:1,reverse:!0},e);t&&i.add(t)}else e===this.#s&&i.add(e);break}case"only-of-type":{if(f){const[t]=this._collectNthOfType({a:0,b:1},e);if(t===e){const[s]=this._collectNthOfType({a:0,b:1,reverse:!0},e);s===e&&i.add(e)}}else e===this.#s&&i.add(e);break}case"defined":{e.hasAttribute("is")||l.includes("-")?(0,_.isCustomElement)(e)&&i.add(e):(e instanceof this.#a.HTMLElement||e instanceof this.#a.SVGElement)&&i.add(e);break}case"popover-open":{e.popover&&(0,_.isVisible)(e)&&i.add(e);break}case"host":case"host-context":break;case"after":case"before":case"first-letter":case"first-line":{if(d)throw new DOMException(`Unsupported pseudo-element ::${a}`,c.NOT_SUPPORTED_ERR);break}case"autofill":case"blank":case"buffering":case"current":case"fullscreen":case"future":case"modal":case"muted":case"past":case"paused":case"picture-in-picture":case"playing":case"seeking":case"stalled":case"user-invalid":case"user-valid":case"volume-locked":case"-webkit-autofill":{if(d)throw new DOMException(`Unsupported pseudo-class :${a}`,c.NOT_SUPPORTED_ERR);break}default:if(a.startsWith("-webkit-")){if(d)throw new DOMException(`Unsupported pseudo-class :${a}`,c.NOT_SUPPORTED_ERR)}else if(!u)throw new DOMException(`Unknown pseudo-class :${a}`,c.SYNTAX_ERR)}return i}_matchShadowHostPseudoClass(n,e){const{children:o,name:r}=n;let a;if(Array.isArray(o)){const{branches:l}=(0,g.walkAST)(o[0]),[f]=l,[...u]=f,{host:d}=e;if(r==="host"){let i;for(const t of u){const{type:s}=t;if(s===c.COMBINATOR){const h=(0,g.generateCSS)(n);throw new DOMException(`Invalid selector ${h}`,c.SYNTAX_ERR)}if(i=this._matchSelector(t,d).has(d),!i)break}i&&(a=e)}else if(r==="host-context"){let i=d,t;for(;i;){for(const s of u){const{type:h}=s;if(h===c.COMBINATOR){const b=(0,g.generateCSS)(n);throw new DOMException(`Invalid selector ${b}`,c.SYNTAX_ERR)}if(t=this._matchSelector(s,i).has(i),!t)break}if(t)break;i=i.parentNode}t&&(a=e)}}else if(r==="host")a=e;else throw new DOMException(`Invalid selector :${r}`,c.SYNTAX_ERR);return a??null}_matchSelector(n,e,o={}){const{type:r}=n,a=new Set;if(n.name===c.EMPTY)return a;const l=(0,g.unescapeSelector)(n.name);if(typeof l=="string"&&l!==n.name&&(n.name=l),e.nodeType===c.ELEMENT_NODE)switch(r){case c.PS_ELEMENT_SELECTOR:{this.#h.matchPseudoElementSelector(l,o);break}case c.ID_SELECTOR:{e.id===l&&a.add(e);break}case c.CLASS_SELECTOR:{e.classList.contains(l)&&a.add(e);break}case c.PS_CLASS_SELECTOR:return this._matchPseudoClassSelector(n,e,o);default:{const f=this.#h.matchSelector(n,e,o,!0);f&&a.add(f)}}else if(this.#u&&r===c.PS_CLASS_SELECTOR&&e.nodeType===c.DOCUMENT_FRAGMENT_NODE){if(c.REG_LOGICAL.test(l))return o.isShadowRoot=!0,this._matchPseudoClassSelector(n,e,o);if(M.test(l)){const f=this._matchShadowHostPseudoClass(n,e,o);f&&(this.#N=!0,a.add(f))}}return a}_matchLeaves(n,e,o){let r,a;if(this.#c?a=this.#b.get(n):a=this.#_.get(n),a&&a.has(e)){const{matched:l}=a.get(e);r=l}if(typeof r!="boolean"){let l=!0;e.nodeType===c.ELEMENT_NODE&&/^(?:button|fieldset|form|input|select|textarea)$/.test(e.localName)&&(l=!1);for(const f of n){switch(f.type){case c.ATTR_SELECTOR:case c.ID_SELECTOR:{l=!1;break}case c.PS_CLASS_SELECTOR:{/^(?:(?:any-)?link|defined|dir)$/.test(f.name)&&(l=!1);break}default:}if(r=this._matchSelector(f,e,o).has(e),!r)break}l&&(a||(a=new WeakMap),a.set(e,{matched:r}),this.#c?this.#b.set(n,a):this.#_.set(n,a))}return!!r}_matchHTMLCollection(n,e){const{compound:o,filterLeaves:r}=e,a=new Set,l=n.length;if(l)if(o)for(let f=0;f<l;f++){const u=n[f];this._matchLeaves(r,u,e)&&a.add(u)}else{const f=[].slice.call(n);return new Set(f)}return a}_findDescendantNodes(n,e,o){const[r,...a]=n,l=a.length>0,{type:f}=r,u=(0,g.unescapeSelector)(r.name);typeof u=="string"&&u!==r.name&&(r.name=u);let d=new Set,i=!1;if(this.#u)i=!0;else switch(f){case c.PS_ELEMENT_SELECTOR:{this.#h.matchPseudoElementSelector(u,o);break}case c.ID_SELECTOR:{if(this.#s.nodeType===c.ELEMENT_NODE)i=!0;else{const t=this.#s.getElementById(u);t&&t!==e&&e.contains(t)&&(l?this._matchLeaves(a,t,o)&&d.add(t):d.add(t))}break}case c.CLASS_SELECTOR:{const t=e.getElementsByClassName(u);d=this._matchHTMLCollection(t,{compound:l,filterLeaves:a});break}case c.TYPE_SELECTOR:{if(this.#t.contentType==="text/html"&&!/[*|]/.test(u)){const t=e.getElementsByTagName(u);d=this._matchHTMLCollection(t,{compound:l,filterLeaves:a})}else i=!0;break}default:i=!0}return{nodes:d,pending:i}}_matchCombinator(n,e,o){const{combo:r,leaves:a}=n,{name:l}=r,{parentNode:f}=e,{dir:u}=o,d=new Set;if(u===v)switch(l){case"+":{const i=e.nextElementSibling;i&&this._matchLeaves(a,i,o)&&d.add(i);break}case"~":{if(f){const i=this._createTreeWalker(f);let t=(0,_.traverseNode)(e,i);for(t=i.nextSibling();t;)this._matchLeaves(a,t,o)&&d.add(t),t=i.nextSibling()}break}case">":{const i=this._createTreeWalker(e);let t=(0,_.traverseNode)(e,i);for(t=i.firstChild();t;)this._matchLeaves(a,t,o)&&d.add(t),t=i.nextSibling();break}case" ":default:{const{nodes:i,pending:t}=this._findDescendantNodes(a,e);if(i.size)return i;if(t){const s=this._createTreeWalker(e);let h=(0,_.traverseNode)(e,s);for(h=s.nextNode();h&&e.contains(h);)this._matchLeaves(a,h,o)&&d.add(h),h=s.nextNode()}}}else switch(l){case"+":{const i=e.previousElementSibling;i&&this._matchLeaves(a,i,o)&&d.add(i);break}case"~":{if(f){const i=this._createTreeWalker(f);let t=(0,_.traverseNode)(f,i);for(t=i.firstChild();t&&t!==e;)this._matchLeaves(a,t,o)&&d.add(t),t=i.nextSibling()}break}case">":{f&&this._matchLeaves(a,f,o)&&d.add(f);break}case" ":default:{const i=[];let t=f;for(;t;)this._matchLeaves(a,t,o)&&i.push(t),t=t.parentNode;if(i.length)return new Set(i.reverse())}}return d}_findNode(n,e){const o=this.#m;let r=(0,_.traverseNode)(e,o),a;if(r)for((r.nodeType!==c.ELEMENT_NODE||r===e&&r!==this.#s)&&(r=o.nextNode());r;){if(this._matchLeaves(n,r,{warn:this.#i})){a=r;break}r=o.nextNode()}return a??null}_matchSelf(n){const e=[],o=this._matchLeaves(n,this.#e,{warn:this.#i});let r=!1;return o&&(e.push(this.#e),r=!0),[e,r]}_findLineal(n,e){const{complex:o}=e,r=[];let a=this._matchLeaves(n,this.#e,{warn:this.#i}),l=!1;if(a&&(r.push(this.#e),l=!0),!a||o){let f=this.#e.parentNode;for(;f&&(a=this._matchLeaves(n,f,{warn:this.#i}),a&&(r.push(f),l=!0),f.parentNode);)f=f.parentNode}return[r,l]}_findFirst(n){const e=[],o=this._findNode(n,this.#e);let r=!1;return o&&(e.push(o),r=!0),[e,r]}_findFromHTMLCollection(n,e){const{complex:o,compound:r,filterLeaves:a,targetType:l}=e;let f=[],u=!1,d=!1;const i=n.length;if(i)if(this.#e.nodeType===c.ELEMENT_NODE)for(let t=0;t<i;t++){const s=n[t];if(s!==this.#e&&(this.#e.contains(s)||s.contains(this.#e))){if(r){if(this._matchLeaves(a,s,{warn:this.#i})&&(f.push(s),u=!0,l===c.TARGET_FIRST))break}else if(f.push(s),u=!0,l===c.TARGET_FIRST)break}}else if(o)if(r)for(let t=0;t<i;t++){const s=n[t];if(this._matchLeaves(a,s,{warn:this.#i})&&(f.push(s),u=!0,l===c.TARGET_FIRST))break}else f=[].slice.call(n),u=!0,d=!0;else if(r)for(let t=0;t<i;t++){const s=n[t];if(this._matchLeaves(a,s,{warn:this.#i})&&(f.push(s),u=!0,l===c.TARGET_FIRST))break}else f=[].slice.call(n),u=!0,d=!0;return[f,u,d]}_findEntryNodes(n,e,o){const{leaves:r}=n,[a,...l]=r,f=l.length>0,{name:u,type:d}=a;let i=[],t=!1,s=!1,h=!1;switch(d){case c.PS_ELEMENT_SELECTOR:{this.#h.matchPseudoElementSelector(u,{warn:this.#i});break}case c.ID_SELECTOR:{if(e===c.TARGET_SELF)[i,s]=this._matchSelf(r);else if(e===c.TARGET_LINEAL)[i,s]=this._findLineal(r,{complex:o});else if(e===c.TARGET_FIRST&&this.#s.nodeType!==c.ELEMENT_NODE){const b=this.#s.getElementById(u);b&&(f?this._matchLeaves(l,b,{warn:this.#i})&&(i.push(b),s=!0):(i.push(b),s=!0))}else e===c.TARGET_FIRST?[i,s]=this._findFirst(r):h=!0;break}case c.CLASS_SELECTOR:{if(e===c.TARGET_SELF)[i,s]=this._matchSelf(r);else if(e===c.TARGET_LINEAL)[i,s]=this._findLineal(r,{complex:o});else if(this.#s.nodeType===c.DOCUMENT_NODE){const b=this.#s.getElementsByClassName(u);b.length&&([i,s,t]=this._findFromHTMLCollection(b,{complex:o,compound:f,filterLeaves:l,targetType:e}))}else e===c.TARGET_FIRST?[i,s]=this._findFirst(r):h=!0;break}case c.TYPE_SELECTOR:{if(e===c.TARGET_SELF)[i,s]=this._matchSelf(r);else if(e===c.TARGET_LINEAL)[i,s]=this._findLineal(r,{complex:o});else if(this.#t.contentType==="text/html"&&this.#s.nodeType===c.DOCUMENT_NODE&&!/[*|]/.test(u)){const b=this.#s.getElementsByTagName(u);b.length&&([i,s,t]=this._findFromHTMLCollection(b,{complex:o,compound:f,filterLeaves:l,targetType:e}))}else e===c.TARGET_FIRST?[i,s]=this._findFirst(r):h=!0;break}default:if(e!==c.TARGET_LINEAL&&M.test(u)){if(this.#u&&this.#e.nodeType===c.DOCUMENT_FRAGMENT_NODE){const b=this._matchShadowHostPseudoClass(a,this.#e);b&&(i.push(b),s=!0)}}else e===c.TARGET_SELF?[i,s]=this._matchSelf(r):e===c.TARGET_LINEAL?[i,s]=this._findLineal(r,{complex:o}):e===c.TARGET_FIRST?[i,s]=this._findFirst(r):h=!0}return{collected:t,compound:f,filtered:s,nodes:i,pending:h}}_collectNodes(n){const e=this.#l.values();if(n===c.TARGET_ALL||n===c.TARGET_FIRST){const o=new Set;let r=0;for(const{branch:a}of e){const l=a.length,f=l>1,u=a[0];let d,i;if(f){const{combo:m,leaves:[{name:w,type:k}]}=u,N=a[l-1],{leaves:[{name:E,type:y}]}=N;if(y===c.PS_ELEMENT_SELECTOR||y===c.ID_SELECTOR)d=S,i=N;else if(k===c.PS_ELEMENT_SELECTOR||k===c.ID_SELECTOR)d=v,i=u;else if(n===c.TARGET_ALL)if(w==="*"&&k===c.TYPE_SELECTOR)d=S,i=N;else if(E==="*"&&y===c.TYPE_SELECTOR)d=v,i=u;else if(l===2){const{name:L}=m;/^[+~]$/.test(L)?(d=S,i=N):(d=v,i=u)}else d=v,i=u;else if(E==="*"&&y===c.TYPE_SELECTOR)d=v,i=u;else if(w==="*"&&k===c.TYPE_SELECTOR)d=S,i=N;else{let L;for(const{combo:T,leaves:[D]}of a){const{name:U,type:F}=D;if(F===c.PS_CLASS_SELECTOR&&U==="dir"){L=!1;break}if(!L&&T){const{name:W}=T;/^[+~]$/.test(W)&&(L=!0)}}L?(d=v,i=u):(d=S,i=N)}}else d=S,i=u;const{collected:t,compound:s,filtered:h,nodes:b,pending:p}=this._findEntryNodes(i,n,f);b.length?(this.#l[r].find=!0,this.#d[r]=b):p&&o.add(new Map([["index",r],["twig",i]])),this.#l[r].collected=t,this.#l[r].dir=d,this.#l[r].filtered=h||!s,r++}if(o.size){let a,l;this.#e!==this.#s&&this.#e.nodeType===c.ELEMENT_NODE?(a=this.#e,l=this.#m):(a=this.#s,l=this.#o);let f=(0,_.traverseNode)(a,l);for(;f;){let u=!1;if(this.#e.nodeType===c.ELEMENT_NODE?f===this.#e?u=!0:u=this.#e.contains(f):u=!0,u)for(const d of o){const{leaves:i}=d.get("twig");if(this._matchLeaves(i,f,{warn:this.#i})){const s=d.get("index");this.#l[s].filtered=!0,this.#l[s].find=!0,this.#d[s].push(f)}}f!==l.currentNode&&(f=(0,_.traverseNode)(f,l)),f=l.nextNode()}}}else{let o=0;for(const{branch:r}of e){const a=r[r.length-1],l=r.length>1,{compound:f,filtered:u,nodes:d}=this._findEntryNodes(a,n,l);d.length&&(this.#l[o].find=!0,this.#d[o]=d),this.#l[o].dir=S,this.#l[o].filtered=u||!f,o++}}return[this.#l,this.#d]}_getCombinedNodes(n,e,o){const r=[];for(const a of e){const l=this._matchCombinator(n,a,{dir:o,warn:this.#i});l.size&&r.push(...l)}return r.length?new Set(r):new Set}_matchNodeNext(n,e,o){const{combo:r,index:a}=o,{combo:l,leaves:f}=n[a],u={combo:r,leaves:f},d=this._getCombinedNodes(u,e,v);let i;if(d.size)if(a===n.length-1){const[t]=(0,_.sortNodes)(d);i=t}else i=this._matchNodeNext(n,d,{combo:l,index:a+1});return i??null}_matchNodePrev(n,e,o){const{index:r}=o,a=n[r],l=new Set([e]),f=this._getCombinedNodes(a,l,S);let u;if(f.size){if(r===0)u=e;else for(const d of f)if(this._matchNodePrev(n,d,{index:r-1}))return e}return u??null}find(n){(n===c.TARGET_ALL||n===c.TARGET_FIRST)&&this._prepareQuerySelectorWalker();const[[...e],o]=this._collectNodes(n),r=e.length;let a,l=new Set;for(let f=0;f<r;f++){const{branch:u,collected:d,dir:i,find:t}=e[f],s=u.length;if(s&&t){const h=o[f],b=h.length,p=s-1;if(p===0)if((n===c.TARGET_ALL||n===c.TARGET_FIRST)&&this.#e.nodeType===c.ELEMENT_NODE)for(let m=0;m<b;m++){const w=h[m];if(w!==this.#e&&this.#e.contains(w)&&(l.add(w),n!==c.TARGET_ALL))break}else if(n===c.TARGET_ALL)if(l.size){const m=[...l];l=new Set([...m,...h]),a=!0}else l=new Set(h);else{const[m]=h;l.add(m)}else if(n===c.TARGET_ALL)if(i===v){let{combo:m}=u[0];for(const w of h){let k=new Set([w]);for(let N=1;N<s;N++){const{combo:E,leaves:y}=u[N],L={combo:m,leaves:y};if(k=this._getCombinedNodes(L,k,i),k.size)if(N===p)if(l.size){const T=[...l];l=new Set([...T,...k]),a=!0}else l=k;else m=E;else break}}}else for(const m of h){let w=new Set([m]);for(let k=p-1;k>=0;k--){const N=u[k];if(w=this._getCombinedNodes(N,w,i),w.size)k===0&&(l.add(m),s>1&&l.size>1&&(a=!0));else break}}else if(n===c.TARGET_FIRST&&i===v){const{combo:m}=u[0];let w;for(const k of h)if(w=this._matchNodeNext(u,new Set([k]),{combo:m,index:1}),w){l.add(w);break}if(!w&&!d){const{leaves:k}=u[0],[N]=h;let E=this._findNode(k,N);for(;E;){if(w=this._matchNodeNext(u,new Set([E]),{combo:m,index:1}),w){l.add(w);break}E=this._findNode(k,E)}}}else{let m;for(const w of h)if(m=this._matchNodePrev(u,w,{index:p-1}),m){l.add(w);break}if(!m&&!d&&n===c.TARGET_FIRST){const{leaves:w}=u[p],[k]=h;let N=this._findNode(w,k);for(;N;){if(m=this._matchNodePrev(u,N,{index:p-1}),m){l.add(N);break}N=this._findNode(w,N)}}}}}return n===c.TARGET_FIRST?(l.delete(this.#e),l.size>1&&(l=new Set((0,_.sortNodes)(l)))):n===c.TARGET_ALL&&(l.delete(this.#e),a&&l.size>1&&(l=new Set((0,_.sortNodes)(l)))),l}}0&&(module.exports={Finder});
//# sourceMappingURL=finder.js.map
