var z=Object.create;var M=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var F=Object.getPrototypeOf,j=Object.prototype.hasOwnProperty;var H=(T,a)=>{for(var e in a)M(T,e,{get:a[e],enumerable:!0})},U=(T,a,e,o)=>{if(a&&typeof a=="object"||typeof a=="function")for(let n of B(a))!j.call(T,n)&&n!==e&&M(T,n,{get:()=>a[n],enumerable:!(o=W(a,n))||o.enumerable});return T};var V=(T,a,e)=>(e=T!=null?z(F(T)):{},U(a||!T||!T.__esModule?M(e,"default",{value:T,enumerable:!0}):e,T)),G=T=>U(M({},"__esModule",{value:!0}),T);var X={};H(X,{Matcher:()=>q});module.exports=G(X);var I=V(require("is-potential-custom-element-name"),1),E=require("./dom-util.js"),v=require("./parser.js"),i=require("./constant.js");const C="next",$="prev",A="all",L="first",O="lineal",P="self";class q{#i;#f;#r;#s;#l;#e;#o;#t;#c;#n;#a;constructor(a,e,o={}){const{warn:n}=o;this.#f=new Map([[i.SELECTOR_PSEUDO_ELEMENT,i.BIT_01],[i.SELECTOR_ID,i.BIT_02],[i.SELECTOR_CLASS,i.BIT_04],[i.SELECTOR_TYPE,i.BIT_08],[i.SELECTOR_ATTR,i.BIT_16],[i.SELECTOR_PSEUDO_CLASS,i.BIT_32]]),this.#r=new WeakMap,[this.#i,this.#o]=this._prepare(a),this.#e=e,[this.#s,this.#t,this.#n]=this._setup(e),this.#c=(0,E.isInShadowTree)(e),this.#a=!!n}_onError(a){if(a instanceof DOMException&&a.name===i.NOT_SUPPORTED_ERR)this.#a&&console.warn(a.message);else throw a}_setup(a){let e,o;switch(a.nodeType){case i.DOCUMENT_NODE:{e=a,o=a;break}case i.DOCUMENT_FRAGMENT_NODE:{e=a.ownerDocument,o=a;break}case i.ELEMENT_NODE:{if(a.ownerDocument.contains(a))e=a.ownerDocument,o=a.ownerDocument;else{let b=a;for(;b&&b.parentNode;)b=b.parentNode;e=b.ownerDocument,o=b}break}default:throw new TypeError(`Unexpected node ${a.nodeName}`)}const n=i.SHOW_DOCUMENT|i.SHOW_DOCUMENT_FRAGMENT|i.SHOW_ELEMENT,s=e.createTreeWalker(o,n);return[e,o,s]}_sortLeaves(a){let e=[...a];if(e.length>1&&(e.sort((o,n)=>{const{type:s}=o,{type:b}=n,d=this.#f.get(s),f=this.#f.get(b);let t;return d===f?t=0:d>f?t=1:t=-1,t}),e.length>2)){const o=e.shift(),n=e.reverse();e=[o,...n]}return e}_prepare(a){const e=(0,v.parseSelector)(a),o=(0,v.walkAST)(e),n=[],s=[];let b=0;for(const[...d]of o){const f=[];let t=d.shift();if(t&&t.type!==i.COMBINATOR){const r=new Set;for(;t;){if(t.type===i.COMBINATOR){const[l]=d;if(l.type===i.COMBINATOR){const c=`Invalid combinator ${t.name}${l.name}`;throw new DOMException(c,i.SYNTAX_ERR)}f.push({combo:t,leaves:this._sortLeaves(r)}),r.clear()}else t&&r.add(t);if(d.length)t=d.shift();else{f.push({combo:null,leaves:this._sortLeaves(r)}),r.clear();break}}}n.push({branch:f,filtered:!1,find:null,skip:!1}),s[b]=new Set,b++}return[n,s]}_traverse(a={},e=this.#n){let o,n=e.currentNode;if(a.nodeType===i.ELEMENT_NODE&&n===a)o=n;else{if(n!==e.root)for(;n&&!(n===e.root||a.nodeType===i.ELEMENT_NODE&&n===a);)n=e.parentNode();if(a.nodeType===i.ELEMENT_NODE)for(;n;){if(n===a){o=n;break}n=e.nextNode()}else o=n}return o??null}_collectNthChild(a,e){const{a:o,b:n,reverse:s,selector:b}=a,{parentNode:d}=e;let f=new Set,t;if(b&&(this.#r.has(b)?t=this.#r.get(b):(t=(0,v.walkAST)(b),this.#r.set(b,t))),d){const r=i.SHOW_DOCUMENT|i.SHOW_DOCUMENT_FRAGMENT|i.SHOW_ELEMENT,l=this.#s.createTreeWalker(d,r);let c=0,h=l.firstChild();for(;h;)c++,h=l.nextSibling();h=this._traverse(d,l);const u=new Set;if(t)for(h=this._traverse(d,l),h=l.firstChild();h;){let m;for(const k of t)if(m=this._matchLeaves(k,h),!m)break;m&&u.add(h),h=l.nextSibling()}if(o===0){if(n>0&&n<=c){if(u.size){let m=0;for(h=this._traverse(d,l),s?h=l.lastChild():h=l.firstChild();h;){if(u.has(h)){if(m===n-1){f.add(h);break}m++}s?h=l.previousSibling():h=l.nextSibling()}}else if(!b){let m=0;for(h=this._traverse(d,l),s?h=l.lastChild():h=l.firstChild();h;){if(m===n-1){f.add(h);break}s?h=l.previousSibling():h=l.nextSibling(),m++}}}}else{let m=n-1;if(o>0)for(;m<0;)m+=o;if(m>=0&&m<c){let k=0,g=o>0?0:n-1;for(h=this._traverse(d,l),s?h=l.lastChild():h=l.firstChild();h&&(h&&m>=0&&m<c);)u.size?u.has(h)&&(g===m&&(f.add(h),m+=o),o>0?g++:g--):k===m&&(b||f.add(h),m+=o),s?h=l.previousSibling():h=l.nextSibling(),k++}}if(s&&f.size>1){const m=[...f];f=new Set(m.reverse())}}else if(e===this.#t&&this.#t.nodeType===i.ELEMENT_NODE&&o+n===1)if(t){let r;for(const l of t)if(r=this._matchLeaves(l,e),r)break;r&&f.add(e)}else f.add(e);return f}_collectNthOfType(a,e){const{a:o,b:n,reverse:s}=a,{localName:b,parentNode:d,prefix:f}=e;let t=new Set;if(d){const r=i.SHOW_DOCUMENT|i.SHOW_DOCUMENT_FRAGMENT|i.SHOW_ELEMENT,l=this.#s.createTreeWalker(d,r);let c=0,h=l.firstChild();for(;h;)c++,h=l.nextSibling();if(o===0){if(n>0&&n<=c){let u=0;for(h=this._traverse(d,l),s?h=l.lastChild():h=l.firstChild();h;){const{localName:m,prefix:k}=h;if(m===b&&k===f){if(u===n-1){t.add(h);break}u++}s?h=l.previousSibling():h=l.nextSibling()}}}else{let u=n-1;if(o>0)for(;u<0;)u+=o;if(u>=0&&u<c){let m=o>0?0:n-1;for(h=this._traverse(d,l),s?h=l.lastChild():h=l.firstChild();h;){const{localName:k,prefix:g}=h;if(k===b&&g===f){if(m===u&&(t.add(h),u+=o),u<0||u>=c)break;o>0?m++:m--}s?h=l.previousSibling():h=l.nextSibling()}}}if(s&&t.size>1){const u=[...t];t=new Set(u.reverse())}}else e===this.#t&&this.#t.nodeType===i.ELEMENT_NODE&&o+n===1&&t.add(e);return t}_matchAnPlusB(a,e,o){const{nth:{a:n,b:s,name:b},selector:d}=a,f=(0,v.unescapeSelector)(b),t=new Map;f?(f==="even"?(t.set("a",2),t.set("b",0)):f==="odd"&&(t.set("a",2),t.set("b",1)),o.indexOf("last")>-1&&t.set("reverse",!0)):(typeof n=="string"&&/-?\d+/.test(n)?t.set("a",n*1):t.set("a",0),typeof s=="string"&&/-?\d+/.test(s)?t.set("b",s*1):t.set("b",0),o.indexOf("last")>-1&&t.set("reverse",!0));let r=new Set;if(t.has("a")&&t.has("b")){if(/^nth-(?:last-)?child$/.test(o)){d&&t.set("selector",d);const l=Object.fromEntries(t),c=this._collectNthChild(l,e);c.size&&(r=c)}else if(/^nth-(?:last-)?of-type$/.test(o)){const l=Object.fromEntries(t),c=this._collectNthOfType(l,e);c.size&&(r=c)}}return r}_matchPseudoElementSelector(a,e={}){const{forgive:o}=e;switch(a){case"after":case"backdrop":case"before":case"cue":case"cue-region":case"first-letter":case"first-line":case"file-selector-button":case"marker":case"placeholder":case"selection":case"target-text":{if(this.#a)throw new DOMException(`Unsupported pseudo-element ::${a}`,i.NOT_SUPPORTED_ERR);break}case"part":case"slotted":{if(this.#a)throw new DOMException(`Unsupported pseudo-element ::${a}()`,i.NOT_SUPPORTED_ERR);break}default:if(a.startsWith("-webkit-")){if(this.#a)throw new DOMException(`Unsupported pseudo-element ::${a}`,i.NOT_SUPPORTED_ERR)}else if(!o)throw new DOMException(`Unknown pseudo-element ::${a}`,i.SYNTAX_ERR)}}_matchDirectionPseudoClass(a,e){const o=(0,v.unescapeSelector)(a.name),n=(0,E.getDirectionality)(e);let s;return o===n&&(s=e),s??null}_matchLanguagePseudoClass(a,e){const o=(0,v.unescapeSelector)(a.name);let n;if(o==="*")if(e.hasAttribute("lang"))e.getAttribute("lang")&&(n=e);else{let s=e.parentNode;for(;s&&s.nodeType===i.ELEMENT_NODE;){if(s.hasAttribute("lang")){s.getAttribute("lang")&&(n=e);break}s=s.parentNode}}else if(o){const s=`(?:-${i.ALPHA_NUM})*`;if(new RegExp(`^(?:\\*-)?${i.ALPHA_NUM}${s}$`,"i").test(o)){let d;if(o.indexOf("-")>-1){const[f,t,...r]=o.split("-");let l;f==="*"?l=`${i.ALPHA_NUM}${s}`:l=`${f}${s}`;const c=`-${t}${s}`,h=r.length;let u="";if(h)for(let m=0;m<h;m++)u+=`-${r[m]}${s}`;d=new RegExp(`^${l}${c}${u}$`,"i")}else d=new RegExp(`^${o}${s}$`,"i");if(e.hasAttribute("lang"))d.test(e.getAttribute("lang"))&&(n=e);else{let f=e.parentNode;for(;f&&f.nodeType===i.ELEMENT_NODE;){if(f.hasAttribute("lang")){const t=f.getAttribute("lang");d.test(t)&&(n=e);break}f=f.parentNode}}}}return n??null}_matchHasPseudoFunc(a,e){let o;if(Array.isArray(a)&&a.length){const[n]=a,{type:s}=n;let b;s===i.COMBINATOR?b=a.shift():b={name:" ",type:i.COMBINATOR};const d=[];for(;a.length;){const[r]=a,{type:l}=r;if(l===i.COMBINATOR)break;d.push(a.shift())}const f={combo:b,leaves:d},t=this._matchCombinator(f,e,{find:C});if(t.size)if(a.length){for(const r of t)if(o=this._matchHasPseudoFunc(Object.assign([],a),r),o)break}else o=!0}return!!o}_matchLogicalPseudoFunc(a,e){const{astName:o="",branches:n=[],selector:s="",twigBranches:b=[]}=a;let d;if(o==="has")if(s.includes(":has("))d=null;else{let f;for(const t of n)if(f=this._matchHasPseudoFunc(Object.assign([],t),e),f)break;f&&(d=e)}else{const f=/^(?:is|where)$/.test(o),t=b.length;let r;for(let l=0;l<t;l++){const c=b[l],h=c.length-1,{leaves:u}=c[h];if(r=this._matchLeaves(u,e,{forgive:f}),r&&h>0){let m=new Set([e]);for(let k=h-1;k>=0;k--){const g=c[k],p=[];for(const w of m){const N=this._matchCombinator(g,w,{forgive:f,find:$});N.size&&p.push(...N)}if(p.length)k===0?r=!0:m=new Set(p);else{r=!1;break}}}if(r)break}o==="not"?r||(d=e):r&&(d=e)}return d??null}_matchPseudoClassSelector(a,e,o={}){const{children:n}=a,{localName:s,parentNode:b}=e,{forgive:d}=o,f=(0,v.unescapeSelector)(a.name);let t=new Set;if(i.REG_LOGICAL_PSEUDO.test(f)){let r;if(this.#r.has(a))r=this.#r.get(a);else{const c=(0,v.walkAST)(a),h=[],u=[];for(const[...m]of c){for(const w of m){const N=(0,v.generateCSS)(w);h.push(N)}const k=[],g=new Set;let p=m.shift();for(;p;)if(p.type===i.COMBINATOR?(k.push({combo:p,leaves:[...g]}),g.clear()):p&&g.add(p),m.length)p=m.shift();else{k.push({combo:null,leaves:[...g]}),g.clear();break}u.push(k)}r={astName:f,branches:c,twigBranches:u,selector:h.join(",")},this.#r.set(a,r)}const l=this._matchLogicalPseudoFunc(r,e);l&&t.add(l)}else if(Array.isArray(n)){const[r]=n;if(/^nth-(?:last-)?(?:child|of-type)$/.test(f)){const l=this._matchAnPlusB(r,e,f);l.size&&(t=l)}else if(f==="dir"){const l=this._matchDirectionPseudoClass(r,e);l&&t.add(l)}else if(f==="lang"){const l=this._matchLanguagePseudoClass(r,e);l&&t.add(l)}else switch(f){case"current":case"nth-col":case"nth-last-col":{if(this.#a)throw new DOMException(`Unsupported pseudo-class :${f}()`,i.NOT_SUPPORTED_ERR);break}case"host":case"host-context":break;default:if(!d)throw new DOMException(`Unknown pseudo-class :${f}()`,i.SYNTAX_ERR)}}else{const r=/^a(?:rea)?$/,l=/^(?:(?:fieldse|inpu|selec)t|button|opt(?:group|ion)|textarea)$/,c=/^(?:(?:inpu|selec)t|button|form|textarea)$/,h=/^d(?:etails|ialog)$/,u=/^(?:checkbox|radio)$/,m=/^(?:date(?:time-local)?|month|time|week)$/,k=/(?:(?:rang|tim)e|date(?:time-local)?|month|number|week)$/,g=/^(?:(?:emai|te|ur)l|number|password|search|text)$/;switch(f){case"any-link":case"link":{r.test(s)&&e.hasAttribute("href")&&t.add(e);break}case"local-link":{if(r.test(s)&&e.hasAttribute("href")){const{href:p,origin:w,pathname:N}=new URL(this.#s.URL),y=new URL(e.getAttribute("href"),p);y.origin===w&&y.pathname===N&&t.add(e)}break}case"visited":break;case"target":{const{hash:p}=new URL(this.#s.URL);e.id&&p===`#${e.id}`&&this.#s.contains(e)&&t.add(e);break}case"target-within":{const{hash:p}=new URL(this.#s.URL);if(p){const w=p.replace(/^#/,"");let N=this.#s.getElementById(w);for(;N;){if(N===e){t.add(e);break}N=N.parentNode}}break}case"scope":{this.#e.nodeType===i.ELEMENT_NODE?e===this.#e&&t.add(e):e===this.#s.documentElement&&t.add(e);break}case"focus":{e===this.#s.activeElement&&t.add(e);break}case"focus-within":{let p=this.#s.activeElement;for(;p;){if(p===e){t.add(e);break}p=p.parentNode}break}case"open":{h.test(s)&&e.hasAttribute("open")&&t.add(e);break}case"closed":{h.test(s)&&!e.hasAttribute("open")&&t.add(e);break}case"disabled":{if(l.test(s)||(0,I.default)(s))if(e.disabled||e.hasAttribute("disabled"))t.add(e);else{let p=b;for(;p&&p.localName!=="fieldset";)p=p.parentNode;p&&b.localName!=="legend"&&p.hasAttribute("disabled")&&t.add(e)}break}case"enabled":{(l.test(s)||(0,I.default)(s))&&!(e.disabled&&e.hasAttribute("disabled"))&&t.add(e);break}case"read-only":{switch(s){case"textarea":{(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}case"input":{(!e.type||m.test(e.type)||g.test(e.type))&&(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}default:(0,E.isContentEditable)(e)||t.add(e)}break}case"read-write":{switch(s){case"textarea":{e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled")||t.add(e);break}case"input":{(!e.type||m.test(e.type)||g.test(e.type))&&!(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}default:(0,E.isContentEditable)(e)&&t.add(e)}break}case"placeholder-shown":{let p;s==="textarea"?p=e:s==="input"&&(e.hasAttribute("type")?g.test(e.getAttribute("type"))&&(p=e):p=e),p&&e.value===""&&e.hasAttribute("placeholder")&&e.getAttribute("placeholder").trim().length&&t.add(e);break}case"checked":{(e.checked&&s==="input"&&e.hasAttribute("type")&&u.test(e.getAttribute("type"))||e.selected&&s==="option")&&t.add(e);break}case"indeterminate":{if(e.indeterminate&&s==="input"&&e.type==="checkbox"||s==="progress"&&!e.hasAttribute("value"))t.add(e);else if(s==="input"&&e.type==="radio"&&!e.hasAttribute("checked")){const p=e.name;let w=e.parentNode;for(;w&&w.localName!=="form";)w=w.parentNode;w||(w=this.#s.documentElement);let N;const y=[].slice.call(w.getElementsByTagName("input"));for(const _ of y)if(_.getAttribute("type")==="radio"&&(p?_.getAttribute("name")===p&&(N=!!_.checked):_.hasAttribute("name")||(N=!!_.checked),N))break;N||t.add(e)}break}case"default":{const p=/^(?:button|reset)$/,w=/^(?:image|submit)$/;if(s==="button"&&!(e.hasAttribute("type")&&p.test(e.getAttribute("type")))||s==="input"&&e.hasAttribute("type")&&w.test(e.getAttribute("type"))){let N=e.parentNode;for(;N&&N.localName!=="form";)N=N.parentNode;if(N){const y=this.#s.createTreeWalker(N,i.SHOW_ELEMENT);let _=y.firstChild();for(;_;){const x=_.localName;let S;if(x==="button"?S=!(_.hasAttribute("type")&&p.test(_.getAttribute("type"))):x==="input"&&(S=_.hasAttribute("type")&&w.test(_.getAttribute("type"))),S){_===e&&t.add(e);break}_=y.nextNode()}}}else if(s==="input"&&e.hasAttribute("type")&&u.test(e.getAttribute("type"))&&(e.checked||e.hasAttribute("checked")))t.add(e);else if(s==="option"){let N=!1,y=b;for(;y&&y.localName!=="datalist";){if(y.localName==="select"){(y.multiple||y.hasAttribute("multiple"))&&(N=!0);break}y=y.parentNode}if(N)(e.selected||e.hasAttribute("selected"))&&t.add(e);else{const _=new Set,x=this.#s.createTreeWalker(b,i.SHOW_ELEMENT);let S=x.firstChild();for(;S;){if(S.selected||S.hasAttribute("selected")){_.add(S);break}S=x.nextSibling()}_.size&&_.has(e)&&t.add(e)}}break}case"valid":{if(c.test(s))e.checkValidity()&&t.add(e);else if(s==="fieldset"){let p;const w=this.#s.createTreeWalker(e,i.SHOW_ELEMENT);let N=w.firstChild();for(;N&&!(c.test(N.localName)&&(p=N.checkValidity(),!p));)N=w.nextNode();p&&t.add(e)}break}case"invalid":{if(c.test(s))e.checkValidity()||t.add(e);else if(s==="fieldset"){let p;const w=this.#s.createTreeWalker(e,i.SHOW_ELEMENT);let N=w.firstChild();for(;N&&!(c.test(N.localName)&&(p=N.checkValidity(),!p));)N=w.nextNode();p||t.add(e)}break}case"in-range":{s==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&k.test(e.getAttribute("type"))&&!(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&(e.hasAttribute("min")||e.hasAttribute("max")||e.getAttribute("type")==="range")&&t.add(e);break}case"out-of-range":{s==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&k.test(e.getAttribute("type"))&&(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&t.add(e);break}case"required":{let p;if(/^(?:select|textarea)$/.test(s))p=e;else if(s==="input")if(e.hasAttribute("type")){const w=e.getAttribute("type");(w==="file"||u.test(w)||m.test(w)||g.test(w))&&(p=e)}else p=e;p&&(e.required||e.hasAttribute("required"))&&t.add(e);break}case"optional":{let p;if(/^(?:select|textarea)$/.test(s))p=e;else if(s==="input")if(e.hasAttribute("type")){const w=e.getAttribute("type");(w==="file"||u.test(w)||m.test(w)||g.test(w))&&(p=e)}else p=e;p&&!(e.required||e.hasAttribute("required"))&&t.add(e);break}case"root":{e===this.#s.documentElement&&t.add(e);break}case"empty":{if(e.hasChildNodes()){let p;const w=this.#s.createTreeWalker(e,i.SHOW_ALL);let N=w.firstChild();for(;N&&(p=N.nodeType!==i.ELEMENT_NODE&&N.nodeType!==i.TEXT_NODE,!!p);)N=w.nextSibling();p&&t.add(e)}else t.add(e);break}case"first-child":{(b&&e===b.firstElementChild||e===this.#t&&this.#t.nodeType===i.ELEMENT_NODE)&&t.add(e);break}case"last-child":{(b&&e===b.lastElementChild||e===this.#t&&this.#t.nodeType===i.ELEMENT_NODE)&&t.add(e);break}case"only-child":{(b&&e===b.firstElementChild&&e===b.lastElementChild||e===this.#t&&this.#t.nodeType===i.ELEMENT_NODE)&&t.add(e);break}case"first-of-type":{if(b){const[p]=this._collectNthOfType({a:0,b:1},e);p&&t.add(p)}else e===this.#t&&this.#t.nodeType===i.ELEMENT_NODE&&t.add(e);break}case"last-of-type":{if(b){const[p]=this._collectNthOfType({a:0,b:1,reverse:!0},e);p&&t.add(p)}else e===this.#t&&this.#t.nodeType===i.ELEMENT_NODE&&t.add(e);break}case"only-of-type":{if(b){const[p]=this._collectNthOfType({a:0,b:1},e);if(p===e){const[w]=this._collectNthOfType({a:0,b:1,reverse:!0},e);w===e&&t.add(e)}}else e===this.#t&&this.#t.nodeType===i.ELEMENT_NODE&&t.add(e);break}case"host":case"host-context":break;case"after":case"before":case"first-letter":case"first-line":{if(this.#a)throw new DOMException(`Unsupported pseudo-element ::${f}`,i.NOT_SUPPORTED_ERR);break}case"active":case"autofill":case"blank":case"buffering":case"current":case"focus-visible":case"fullscreen":case"future":case"hover":case"modal":case"muted":case"past":case"paused":case"picture-in-picture":case"playing":case"seeking":case"stalled":case"user-invalid":case"user-valid":case"volume-locked":case"-webkit-autofill":{if(this.#a)throw new DOMException(`Unsupported pseudo-class :${f}`,i.NOT_SUPPORTED_ERR);break}default:if(f.startsWith("-webkit-")){if(this.#a)throw new DOMException(`Unsupported pseudo-class :${f}`,i.NOT_SUPPORTED_ERR)}else if(!d)throw new DOMException(`Unknown pseudo-class :${f}`,i.SYNTAX_ERR)}}return t}_matchAttributeSelector(a,e){const{flags:o,matcher:n,name:s,value:b}=a;if(typeof o=="string"&&!/^[is]$/i.test(o)){const t=(0,v.generateCSS)(a);throw new DOMException(`Invalid selector ${t}`,i.SYNTAX_ERR)}const{attributes:d}=e;let f;if(d&&d.length){let t;this.#s.contentType==="text/html"?typeof o=="string"&&/^s$/i.test(o)?t=!1:t=!0:typeof o=="string"&&/^i$/i.test(o)?t=!0:t=!1;let r=(0,v.unescapeSelector)(s.name);t&&(r=r.toLowerCase());const l=new Set;if(r.indexOf("|")>-1){const{prefix:c,tagName:h}=(0,E.selectorToNodeProps)(r);for(let{name:u,value:m}of d)switch(t&&(u=u.toLowerCase(),m=m.toLowerCase()),c){case"":{h===u&&l.add(m);break}case"*":{u.indexOf(":")>-1?u.endsWith(`:${h}`)&&l.add(m):h===u&&l.add(m);break}default:if(u.indexOf(":")>-1){const[k,g]=u.split(":");c===k&&h===g&&(0,E.isNamespaceDeclared)(c,e)&&l.add(m)}}}else for(let{name:c,value:h}of d)if(t&&(c=c.toLowerCase(),h=h.toLowerCase()),c.indexOf(":")>-1){const[u,m]=c.split(":");if(u==="xml"&&m==="lang")continue;r===m&&l.add(h)}else r===c&&l.add(h);if(l.size){const{name:c,value:h}=b||{};let u;switch(c?t?u=c.toLowerCase():u=c:h?t?u=h.toLowerCase():u=h:h===""&&(u=h),n){case"=":{typeof u=="string"&&l.has(u)&&(f=e);break}case"~=":{if(u&&typeof u=="string"){for(const m of l)if(new Set(m.split(/\s+/)).has(u)){f=e;break}}break}case"|=":{if(u&&typeof u=="string"){let m;for(const k of l)if(k===u||k.startsWith(`${u}-`)){m=k;break}m&&(f=e)}break}case"^=":{if(u&&typeof u=="string"){let m;for(const k of l)if(k.startsWith(`${u}`)){m=k;break}m&&(f=e)}break}case"$=":{if(u&&typeof u=="string"){let m;for(const k of l)if(k.endsWith(`${u}`)){m=k;break}m&&(f=e)}break}case"*=":{if(u&&typeof u=="string"){let m;for(const k of l)if(k.includes(`${u}`)){m=k;break}m&&(f=e)}break}case null:default:f=e}}}return f??null}_matchClassSelector(a,e){const o=(0,v.unescapeSelector)(a.name);let n;return e.classList.contains(o)&&(n=e),n??null}_matchIDSelector(a,e){const o=(0,v.unescapeSelector)(a.name),{id:n}=e;let s;return o===n&&(s=e),s??null}_matchTypeSelector(a,e,o={}){const n=(0,v.unescapeSelector)(a.name),{localName:s,prefix:b}=e,{forgive:d}=o;let{prefix:f,tagName:t}=(0,E.selectorToNodeProps)(n,e);this.#s.contentType==="text/html"&&(f=f.toLowerCase(),t=t.toLowerCase());let r,l;s.indexOf(":")>-1?[r,l]=s.split(":"):(r=b||"",l=s);let c;if(f===""&&r==="")e.namespaceURI===null&&(t==="*"||t===l)&&(c=e);else if(f==="*")(t==="*"||t===l)&&(c=e);else if(f===r){if((0,E.isNamespaceDeclared)(f,e))(t==="*"||t===l)&&(c=e);else if(!d)throw new DOMException(`Undeclared namespace ${f}`,i.SYNTAX_ERR)}else if(f&&!d&&!(0,E.isNamespaceDeclared)(f,e))throw new DOMException(`Undeclared namespace ${f}`,i.SYNTAX_ERR);return c??null}_matchShadowHostPseudoClass(a,e){const{children:o}=a,n=(0,v.unescapeSelector)(a.name);let s;if(Array.isArray(o)){const[b]=(0,v.walkAST)(o[0]),[...d]=b,{host:f}=e;if(n==="host"){let t;for(const r of d){const{type:l}=r;if(l===i.COMBINATOR){const c=(0,v.generateCSS)(a);throw new DOMException(`Invalid selector ${c}`,i.SYNTAX_ERR)}if(t=this._matchSelector(r,f).has(f),!t)break}t&&(s=e)}else if(n==="host-context"){let t,r=f;for(;r;){for(const l of d){const{type:c}=l;if(c===i.COMBINATOR){const h=(0,v.generateCSS)(a);throw new DOMException(`Invalid selector ${h}`,i.SYNTAX_ERR)}if(t=this._matchSelector(l,r).has(r),!t)break}if(t)break;r=r.parentNode}t&&(s=e)}}else if(n==="host")s=e;else throw new DOMException(`Invalid selector :${n}`,i.SYNTAX_ERR);return s??null}_matchSelector(a,e,o){const{type:n}=a,s=(0,v.unescapeSelector)(a.name);let b=new Set;if(e.nodeType===i.ELEMENT_NODE)switch(n){case i.SELECTOR_ATTR:{const d=this._matchAttributeSelector(a,e);d&&b.add(d);break}case i.SELECTOR_CLASS:{const d=this._matchClassSelector(a,e);d&&b.add(d);break}case i.SELECTOR_ID:{const d=this._matchIDSelector(a,e);d&&b.add(d);break}case i.SELECTOR_PSEUDO_CLASS:{const d=this._matchPseudoClassSelector(a,e,o);d.size&&(b=d);break}case i.SELECTOR_PSEUDO_ELEMENT:{this._matchPseudoElementSelector(s,o);break}case i.SELECTOR_TYPE:default:{const d=this._matchTypeSelector(a,e,o);d&&b.add(d)}}else if(this.#c&&n===i.SELECTOR_PSEUDO_CLASS&&e.nodeType===i.DOCUMENT_FRAGMENT_NODE){if(s!=="has"&&i.REG_LOGICAL_PSEUDO.test(s)){const d=this._matchPseudoClassSelector(a,e,o);d.size&&(b=d)}else if(i.REG_SHADOW_HOST.test(s)){const d=this._matchShadowHostPseudoClass(a,e);d&&b.add(d)}}return b}_matchLeaves(a,e,o){let n;for(const s of a)if(n=this._matchSelector(s,e,o).has(e),!n)break;return!!n}_findDescendantNodes(a,e){const[o,...n]=a,{type:s}=o,b=(0,v.unescapeSelector)(o.name),d=n.length>0;let f=new Set,t=!1;if(this.#c)t=!0;else switch(s){case i.SELECTOR_ID:{if(this.#t.nodeType===i.ELEMENT_NODE)t=!0;else{const r=this.#t.getElementById(b);r&&r!==e&&e.contains(r)&&(d?this._matchLeaves(n,r)&&f.add(r):f.add(r))}break}case i.SELECTOR_CLASS:{const r=[].slice.call(e.getElementsByClassName(b));if(r.length)if(d)for(const l of r)this._matchLeaves(n,l)&&f.add(l);else f=new Set(r);break}case i.SELECTOR_TYPE:{if(this.#s.contentType==="text/html"&&!/[*|]/.test(b)){const r=[].slice.call(e.getElementsByTagName(b));if(r.length)if(d)for(const l of r)this._matchLeaves(n,l)&&f.add(l);else f=new Set(r)}else t=!0;break}case i.SELECTOR_PSEUDO_ELEMENT:{this._matchPseudoElementSelector(b);break}default:t=!0}return{nodes:f,pending:t}}_matchCombinator(a,e,o={}){const{combo:n,leaves:s}=a,{name:b}=n,{find:d,forgive:f}=o;let t=new Set;if(d===C)switch(b){case"+":{const r=e.nextElementSibling;r&&this._matchLeaves(s,r,{forgive:f})&&t.add(r);break}case"~":{const r=this.#s.createTreeWalker(e.parentNode,i.SHOW_ELEMENT);let l=this._traverse(e,r);for(l===e&&(l=r.nextSibling());l;)this._matchLeaves(s,l,{forgive:f})&&t.add(l),l=r.nextSibling();break}case">":{const r=this.#s.createTreeWalker(e,i.SHOW_ELEMENT);let l=r.firstChild();for(;l;)this._matchLeaves(s,l,{forgive:f})&&t.add(l),l=r.nextSibling();break}case" ":default:{const{nodes:r,pending:l}=this._findDescendantNodes(s,e);if(r.size)t=r;else if(l){const c=this.#s.createTreeWalker(e,i.SHOW_ELEMENT);let h=c.nextNode();for(;h;)this._matchLeaves(s,h,{forgive:f})&&t.add(h),h=c.nextNode()}}}else switch(b){case"+":{const r=e.previousElementSibling;r&&this._matchLeaves(s,r,{forgive:f})&&t.add(r);break}case"~":{const r=this.#s.createTreeWalker(e.parentNode,i.SHOW_ELEMENT);let l=r.firstChild();for(;l&&l!==e;)this._matchLeaves(s,l,{forgive:f})&&t.add(l),l=r.nextSibling();break}case">":{const r=e.parentNode;r&&this._matchLeaves(s,r,{forgive:f})&&t.add(r);break}case" ":default:{const r=[];let l=e.parentNode;for(;l;)this._matchLeaves(s,l,{forgive:f})&&r.push(l),l=l.parentNode;r.length&&(t=new Set(r.reverse()))}}return t}_findNode(a,e={}){let{node:o,walker:n}=e;n||(n=this.#n);let s=this._traverse(o,n),b;if(s)for((s.nodeType!==i.ELEMENT_NODE||s===o)&&(s=n.nextNode());s;){let d;if(this.#e.nodeType===i.ELEMENT_NODE?s===this.#e?d=!0:d=this.#e.contains(s):d=!0,d&&this._matchLeaves(a,s)){b=s;break}s=n.nextNode()}return b??null}_findEntryNodes(a,e){const{leaves:o}=a,[n,...s]=o,{type:b}=n,d=(0,v.unescapeSelector)(n.name),f=s.length>0;let t=new Set,r=!1,l=!1;switch(b){case i.SELECTOR_ID:{if(e===P)this._matchLeaves(o,this.#e)&&(t.add(this.#e),r=!0);else if(e===O){let c=this.#e;for(;c;)this._matchLeaves(o,c)&&(t.add(c),r=!0),c=c.parentNode}else if(e===A||this.#t.nodeType===i.ELEMENT_NODE)l=!0;else{const c=this.#t.getElementById(d);c&&(t.add(c),r=!0)}break}case i.SELECTOR_CLASS:{if(e===P)this.#e.nodeType===i.ELEMENT_NODE&&this.#e.classList.contains(d)&&t.add(this.#e);else if(e===O){let c=this.#e;for(;c&&c.nodeType===i.ELEMENT_NODE;)c.classList.contains(d)&&t.add(c),c=c.parentNode}else if(e===L){const c=this._findNode(o,{node:this.#e,walker:this.#l});if(c){t.add(c),r=!0;break}}else if(this.#t.nodeType===i.DOCUMENT_FRAGMENT_NODE)l=!0;else{const c=[].slice.call(this.#t.getElementsByClassName(d));if(this.#e.nodeType===i.ELEMENT_NODE)for(const h of c)(h===this.#e||(0,E.isInclusive)(h,this.#e))&&t.add(h);else c.length&&(t=new Set(c))}break}case i.SELECTOR_TYPE:{if(e===P)this.#e.nodeType===i.ELEMENT_NODE&&this._matchLeaves(o,this.#e)&&(t.add(this.#e),r=!0);else if(e===O){let c=this.#e;for(;c&&c.nodeType===i.ELEMENT_NODE;)this._matchLeaves(o,c)&&(t.add(c),r=!0),c=c.parentNode}else if(e===L){const c=this._findNode(o,{node:this.#e,walker:this.#l});if(c){t.add(c),r=!0;break}}else if(this.#s.contentType!=="text/html"||/[*|]/.test(d))l=!0;else if(this.#t.nodeType===i.DOCUMENT_FRAGMENT_NODE)l=!0;else{const c=[].slice.call(this.#t.getElementsByTagName(d));if(this.#e.nodeType===i.ELEMENT_NODE)for(const h of c)(h===this.#e||(0,E.isInclusive)(h,this.#e))&&t.add(h);else c.length&&(t=new Set(c))}break}case i.SELECTOR_PSEUDO_ELEMENT:{this._matchPseudoElementSelector(d);break}default:if(e!==O&&i.REG_SHADOW_HOST.test(d)){if(this.#c&&this.#e.nodeType===i.DOCUMENT_FRAGMENT_NODE){const c=this._matchShadowHostPseudoClass(n,this.#e);c&&t.add(c)}}else if(e===P)this._matchLeaves(o,this.#e)&&(t.add(this.#e),r=!0);else if(e===O){let c=this.#e;for(;c;)this._matchLeaves(o,c)&&(t.add(c),r=!0),c=c.parentNode}else if(e===L){const c=this._findNode(o,{node:this.#e,walker:this.#l});if(c){t.add(c),r=!0;break}}else l=!0}if(!t.size&&!l&&f){const c=s[s.length-1],{type:h}=c;if(h===i.SELECTOR_PSEUDO_CLASS){let u;this.#t.nodeType===i.ELEMENT_NODE?u=this.#t:u=this.#t.firstElementChild,this._matchPseudoClassSelector(c,u)}}return{compound:f,filtered:r,nodes:t,pending:l}}_getEntryTwig(a,e){const o=a.length,n=o>1,s=a[0];let b,d;if(n){const{combo:f,leaves:[{type:t}]}=s,r=a[o-1],{leaves:[{type:l}]}=r;if(l===i.SELECTOR_PSEUDO_ELEMENT||l===i.SELECTOR_ID)b=$,d=r;else if(t===i.SELECTOR_PSEUDO_ELEMENT||t===i.SELECTOR_ID)b=C,d=s;else if(e===A&&o===i.BIT_02){const{name:c}=f;/^[+~]$/.test(c)?(b=$,d=r):(b=C,d=s)}else if(e===A)b=C,d=s;else{let c;for(const{combo:h,leaves:[u]}of a){const{type:m}=u,k=(0,v.unescapeSelector)(u.name);if(m===i.SELECTOR_PSEUDO_CLASS&&k==="dir"){c=!1;break}if(h){const{name:g}=h;if(/^[+~]$/.test(g)){c=!0;break}}}c?(b=C,d=s):(b=$,d=r)}}else b=$,d=s;return{complex:n,find:b,twig:d}}_collectNodes(a){const e=this.#i.values();if(a===A||a===L){const o=new Set;let n=0;for(const{branch:s}of e){const{find:b,twig:d}=this._getEntryTwig(s,a),{compound:f,filtered:t,nodes:r,pending:l}=this._findEntryNodes(d,a);r.size?this.#o[n]=r:l?o.add(new Map([["index",n],["twig",d]])):this.#i[n].skip=!0,this.#i[n].filtered=t||!f,this.#i[n].find=b,n++}if(o.size){let s=this._traverse();for(;s;){let b=!1;if(this.#e.nodeType===i.ELEMENT_NODE?s===this.#e?b=!0:b=this.#e.contains(s):b=!0,b)for(const d of o){const{leaves:f}=d.get("twig");if(this._matchLeaves(f,s)){const r=d.get("index");this.#o[r].add(s),this.#i[r].filtered=!0}}s=this.#n.nextNode()}}}else{let o=0;for(const{branch:n}of e){const s=n[n.length-1],{compound:b,filtered:d,nodes:f}=this._findEntryNodes(s,a);f.size?this.#o[o]=f:this.#i[o].skip=!0,this.#i[o].filtered=d||!b,this.#i[o].find=$,o++}}return[this.#i,this.#o]}_sortNodes(a){const e=[...a];return e.length>1&&e.sort((o,n)=>{let s;return(0,E.isPreceding)(n,o)?s=1:s=-1,s}),e}_matchNodes(a){const[...e]=this.#i,o=e.length;let n=new Set;for(let s=0;s<o;s++){const{branch:b,filtered:d,find:f,skip:t}=e[s],r=b.length;if(!t&&r){const l=this.#o[s],c=r-1;if(c===0){const{leaves:[,...h]}=b[0];if((a===A||a===L)&&this.#e.nodeType===i.ELEMENT_NODE){for(const u of l)if((d||this._matchLeaves(h,u))&&u!==this.#e&&this.#e.contains(u)&&(n.add(u),a!==A))break}else if(h.length){for(const u of l)if((d||this._matchLeaves(h,u))&&(n.add(u),a!==A))break}else if(a===A){const u=[...n];n=new Set([...u,...l])}else{const[u]=[...l];n.add(u)}}else if(f===C){let{combo:h,leaves:u}=b[0];const[,...m]=u;let k;for(const g of l){if(d||this._matchLeaves(m,g)){let w=new Set([g]);for(let N=1;N<r;N++){const{combo:y,leaves:_}=b[N],x=[];for(const S of w){const R={combo:h,leaves:_},D=this._matchCombinator(R,S,{find:f});D.size&&x.push(...D)}if(x.length)if(N===c){if(a===A){const S=[...n];n=new Set([...S,...x])}else{const[S]=this._sortNodes(x);n.add(S)}k=!0}else h=y,w=new Set(x),k=!1;else{k=!1;break}}}else k=!1;if(k&&a!==A)break}if(!k&&a===L){const[g]=[...l];let p=this._findNode(u,{node:g,walker:this.#l});for(;p;){let w=new Set([p]);for(let N=1;N<r;N++){const{combo:y,leaves:_}=b[N],x=[];for(const S of w){const R={combo:h,leaves:_},D=this._matchCombinator(R,S,{find:f});D.size&&x.push(...D)}if(x.length)if(N===c){const[S]=this._sortNodes(x);n.add(S),k=!0}else h=y,w=new Set(x),k=!1;else{k=!1;break}}if(k)break;p=this._findNode(u,{node:p,walker:this.#l}),w=new Set([p])}}}else{const{leaves:h}=b[c],[,...u]=h;let m;for(const k of l){if(d||this._matchLeaves(u,k)){let p=new Set([k]);for(let w=c-1;w>=0;w--){const N=b[w],y=[];for(const _ of p){const x=this._matchCombinator(N,_,{find:f});x.size&&y.push(...x)}if(y.length)w===0?(n.add(k),m=!0):(p=new Set(y),m=!1);else{m=!1;break}}}if(m&&a!==A)break}if(!m&&a===L){const[k]=[...l];let g=this._findNode(h,{node:k,walker:this.#l});for(;g;){let p=new Set([g]);for(let w=c-1;w>=0;w--){const N=b[w],y=[];for(const _ of p){const x=this._matchCombinator(N,_,{find:f});x.size&&y.push(...x)}if(y.length)w===0?(n.add(g),m=!0):(p=new Set(y),m=!1);else{m=!1;break}}if(m)break;g=this._findNode(h,{node:g,walker:this.#l}),p=new Set([g])}}}}}return n}_find(a){return a===L&&(this.#l=this.#s.createTreeWalker(this.#e,i.SHOW_ELEMENT)),this._collectNodes(a),this._matchNodes(a)}matches(){if(this.#e.nodeType!==i.ELEMENT_NODE)throw new TypeError(`Unexpected node ${this.#e.nodeName}`);let a;try{const e=this._find(P);e.size&&(a=e.has(this.#e))}catch(e){this._onError(e)}return!!a}closest(){if(this.#e.nodeType!==i.ELEMENT_NODE)throw new TypeError(`Unexpected node ${this.#e.nodeName}`);let a;try{const e=this._find(O);let o=this.#e;for(;o;){if(e.has(o)){a=o;break}o=o.parentNode}}catch(e){this._onError(e)}return a??null}querySelector(){let a;try{const e=this._find(L);e.delete(this.#e),e.size&&([a]=this._sortNodes(e))}catch(e){this._onError(e)}return a??null}querySelectorAll(){let a;try{const e=this._find(A);e.delete(this.#e),e.size&&(a=this._sortNodes(e))}catch(e){this._onError(e)}return a??[]}}0&&(module.exports={Matcher});
//# sourceMappingURL=matcher.js.map
