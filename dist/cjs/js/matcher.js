var j=Object.create;var L=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var W=Object.getOwnPropertyNames;var q=Object.getPrototypeOf,G=Object.prototype.hasOwnProperty;var Y=(y,l)=>{for(var e in l)L(y,e,{get:l[e],enumerable:!0})},R=(y,l,e,f)=>{if(l&&typeof l=="object"||typeof l=="function")for(let c of W(l))!G.call(y,c)&&c!==e&&L(y,c,{get:()=>l[c],enumerable:!(f=H(l,c))||f.enumerable});return y};var X=(y,l,e)=>(e=y!=null?j(q(y)):{},R(l||!y||!y.__esModule?L(e,"default",{value:y,enumerable:!0}):e,y)),Z=y=>R(L({},"__esModule",{value:!0}),y);var ee={};Y(ee,{Matcher:()=>Q});module.exports=Z(ee);var D=X(require("is-potential-custom-element-name"),1),k=require("./dom-util.js"),g=require("./parser.js"),b=require("./constant.js");const C="all",A="first",v="lineal",S="self",U=/^(?:(?:fieldse|inpu|selec)t|button|opt(?:group|ion)|textarea)$/,O=/^(?:(?:(?:in|out)pu|selec)t|button|form|textarea)$/,M=/^a(?:rea)?$/,B=/^d(?:etails|ialog)$/,$=/^(?:checkbox|radio)$/,x=/^(?:(?:emai|te|ur)l|number|password|search|text)$/,z=/(?:(?:rang|tim)e|date(?:time-local)?|month|number|week)$/,F=/^(?:button|reset)$/,V=/^(?:image|submit)$/,I=/^(?:date(?:time-local)?|month|time|week)$/,K=/^(?:(?:ha|i)s|not|where)$/,J=/^nth-(?:last-)?(?:child|of-type)$/;class Q{#s;#r;#a;#e;#l;#t;#o;#c;#i;constructor(l,e,f={}){const{sort:c,warn:n}=f;this.#r=new Map([[b.ATTRIBUTE_SELECTOR,b.BIT_10000],[b.CLASS_SELECTOR,b.BIT_100],[b.ID_SELECTOR,b.BIT_10],[b.PSEUDO_CLASS_SELECTOR,b.BIT_100000],[b.PSEUDO_ELEMENT_SELECTOR,b.BIT_1],[b.TYPE_SELECTOR,b.BIT_1000]]),this.#a=new WeakMap,this.#o=l,this.#e=e,this.#c=!!c,this.#i=!!n,[this.#s,this.#l]=this._prepare(l),this.#t=this._getRoot(e)}_onError(l){if(l instanceof DOMException&&l.name===b.NOT_SUPPORTED_ERR)this.#i&&console.warn(l.message);else throw l}_getRoot(l=this.#e){let e,f;switch(l.nodeType){case b.DOCUMENT_NODE:{e=l,f=l;break}case b.DOCUMENT_FRAGMENT_NODE:{e=l.ownerDocument,f=l;break}case b.ELEMENT_NODE:{if((0,k.isSameOrDescendant)(l))e=l.ownerDocument,f=l.ownerDocument;else{let c=l;for(;c&&c.parentNode;)c=c.parentNode;e=c.ownerDocument,f=c}break}default:throw new TypeError(`Unexpected node ${l.nodeName}`)}return{document:e,root:f}}_sortLeaves(l){const e=[...l];return e.length>1&&e.sort((f,c)=>{const{type:n}=f,{type:d}=c,p=this.#r.get(n),u=this.#r.get(d);let t;return p===u?t=0:p>u?t=1:t=-1,t}),e}_prepare(l=this.#o){const e=(0,g.parseSelector)(l),f=(0,g.walkAST)(e),c=[],n=[];let d=0;for(const[...p]of f){const u=[];let t=p.shift();if(t&&t.type!==b.COMBINATOR){const i=new Set;for(;t;){if(t.type===b.COMBINATOR){const[h]=p;if(h.type===b.COMBINATOR){const r=`Invalid combinator ${t.name}${h.name}`;throw new DOMException(r,b.SYNTAX_ERR)}u.push({combo:t,leaves:this._sortLeaves(i)}),i.clear()}else t&&i.add(t);if(p.length)t=p.shift();else{u.push({combo:null,leaves:this._sortLeaves(i)}),i.clear();break}}}c.push({branch:u,find:null,skip:!1}),n[d]=new Set,d++}return[c,n]}_collectNthChild(l,e){const{a:f,b:c,reverse:n,selector:d}=l,{parentNode:p}=e,u=new Set;let t;if(d&&(this.#a.has(d)?t=this.#a.get(d):(t=(0,g.walkAST)(d),this.#a.set(d,t))),p){const i=[...p.children],h=i.length;if(h){const r=new Set;if(t){const o=t.length;for(const s of i){let a;for(let m=0;m<o;m++){const N=t[m];if(a=this._matchLeaves(N,s),!a)break}a&&r.add(s)}}if(n&&i.reverse(),f===0){if(c>0&&c<=h){if(r.size)for(let o=0;o<h;o++){const s=i[o];if(r.has(s)){u.add(s);break}}else if(!d){const o=i[c-1];u.add(o)}}}else{let o=0,s=c-1;if(f>0)for(;s<0;)s+=++o*f;if(s>=0&&s<h){let a=f>0?0:c-1;for(let m=0;m<h&&s>=0&&s<h;m++){const N=i[m];r.size?r.has(N)&&(a===s&&(u.add(N),s+=f),f>0?a++:a--):m===s&&(d||u.add(N),s+=f)}}}}}else{const{root:i}=this.#t;if(i.nodeType===b.ELEMENT_NODE&&e===i&&f+c===1)if(t){const h=t.length;let r;for(let o=0;o<h;o++){const s=t[o];if(r=this._matchLeaves(s,e),r)break}r&&u.add(e)}else u.add(e)}return u}_collectNthOfType(l,e){const{a:f,b:c,reverse:n}=l,{localName:d,parentNode:p,prefix:u}=e,t=new Set;if(p){const i=[...p.children],h=i.length;if(h)if(n&&i.reverse(),f===0){if(c>0&&c<=h){let r=0;for(let o=0;o<h;o++){const s=i[o],{localName:a,prefix:m}=s;if(a===d&&m===u){if(r===c-1){t.add(s);break}r++}}}}else{let r=c-1;if(f>0)for(;r<0;)r+=f;if(r>=0&&r<h){let o=f>0?0:c-1;for(let s=0;s<h;s++){const a=i[s],{localName:m,prefix:N}=a;if(m===d&&N===u){if(o===r&&(t.add(a),r+=f),r<0||r>=h)break;f>0?o++:o--}}}}}else{const{root:i}=this.#t;i.nodeType===b.ELEMENT_NODE&&e===i&&f+c===1&&t.add(e)}return t}_matchAnPlusB(l,e,f){const{nth:{a:c,b:n,name:d},selector:p}=l,u=(0,g.unescapeSelector)(d),t=new Map;u?(u==="even"?(t.set("a",2),t.set("b",0)):u==="odd"&&(t.set("a",2),t.set("b",1)),/last/.test(f)&&t.set("reverse",!0)):(typeof c=="string"&&/-?\d+/.test(c)?t.set("a",c*1):t.set("a",0),typeof n=="string"&&/-?\d+/.test(n)?t.set("b",n*1):t.set("b",0),/last/.test(f)&&t.set("reverse",!0));let i=new Set;if(t.has("a")&&t.has("b")){if(/^nth-(?:last-)?child$/.test(f)){p&&t.set("selector",p);const h=Object.fromEntries(t),r=this._collectNthChild(h,e);r.size&&(i=r)}else if(/^nth-(?:last-)?of-type$/.test(f)){const h=Object.fromEntries(t),r=this._collectNthOfType(h,e);r.size&&(i=r)}}return i}_matchPseudoElementSelector(l,e={}){const{forgive:f}=e;switch(l){case"after":case"backdrop":case"before":case"cue":case"cue-region":case"first-letter":case"first-line":case"file-selector-button":case"marker":case"part":case"placeholder":case"selection":case"slotted":case"target-text":{if(this.#i)throw new DOMException(`Unsupported pseudo-element ::${l}`,b.NOT_SUPPORTED_ERR);break}default:if(l.startsWith("-webkit-")){if(this.#i)throw new DOMException(`Unsupported pseudo-element ::${l}`,b.NOT_SUPPORTED_ERR)}else if(!f)throw new DOMException(`Unknown pseudo-element ::${l}`,b.SYNTAX_ERR)}}_matchDirectionPseudoClass(l,e){const f=(0,g.unescapeSelector)(l.name),c=(0,k.getDirectionality)(e);let n;return f===c&&(n=e),n??null}_matchLanguagePseudoClass(l,e){const{lang:f}=e,c=(0,g.unescapeSelector)(l.name);let n;if(c==="")e.getAttribute("lang")===""&&(n=e);else if(c==="*")e.hasAttribute("lang")||(n=e);else if(/[A-Z\d-]+/i.test(c)){const d="(?:-[A-Za-z\\d]+)?";let p;if(/-/.test(c)){const[u,t,...i]=c.split("-"),h=`${u}${d}`,r=`-${t}${d}`,o=i.length;let s="";if(o)for(let a=0;a<o;a++)s+=`-${i[a]}${d}`;p=new RegExp(`^${h}${r}${s}$`,"i")}else p=new RegExp(`^${c}${d}$`,"i");if(f)p.test(f)&&(n=e);else{let u=e;for(;u;){if(p.test(u.lang)){n=e;break}u=u.parentNode}}}return n??null}_matchHasPseudoFunc(l,e){let f;if(Array.isArray(l)&&l.length){const[c]=l,{type:n}=c;let d;n===b.COMBINATOR?d=l.shift():d={name:" ",type:b.COMBINATOR};const p=[];for(;l.length;){const[i]=l,{type:h}=i;if(h===b.COMBINATOR)break;p.push(l.shift())}const u={combo:d,leaves:p},t=this._matchCombinator(u,e,{find:"next"});if(t.size)if(l.length){for(const i of t)if(f=this._matchHasPseudoFunc(Object.assign([],l),i),f)break}else f=!0}return!!f}_matchLogicalPseudoFunc(l,e){const{astName:f="",branches:c=[],selector:n="",twigBranches:d=[]}=l;let p;if(f==="has")if(n.includes(":has("))p=null;else{let u;const t=c.length;for(let i=0;i<t;i++){const h=c[i];if(u=this._matchHasPseudoFunc(Object.assign([],h),e),u)break}u&&(p=e)}else{const u=/^(?:is|where)$/.test(f);let t;const i=d.length;for(let h=0;h<i;h++){const r=d[h],o=r.length-1,{leaves:s}=r[o];if(t=this._matchLeaves(s,e,{forgive:u}),t&&o>0){let a=new Set([e]);for(let m=o-1;m>=0;m--){const N=r[m],w=[];for(const _ of a){const T=this._matchCombinator(N,_,{forgive:u,find:"prev"});T.size&&w.push(...T)}const E=new Set(w);if(E.size)if(m===0){t=!0;break}else a=E;else{t=!1;break}}}if(t)break}f==="not"?t||(p=e):t&&(p=e)}return p??null}_matchPseudoClassSelector(l,e,f={}){const{children:c}=l,{localName:n,parentNode:d}=e,{forgive:p}=f,u=(0,g.unescapeSelector)(l.name);let t=new Set;if(K.test(u)){let i;if(this.#a.has(l))i=this.#a.get(l);else{const r=(0,g.walkAST)(l),o=[],s=[];for(const[...a]of r){for(const E of a){const _=(0,g.generateCSS)(E);o.push(_)}const m=[],N=new Set;let w=a.shift();for(;w;)if(w.type===b.COMBINATOR?(m.push({combo:w,leaves:[...N]}),N.clear()):w&&N.add(w),a.length)w=a.shift();else{m.push({combo:null,leaves:[...N]}),N.clear();break}s.push(m)}i={astName:u,branches:r,twigBranches:s,selector:o.join(",")},this.#a.set(l,i)}const h=this._matchLogicalPseudoFunc(i,e);h&&t.add(h)}else if(Array.isArray(c)){const[i]=c;if(J.test(u)){const h=this._matchAnPlusB(i,e,u);h.size&&(t=h)}else if(u==="dir"){const h=this._matchDirectionPseudoClass(i,e);h&&t.add(h)}else if(u==="lang"){const h=this._matchLanguagePseudoClass(i,e);h&&t.add(h)}else switch(u){case"current":case"nth-col":case"nth-last-col":{if(this.#i)throw new DOMException(`Unsupported pseudo-class :${u}()`,b.NOT_SUPPORTED_ERR);break}default:if(!p)throw new DOMException(`Unknown pseudo-class :${u}()`,b.SYNTAX_ERR)}}else{const{document:i,root:h}=this.#t,{documentElement:r}=i,o=new URL(i.URL);switch(u){case"any-link":case"link":{M.test(n)&&e.hasAttribute("href")&&t.add(e);break}case"local-link":{if(M.test(n)&&e.hasAttribute("href")){const s=new URL(e.getAttribute("href"),o.href);s.origin===o.origin&&s.pathname===o.pathname&&t.add(e)}break}case"visited":break;case"target":{(0,k.isSameOrDescendant)(e)&&o.hash&&e.id&&o.hash===`#${e.id}`&&t.add(e);break}case"target-within":{if(o.hash){const s=o.hash.replace(/^#/,"");let a=i.getElementById(s);for(;a;){if(a===e){t.add(e);break}a=a.parentNode}}break}case"scope":{this.#e.nodeType===b.ELEMENT_NODE?e===this.#e&&t.add(e):e===r&&t.add(e);break}case"focus":{e===i.activeElement&&t.add(e);break}case"focus-within":{let s=i.activeElement;for(;s;){if(s===e){t.add(e);break}s=s.parentNode}break}case"open":{B.test(n)&&e.hasAttribute("open")&&t.add(e);break}case"closed":{B.test(n)&&!e.hasAttribute("open")&&t.add(e);break}case"disabled":{if(U.test(n)||(0,D.default)(n))if(e.disabled||e.hasAttribute("disabled"))t.add(e);else{let s=d;for(;s&&s.localName!=="fieldset";)s=s.parentNode;s&&s.hasAttribute("disabled")&&d.localName!=="legend"&&t.add(e)}break}case"enabled":{(U.test(n)||(0,D.default)(n))&&!(e.disabled&&e.hasAttribute("disabled"))&&t.add(e);break}case"read-only":{switch(n){case"textarea":{(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}case"input":{(!e.type||x.test(e.type)||I.test(e.type))&&(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}default:(0,k.isContentEditable)(e)||t.add(e)}break}case"read-write":{switch(n){case"textarea":{e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled")||t.add(e);break}case"input":{(!e.type||x.test(e.type)||I.test(e.type))&&!(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}default:(0,k.isContentEditable)(e)&&t.add(e)}break}case"placeholder-shown":{let s;n==="textarea"?s=e:n==="input"&&(e.hasAttribute("type")?x.test(e.getAttribute("type"))&&(s=e):s=e),s&&e.hasAttribute("placeholder")&&e.getAttribute("placeholder").trim().length&&e.value===""&&t.add(e);break}case"checked":{(n==="input"&&e.hasAttribute("type")&&$.test(e.getAttribute("type"))&&e.checked||n==="option"&&e.selected)&&t.add(e);break}case"indeterminate":{if(n==="input"&&e.type==="checkbox"&&e.indeterminate||n==="progress"&&!e.hasAttribute("value"))t.add(e);else if(n==="input"&&e.type==="radio"&&!e.hasAttribute("checked")){const s=e.name;let a=e.parentNode;for(;a&&a.localName!=="form";)a=a.parentNode;a||(a=r);const m=[...a.getElementsByTagName("input")];let N;for(const w of m)if(w.getAttribute("type")==="radio"&&(s?w.getAttribute("name")===s&&(N=!!w.checked):w.hasAttribute("name")||(N=!!w.checked),N))break;N||t.add(e)}break}case"default":{if(n==="button"&&!(e.hasAttribute("type")&&F.test(e.getAttribute("type")))||n==="input"&&e.hasAttribute("type")&&V.test(e.getAttribute("type"))){let s=e.parentNode;for(;s&&s.localName!=="form";)s=s.parentNode;if(s){const a=i.createNodeIterator(s,b.SHOW_ELEMENT);let m=a.nextNode();for(;m;){const N=m.localName;let w;if(N==="button"?w=!(m.hasAttribute("type")&&F.test(m.getAttribute("type"))):N==="input"&&(w=m.hasAttribute("type")&&V.test(m.getAttribute("type"))),w){m===e&&t.add(e);break}m=a.nextNode()}}}else if(n==="input"&&e.hasAttribute("type")&&$.test(e.getAttribute("type"))&&(e.checked||e.hasAttribute("checked")))t.add(e);else if(n==="option"){let s=!1,a=d;for(;a&&a.localName!=="datalist";){if(a.localName==="select"){(a.multiple||a.hasAttribute("multiple"))&&(s=!0);break}a=a.parentNode}if(s)(e.selected||e.hasAttribute("selected"))&&t.add(e);else{const m=d.firstElementChild,N=new Set;let w=m;for(;w;){if(w.selected||w.hasAttribute("selected")){N.add(w);break}w=w.nextElementSibling}N.size||N.add(m),N.has(e)&&t.add(e)}}break}case"valid":{if(O.test(n))e.checkValidity()&&t.add(e);else if(/^fieldset$/.test(n)){const s=i.createNodeIterator(e,b.SHOW_ELEMENT);let a=s.nextNode();a===e&&(a=s.nextNode());let m;for(;a&&!(O.test(a.localName)&&(m=a.checkValidity(),!m));)a=s.nextNode();m&&t.add(e)}break}case"invalid":{if(O.test(n))e.checkValidity()||t.add(e);else if(/^fieldset$/.test(n)){const s=i.createNodeIterator(e,b.SHOW_ELEMENT);let a=s.nextNode();a===e&&(a=s.nextNode());let m;for(;a&&!(O.test(a.localName)&&(m=a.checkValidity(),!m));)a=s.nextNode();m||t.add(e)}break}case"in-range":{n==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&z.test(e.getAttribute("type"))&&!(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&(e.hasAttribute("min")||e.hasAttribute("max")||e.getAttribute("type")==="range")&&t.add(e);break}case"out-of-range":{n==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&z.test(e.getAttribute("type"))&&(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&t.add(e);break}case"required":{let s;if(/^(?:select|textarea)$/.test(n))s=e;else if(n==="input")if(e.hasAttribute("type")){const a=e.getAttribute("type");(x.test(a)||$.test(a)||I.test(a)||a==="file")&&(s=e)}else s=e;s&&(e.required||e.hasAttribute("required"))&&t.add(e);break}case"optional":{let s;if(/^(?:select|textarea)$/.test(n))s=e;else if(n==="input")if(e.hasAttribute("type")){const a=e.getAttribute("type");(x.test(a)||$.test(a)||I.test(a)||a==="file")&&(s=e)}else s=e;s&&!(e.required||e.hasAttribute("required"))&&t.add(e);break}case"root":{e===r&&t.add(e);break}case"empty":{if(e.hasChildNodes()){const s=e.childNodes.values();let a;for(const m of s)if(a=m.nodeType!==b.ELEMENT_NODE&&m.nodeType!==b.TEXT_NODE,!a)break;a&&t.add(e)}else t.add(e);break}case"first-child":{(d&&e===d.firstElementChild||h.nodeType===b.ELEMENT_NODE&&e===h)&&t.add(e);break}case"last-child":{(d&&e===d.lastElementChild||h.nodeType===b.ELEMENT_NODE&&e===h)&&t.add(e);break}case"only-child":{(d&&e===d.firstElementChild&&e===d.lastElementChild||h.nodeType===b.ELEMENT_NODE&&e===h)&&t.add(e);break}case"first-of-type":{if(d){const[s]=this._collectNthOfType({a:0,b:1},e);s&&t.add(s)}else h.nodeType===b.ELEMENT_NODE&&e===h&&t.add(e);break}case"last-of-type":{if(d){const[s]=this._collectNthOfType({a:0,b:1,reverse:!0},e);s&&t.add(s)}else h.nodeType===b.ELEMENT_NODE&&e===h&&t.add(e);break}case"only-of-type":{if(d){const[s]=this._collectNthOfType({a:0,b:1},e);if(s===e){const[a]=this._collectNthOfType({a:0,b:1,reverse:!0},e);a===e&&t.add(e)}}else h.nodeType===b.ELEMENT_NODE&&e===h&&t.add(e);break}case"after":case"before":case"first-letter":case"first-line":{if(this.#i)throw new DOMException(`Unsupported pseudo-element ::${u}`,b.NOT_SUPPORTED_ERR);break}case"active":case"autofill":case"blank":case"buffering":case"current":case"focus-visible":case"fullscreen":case"future":case"hover":case"modal":case"muted":case"past":case"paused":case"picture-in-picture":case"playing":case"seeking":case"stalled":case"user-invalid":case"user-valid":case"volume-locked":case"-webkit-autofill":{if(this.#i)throw new DOMException(`Unsupported pseudo-class :${u}`,b.NOT_SUPPORTED_ERR);break}default:if(u.startsWith("-webkit-")){if(this.#i)throw new DOMException(`Unsupported pseudo-class :${u}`,b.NOT_SUPPORTED_ERR)}else if(!p)throw new DOMException(`Unknown pseudo-class :${u}`,b.SYNTAX_ERR)}}return t}_matchAttributeSelector(l,e){const{flags:f,matcher:c,name:n,value:d}=l;if(typeof f=="string"&&!/^[is]$/i.test(f))throw new DOMException("Invalid attribute selector",b.SYNTAX_ERR);const{attributes:p}=e;let u;if(p&&p.length){const{document:t}=this.#t;let i;t.contentType==="text/html"?typeof f=="string"&&/^s$/i.test(f)?i=!1:i=!0:typeof f=="string"&&/^i$/i.test(f)?i=!0:i=!1;let{name:h}=n;h=(0,g.unescapeSelector)(h),i&&(h=h.toLowerCase());const r=new Set;if(/\|/.test(h)){const{prefix:o,tagName:s}=(0,k.selectorToNodeProps)(h);for(let{name:a,value:m}of p)switch(i&&(a=a.toLowerCase(),m=m.toLowerCase()),o){case"":{s===a&&r.add(m);break}case"*":{/:/.test(a)?a.endsWith(`:${s}`)&&r.add(m):s===a&&r.add(m);break}default:if(/:/.test(a)){const[N,w]=a.split(":");o===N&&s===w&&(0,k.isNamespaceDeclared)(o,e)&&r.add(m)}}}else for(let{name:o,value:s}of p)if(i&&(o=o.toLowerCase(),s=s.toLowerCase()),/:/.test(o)){const[,a]=o.split(":");h===a&&r.add(s)}else h===o&&r.add(s);if(r.size){const{name:o,value:s}=d||{};let a;switch(o?i?a=o.toLowerCase():a=o:s?i?a=s.toLowerCase():a=s:s===""&&(a=s),c){case"=":{typeof a=="string"&&r.has(a)&&(u=e);break}case"~=":{if(a&&typeof a=="string"){for(const m of r)if(new Set(m.split(/\s+/)).has(a)){u=e;break}}break}case"|=":{if(a&&typeof a=="string"){let m;for(const N of r)if(N===a||N.startsWith(`${a}-`)){m=N;break}m&&(u=e)}break}case"^=":{if(a&&typeof a=="string"){let m;for(const N of r)if(N.startsWith(`${a}`)){m=N;break}m&&(u=e)}break}case"$=":{if(a&&typeof a=="string"){let m;for(const N of r)if(N.endsWith(`${a}`)){m=N;break}m&&(u=e)}break}case"*=":{if(a&&typeof a=="string"){let m;for(const N of r)if(N.includes(`${a}`)){m=N;break}m&&(u=e)}break}case null:default:u=e}}}return u??null}_matchClassSelector(l,e){const f=(0,g.unescapeSelector)(l.name);let c;return e.classList.contains(f)&&(c=e),c??null}_matchIDSelector(l,e){const{id:f}=e,c=(0,g.unescapeSelector)(l.name);let n;return c===f&&(n=e),n??null}_matchTypeSelector(l,e){const f=(0,g.unescapeSelector)(l.name),{localName:c,prefix:n}=e,{document:d}=this.#t;let{prefix:p,tagName:u}=(0,k.selectorToNodeProps)(f,e);d.contentType==="text/html"&&(p=p.toLowerCase(),u=u.toLowerCase());let t,i;/:/.test(c)?[t,i]=c.split(":"):(t=n||"",i=c);let h;return p===""&&t===""?e.namespaceURI===null&&(u==="*"||u===i)&&(h=e):p==="*"?(u==="*"||u===i)&&(h=e):p===t&&(0,k.isNamespaceDeclared)(p,e)&&(u==="*"||u===i)&&(h=e),h??null}_matchSelector(l,e,f){const{type:c}=l;let n=new Set;if(e.nodeType===b.ELEMENT_NODE)switch(c){case b.ATTRIBUTE_SELECTOR:{const d=this._matchAttributeSelector(l,e);d&&n.add(d);break}case b.CLASS_SELECTOR:{const d=this._matchClassSelector(l,e);d&&n.add(d);break}case b.ID_SELECTOR:{const d=this._matchIDSelector(l,e);d&&n.add(d);break}case b.PSEUDO_CLASS_SELECTOR:{const d=this._matchPseudoClassSelector(l,e,f);d.size&&(n=d);break}case b.PSEUDO_ELEMENT_SELECTOR:{const d=(0,g.unescapeSelector)(l.name);this._matchPseudoElementSelector(d,f);break}case b.TYPE_SELECTOR:default:{const d=this._matchTypeSelector(l,e);d&&n.add(d)}}return n}_matchLeaves(l,e,f){let c;for(const n of l)if(c=this._matchSelector(n,e,f).has(e),!c)break;return!!c}_findDescendantNodes(l,e){const[f,...c]=l,{type:n}=f,d=(0,g.unescapeSelector)(f.name),p=c.length>0,{document:u,root:t}=this.#t;let i=new Set,h=!1;switch(n){case b.ID_SELECTOR:{if(t.nodeType===b.ELEMENT_NODE)h=!0;else{const r=t.getElementById(d);if(r&&r!==e){const o=(0,k.isSameOrDescendant)(r,e);let s;o&&(s=r),s&&(p?this._matchLeaves(c,s)&&i.add(s):i.add(s))}}break}case b.CLASS_SELECTOR:{const r=[...e.getElementsByClassName(d)];if(r.length)if(p)for(const o of r)this._matchLeaves(c,o)&&i.add(o);else i=new Set(r);break}case b.TYPE_SELECTOR:{if(u.contentType!=="text/html"||/[*|]/.test(d))h=!0;else{const r=[...e.getElementsByTagName(d)];if(r.length)if(p)for(const o of r)this._matchLeaves(c,o)&&i.add(o);else i=new Set(r)}break}case b.PSEUDO_ELEMENT_SELECTOR:{this._matchPseudoElementSelector(d);break}default:h=!0}return{nodes:i,pending:h}}_matchCombinator(l,e,f={}){const{combo:c,leaves:n}=l,{name:d}=c,{find:p,forgive:u}=f;let t=new Set;if(p==="next")switch(d){case"+":{const i=e.nextElementSibling;i&&this._matchLeaves(n,i)&&t.add(i);break}case"~":{let i=e.nextElementSibling;for(;i;)this._matchLeaves(n,i)&&t.add(i),i=i.nextElementSibling;break}case">":{const i=[...e.children];for(const h of i)this._matchLeaves(n,h)&&t.add(h);break}case" ":default:{const{nodes:i,pending:h}=this._findDescendantNodes(n,e);if(i.size)t=i;else if(h){const{document:r}=this.#t,o=r.createNodeIterator(e,b.SHOW_ELEMENT);let s=o.nextNode();for(s===e&&(s=o.nextNode());s;)this._matchLeaves(n,s)&&t.add(s),s=o.nextNode()}}}else switch(d){case"+":{const i=e.previousElementSibling;i&&this._matchLeaves(n,i,{forgive:u})&&t.add(i);break}case"~":{const i=[];let h=e.previousElementSibling;for(;h;)this._matchLeaves(n,h,{forgive:u})&&i.push(h),h=h.previousElementSibling;i.length&&(t=new Set(i.reverse()));break}case">":{const i=e.parentNode;i&&this._matchLeaves(n,i,{forgive:u})&&t.add(i);break}case" ":default:{const i=[];let h=e.parentNode;for(;h;)this._matchLeaves(n,h,{forgive:u})&&i.push(h),h=h.parentNode;i.length&&(t=new Set(i.reverse()))}}return t}_findNodes(l,e){const{leaves:[f,...c]}=l,{type:n}=f,d=(0,g.unescapeSelector)(f.name),p=c.length>0,{document:u,root:t}=this.#t;let i=new Set,h=!1;switch(n){case b.ID_SELECTOR:{let r;if(e===S)this._matchLeaves([f],this.#e)&&(r=this.#e);else if(e===v){let o=this.#e;for(;o;){if(this._matchLeaves([f],o)){r=o;break}o=o.parentNode}}else t.nodeType===b.ELEMENT_NODE?h=!0:r=t.getElementById(d);r&&(p?this._matchLeaves(c,r)&&i.add(r):i.add(r));break}case b.CLASS_SELECTOR:{const r=[];if(e===S)this.#e.nodeType===b.ELEMENT_NODE&&this.#e.classList.contains(d)&&r.push(this.#e);else if(e===v){let o=this.#e;for(;o&&o.nodeType===b.ELEMENT_NODE;)o.classList.contains(d)&&r.push(o),o=o.parentNode}else if(t.nodeType===b.DOCUMENT_FRAGMENT_NODE){const o=[...t.children];for(const s of o){s.classList.contains(d)&&r.push(s);const a=[...s.getElementsByClassName(d)];r.push(...a)}}else{const o=[...t.getElementsByClassName(d)];r.push(...o)}if(r.length)if(p)for(const o of r)this._matchLeaves(c,o)&&i.add(o);else i=new Set(r);break}case b.TYPE_SELECTOR:{const r=[];if(e===S)this.#e.nodeType===b.ELEMENT_NODE&&this._matchLeaves([f],this.#e)&&r.push(this.#e);else if(e===v){let o=this.#e;for(;o&&o.nodeType===b.ELEMENT_NODE;)this._matchLeaves([f],o)&&r.push(o),o=o.parentNode}else if(u.contentType!=="text/html"||/[*|]/.test(d))h=!0;else if(t.nodeType===b.DOCUMENT_FRAGMENT_NODE){const o=d.toLowerCase(),s=[...t.children];for(const a of s){a.localName===o&&r.push(a);const m=[...a.getElementsByTagName(d)];r.push(...m)}}else{const o=[...t.getElementsByTagName(d)];r.push(...o)}if(r.length)if(p)for(const o of r)this._matchLeaves(c,o)&&i.add(o);else i=new Set(r);break}case b.PSEUDO_ELEMENT_SELECTOR:{this._matchPseudoElementSelector(d);break}default:{const r=[];if(e===S)this._matchLeaves([f],this.#e)&&r.push(this.#e);else if(e===v){let o=this.#e;for(;o;)this._matchLeaves([f],o)&&r.push(o),o=o.parentNode}else h=!0;if(r.length)if(p)for(const o of r)this._matchLeaves(c,o)&&i.add(o);else i=new Set(r)}}return{nodes:i,pending:h}}_getFirstTwig(l){const e=l.length-1,f=l[0];let c,n;if(e){const d=l[e],{leaves:[{type:p}]}=d;p===b.PSEUDO_ELEMENT_SELECTOR||p===b.ID_SELECTOR?(c="prev",n=d):(c="next",n=f)}else c="prev",n=f;return{find:c,twig:n}}_collectNodes(l){const e=this.#s.values();if(l===C||l===A){const f=new Set;let c=0;for(const{branch:n}of e){const{find:d,twig:p}=this._getFirstTwig(n),{nodes:u,pending:t}=this._findNodes(p,l);u.size?this.#l[c]=u:t?f.add(new Map([["index",c],["twig",p]])):this.#s[c].skip=!0,this.#s[c].find=d,c++}if(f.size){const{document:n,root:d}=this.#t,p=n.createNodeIterator(d,b.SHOW_ELEMENT);let u=p.nextNode();for(;u;){let t=!1;if(this.#e.nodeType===b.ELEMENT_NODE?t=(0,k.isSameOrDescendant)(u,this.#e):t=!0,t)for(const i of f){const{leaves:h}=i.get("twig");if(this._matchLeaves(h,u)){const o=i.get("index");this.#l[o].add(u)}}u=p.nextNode()}}}else{let f=0;for(const{branch:c}of e){const n=c[c.length-1],{nodes:d}=this._findNodes(n,l);d.size?this.#l[f]=d:this.#s[f].skip=!0,this.#s[f].find="prev",f++}}return[this.#s,this.#l]}_matchNodes(l){const[...e]=this.#s,f=e.length;let c=new Set;for(let n=0;n<f;n++){const{branch:d,find:p,skip:u}=e[n],t=d.length;if(!u&&t){const i=this.#l[n],h=t-1;if(h===0)if((l===C||l===A)&&this.#e.nodeType===b.ELEMENT_NODE){for(const r of i)if(r!==this.#e&&(0,k.isSameOrDescendant)(r,this.#e)&&(c.add(r),l===A))break}else if(l===A){const[r]=[...i];c.add(r)}else{const r=[...c],o=[...i];c=new Set([...r,...o])}else if(p==="next"){let{combo:r}=d[0];for(const o of i){let s=new Set([o]);for(let a=1;a<t;a++){const{combo:m,leaves:N}=d[a],w=[];for(const _ of s){const T={combo:r,leaves:N},P=this._matchCombinator(T,_,{find:p});P.size&&w.push(...P)}const E=new Set(w);if(E.size)if(a===h){if(l===A){const[_]=[...E];c.add(_)}else{const _=[...c],T=[...E];c=new Set([..._,...T])}break}else r=m,s=E;else break}}}else for(const r of i){let o=new Set([r]),s;for(let a=h-1;a>=0;a--){const m=d[a],N=[];for(const E of o){const _=this._matchCombinator(m,E,{find:p});_.size&&N.push(..._)}const w=new Set(N);if(w.size)if(s=!0,a===0){c.add(r);break}else o=w;else{s=!1;break}}if(s&&l!==C)break}}}return c}_find(l){return this._collectNodes(l),this._matchNodes(l)}_sortNodes(l){const e=[...l];return e.length>1&&e.sort((f,c)=>{let n;const d=f.compareDocumentPosition(c);return d&b.DOCUMENT_POSITION_PRECEDING||d&b.DOCUMENT_POSITION_CONTAINS?n=1:n=-1,n}),e}matches(){if(this.#e.nodeType!==b.ELEMENT_NODE)throw new TypeError(`Unexpected node ${this.#e.nodeName}`);let l;try{l=this._find(S).has(this.#e)}catch(e){this._onError(e)}return!!l}closest(){if(this.#e.nodeType!==b.ELEMENT_NODE)throw new TypeError(`Unexpected node ${this.#e.nodeName}`);let l;try{const e=this._find(v);let f=this.#e;for(;f;){if(e.has(f)){l=f;break}f=f.parentNode}}catch(e){this._onError(e)}return l??null}querySelector(){let l;try{const e=this._find(A);e.delete(this.#e),e.size>1?[l]=this._sortNodes(e):e.size&&([l]=[...e])}catch(e){this._onError(e)}return l??null}querySelectorAll(){const l=[];try{const e=this._find(C);e.delete(this.#e),e.size>1&&this.#c?l.push(...this._sortNodes(e)):e.size&&l.push(...e)}catch(e){this._onError(e)}return l}}0&&(module.exports={Matcher});
//# sourceMappingURL=matcher.js.map
