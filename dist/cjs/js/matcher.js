var F=Object.create;var M=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var H=Object.getPrototypeOf,G=Object.prototype.hasOwnProperty;var W=(T,s)=>{for(var e in s)M(T,e,{get:s[e],enumerable:!0})},z=(T,s,e,n)=>{if(s&&typeof s=="object"||typeof s=="function")for(let h of j(s))!G.call(T,h)&&h!==e&&M(T,h,{get:()=>s[h],enumerable:!(n=V(s,h))||n.enumerable});return T};var q=(T,s,e)=>(e=T!=null?F(H(T)):{},z(s||!T||!T.__esModule?M(e,"default",{value:T,enumerable:!0}):e,T)),X=T=>z(M({},"__esModule",{value:!0}),T);var J={};W(J,{Matcher:()=>Y});module.exports=X(J);var B=q(require("is-potential-custom-element-name"),1),E=require("./dom-util.js"),k=require("./parser.js"),l=require("./constant.js");const R="next",U="prev",I="all",$="first",D="lineal",P="self";class Y{#i;#o;#a;#e;#l;#t;#r;#s;constructor(s,e,n={}){const{warn:h}=n;this.#o=new Map([[l.SELECTOR_PSEUDO_ELEMENT,l.BIT_01],[l.SELECTOR_ID,l.BIT_02],[l.SELECTOR_CLASS,l.BIT_04],[l.SELECTOR_TYPE,l.BIT_08],[l.SELECTOR_ATTR,l.BIT_16],[l.SELECTOR_PSEUDO_CLASS,l.BIT_32]]),this.#a=new WeakMap,this.#r=s,this.#e=e,this.#s=!!h,[this.#i,this.#l]=this._prepare(s),this.#t=this._getRoot(e)}_onError(s){if(s instanceof DOMException&&s.name===l.NOT_SUPPORTED_ERR)this.#s&&console.warn(s.message);else throw s}_getRoot(s=this.#e){let e,n;switch(s.nodeType){case l.DOCUMENT_NODE:{e=s,n=s;break}case l.DOCUMENT_FRAGMENT_NODE:{e=s.ownerDocument,n=s;break}case l.ELEMENT_NODE:{if((0,E.isSameOrDescendant)(s))e=s.ownerDocument,n=s.ownerDocument;else{let o=s;for(;o&&o.parentNode;)o=o.parentNode;e=o.ownerDocument,n=o}break}default:throw new TypeError(`Unexpected node ${s.nodeName}`)}const h=(0,E.isInShadowTree)(s);return{document:e,root:n,shadow:h}}_sortLeaves(s){const e=[...s];return e.length>1&&e.sort((n,h)=>{const{type:o}=n,{type:u}=h,p=this.#o.get(o),f=this.#o.get(u);let t;return p===f?t=0:p>f?t=1:t=-1,t}),e}_prepare(s=this.#r){const e=(0,k.parseSelector)(s),n=(0,k.walkAST)(e),h=[],o=[];let u=0;for(const[...p]of n){const f=[];let t=p.shift();if(t&&t.type!==l.COMBINATOR){const i=new Set;for(;t;){if(t.type===l.COMBINATOR){const[r]=p;if(r.type===l.COMBINATOR){const b=`Invalid combinator ${t.name}${r.name}`;throw new DOMException(b,l.SYNTAX_ERR)}f.push({combo:t,leaves:this._sortLeaves(i)}),i.clear()}else t&&i.add(t);if(p.length)t=p.shift();else{f.push({combo:null,leaves:this._sortLeaves(i)}),i.clear();break}}}h.push({branch:f,find:null,skip:!1}),o[u]=new Set,u++}return[h,o]}_collectNthChild(s,e){const{a:n,b:h,reverse:o,selector:u}=s,{parentNode:p}=e,f=new Set;let t;if(u&&(this.#a.has(u)?t=this.#a.get(u):(t=(0,k.walkAST)(u),this.#a.set(u,t))),p){const i=[].slice.call(p.children),r=i.length;if(r){const b=new Set;if(t){const a=t.length;for(const c of i){let d;for(let m=0;m<a;m++){const N=t[m];if(d=this._matchLeaves(N,c),!d)break}d&&b.add(c)}}if(o&&i.reverse(),n===0){if(h>0&&h<=r){if(b.size)for(let a=0;a<r;a++){const c=i[a];if(b.has(c)){f.add(c);break}}else if(!u){const a=i[h-1];f.add(a)}}}else{let a=h-1;if(n>0)for(;a<0;)a+=n;if(a>=0&&a<r){let c=n>0?0:h-1;for(let d=0;d<r&&a>=0&&a<r;d++){const m=i[d];b.size?b.has(m)&&(c===a&&(f.add(m),a+=n),n>0?c++:c--):d===a&&(u||f.add(m),a+=n)}}}}}else{const{root:i}=this.#t;if(e===i&&i.nodeType===l.ELEMENT_NODE&&n+h===1)if(t){const r=t.length;let b;for(let a=0;a<r;a++){const c=t[a];if(b=this._matchLeaves(c,e),b)break}b&&f.add(e)}else f.add(e)}return f}_collectNthOfType(s,e){const{a:n,b:h,reverse:o}=s,{localName:u,parentNode:p,prefix:f}=e,t=new Set;if(p){const i=[].slice.call(p.children),r=i.length;if(r)if(o&&i.reverse(),n===0){if(h>0&&h<=r){let b=0;for(let a=0;a<r;a++){const c=i[a],{localName:d,prefix:m}=c;if(d===u&&m===f){if(b===h-1){t.add(c);break}b++}}}}else{let b=h-1;if(n>0)for(;b<0;)b+=n;if(b>=0&&b<r){let a=n>0?0:h-1;for(let c=0;c<r;c++){const d=i[c],{localName:m,prefix:N}=d;if(m===u&&N===f){if(a===b&&(t.add(d),b+=n),b<0||b>=r)break;n>0?a++:a--}}}}}else{const{root:i}=this.#t;e===i&&i.nodeType===l.ELEMENT_NODE&&n+h===1&&t.add(e)}return t}_matchAnPlusB(s,e,n){const{nth:{a:h,b:o,name:u},selector:p}=s,f=(0,k.unescapeSelector)(u),t=new Map;f?(f==="even"?(t.set("a",2),t.set("b",0)):f==="odd"&&(t.set("a",2),t.set("b",1)),n.indexOf("last")>-1&&t.set("reverse",!0)):(typeof h=="string"&&/-?\d+/.test(h)?t.set("a",h*1):t.set("a",0),typeof o=="string"&&/-?\d+/.test(o)?t.set("b",o*1):t.set("b",0),n.indexOf("last")>-1&&t.set("reverse",!0));let i=new Set;if(t.has("a")&&t.has("b")){if(/^nth-(?:last-)?child$/.test(n)){p&&t.set("selector",p);const r=Object.fromEntries(t),b=this._collectNthChild(r,e);b.size&&(i=b)}else if(/^nth-(?:last-)?of-type$/.test(n)){const r=Object.fromEntries(t),b=this._collectNthOfType(r,e);b.size&&(i=b)}}return i}_matchPseudoElementSelector(s,e={}){const{forgive:n}=e;switch(s){case"after":case"backdrop":case"before":case"cue":case"cue-region":case"first-letter":case"first-line":case"file-selector-button":case"marker":case"placeholder":case"selection":case"target-text":{if(this.#s)throw new DOMException(`Unsupported pseudo-element ::${s}`,l.NOT_SUPPORTED_ERR);break}case"part":case"slotted":{if(this.#s)throw new DOMException(`Unsupported pseudo-element ::${s}()`,l.NOT_SUPPORTED_ERR);break}default:if(s.startsWith("-webkit-")){if(this.#s)throw new DOMException(`Unsupported pseudo-element ::${s}`,l.NOT_SUPPORTED_ERR)}else if(!n)throw new DOMException(`Unknown pseudo-element ::${s}`,l.SYNTAX_ERR)}}_matchDirectionPseudoClass(s,e){const n=(0,k.unescapeSelector)(s.name),h=(0,E.getDirectionality)(e);let o;return n===h&&(o=e),o??null}_matchLanguagePseudoClass(s,e){const n=(0,k.unescapeSelector)(s.name);let h;if(n)if(n==="*")if(e.hasAttribute("lang"))e.getAttribute("lang")&&(h=e);else{let o=e.parentNode;for(;o&&o.nodeType===l.ELEMENT_NODE;){if(o.hasAttribute("lang")){o.getAttribute("lang")&&(h=e);break}o=o.parentNode}}else{const o=`(?:-${l.ALPHA_NUM})*`;if(new RegExp(`^(?:\\*-)?${l.ALPHA_NUM}${o}$`,"i").test(n)){let p;if(n.indexOf("-")>-1){const[f,t,...i]=n.split("-");let r;f==="*"?r=`${l.ALPHA_NUM}${o}`:r=`${f}${o}`;const b=`-${t}${o}`,a=i.length;let c="";if(a)for(let d=0;d<a;d++)c+=`-${i[d]}${o}`;p=new RegExp(`^${r}${b}${c}$`,"i")}else p=new RegExp(`^${n}${o}$`,"i");if(e.hasAttribute("lang"))p.test(e.getAttribute("lang"))&&(h=e);else{let f=e.parentNode;for(;f&&f.nodeType===l.ELEMENT_NODE;){if(f.hasAttribute("lang")){const t=f.getAttribute("lang");p.test(t)&&(h=e);break}f=f.parentNode}}}}return h??null}_matchHasPseudoFunc(s,e){let n;if(Array.isArray(s)&&s.length){const[h]=s,{type:o}=h;let u;o===l.COMBINATOR?u=s.shift():u={name:" ",type:l.COMBINATOR};const p=[];for(;s.length;){const[i]=s,{type:r}=i;if(r===l.COMBINATOR)break;p.push(s.shift())}const f={combo:u,leaves:p},t=this._matchCombinator(f,e,{find:R});if(t.size)if(s.length){for(const i of t)if(n=this._matchHasPseudoFunc(Object.assign([],s),i),n)break}else n=!0}return!!n}_matchLogicalPseudoFunc(s,e){const{astName:n="",branches:h=[],selector:o="",twigBranches:u=[]}=s;let p;if(n==="has")if(o.includes(":has("))p=null;else{const f=h.length;let t;for(let i=0;i<f;i++){const r=h[i];if(t=this._matchHasPseudoFunc(Object.assign([],r),e),t)break}t&&(p=e)}else{const f=/^(?:is|where)$/.test(n),t=u.length;let i;for(let r=0;r<t;r++){const b=u[r],a=b.length-1,{leaves:c}=b[a];if(i=this._matchLeaves(c,e,{forgive:f}),i&&a>0){let d=new Set([e]);for(let m=a-1;m>=0;m--){const N=b[m],y=[];for(const x of d){const L=this._matchCombinator(N,x,{forgive:f,find:U});L.size&&y.push(...L)}if(y.length)if(m===0){i=!0;break}else d=new Set(y);else{i=!1;break}}}if(i)break}n==="not"?i||(p=e):i&&(p=e)}return p??null}_matchPseudoClassSelector(s,e,n={}){const{children:h}=s,{localName:o,parentNode:u}=e,{forgive:p}=n,f=(0,k.unescapeSelector)(s.name);let t=new Set;if(l.REG_LOGICAL_PSEUDO.test(f)){let i;if(this.#a.has(s))i=this.#a.get(s);else{const b=(0,k.walkAST)(s),a=[],c=[];for(const[...d]of b){for(const x of d){const L=(0,k.generateCSS)(x);a.push(L)}const m=[],N=new Set;let y=d.shift();for(;y;)if(y.type===l.COMBINATOR?(m.push({combo:y,leaves:[...N]}),N.clear()):y&&N.add(y),d.length)y=d.shift();else{m.push({combo:null,leaves:[...N]}),N.clear();break}c.push(m)}i={astName:f,branches:b,twigBranches:c,selector:a.join(",")},this.#a.set(s,i)}const r=this._matchLogicalPseudoFunc(i,e);r&&t.add(r)}else if(Array.isArray(h)){const[i]=h;if(/^nth-(?:last-)?(?:child|of-type)$/.test(f)){const r=this._matchAnPlusB(i,e,f);r.size&&(t=r)}else if(f==="dir"){const r=this._matchDirectionPseudoClass(i,e);r&&t.add(r)}else if(f==="lang"){const r=this._matchLanguagePseudoClass(i,e);r&&t.add(r)}else switch(f){case"current":case"nth-col":case"nth-last-col":{if(this.#s)throw new DOMException(`Unsupported pseudo-class :${f}()`,l.NOT_SUPPORTED_ERR);break}case"host":case"host-context":break;default:if(!p)throw new DOMException(`Unknown pseudo-class :${f}()`,l.SYNTAX_ERR)}}else{const{document:i,root:r}=this.#t,{documentElement:b}=i,a=new URL(i.URL),c=/^a(?:rea)?$/,d=/^(?:(?:fieldse|inpu|selec)t|button|opt(?:group|ion)|textarea)$/,m=/^(?:(?:inpu|selec)t|button|form|textarea)$/,N=/^d(?:etails|ialog)$/,y=/^(?:checkbox|radio)$/,x=/^(?:date(?:time-local)?|month|time|week)$/,L=/(?:(?:rang|tim)e|date(?:time-local)?|month|number|week)$/,O=/^(?:(?:emai|te|ur)l|number|password|search|text)$/;switch(f){case"any-link":case"link":{c.test(o)&&e.hasAttribute("href")&&t.add(e);break}case"local-link":{if(c.test(o)&&e.hasAttribute("href")){const w=new URL(e.getAttribute("href"),a.href);w.origin===a.origin&&w.pathname===a.pathname&&t.add(e)}break}case"visited":break;case"target":{e.id&&a.hash&&a.hash===`#${e.id}`&&(0,E.isSameOrDescendant)(e)&&t.add(e);break}case"target-within":{if(a.hash){const w=a.hash.replace(/^#/,"");let g=i.getElementById(w);for(;g;){if(g===e){t.add(e);break}g=g.parentNode}}break}case"scope":{this.#e.nodeType===l.ELEMENT_NODE?e===this.#e&&t.add(e):e===b&&t.add(e);break}case"focus":{e===i.activeElement&&t.add(e);break}case"focus-within":{let w=i.activeElement;for(;w;){if(w===e){t.add(e);break}w=w.parentNode}break}case"open":{N.test(o)&&e.hasAttribute("open")&&t.add(e);break}case"closed":{N.test(o)&&!e.hasAttribute("open")&&t.add(e);break}case"disabled":{if(d.test(o)||(0,B.default)(o))if(e.disabled||e.hasAttribute("disabled"))t.add(e);else{let w=u;for(;w&&w.localName!=="fieldset";)w=w.parentNode;w&&u.localName!=="legend"&&w.hasAttribute("disabled")&&t.add(e)}break}case"enabled":{(d.test(o)||(0,B.default)(o))&&!(e.disabled&&e.hasAttribute("disabled"))&&t.add(e);break}case"read-only":{switch(o){case"textarea":{(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}case"input":{(!e.type||x.test(e.type)||O.test(e.type))&&(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}default:(0,E.isContentEditable)(e)||t.add(e)}break}case"read-write":{switch(o){case"textarea":{e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled")||t.add(e);break}case"input":{(!e.type||x.test(e.type)||O.test(e.type))&&!(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}default:(0,E.isContentEditable)(e)&&t.add(e)}break}case"placeholder-shown":{let w;o==="textarea"?w=e:o==="input"&&(e.hasAttribute("type")?O.test(e.getAttribute("type"))&&(w=e):w=e),w&&e.value===""&&e.hasAttribute("placeholder")&&e.getAttribute("placeholder").trim().length&&t.add(e);break}case"checked":{(e.checked&&o==="input"&&e.hasAttribute("type")&&y.test(e.getAttribute("type"))||e.selected&&o==="option")&&t.add(e);break}case"indeterminate":{if(e.indeterminate&&o==="input"&&e.type==="checkbox"||o==="progress"&&!e.hasAttribute("value"))t.add(e);else if(o==="input"&&e.type==="radio"&&!e.hasAttribute("checked")){const w=e.name;let g=e.parentNode;for(;g&&g.localName!=="form";)g=g.parentNode;g||(g=b);const _=[].slice.call(g.getElementsByTagName("input"));let S;for(const A of _)if(A.getAttribute("type")==="radio"&&(w?A.getAttribute("name")===w&&(S=!!A.checked):A.hasAttribute("name")||(S=!!A.checked),S))break;S||t.add(e)}break}case"default":{const w=/^(?:button|reset)$/,g=/^(?:image|submit)$/;if(o==="button"&&!(e.hasAttribute("type")&&w.test(e.getAttribute("type")))||o==="input"&&e.hasAttribute("type")&&g.test(e.getAttribute("type"))){let _=e.parentNode;for(;_&&_.localName!=="form";)_=_.parentNode;if(_){const S=i.createNodeIterator(_,l.SHOW_ELEMENT);let A=S.nextNode();for(;A;){const C=A.localName;let v;if(C==="button"?v=!(A.hasAttribute("type")&&w.test(A.getAttribute("type"))):C==="input"&&(v=A.hasAttribute("type")&&g.test(A.getAttribute("type"))),v){A===e&&t.add(e);break}A=S.nextNode()}}}else if(o==="input"&&e.hasAttribute("type")&&y.test(e.getAttribute("type"))&&(e.checked||e.hasAttribute("checked")))t.add(e);else if(o==="option"){let _=!1,S=u;for(;S&&S.localName!=="datalist";){if(S.localName==="select"){(S.multiple||S.hasAttribute("multiple"))&&(_=!0);break}S=S.parentNode}if(_)(e.selected||e.hasAttribute("selected"))&&t.add(e);else{const A=u.firstElementChild,C=new Set;let v=A;for(;v;){if(v.selected||v.hasAttribute("selected")){C.add(v);break}v=v.nextElementSibling}C.size||C.add(A),C.has(e)&&t.add(e)}}break}case"valid":{if(m.test(o))e.checkValidity()&&t.add(e);else if(o==="fieldset"){const w=i.createNodeIterator(e,l.SHOW_ELEMENT);let g=w.nextNode();g===e&&(g=w.nextNode());let _;for(;g&&!(m.test(g.localName)&&(_=g.checkValidity(),!_));)g=w.nextNode();_&&t.add(e)}break}case"invalid":{if(m.test(o))e.checkValidity()||t.add(e);else if(o==="fieldset"){const w=i.createNodeIterator(e,l.SHOW_ELEMENT);let g=w.nextNode();g===e&&(g=w.nextNode());let _;for(;g&&!(m.test(g.localName)&&(_=g.checkValidity(),!_));)g=w.nextNode();_||t.add(e)}break}case"in-range":{o==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&L.test(e.getAttribute("type"))&&!(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&(e.hasAttribute("min")||e.hasAttribute("max")||e.getAttribute("type")==="range")&&t.add(e);break}case"out-of-range":{o==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&L.test(e.getAttribute("type"))&&(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&t.add(e);break}case"required":{let w;if(/^(?:select|textarea)$/.test(o))w=e;else if(o==="input")if(e.hasAttribute("type")){const g=e.getAttribute("type");(g==="file"||y.test(g)||x.test(g)||O.test(g))&&(w=e)}else w=e;w&&(e.required||e.hasAttribute("required"))&&t.add(e);break}case"optional":{let w;if(/^(?:select|textarea)$/.test(o))w=e;else if(o==="input")if(e.hasAttribute("type")){const g=e.getAttribute("type");(g==="file"||y.test(g)||x.test(g)||O.test(g))&&(w=e)}else w=e;w&&!(e.required||e.hasAttribute("required"))&&t.add(e);break}case"root":{e===b&&t.add(e);break}case"empty":{if(e.hasChildNodes()){const w=e.childNodes.values();let g;for(const _ of w)if(g=_.nodeType!==l.ELEMENT_NODE&&_.nodeType!==l.TEXT_NODE,!g)break;g&&t.add(e)}else t.add(e);break}case"first-child":{(u&&e===u.firstElementChild||e===r&&r.nodeType===l.ELEMENT_NODE)&&t.add(e);break}case"last-child":{(u&&e===u.lastElementChild||e===r&&r.nodeType===l.ELEMENT_NODE)&&t.add(e);break}case"only-child":{(u&&e===u.firstElementChild&&e===u.lastElementChild||e===r&&r.nodeType===l.ELEMENT_NODE)&&t.add(e);break}case"first-of-type":{if(u){const[w]=this._collectNthOfType({a:0,b:1},e);w&&t.add(w)}else e===r&&r.nodeType===l.ELEMENT_NODE&&t.add(e);break}case"last-of-type":{if(u){const[w]=this._collectNthOfType({a:0,b:1,reverse:!0},e);w&&t.add(w)}else e===r&&r.nodeType===l.ELEMENT_NODE&&t.add(e);break}case"only-of-type":{if(u){const[w]=this._collectNthOfType({a:0,b:1},e);if(w===e){const[g]=this._collectNthOfType({a:0,b:1,reverse:!0},e);g===e&&t.add(e)}}else e===r&&r.nodeType===l.ELEMENT_NODE&&t.add(e);break}case"host":case"host-context":break;case"after":case"before":case"first-letter":case"first-line":{if(this.#s)throw new DOMException(`Unsupported pseudo-element ::${f}`,l.NOT_SUPPORTED_ERR);break}case"active":case"autofill":case"blank":case"buffering":case"current":case"focus-visible":case"fullscreen":case"future":case"hover":case"modal":case"muted":case"past":case"paused":case"picture-in-picture":case"playing":case"seeking":case"stalled":case"user-invalid":case"user-valid":case"volume-locked":case"-webkit-autofill":{if(this.#s)throw new DOMException(`Unsupported pseudo-class :${f}`,l.NOT_SUPPORTED_ERR);break}default:if(f.startsWith("-webkit-")){if(this.#s)throw new DOMException(`Unsupported pseudo-class :${f}`,l.NOT_SUPPORTED_ERR)}else if(!p)throw new DOMException(`Unknown pseudo-class :${f}`,l.SYNTAX_ERR)}}return t}_matchAttributeSelector(s,e){const{flags:n,matcher:h,name:o,value:u}=s;if(typeof n=="string"&&!/^[is]$/i.test(n)){const t=(0,k.generateCSS)(s);throw new DOMException(`Invalid selector ${t}`,l.SYNTAX_ERR)}const{attributes:p}=e;let f;if(p&&p.length){const{document:t}=this.#t;let i;t.contentType==="text/html"?typeof n=="string"&&/^s$/i.test(n)?i=!1:i=!0:typeof n=="string"&&/^i$/i.test(n)?i=!0:i=!1;let r=(0,k.unescapeSelector)(o.name);i&&(r=r.toLowerCase());const b=new Set;if(r.indexOf("|")>-1){const{prefix:a,tagName:c}=(0,E.selectorToNodeProps)(r);for(let{name:d,value:m}of p)switch(i&&(d=d.toLowerCase(),m=m.toLowerCase()),a){case"":{c===d&&b.add(m);break}case"*":{d.indexOf(":")>-1?d.endsWith(`:${c}`)&&b.add(m):c===d&&b.add(m);break}default:if(d.indexOf(":")>-1){const[N,y]=d.split(":");a===N&&c===y&&(0,E.isNamespaceDeclared)(a,e)&&b.add(m)}}}else for(let{name:a,value:c}of p)if(i&&(a=a.toLowerCase(),c=c.toLowerCase()),a.indexOf(":")>-1){const[d,m]=a.split(":");if(d==="xml"&&m==="lang")continue;r===m&&b.add(c)}else r===a&&b.add(c);if(b.size){const{name:a,value:c}=u||{};let d;switch(a?i?d=a.toLowerCase():d=a:c?i?d=c.toLowerCase():d=c:c===""&&(d=c),h){case"=":{typeof d=="string"&&b.has(d)&&(f=e);break}case"~=":{if(d&&typeof d=="string"){for(const m of b)if(new Set(m.split(/\s+/)).has(d)){f=e;break}}break}case"|=":{if(d&&typeof d=="string"){let m;for(const N of b)if(N===d||N.startsWith(`${d}-`)){m=N;break}m&&(f=e)}break}case"^=":{if(d&&typeof d=="string"){let m;for(const N of b)if(N.startsWith(`${d}`)){m=N;break}m&&(f=e)}break}case"$=":{if(d&&typeof d=="string"){let m;for(const N of b)if(N.endsWith(`${d}`)){m=N;break}m&&(f=e)}break}case"*=":{if(d&&typeof d=="string"){let m;for(const N of b)if(N.includes(`${d}`)){m=N;break}m&&(f=e)}break}case null:default:f=e}}}return f??null}_matchClassSelector(s,e){const n=(0,k.unescapeSelector)(s.name);let h;return e.classList.contains(n)&&(h=e),h??null}_matchIDSelector(s,e){const n=(0,k.unescapeSelector)(s.name),{id:h}=e;let o;return n===h&&(o=e),o??null}_matchTypeSelector(s,e,n={}){const h=(0,k.unescapeSelector)(s.name),{localName:o,prefix:u}=e,{forgive:p}=n,{document:f}=this.#t;let{prefix:t,tagName:i}=(0,E.selectorToNodeProps)(h,e);f.contentType==="text/html"&&(t=t.toLowerCase(),i=i.toLowerCase());let r,b;o.indexOf(":")>-1?[r,b]=o.split(":"):(r=u||"",b=o);let a;if(t===""&&r==="")e.namespaceURI===null&&(i==="*"||i===b)&&(a=e);else if(t==="*")(i==="*"||i===b)&&(a=e);else if(t===r){if((0,E.isNamespaceDeclared)(t,e))(i==="*"||i===b)&&(a=e);else if(!p)throw new DOMException(`Undeclared namespace ${t}`,l.SYNTAX_ERR)}else if(t&&!p&&!(0,E.isNamespaceDeclared)(t,e))throw new DOMException(`Undeclared namespace ${t}`,l.SYNTAX_ERR);return a??null}_matchShadowHostPseudoClass(s,e){const{children:n}=s,h=(0,k.unescapeSelector)(s.name);let o;if(Array.isArray(n)){const[u]=(0,k.walkAST)(n[0]),[...p]=u,{host:f}=e;if(h==="host"){let t;for(const i of p){const{type:r}=i;if(r===l.COMBINATOR){const b=(0,k.generateCSS)(s);throw new DOMException(`Invalid selector ${b}`,l.SYNTAX_ERR)}if(t=this._matchSelector(i,f).has(f),!t)break}t&&(o=e)}else if(h==="host-context"){let t=f,i;for(;t;){for(const r of p){const{type:b}=r;if(b===l.COMBINATOR){const a=(0,k.generateCSS)(s);throw new DOMException(`Invalid selector ${a}`,l.SYNTAX_ERR)}if(i=this._matchSelector(r,t).has(t),!i)break}if(i)break;t=t.parentNode}i&&(o=e)}}else if(h==="host")o=e;else throw new DOMException(`Invalid selector :${h}`,l.SYNTAX_ERR);return o??null}_matchSelector(s,e,n){const{type:h}=s,o=(0,k.unescapeSelector)(s.name),{shadow:u}=this.#t;let p=new Set;if(e.nodeType===l.ELEMENT_NODE)switch(h){case l.SELECTOR_ATTR:{const f=this._matchAttributeSelector(s,e);f&&p.add(f);break}case l.SELECTOR_CLASS:{const f=this._matchClassSelector(s,e);f&&p.add(f);break}case l.SELECTOR_ID:{const f=this._matchIDSelector(s,e);f&&p.add(f);break}case l.SELECTOR_PSEUDO_CLASS:{const f=this._matchPseudoClassSelector(s,e,n);f.size&&(p=f);break}case l.SELECTOR_PSEUDO_ELEMENT:{this._matchPseudoElementSelector(o,n);break}case l.SELECTOR_TYPE:default:{const f=this._matchTypeSelector(s,e,n);f&&p.add(f)}}else if(u&&h===l.SELECTOR_PSEUDO_CLASS&&e.nodeType===l.DOCUMENT_FRAGMENT_NODE){if(o!=="has"&&l.REG_LOGICAL_PSEUDO.test(o)){const f=this._matchPseudoClassSelector(s,e,n);f.size&&(p=f)}else if(l.REG_SHADOW_HOST.test(o)){const f=this._matchShadowHostPseudoClass(s,e);f&&p.add(f)}}return p}_matchLeaves(s,e,n){let h;for(const o of s)if(h=this._matchSelector(o,e,n).has(e),!h)break;return!!h}_findDescendantNodes(s,e){const[n,...h]=s,{type:o}=n,u=(0,k.unescapeSelector)(n.name),p=h.length>0,{document:f,root:t,shadow:i}=this.#t;let r=new Set,b=!1;if(i)b=!0;else switch(o){case l.SELECTOR_ID:{if(t.nodeType===l.ELEMENT_NODE)b=!0;else{const a=t.getElementById(u);if(a&&a!==e){const c=(0,E.isSameOrDescendant)(a,e);let d;c&&(d=a),d&&(p?this._matchLeaves(h,d)&&r.add(d):r.add(d))}}break}case l.SELECTOR_CLASS:{const a=[].slice.call(e.getElementsByClassName(u));if(a.length)if(p)for(const c of a)this._matchLeaves(h,c)&&r.add(c);else r=new Set(a);break}case l.SELECTOR_TYPE:{if(f.contentType==="text/html"&&!/[*|]/.test(u)){const a=[].slice.call(e.getElementsByTagName(u));if(a.length)if(p)for(const c of a)this._matchLeaves(h,c)&&r.add(c);else r=new Set(a)}else b=!0;break}case l.SELECTOR_PSEUDO_ELEMENT:{this._matchPseudoElementSelector(u);break}default:b=!0}return{nodes:r,pending:b}}_matchCombinator(s,e,n={}){const{combo:h,leaves:o}=s,{name:u}=h,{find:p,forgive:f}=n;let t=new Set;if(p===R)switch(u){case"+":{const i=e.nextElementSibling;i&&this._matchLeaves(o,i,{forgive:f})&&t.add(i);break}case"~":{let i=e.nextElementSibling;for(;i;)this._matchLeaves(o,i,{forgive:f})&&t.add(i),i=i.nextElementSibling;break}case">":{const i=[].slice.call(e.children);for(const r of i)this._matchLeaves(o,r,{forgive:f})&&t.add(r);break}case" ":default:{const{nodes:i,pending:r}=this._findDescendantNodes(o,e);if(i.size)t=i;else if(r){const{document:b}=this.#t,a=b.createNodeIterator(e,l.SHOW_ELEMENT);let c=a.nextNode();for(c===e&&(c=a.nextNode());c;)this._matchLeaves(o,c,{forgive:f})&&t.add(c),c=a.nextNode()}}}else switch(u){case"+":{const i=e.previousElementSibling;i&&this._matchLeaves(o,i,{forgive:f})&&t.add(i);break}case"~":{const i=[];let r=e.previousElementSibling;for(;r;)this._matchLeaves(o,r,{forgive:f})&&i.push(r),r=r.previousElementSibling;i.length&&(t=new Set(i.reverse()));break}case">":{const i=e.parentNode;i&&this._matchLeaves(o,i,{forgive:f})&&t.add(i);break}case" ":default:{const i=[];let r=e.parentNode;for(;r;)this._matchLeaves(o,r,{forgive:f})&&i.push(r),r=r.parentNode;i.length&&(t=new Set(i.reverse()))}}return t}_findNodes(s,e){const{leaves:[n,...h]}=s,{type:o}=n,u=(0,k.unescapeSelector)(n.name),p=h.length>0,{document:f,root:t,shadow:i}=this.#t;let r=new Set,b=!1;switch(o){case l.SELECTOR_ID:{let a;if(e===P)this._matchLeaves([n],this.#e)&&(a=this.#e);else if(e===D){let c=this.#e;for(;c;){if(this._matchLeaves([n],c)){a=c;break}c=c.parentNode}}else e===I||t.nodeType===l.ELEMENT_NODE?b=!0:a=t.getElementById(u);a&&(p?this._matchLeaves(h,a)&&r.add(a):r.add(a));break}case l.SELECTOR_CLASS:{let a=[];if(e===P)this.#e.nodeType===l.ELEMENT_NODE&&this.#e.classList.contains(u)&&a.push(this.#e);else if(e===D){let c=this.#e;for(;c&&c.nodeType===l.ELEMENT_NODE;)c.classList.contains(u)&&a.push(c),c=c.parentNode}else if(t.nodeType===l.DOCUMENT_FRAGMENT_NODE){const c=[].slice.call(t.children);for(const d of c){d.classList.contains(u)&&a.push(d);const m=[].slice.call(d.getElementsByClassName(u));a.push(...m)}}else{const c=[].slice.call(t.getElementsByClassName(u));if(this.#e.nodeType===l.ELEMENT_NODE)for(const d of c)if(d===this.#e)a.push(d);else{const m=d.compareDocumentPosition(this.#e);(m&l.DOCUMENT_POSITION_CONTAINED_BY||m&l.DOCUMENT_POSITION_CONTAINS)&&a.push(d)}else a=c}if(a.length)if(p)for(const c of a)this._matchLeaves(h,c)&&r.add(c);else r=new Set(a);break}case l.SELECTOR_TYPE:{let a=[];if(e===P)this.#e.nodeType===l.ELEMENT_NODE&&this._matchLeaves([n],this.#e)&&a.push(this.#e);else if(e===D){let c=this.#e;for(;c&&c.nodeType===l.ELEMENT_NODE;)this._matchLeaves([n],c)&&a.push(c),c=c.parentNode}else if(f.contentType!=="text/html"||/[*|]/.test(u))b=!0;else if(t.nodeType===l.DOCUMENT_FRAGMENT_NODE){const c=u.toLowerCase(),d=[].slice.call(t.children);for(const m of d){m.localName===c&&a.push(m);const N=[].slice.call(m.getElementsByTagName(u));a.push(...N)}}else{const c=[].slice.call(t.getElementsByTagName(u));if(this.#e.nodeType===l.ELEMENT_NODE)for(const d of c)if(d===this.#e)a.push(d);else{const m=d.compareDocumentPosition(this.#e);(m&l.DOCUMENT_POSITION_CONTAINED_BY||m&l.DOCUMENT_POSITION_CONTAINS)&&a.push(d)}else a=c}if(a.length)if(p)for(const c of a)this._matchLeaves(h,c)&&r.add(c);else r=new Set(a);break}case l.SELECTOR_PSEUDO_ELEMENT:{this._matchPseudoElementSelector(u);break}default:{const a=[];if(e!==D&&l.REG_SHADOW_HOST.test(u)){if(i&&this.#e.nodeType===l.DOCUMENT_FRAGMENT_NODE){const c=this._matchShadowHostPseudoClass(n,this.#e);c&&a.push(c)}}else if(e===P)this._matchLeaves([n],this.#e)&&a.push(this.#e);else if(e===D){let c=this.#e;for(;c;)this._matchLeaves([n],c)&&a.push(c),c=c.parentNode}else b=!0;if(a.length)if(p)for(const c of a)this._matchLeaves(h,c)&&r.add(c);else r=new Set(a)}}if(p&&!b&&!r.size){const a=h[h.length-1],{type:c}=a;if(c===l.SELECTOR_PSEUDO_CLASS){let d;t.nodeType===l.ELEMENT_NODE?d=t:d=t.firstElementChild,this._matchPseudoClassSelector(a,d)}}return{nodes:r,pending:b}}_getFirstTwig(s){const e=s.length-1,n=s[0];let h,o;if(e){const u=s[e],{leaves:[{type:p}]}=u;p===l.SELECTOR_PSEUDO_ELEMENT||p===l.SELECTOR_ID?(h=U,o=u):(h=R,o=n)}else h=U,o=n;return{find:h,twig:o}}_collectNodes(s){const e=this.#i.values();if(s===I||s===$){const n=new Set;let h=0;for(const{branch:o}of e){const{find:u,twig:p}=this._getFirstTwig(o),{nodes:f,pending:t}=this._findNodes(p,s);f.size?this.#l[h]=f:t?n.add(new Map([["index",h],["twig",p]])):this.#i[h].skip=!0,this.#i[h].find=u,h++}if(n.size){const{document:o,root:u}=this.#t,p=o.createNodeIterator(u,l.SHOW_ELEMENT);let f=p.nextNode();for(;f;){let t=!1;if(this.#e.nodeType===l.ELEMENT_NODE?t=(0,E.isSameOrDescendant)(f,this.#e):t=!0,t)for(const i of n){const{leaves:r}=i.get("twig");if(this._matchLeaves(r,f)){const a=i.get("index");this.#l[a].add(f)}}f=p.nextNode()}}}else{let n=0;for(const{branch:h}of e){const o=h[h.length-1],{nodes:u}=this._findNodes(o,s);u.size?this.#l[n]=u:this.#i[n].skip=!0,this.#i[n].find=U,n++}}return[this.#i,this.#l]}_sortNodes(s){const e=[...s];return e.length>1&&e.sort((n,h)=>{const o=n.compareDocumentPosition(h);let u;return o&l.DOCUMENT_POSITION_PRECEDING||o&l.DOCUMENT_POSITION_CONTAINS?u=1:u=-1,u}),e}_matchNodes(s){const[...e]=this.#i,n=e.length;let h=new Set;for(let o=0;o<n;o++){const{branch:u,find:p,skip:f}=e[o],t=u.length;if(!f&&t){const i=this.#l[o],r=t-1;if(r===0)if((s===I||s===$)&&this.#e.nodeType===l.ELEMENT_NODE){for(const b of i)if(b!==this.#e&&(0,E.isSameOrDescendant)(b,this.#e)&&(h.add(b),s===$))break}else if(s===$){const[b]=this._sortNodes(i);h.add(b)}else{const b=[...h],a=[...i];h=new Set([...b,...a])}else if(p===R){let{combo:b}=u[0];for(const a of i){let c=new Set([a]);for(let d=1;d<t;d++){const{combo:m,leaves:N}=u[d],y=[];for(const x of c){const L={combo:b,leaves:N},O=this._matchCombinator(L,x,{find:p});O.size&&y.push(...O)}if(y.length)if(d===r){if(s===$){const[x]=this._sortNodes(y);h.add(x)}else{const x=[...h];h=new Set([...x,...y])}break}else b=m,c=new Set(y);else break}}}else for(const b of i){let a=new Set([b]),c;for(let d=r-1;d>=0;d--){const m=u[d],N=[];for(const y of a){const x=this._matchCombinator(m,y,{find:p});x.size&&N.push(...x)}if(N.length)if(c=!0,d===0){h.add(b);break}else a=new Set(N);else{c=!1;break}}if(c&&s!==I)break}}}return h}_find(s){return this._collectNodes(s),this._matchNodes(s)}matches(){if(this.#e.nodeType!==l.ELEMENT_NODE)throw new TypeError(`Unexpected node ${this.#e.nodeName}`);let s;try{s=this._find(P).has(this.#e)}catch(e){this._onError(e)}return!!s}closest(){if(this.#e.nodeType!==l.ELEMENT_NODE)throw new TypeError(`Unexpected node ${this.#e.nodeName}`);let s;try{const e=this._find(D);let n=this.#e;for(;n;){if(e.has(n)){s=n;break}n=n.parentNode}}catch(e){this._onError(e)}return s??null}querySelector(){let s;try{const e=this._find($);e.delete(this.#e),e.size&&([s]=this._sortNodes(e))}catch(e){this._onError(e)}return s??null}querySelectorAll(){let s;try{const e=this._find(I);e.delete(this.#e),e.size&&(s=this._sortNodes(e))}catch(e){this._onError(e)}return s??[]}}0&&(module.exports={Matcher});
//# sourceMappingURL=matcher.js.map
