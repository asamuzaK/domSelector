var G=Object.create;var $=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var q=Object.getOwnPropertyNames;var Y=Object.getPrototypeOf,X=Object.prototype.hasOwnProperty;var K=(_,r)=>{for(var e in r)$(_,e,{get:r[e],enumerable:!0})},U=(_,r,e,c)=>{if(r&&typeof r=="object"||typeof r=="function")for(let h of q(r))!X.call(_,h)&&h!==e&&$(_,h,{get:()=>r[h],enumerable:!(c=W(r,h))||c.enumerable});return _};var Z=(_,r,e)=>(e=_!=null?G(Y(_)):{},U(r||!_||!_.__esModule?$(e,"default",{value:_,enumerable:!0}):e,_)),J=_=>U($({},"__esModule",{value:!0}),_);var ie={};K(ie,{Matcher:()=>se});module.exports=J(ie);var R=Z(require("is-potential-custom-element-name"),1),k=require("./dom-util.js"),g=require("./parser.js"),b=require("./constant.js");const P="[A-Z\\d]+",T=`(?:-${P})*`,C="all",v="first",x="lineal",S="self",B=/^(?:(?:fieldse|inpu|selec)t|button|opt(?:group|ion)|textarea)$/,O=/^(?:(?:(?:in|out)pu|selec)t|button|form|textarea)$/,z=/^a(?:rea)?$/,F=/^d(?:etails|ialog)$/,I=/^(?:checkbox|radio)$/,L=/^(?:(?:emai|te|ur)l|number|password|search|text)$/,V=/(?:(?:rang|tim)e|date(?:time-local)?|month|number|week)$/,j=/^(?:button|reset)$/,H=/^(?:image|submit)$/,D=/^(?:date(?:time-local)?|month|time|week)$/,Q=/^(?:(?:ha|i)s|not|where)$/,ee=/^nth-(?:last-)?(?:child|of-type)$/,te=new RegExp(`^(?:\\*-)?${P}${T}$`,"i");class se{#s;#l;#a;#e;#r;#t;#o;#c;#i;constructor(r,e,c={}){const{sort:h,warn:o}=c;this.#l=new Map([[b.PSEUDO_ELEMENT_SELECTOR,b.BIT_1],[b.ID_SELECTOR,b.BIT_10],[b.CLASS_SELECTOR,b.BIT_100],[b.TYPE_SELECTOR,b.BIT_1000],[b.ATTRIBUTE_SELECTOR,b.BIT_10000],[b.PSEUDO_CLASS_SELECTOR,b.BIT_100000]]),this.#a=new WeakMap,this.#o=r,this.#e=e,this.#c=!!h,this.#i=!!o,[this.#s,this.#r]=this._prepare(r),this.#t=this._getRoot(e)}_onError(r){if(r instanceof DOMException&&r.name===b.NOT_SUPPORTED_ERR)this.#i&&console.warn(r.message);else throw r}_getRoot(r=this.#e){let e,c;switch(r.nodeType){case b.DOCUMENT_NODE:{e=r,c=r;break}case b.DOCUMENT_FRAGMENT_NODE:{e=r.ownerDocument,c=r;break}case b.ELEMENT_NODE:{if((0,k.isSameOrDescendant)(r))e=r.ownerDocument,c=r.ownerDocument;else{let h=r;for(;h&&h.parentNode;)h=h.parentNode;e=h.ownerDocument,c=h}break}default:throw new TypeError(`Unexpected node ${r.nodeName}`)}return{document:e,root:c}}_sortLeaves(r){const e=[...r];return e.length>1&&e.sort((c,h)=>{const{type:o}=c,{type:d}=h,p=this.#l.get(o),u=this.#l.get(d);let t;return p===u?t=0:p>u?t=1:t=-1,t}),e}_prepare(r=this.#o){const e=(0,g.parseSelector)(r),c=(0,g.walkAST)(e),h=[],o=[];let d=0;for(const[...p]of c){const u=[];let t=p.shift();if(t&&t.type!==b.COMBINATOR){const s=new Set;for(;t;){if(t.type===b.COMBINATOR){const[f]=p;if(f.type===b.COMBINATOR){const n=`Invalid combinator ${t.name}${f.name}`;throw new DOMException(n,b.SYNTAX_ERR)}u.push({combo:t,leaves:this._sortLeaves(s)}),s.clear()}else t&&s.add(t);if(p.length)t=p.shift();else{u.push({combo:null,leaves:this._sortLeaves(s)}),s.clear();break}}}h.push({branch:u,find:null,skip:!1}),o[d]=new Set,d++}return[h,o]}_collectNthChild(r,e){const{a:c,b:h,reverse:o,selector:d}=r,{parentNode:p}=e,u=new Set;let t;if(d&&(this.#a.has(d)?t=this.#a.get(d):(t=(0,g.walkAST)(d),this.#a.set(d,t))),p){const s=[...p.children],f=s.length;if(f){const n=new Set;if(t){const i=t.length;for(const a of s){let l;for(let m=0;m<i;m++){const N=t[m];if(l=this._matchLeaves(N,a),!l)break}l&&n.add(a)}}if(o&&s.reverse(),c===0){if(h>0&&h<=f){if(n.size)for(let i=0;i<f;i++){const a=s[i];if(n.has(a)){u.add(a);break}}else if(!d){const i=s[h-1];u.add(i)}}}else{let i=h-1;if(c>0)for(;i<0;)i+=c;if(i>=0&&i<f){let a=c>0?0:h-1;for(let l=0;l<f&&i>=0&&i<f;l++){const m=s[l];n.size?n.has(m)&&(a===i&&(u.add(m),i+=c),c>0?a++:a--):l===i&&(d||u.add(m),i+=c)}}}}}else{const{root:s}=this.#t;if(s.nodeType===b.ELEMENT_NODE&&e===s&&c+h===1)if(t){const f=t.length;let n;for(let i=0;i<f;i++){const a=t[i];if(n=this._matchLeaves(a,e),n)break}n&&u.add(e)}else u.add(e)}return u}_collectNthOfType(r,e){const{a:c,b:h,reverse:o}=r,{localName:d,parentNode:p,prefix:u}=e,t=new Set;if(p){const s=[...p.children],f=s.length;if(f)if(o&&s.reverse(),c===0){if(h>0&&h<=f){let n=0;for(let i=0;i<f;i++){const a=s[i],{localName:l,prefix:m}=a;if(l===d&&m===u){if(n===h-1){t.add(a);break}n++}}}}else{let n=h-1;if(c>0)for(;n<0;)n+=c;if(n>=0&&n<f){let i=c>0?0:h-1;for(let a=0;a<f;a++){const l=s[a],{localName:m,prefix:N}=l;if(m===d&&N===u){if(i===n&&(t.add(l),n+=c),n<0||n>=f)break;c>0?i++:i--}}}}}else{const{root:s}=this.#t;s.nodeType===b.ELEMENT_NODE&&e===s&&c+h===1&&t.add(e)}return t}_matchAnPlusB(r,e,c){const{nth:{a:h,b:o,name:d},selector:p}=r,u=(0,g.unescapeSelector)(d),t=new Map;u?(u==="even"?(t.set("a",2),t.set("b",0)):u==="odd"&&(t.set("a",2),t.set("b",1)),/last/.test(c)&&t.set("reverse",!0)):(typeof h=="string"&&/-?\d+/.test(h)?t.set("a",h*1):t.set("a",0),typeof o=="string"&&/-?\d+/.test(o)?t.set("b",o*1):t.set("b",0),/last/.test(c)&&t.set("reverse",!0));let s=new Set;if(t.has("a")&&t.has("b")){if(/^nth-(?:last-)?child$/.test(c)){p&&t.set("selector",p);const f=Object.fromEntries(t),n=this._collectNthChild(f,e);n.size&&(s=n)}else if(/^nth-(?:last-)?of-type$/.test(c)){const f=Object.fromEntries(t),n=this._collectNthOfType(f,e);n.size&&(s=n)}}return s}_matchPseudoElementSelector(r,e={}){const{forgive:c}=e;switch(r){case"after":case"backdrop":case"before":case"cue":case"cue-region":case"first-letter":case"first-line":case"file-selector-button":case"marker":case"part":case"placeholder":case"selection":case"slotted":case"target-text":{if(this.#i)throw new DOMException(`Unsupported pseudo-element ::${r}`,b.NOT_SUPPORTED_ERR);break}default:if(r.startsWith("-webkit-")){if(this.#i)throw new DOMException(`Unsupported pseudo-element ::${r}`,b.NOT_SUPPORTED_ERR)}else if(!c)throw new DOMException(`Unknown pseudo-element ::${r}`,b.SYNTAX_ERR)}}_matchDirectionPseudoClass(r,e){const c=(0,g.unescapeSelector)(r.name),h=(0,k.getDirectionality)(e);let o;return c===h&&(o=e),o??null}_matchLanguagePseudoClass(r,e){const c=(0,g.unescapeSelector)(r.name);let h;if(c){if(c==="*")if(e.hasAttribute("lang"))e.getAttribute("lang")&&(h=e);else{let o=e.parentNode;for(;o;){if(o.hasAttribute("lang")){o.getAttribute("lang")&&(h=e);break}o=o.parentNode}}else if(te.test(c)){let o;if(/-/.test(c)){const[d,p,...u]=c.split("-");let t;d==="*"?t=`${P}${T}`:t=`${d}${T}`;const s=`-${p}${T}`,f=u.length;let n="";if(f)for(let i=0;i<f;i++)n+=`-${u[i]}${T}`;o=new RegExp(`^${t}${s}${n}$`,"i")}else o=new RegExp(`^${c}${T}$`,"i");if(e.hasAttribute("lang"))o.test(e.getAttribute("lang"))&&(h=e);else{let d=e.parentNode;for(;d;){if(d.hasAttribute("lang")){const p=d.getAttribute("lang");o.test(p)&&(h=e);break}d=d.parentNode}}}}return h??null}_matchHasPseudoFunc(r,e){let c;if(Array.isArray(r)&&r.length){const[h]=r,{type:o}=h;let d;o===b.COMBINATOR?d=r.shift():d={name:" ",type:b.COMBINATOR};const p=[];for(;r.length;){const[s]=r,{type:f}=s;if(f===b.COMBINATOR)break;p.push(r.shift())}const u={combo:d,leaves:p},t=this._matchCombinator(u,e,{find:"next"});if(t.size)if(r.length){for(const s of t)if(c=this._matchHasPseudoFunc(Object.assign([],r),s),c)break}else c=!0}return!!c}_matchLogicalPseudoFunc(r,e){const{astName:c="",branches:h=[],selector:o="",twigBranches:d=[]}=r;let p;if(c==="has")if(o.includes(":has("))p=null;else{const u=h.length;let t;for(let s=0;s<u;s++){const f=h[s];if(t=this._matchHasPseudoFunc(Object.assign([],f),e),t)break}t&&(p=e)}else{const u=/^(?:is|where)$/.test(c),t=d.length;let s;for(let f=0;f<t;f++){const n=d[f],i=n.length-1,{leaves:a}=n[i];if(s=this._matchLeaves(a,e,{forgive:u}),s&&i>0){let l=new Set([e]);for(let m=i-1;m>=0;m--){const N=n[m],w=[];for(const y of l){const A=this._matchCombinator(N,y,{forgive:u,find:"prev"});A.size&&w.push(...A)}const E=new Set(w);if(E.size)if(m===0){s=!0;break}else l=E;else{s=!1;break}}}if(s)break}c==="not"?s||(p=e):s&&(p=e)}return p??null}_matchPseudoClassSelector(r,e,c={}){const{children:h}=r,{localName:o,parentNode:d}=e,{forgive:p}=c,u=(0,g.unescapeSelector)(r.name);let t=new Set;if(Q.test(u)){let s;if(this.#a.has(r))s=this.#a.get(r);else{const n=(0,g.walkAST)(r),i=[],a=[];for(const[...l]of n){for(const E of l){const y=(0,g.generateCSS)(E);i.push(y)}const m=[],N=new Set;let w=l.shift();for(;w;)if(w.type===b.COMBINATOR?(m.push({combo:w,leaves:[...N]}),N.clear()):w&&N.add(w),l.length)w=l.shift();else{m.push({combo:null,leaves:[...N]}),N.clear();break}a.push(m)}s={astName:u,branches:n,twigBranches:a,selector:i.join(",")},this.#a.set(r,s)}const f=this._matchLogicalPseudoFunc(s,e);f&&t.add(f)}else if(Array.isArray(h)){const[s]=h;if(ee.test(u)){const f=this._matchAnPlusB(s,e,u);f.size&&(t=f)}else if(u==="dir"){const f=this._matchDirectionPseudoClass(s,e);f&&t.add(f)}else if(u==="lang"){const f=this._matchLanguagePseudoClass(s,e);f&&t.add(f)}else switch(u){case"current":case"nth-col":case"nth-last-col":{if(this.#i)throw new DOMException(`Unsupported pseudo-class :${u}()`,b.NOT_SUPPORTED_ERR);break}default:if(!p)throw new DOMException(`Unknown pseudo-class :${u}()`,b.SYNTAX_ERR)}}else{const{document:s,root:f}=this.#t,{documentElement:n}=s,i=new URL(s.URL);switch(u){case"any-link":case"link":{z.test(o)&&e.hasAttribute("href")&&t.add(e);break}case"local-link":{if(z.test(o)&&e.hasAttribute("href")){const a=new URL(e.getAttribute("href"),i.href);a.origin===i.origin&&a.pathname===i.pathname&&t.add(e)}break}case"visited":break;case"target":{(0,k.isSameOrDescendant)(e)&&i.hash&&e.id&&i.hash===`#${e.id}`&&t.add(e);break}case"target-within":{if(i.hash){const a=i.hash.replace(/^#/,"");let l=s.getElementById(a);for(;l;){if(l===e){t.add(e);break}l=l.parentNode}}break}case"scope":{this.#e.nodeType===b.ELEMENT_NODE?e===this.#e&&t.add(e):e===n&&t.add(e);break}case"focus":{e===s.activeElement&&t.add(e);break}case"focus-within":{let a=s.activeElement;for(;a;){if(a===e){t.add(e);break}a=a.parentNode}break}case"open":{F.test(o)&&e.hasAttribute("open")&&t.add(e);break}case"closed":{F.test(o)&&!e.hasAttribute("open")&&t.add(e);break}case"disabled":{if(B.test(o)||(0,R.default)(o))if(e.disabled||e.hasAttribute("disabled"))t.add(e);else{let a=d;for(;a&&a.localName!=="fieldset";)a=a.parentNode;a&&a.hasAttribute("disabled")&&d.localName!=="legend"&&t.add(e)}break}case"enabled":{(B.test(o)||(0,R.default)(o))&&!(e.disabled&&e.hasAttribute("disabled"))&&t.add(e);break}case"read-only":{switch(o){case"textarea":{(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}case"input":{(!e.type||L.test(e.type)||D.test(e.type))&&(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}default:(0,k.isContentEditable)(e)||t.add(e)}break}case"read-write":{switch(o){case"textarea":{e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled")||t.add(e);break}case"input":{(!e.type||L.test(e.type)||D.test(e.type))&&!(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}default:(0,k.isContentEditable)(e)&&t.add(e)}break}case"placeholder-shown":{let a;o==="textarea"?a=e:o==="input"&&(e.hasAttribute("type")?L.test(e.getAttribute("type"))&&(a=e):a=e),a&&e.hasAttribute("placeholder")&&e.getAttribute("placeholder").trim().length&&e.value===""&&t.add(e);break}case"checked":{(o==="input"&&e.hasAttribute("type")&&I.test(e.getAttribute("type"))&&e.checked||o==="option"&&e.selected)&&t.add(e);break}case"indeterminate":{if(o==="input"&&e.type==="checkbox"&&e.indeterminate||o==="progress"&&!e.hasAttribute("value"))t.add(e);else if(o==="input"&&e.type==="radio"&&!e.hasAttribute("checked")){const a=e.name;let l=e.parentNode;for(;l&&l.localName!=="form";)l=l.parentNode;l||(l=n);const m=[...l.getElementsByTagName("input")];let N;for(const w of m)if(w.getAttribute("type")==="radio"&&(a?w.getAttribute("name")===a&&(N=!!w.checked):w.hasAttribute("name")||(N=!!w.checked),N))break;N||t.add(e)}break}case"default":{if(o==="button"&&!(e.hasAttribute("type")&&j.test(e.getAttribute("type")))||o==="input"&&e.hasAttribute("type")&&H.test(e.getAttribute("type"))){let a=e.parentNode;for(;a&&a.localName!=="form";)a=a.parentNode;if(a){const l=s.createNodeIterator(a,b.SHOW_ELEMENT);let m=l.nextNode();for(;m;){const N=m.localName;let w;if(N==="button"?w=!(m.hasAttribute("type")&&j.test(m.getAttribute("type"))):N==="input"&&(w=m.hasAttribute("type")&&H.test(m.getAttribute("type"))),w){m===e&&t.add(e);break}m=l.nextNode()}}}else if(o==="input"&&e.hasAttribute("type")&&I.test(e.getAttribute("type"))&&(e.checked||e.hasAttribute("checked")))t.add(e);else if(o==="option"){let a=!1,l=d;for(;l&&l.localName!=="datalist";){if(l.localName==="select"){(l.multiple||l.hasAttribute("multiple"))&&(a=!0);break}l=l.parentNode}if(a)(e.selected||e.hasAttribute("selected"))&&t.add(e);else{const m=d.firstElementChild,N=new Set;let w=m;for(;w;){if(w.selected||w.hasAttribute("selected")){N.add(w);break}w=w.nextElementSibling}N.size||N.add(m),N.has(e)&&t.add(e)}}break}case"valid":{if(O.test(o))e.checkValidity()&&t.add(e);else if(/^fieldset$/.test(o)){const a=s.createNodeIterator(e,b.SHOW_ELEMENT);let l=a.nextNode();l===e&&(l=a.nextNode());let m;for(;l&&!(O.test(l.localName)&&(m=l.checkValidity(),!m));)l=a.nextNode();m&&t.add(e)}break}case"invalid":{if(O.test(o))e.checkValidity()||t.add(e);else if(/^fieldset$/.test(o)){const a=s.createNodeIterator(e,b.SHOW_ELEMENT);let l=a.nextNode();l===e&&(l=a.nextNode());let m;for(;l&&!(O.test(l.localName)&&(m=l.checkValidity(),!m));)l=a.nextNode();m||t.add(e)}break}case"in-range":{o==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&V.test(e.getAttribute("type"))&&!(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&(e.hasAttribute("min")||e.hasAttribute("max")||e.getAttribute("type")==="range")&&t.add(e);break}case"out-of-range":{o==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&V.test(e.getAttribute("type"))&&(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&t.add(e);break}case"required":{let a;if(/^(?:select|textarea)$/.test(o))a=e;else if(o==="input")if(e.hasAttribute("type")){const l=e.getAttribute("type");(L.test(l)||I.test(l)||D.test(l)||l==="file")&&(a=e)}else a=e;a&&(e.required||e.hasAttribute("required"))&&t.add(e);break}case"optional":{let a;if(/^(?:select|textarea)$/.test(o))a=e;else if(o==="input")if(e.hasAttribute("type")){const l=e.getAttribute("type");(L.test(l)||I.test(l)||D.test(l)||l==="file")&&(a=e)}else a=e;a&&!(e.required||e.hasAttribute("required"))&&t.add(e);break}case"root":{e===n&&t.add(e);break}case"empty":{if(e.hasChildNodes()){const a=e.childNodes.values();let l;for(const m of a)if(l=m.nodeType!==b.ELEMENT_NODE&&m.nodeType!==b.TEXT_NODE,!l)break;l&&t.add(e)}else t.add(e);break}case"first-child":{(d&&e===d.firstElementChild||f.nodeType===b.ELEMENT_NODE&&e===f)&&t.add(e);break}case"last-child":{(d&&e===d.lastElementChild||f.nodeType===b.ELEMENT_NODE&&e===f)&&t.add(e);break}case"only-child":{(d&&e===d.firstElementChild&&e===d.lastElementChild||f.nodeType===b.ELEMENT_NODE&&e===f)&&t.add(e);break}case"first-of-type":{if(d){const[a]=this._collectNthOfType({a:0,b:1},e);a&&t.add(a)}else f.nodeType===b.ELEMENT_NODE&&e===f&&t.add(e);break}case"last-of-type":{if(d){const[a]=this._collectNthOfType({a:0,b:1,reverse:!0},e);a&&t.add(a)}else f.nodeType===b.ELEMENT_NODE&&e===f&&t.add(e);break}case"only-of-type":{if(d){const[a]=this._collectNthOfType({a:0,b:1},e);if(a===e){const[l]=this._collectNthOfType({a:0,b:1,reverse:!0},e);l===e&&t.add(e)}}else f.nodeType===b.ELEMENT_NODE&&e===f&&t.add(e);break}case"after":case"before":case"first-letter":case"first-line":{if(this.#i)throw new DOMException(`Unsupported pseudo-element ::${u}`,b.NOT_SUPPORTED_ERR);break}case"active":case"autofill":case"blank":case"buffering":case"current":case"focus-visible":case"fullscreen":case"future":case"hover":case"modal":case"muted":case"past":case"paused":case"picture-in-picture":case"playing":case"seeking":case"stalled":case"user-invalid":case"user-valid":case"volume-locked":case"-webkit-autofill":{if(this.#i)throw new DOMException(`Unsupported pseudo-class :${u}`,b.NOT_SUPPORTED_ERR);break}default:if(u.startsWith("-webkit-")){if(this.#i)throw new DOMException(`Unsupported pseudo-class :${u}`,b.NOT_SUPPORTED_ERR)}else if(!p)throw new DOMException(`Unknown pseudo-class :${u}`,b.SYNTAX_ERR)}}return t}_matchAttributeSelector(r,e){const{flags:c,matcher:h,name:o,value:d}=r;if(typeof c=="string"&&!/^[is]$/i.test(c))throw new DOMException("Invalid attribute selector",b.SYNTAX_ERR);const{attributes:p}=e;let u;if(p&&p.length){const{document:t}=this.#t;let s;t.contentType==="text/html"?typeof c=="string"&&/^s$/i.test(c)?s=!1:s=!0:typeof c=="string"&&/^i$/i.test(c)?s=!0:s=!1;let{name:f}=o;f=(0,g.unescapeSelector)(f),s&&(f=f.toLowerCase());const n=new Set;if(/\|/.test(f)){const{prefix:i,tagName:a}=(0,k.selectorToNodeProps)(f);for(let{name:l,value:m}of p)switch(s&&(l=l.toLowerCase(),m=m.toLowerCase()),i){case"":{a===l&&n.add(m);break}case"*":{/:/.test(l)?l.endsWith(`:${a}`)&&n.add(m):a===l&&n.add(m);break}default:if(/:/.test(l)){const[N,w]=l.split(":");i===N&&a===w&&(0,k.isNamespaceDeclared)(i,e)&&n.add(m)}}}else for(let{name:i,value:a}of p)if(s&&(i=i.toLowerCase(),a=a.toLowerCase()),/:/.test(i)){const[l,m]=i.split(":");if(l==="xml"&&m==="lang")continue;f===m&&n.add(a)}else f===i&&n.add(a);if(n.size){const{name:i,value:a}=d||{};let l;switch(i?s?l=i.toLowerCase():l=i:a?s?l=a.toLowerCase():l=a:a===""&&(l=a),h){case"=":{typeof l=="string"&&n.has(l)&&(u=e);break}case"~=":{if(l&&typeof l=="string"){for(const m of n)if(new Set(m.split(/\s+/)).has(l)){u=e;break}}break}case"|=":{if(l&&typeof l=="string"){let m;for(const N of n)if(N===l||N.startsWith(`${l}-`)){m=N;break}m&&(u=e)}break}case"^=":{if(l&&typeof l=="string"){let m;for(const N of n)if(N.startsWith(`${l}`)){m=N;break}m&&(u=e)}break}case"$=":{if(l&&typeof l=="string"){let m;for(const N of n)if(N.endsWith(`${l}`)){m=N;break}m&&(u=e)}break}case"*=":{if(l&&typeof l=="string"){let m;for(const N of n)if(N.includes(`${l}`)){m=N;break}m&&(u=e)}break}case null:default:u=e}}}return u??null}_matchClassSelector(r,e){const c=(0,g.unescapeSelector)(r.name);let h;return e.classList.contains(c)&&(h=e),h??null}_matchIDSelector(r,e){const{id:c}=e,h=(0,g.unescapeSelector)(r.name);let o;return h===c&&(o=e),o??null}_matchTypeSelector(r,e){const c=(0,g.unescapeSelector)(r.name),{localName:h,prefix:o}=e,{document:d}=this.#t;let{prefix:p,tagName:u}=(0,k.selectorToNodeProps)(c,e);d.contentType==="text/html"&&(p=p.toLowerCase(),u=u.toLowerCase());let t,s;/:/.test(h)?[t,s]=h.split(":"):(t=o||"",s=h);let f;return p===""&&t===""?e.namespaceURI===null&&(u==="*"||u===s)&&(f=e):p==="*"?(u==="*"||u===s)&&(f=e):p===t&&(0,k.isNamespaceDeclared)(p,e)&&(u==="*"||u===s)&&(f=e),f??null}_matchSelector(r,e,c){const{type:h}=r;let o=new Set;if(e.nodeType===b.ELEMENT_NODE)switch(h){case b.ATTRIBUTE_SELECTOR:{const d=this._matchAttributeSelector(r,e);d&&o.add(d);break}case b.CLASS_SELECTOR:{const d=this._matchClassSelector(r,e);d&&o.add(d);break}case b.ID_SELECTOR:{const d=this._matchIDSelector(r,e);d&&o.add(d);break}case b.PSEUDO_CLASS_SELECTOR:{const d=this._matchPseudoClassSelector(r,e,c);d.size&&(o=d);break}case b.PSEUDO_ELEMENT_SELECTOR:{const d=(0,g.unescapeSelector)(r.name);this._matchPseudoElementSelector(d,c);break}case b.TYPE_SELECTOR:default:{const d=this._matchTypeSelector(r,e);d&&o.add(d)}}return o}_matchLeaves(r,e,c){let h;for(const o of r)if(h=this._matchSelector(o,e,c).has(e),!h)break;return!!h}_findDescendantNodes(r,e){const[c,...h]=r,{type:o}=c,d=(0,g.unescapeSelector)(c.name),p=h.length>0,u=new Set;let t=!1;switch(o){case b.ID_SELECTOR:{const{root:s}=this.#t;if(s.nodeType===b.ELEMENT_NODE)t=!0;else{const f=s.getElementById(d);if(f&&f!==e){const n=(0,k.isSameOrDescendant)(f,e);let i;n&&(i=f),i&&(p?this._matchLeaves(h,i)&&u.add(i):u.add(i))}}break}case b.PSEUDO_ELEMENT_SELECTOR:{this._matchPseudoElementSelector(d);break}default:t=!0}return{nodes:u,pending:t}}_matchCombinator(r,e,c={}){const{combo:h,leaves:o}=r,{name:d}=h,{find:p,forgive:u}=c;let t=new Set;if(p==="next")switch(d){case"+":{const s=e.nextElementSibling;s&&this._matchLeaves(o,s,{forgive:u})&&t.add(s);break}case"~":{let s=e.nextElementSibling;for(;s;)this._matchLeaves(o,s,{forgive:u})&&t.add(s),s=s.nextElementSibling;break}case">":{const s=[...e.children];for(const f of s)this._matchLeaves(o,f,{forgive:u})&&t.add(f);break}case" ":default:{const{nodes:s,pending:f}=this._findDescendantNodes(o,e);if(s.size)t=s;else if(f){const{document:n}=this.#t,i=n.createNodeIterator(e,b.SHOW_ELEMENT);let a=i.nextNode();for(a===e&&(a=i.nextNode());a;)this._matchLeaves(o,a,{forgive:u})&&t.add(a),a=i.nextNode()}}}else switch(d){case"+":{const s=e.previousElementSibling;s&&this._matchLeaves(o,s,{forgive:u})&&t.add(s);break}case"~":{const s=[];let f=e.previousElementSibling;for(;f;)this._matchLeaves(o,f,{forgive:u})&&s.push(f),f=f.previousElementSibling;s.length&&(t=new Set(s.reverse()));break}case">":{const s=e.parentNode;s&&this._matchLeaves(o,s,{forgive:u})&&t.add(s);break}case" ":default:{const s=[];let f=e.parentNode;for(;f;)this._matchLeaves(o,f,{forgive:u})&&s.push(f),f=f.parentNode;s.length&&(t=new Set(s.reverse()))}}return t}_findNodes(r,e){const{leaves:[c,...h]}=r,{type:o}=c,d=(0,g.unescapeSelector)(c.name),p=h.length>0,{document:u,root:t}=this.#t;let s=new Set,f=!1;switch(o){case b.ID_SELECTOR:{let n;if(e===S)this._matchLeaves([c],this.#e)&&(n=this.#e);else if(e===x){let i=this.#e;for(;i;){if(this._matchLeaves([c],i)){n=i;break}i=i.parentNode}}else t.nodeType===b.ELEMENT_NODE?f=!0:n=t.getElementById(d);n&&(p?this._matchLeaves(h,n)&&s.add(n):s.add(n));break}case b.CLASS_SELECTOR:{const n=[];if(e===S)this.#e.nodeType===b.ELEMENT_NODE&&this.#e.classList.contains(d)&&n.push(this.#e);else if(e===x){let i=this.#e;for(;i&&i.nodeType===b.ELEMENT_NODE;)i.classList.contains(d)&&n.push(i),i=i.parentNode}else if(t.nodeType===b.DOCUMENT_FRAGMENT_NODE){const i=[...t.children];for(const a of i){a.classList.contains(d)&&n.push(a);const l=[...a.getElementsByClassName(d)];n.push(...l)}}else{const i=[...t.getElementsByClassName(d)];n.push(...i)}if(n.length)if(p)for(const i of n)this._matchLeaves(h,i)&&s.add(i);else s=new Set(n);break}case b.TYPE_SELECTOR:{const n=[];if(e===S)this.#e.nodeType===b.ELEMENT_NODE&&this._matchLeaves([c],this.#e)&&n.push(this.#e);else if(e===x){let i=this.#e;for(;i&&i.nodeType===b.ELEMENT_NODE;)this._matchLeaves([c],i)&&n.push(i),i=i.parentNode}else if(u.contentType!=="text/html"||/[*|]/.test(d))f=!0;else if(t.nodeType===b.DOCUMENT_FRAGMENT_NODE){const i=d.toLowerCase(),a=[...t.children];for(const l of a){l.localName===i&&n.push(l);const m=[...l.getElementsByTagName(d)];n.push(...m)}}else{const i=[...t.getElementsByTagName(d)];n.push(...i)}if(n.length)if(p)for(const i of n)this._matchLeaves(h,i)&&s.add(i);else s=new Set(n);break}case b.PSEUDO_ELEMENT_SELECTOR:{this._matchPseudoElementSelector(d);break}default:{const n=[];if(e===S)this._matchLeaves([c],this.#e)&&n.push(this.#e);else if(e===x){let i=this.#e;for(;i;)this._matchLeaves([c],i)&&n.push(i),i=i.parentNode}else f=!0;if(n.length)if(p)for(const i of n)this._matchLeaves(h,i)&&s.add(i);else s=new Set(n)}}return{nodes:s,pending:f}}_getFirstTwig(r){const e=r.length-1,c=r[0];let h,o;if(e){const d=r[e],{leaves:[{type:p}]}=d;p===b.PSEUDO_ELEMENT_SELECTOR||p===b.ID_SELECTOR?(h="prev",o=d):(h="next",o=c)}else h="prev",o=c;return{find:h,twig:o}}_collectNodes(r){const e=this.#s.values();if(r===C||r===v){const c=new Set;let h=0;for(const{branch:o}of e){const{find:d,twig:p}=this._getFirstTwig(o),{nodes:u,pending:t}=this._findNodes(p,r);u.size?this.#r[h]=u:t?c.add(new Map([["index",h],["twig",p]])):this.#s[h].skip=!0,this.#s[h].find=d,h++}if(c.size){const{document:o,root:d}=this.#t,p=o.createNodeIterator(d,b.SHOW_ELEMENT);let u=p.nextNode();for(;u;){let t=!1;if(this.#e.nodeType===b.ELEMENT_NODE?t=(0,k.isSameOrDescendant)(u,this.#e):t=!0,t)for(const s of c){const{leaves:f}=s.get("twig");if(this._matchLeaves(f,u)){const i=s.get("index");this.#r[i].add(u)}}u=p.nextNode()}}}else{let c=0;for(const{branch:h}of e){const o=h[h.length-1],{nodes:d}=this._findNodes(o,r);d.size?this.#r[c]=d:this.#s[c].skip=!0,this.#s[c].find="prev",c++}}return[this.#s,this.#r]}_sortNodes(r){const e=[...r];return e.length>1&&e.sort((c,h)=>{const o=c.compareDocumentPosition(h);let d;return o&b.DOCUMENT_POSITION_PRECEDING||o&b.DOCUMENT_POSITION_CONTAINS?d=1:d=-1,d}),e}_matchNodes(r){const[...e]=this.#s,c=e.length;let h=new Set;for(let o=0;o<c;o++){const{branch:d,find:p,skip:u}=e[o],t=d.length;if(!u&&t){const s=this.#r[o],f=t-1;if(f===0)if((r===C||r===v)&&this.#e.nodeType===b.ELEMENT_NODE){for(const n of s)if(n!==this.#e&&(0,k.isSameOrDescendant)(n,this.#e)&&(h.add(n),r===v))break}else if(r===v){const[n]=this._sortNodes(s);h.add(n)}else{const n=[...h],i=[...s];h=new Set([...n,...i])}else if(p==="next"){let{combo:n}=d[0];for(const i of s){let a=new Set([i]);for(let l=1;l<t;l++){const{combo:m,leaves:N}=d[l],w=[];for(const y of a){const A={combo:n,leaves:N},M=this._matchCombinator(A,y,{find:p});M.size&&w.push(...M)}const E=new Set(w);if(E.size)if(l===f){if(r===v){const[y]=this._sortNodes(E);h.add(y)}else{const y=[...h],A=[...E];h=new Set([...y,...A])}break}else n=m,a=E;else break}}}else for(const n of s){let i=new Set([n]),a;for(let l=f-1;l>=0;l--){const m=d[l],N=[];for(const E of i){const y=this._matchCombinator(m,E,{find:p});y.size&&N.push(...y)}const w=new Set(N);if(w.size)if(a=!0,l===0){h.add(n);break}else i=w;else{a=!1;break}}if(a&&r!==C)break}}}return h}_find(r){return this._collectNodes(r),this._matchNodes(r)}matches(){if(this.#e.nodeType!==b.ELEMENT_NODE)throw new TypeError(`Unexpected node ${this.#e.nodeName}`);let r;try{r=this._find(S).has(this.#e)}catch(e){this._onError(e)}return!!r}closest(){if(this.#e.nodeType!==b.ELEMENT_NODE)throw new TypeError(`Unexpected node ${this.#e.nodeName}`);let r;try{const e=this._find(x);let c=this.#e;for(;c;){if(e.has(c)){r=c;break}c=c.parentNode}}catch(e){this._onError(e)}return r??null}querySelector(){let r;try{const e=this._find(v);e.delete(this.#e),e.size>1?[r]=this._sortNodes(e):e.size&&([r]=[...e])}catch(e){this._onError(e)}return r??null}querySelectorAll(){const r=[];try{const e=this._find(C);e.delete(this.#e),e.size>1&&this.#c?r.push(...this._sortNodes(e)):e.size&&r.push(...e)}catch(e){this._onError(e)}return r}}0&&(module.exports={Matcher});
//# sourceMappingURL=matcher.js.map
