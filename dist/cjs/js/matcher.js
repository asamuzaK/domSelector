var B=Object.create;var R=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var V=Object.getPrototypeOf,j=Object.prototype.hasOwnProperty;var H=(S,a)=>{for(var e in a)R(S,e,{get:a[e],enumerable:!0})},U=(S,a,e,c)=>{if(a&&typeof a=="object"||typeof a=="function")for(let f of F(a))!j.call(S,f)&&f!==e&&R(S,f,{get:()=>a[f],enumerable:!(c=z(a,f))||c.enumerable});return S};var W=(S,a,e)=>(e=S!=null?B(V(S)):{},U(a||!S||!S.__esModule?R(e,"default",{value:S,enumerable:!0}):e,S)),G=S=>U(R({},"__esModule",{value:!0}),S);var X={};H(X,{Matcher:()=>q});module.exports=G(X);var M=W(require("is-potential-custom-element-name"),1),x=require("./dom-util.js"),k=require("./parser.js"),o=require("./constant.js");const C="next",D="prev",$="all",I="first",O="lineal",P="self";class q{#t;#r;#a;#e;#l;#s;#o;#i;constructor(a,e,c={}){const{warn:f}=c;this.#r=new Map([[o.SELECTOR_PSEUDO_ELEMENT,o.BIT_01],[o.SELECTOR_ID,o.BIT_02],[o.SELECTOR_CLASS,o.BIT_04],[o.SELECTOR_TYPE,o.BIT_08],[o.SELECTOR_ATTR,o.BIT_16],[o.SELECTOR_PSEUDO_CLASS,o.BIT_32]]),this.#a=new WeakMap,this.#o=a,this.#e=e,this.#i=!!f,[this.#t,this.#l]=this._prepare(a),this.#s=this._getRoot(e)}_onError(a){if(a instanceof DOMException&&a.name===o.NOT_SUPPORTED_ERR)this.#i&&console.warn(a.message);else throw a}_getRoot(a=this.#e){let e,c;switch(a.nodeType){case o.DOCUMENT_NODE:{e=a,c=a;break}case o.DOCUMENT_FRAGMENT_NODE:{e=a.ownerDocument,c=a;break}case o.ELEMENT_NODE:{if(a.ownerDocument.contains(a))e=a.ownerDocument,c=a.ownerDocument;else{let r=a;for(;r&&r.parentNode;)r=r.parentNode;e=r.ownerDocument,c=r}break}default:throw new TypeError(`Unexpected node ${a.nodeName}`)}const f=(0,x.isInShadowTree)(a);return{document:e,root:c,shadow:f}}_sortLeaves(a){const e=[...a];return e.length>1&&e.sort((c,f)=>{const{type:r}=c,{type:d}=f,m=this.#r.get(r),l=this.#r.get(d);let t;return m===l?t=0:m>l?t=1:t=-1,t}),e}_prepare(a=this.#o){const e=(0,k.parseSelector)(a),c=(0,k.walkAST)(e),f=[],r=[];let d=0;for(const[...m]of c){const l=[];let t=m.shift();if(t&&t.type!==o.COMBINATOR){const s=new Set;for(;t;){if(t.type===o.COMBINATOR){const[n]=m;if(n.type===o.COMBINATOR){const b=`Invalid combinator ${t.name}${n.name}`;throw new DOMException(b,o.SYNTAX_ERR)}l.push({combo:t,leaves:this._sortLeaves(s)}),s.clear()}else t&&s.add(t);if(m.length)t=m.shift();else{l.push({combo:null,leaves:this._sortLeaves(s)}),s.clear();break}}}f.push({branch:l,filtered:!1,find:null,skip:!1}),r[d]=new Set,d++}return[f,r]}_collectNthChild(a,e){const{a:c,b:f,reverse:r,selector:d}=a,{parentNode:m}=e,l=new Set;let t;if(d&&(this.#a.has(d)?t=this.#a.get(d):(t=(0,k.walkAST)(d),this.#a.set(d,t))),m){const s=[].slice.call(m.children),n=s.length;if(n){const b=new Set;if(t){const i=t.length;for(const h of s){let u;for(let w=0;w<i;w++){const N=t[w];if(u=this._matchLeaves(N,h),!u)break}u&&b.add(h)}}if(r&&s.reverse(),c===0){if(f>0&&f<=n){if(b.size)for(let i=0;i<n;i++){const h=s[i];if(b.has(h)){l.add(h);break}}else if(!d){const i=s[f-1];l.add(i)}}}else{let i=f-1;if(c>0)for(;i<0;)i+=c;if(i>=0&&i<n){let h=c>0?0:f-1;for(let u=0;u<n&&i>=0&&i<n;u++){const w=s[u];b.size?b.has(w)&&(h===i&&(l.add(w),i+=c),c>0?h++:h--):u===i&&(d||l.add(w),i+=c)}}}}}else{const{root:s}=this.#s;if(e===s&&s.nodeType===o.ELEMENT_NODE&&c+f===1)if(t){const n=t.length;let b;for(let i=0;i<n;i++){const h=t[i];if(b=this._matchLeaves(h,e),b)break}b&&l.add(e)}else l.add(e)}return l}_collectNthOfType(a,e){const{a:c,b:f,reverse:r}=a,{localName:d,parentNode:m,prefix:l}=e,t=new Set;if(m){const s=[].slice.call(m.children),n=s.length;if(n)if(r&&s.reverse(),c===0){if(f>0&&f<=n){let b=0;for(let i=0;i<n;i++){const h=s[i],{localName:u,prefix:w}=h;if(u===d&&w===l){if(b===f-1){t.add(h);break}b++}}}}else{let b=f-1;if(c>0)for(;b<0;)b+=c;if(b>=0&&b<n){let i=c>0?0:f-1;for(let h=0;h<n;h++){const u=s[h],{localName:w,prefix:N}=u;if(w===d&&N===l){if(i===b&&(t.add(u),b+=c),b<0||b>=n)break;c>0?i++:i--}}}}}else{const{root:s}=this.#s;e===s&&s.nodeType===o.ELEMENT_NODE&&c+f===1&&t.add(e)}return t}_matchAnPlusB(a,e,c){const{nth:{a:f,b:r,name:d},selector:m}=a,l=(0,k.unescapeSelector)(d),t=new Map;l?(l==="even"?(t.set("a",2),t.set("b",0)):l==="odd"&&(t.set("a",2),t.set("b",1)),c.indexOf("last")>-1&&t.set("reverse",!0)):(typeof f=="string"&&/-?\d+/.test(f)?t.set("a",f*1):t.set("a",0),typeof r=="string"&&/-?\d+/.test(r)?t.set("b",r*1):t.set("b",0),c.indexOf("last")>-1&&t.set("reverse",!0));let s=new Set;if(t.has("a")&&t.has("b")){if(/^nth-(?:last-)?child$/.test(c)){m&&t.set("selector",m);const n=Object.fromEntries(t),b=this._collectNthChild(n,e);b.size&&(s=b)}else if(/^nth-(?:last-)?of-type$/.test(c)){const n=Object.fromEntries(t),b=this._collectNthOfType(n,e);b.size&&(s=b)}}return s}_matchPseudoElementSelector(a,e={}){const{forgive:c}=e;switch(a){case"after":case"backdrop":case"before":case"cue":case"cue-region":case"first-letter":case"first-line":case"file-selector-button":case"marker":case"placeholder":case"selection":case"target-text":{if(this.#i)throw new DOMException(`Unsupported pseudo-element ::${a}`,o.NOT_SUPPORTED_ERR);break}case"part":case"slotted":{if(this.#i)throw new DOMException(`Unsupported pseudo-element ::${a}()`,o.NOT_SUPPORTED_ERR);break}default:if(a.startsWith("-webkit-")){if(this.#i)throw new DOMException(`Unsupported pseudo-element ::${a}`,o.NOT_SUPPORTED_ERR)}else if(!c)throw new DOMException(`Unknown pseudo-element ::${a}`,o.SYNTAX_ERR)}}_matchDirectionPseudoClass(a,e){const c=(0,k.unescapeSelector)(a.name),f=(0,x.getDirectionality)(e);let r;return c===f&&(r=e),r??null}_matchLanguagePseudoClass(a,e){const c=(0,k.unescapeSelector)(a.name);let f;if(c==="*")if(e.hasAttribute("lang"))e.getAttribute("lang")&&(f=e);else{let r=e.parentNode;for(;r&&r.nodeType===o.ELEMENT_NODE;){if(r.hasAttribute("lang")){r.getAttribute("lang")&&(f=e);break}r=r.parentNode}}else if(c){const r=`(?:-${o.ALPHA_NUM})*`;if(new RegExp(`^(?:\\*-)?${o.ALPHA_NUM}${r}$`,"i").test(c)){let m;if(c.indexOf("-")>-1){const[l,t,...s]=c.split("-");let n;l==="*"?n=`${o.ALPHA_NUM}${r}`:n=`${l}${r}`;const b=`-${t}${r}`,i=s.length;let h="";if(i)for(let u=0;u<i;u++)h+=`-${s[u]}${r}`;m=new RegExp(`^${n}${b}${h}$`,"i")}else m=new RegExp(`^${c}${r}$`,"i");if(e.hasAttribute("lang"))m.test(e.getAttribute("lang"))&&(f=e);else{let l=e.parentNode;for(;l&&l.nodeType===o.ELEMENT_NODE;){if(l.hasAttribute("lang")){const t=l.getAttribute("lang");m.test(t)&&(f=e);break}l=l.parentNode}}}}return f??null}_matchHasPseudoFunc(a,e){let c;if(Array.isArray(a)&&a.length){const[f]=a,{type:r}=f;let d;r===o.COMBINATOR?d=a.shift():d={name:" ",type:o.COMBINATOR};const m=[];for(;a.length;){const[s]=a,{type:n}=s;if(n===o.COMBINATOR)break;m.push(a.shift())}const l={combo:d,leaves:m},t=this._matchCombinator(l,e,{find:C});if(t.size)if(a.length){for(const s of t)if(c=this._matchHasPseudoFunc(Object.assign([],a),s),c)break}else c=!0}return!!c}_matchLogicalPseudoFunc(a,e){const{astName:c="",branches:f=[],selector:r="",twigBranches:d=[]}=a;let m;if(c==="has")if(r.includes(":has("))m=null;else{const l=f.length;let t;for(let s=0;s<l;s++){const n=f[s];if(t=this._matchHasPseudoFunc(Object.assign([],n),e),t)break}t&&(m=e)}else{const l=/^(?:is|where)$/.test(c),t=d.length;let s;for(let n=0;n<t;n++){const b=d[n],i=b.length-1,{leaves:h}=b[i];if(s=this._matchLeaves(h,e,{forgive:l}),s&&i>0){let u=new Set([e]);for(let w=i-1;w>=0;w--){const N=b[w],E=[];for(const A of u){const p=this._matchCombinator(N,A,{forgive:l,find:D});p.size&&E.push(...p)}if(E.length)if(w===0){s=!0;break}else u=new Set(E);else{s=!1;break}}}if(s)break}c==="not"?s||(m=e):s&&(m=e)}return m??null}_matchPseudoClassSelector(a,e,c={}){const{children:f}=a,{localName:r,parentNode:d}=e,{forgive:m}=c,l=(0,k.unescapeSelector)(a.name);let t=new Set;if(o.REG_LOGICAL_PSEUDO.test(l)){let s;if(this.#a.has(a))s=this.#a.get(a);else{const b=(0,k.walkAST)(a),i=[],h=[];for(const[...u]of b){for(const A of u){const p=(0,k.generateCSS)(A);i.push(p)}const w=[],N=new Set;let E=u.shift();for(;E;)if(E.type===o.COMBINATOR?(w.push({combo:E,leaves:[...N]}),N.clear()):E&&N.add(E),u.length)E=u.shift();else{w.push({combo:null,leaves:[...N]}),N.clear();break}h.push(w)}s={astName:l,branches:b,twigBranches:h,selector:i.join(",")},this.#a.set(a,s)}const n=this._matchLogicalPseudoFunc(s,e);n&&t.add(n)}else if(Array.isArray(f)){const[s]=f;if(/^nth-(?:last-)?(?:child|of-type)$/.test(l)){const n=this._matchAnPlusB(s,e,l);n.size&&(t=n)}else if(l==="dir"){const n=this._matchDirectionPseudoClass(s,e);n&&t.add(n)}else if(l==="lang"){const n=this._matchLanguagePseudoClass(s,e);n&&t.add(n)}else switch(l){case"current":case"nth-col":case"nth-last-col":{if(this.#i)throw new DOMException(`Unsupported pseudo-class :${l}()`,o.NOT_SUPPORTED_ERR);break}case"host":case"host-context":break;default:if(!m)throw new DOMException(`Unknown pseudo-class :${l}()`,o.SYNTAX_ERR)}}else{const{document:s,root:n}=this.#s,b=/^a(?:rea)?$/,i=/^(?:(?:fieldse|inpu|selec)t|button|opt(?:group|ion)|textarea)$/,h=/^(?:(?:inpu|selec)t|button|form|textarea)$/,u=/^d(?:etails|ialog)$/,w=/^(?:checkbox|radio)$/,N=/^(?:date(?:time-local)?|month|time|week)$/,E=/(?:(?:rang|tim)e|date(?:time-local)?|month|number|week)$/,A=/^(?:(?:emai|te|ur)l|number|password|search|text)$/;switch(l){case"any-link":case"link":{b.test(r)&&e.hasAttribute("href")&&t.add(e);break}case"local-link":{if(b.test(r)&&e.hasAttribute("href")){const{href:p,origin:g,pathname:y}=new URL(s.URL),_=new URL(e.getAttribute("href"),p);_.origin===g&&_.pathname===y&&t.add(e)}break}case"visited":break;case"target":{const{hash:p}=new URL(s.URL);e.id&&p===`#${e.id}`&&s.contains(e)&&t.add(e);break}case"target-within":{const{hash:p}=new URL(s.URL);if(p){const g=p.replace(/^#/,"");let y=s.getElementById(g);for(;y;){if(y===e){t.add(e);break}y=y.parentNode}}break}case"scope":{this.#e.nodeType===o.ELEMENT_NODE?e===this.#e&&t.add(e):e===s.documentElement&&t.add(e);break}case"focus":{e===s.activeElement&&t.add(e);break}case"focus-within":{let p=s.activeElement;for(;p;){if(p===e){t.add(e);break}p=p.parentNode}break}case"open":{u.test(r)&&e.hasAttribute("open")&&t.add(e);break}case"closed":{u.test(r)&&!e.hasAttribute("open")&&t.add(e);break}case"disabled":{if(i.test(r)||(0,M.default)(r))if(e.disabled||e.hasAttribute("disabled"))t.add(e);else{let p=d;for(;p&&p.localName!=="fieldset";)p=p.parentNode;p&&d.localName!=="legend"&&p.hasAttribute("disabled")&&t.add(e)}break}case"enabled":{(i.test(r)||(0,M.default)(r))&&!(e.disabled&&e.hasAttribute("disabled"))&&t.add(e);break}case"read-only":{switch(r){case"textarea":{(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}case"input":{(!e.type||N.test(e.type)||A.test(e.type))&&(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}default:(0,x.isContentEditable)(e)||t.add(e)}break}case"read-write":{switch(r){case"textarea":{e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled")||t.add(e);break}case"input":{(!e.type||N.test(e.type)||A.test(e.type))&&!(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}default:(0,x.isContentEditable)(e)&&t.add(e)}break}case"placeholder-shown":{let p;r==="textarea"?p=e:r==="input"&&(e.hasAttribute("type")?A.test(e.getAttribute("type"))&&(p=e):p=e),p&&e.value===""&&e.hasAttribute("placeholder")&&e.getAttribute("placeholder").trim().length&&t.add(e);break}case"checked":{(e.checked&&r==="input"&&e.hasAttribute("type")&&w.test(e.getAttribute("type"))||e.selected&&r==="option")&&t.add(e);break}case"indeterminate":{if(e.indeterminate&&r==="input"&&e.type==="checkbox"||r==="progress"&&!e.hasAttribute("value"))t.add(e);else if(r==="input"&&e.type==="radio"&&!e.hasAttribute("checked")){const p=e.name;let g=e.parentNode;for(;g&&g.localName!=="form";)g=g.parentNode;g||(g=s.documentElement);const y=[].slice.call(g.getElementsByTagName("input"));let _;for(const v of y)if(v.getAttribute("type")==="radio"&&(p?v.getAttribute("name")===p&&(_=!!v.checked):v.hasAttribute("name")||(_=!!v.checked),_))break;_||t.add(e)}break}case"default":{const p=/^(?:button|reset)$/,g=/^(?:image|submit)$/;if(r==="button"&&!(e.hasAttribute("type")&&p.test(e.getAttribute("type")))||r==="input"&&e.hasAttribute("type")&&g.test(e.getAttribute("type"))){let y=e.parentNode;for(;y&&y.localName!=="form";)y=y.parentNode;if(y){const _=s.createNodeIterator(y,o.SHOW_ELEMENT);let v=_.nextNode();for(;v;){const T=v.localName;let L;if(T==="button"?L=!(v.hasAttribute("type")&&p.test(v.getAttribute("type"))):T==="input"&&(L=v.hasAttribute("type")&&g.test(v.getAttribute("type"))),L){v===e&&t.add(e);break}v=_.nextNode()}}}else if(r==="input"&&e.hasAttribute("type")&&w.test(e.getAttribute("type"))&&(e.checked||e.hasAttribute("checked")))t.add(e);else if(r==="option"){let y=!1,_=d;for(;_&&_.localName!=="datalist";){if(_.localName==="select"){(_.multiple||_.hasAttribute("multiple"))&&(y=!0);break}_=_.parentNode}if(y)(e.selected||e.hasAttribute("selected"))&&t.add(e);else{const v=d.firstElementChild,T=new Set;let L=v;for(;L;){if(L.selected||L.hasAttribute("selected")){T.add(L);break}L=L.nextElementSibling}T.size||T.add(v),T.has(e)&&t.add(e)}}break}case"valid":{if(h.test(r))e.checkValidity()&&t.add(e);else if(r==="fieldset"){const p=s.createNodeIterator(e,o.SHOW_ELEMENT);let g=p.nextNode();g===e&&(g=p.nextNode());let y;for(;g&&!(h.test(g.localName)&&(y=g.checkValidity(),!y));)g=p.nextNode();y&&t.add(e)}break}case"invalid":{if(h.test(r))e.checkValidity()||t.add(e);else if(r==="fieldset"){const p=s.createNodeIterator(e,o.SHOW_ELEMENT);let g=p.nextNode();g===e&&(g=p.nextNode());let y;for(;g&&!(h.test(g.localName)&&(y=g.checkValidity(),!y));)g=p.nextNode();y||t.add(e)}break}case"in-range":{r==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&E.test(e.getAttribute("type"))&&!(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&(e.hasAttribute("min")||e.hasAttribute("max")||e.getAttribute("type")==="range")&&t.add(e);break}case"out-of-range":{r==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&E.test(e.getAttribute("type"))&&(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&t.add(e);break}case"required":{let p;if(/^(?:select|textarea)$/.test(r))p=e;else if(r==="input")if(e.hasAttribute("type")){const g=e.getAttribute("type");(g==="file"||w.test(g)||N.test(g)||A.test(g))&&(p=e)}else p=e;p&&(e.required||e.hasAttribute("required"))&&t.add(e);break}case"optional":{let p;if(/^(?:select|textarea)$/.test(r))p=e;else if(r==="input")if(e.hasAttribute("type")){const g=e.getAttribute("type");(g==="file"||w.test(g)||N.test(g)||A.test(g))&&(p=e)}else p=e;p&&!(e.required||e.hasAttribute("required"))&&t.add(e);break}case"root":{e===s.documentElement&&t.add(e);break}case"empty":{if(e.hasChildNodes()){const p=e.childNodes.values();let g;for(const y of p)if(g=y.nodeType!==o.ELEMENT_NODE&&y.nodeType!==o.TEXT_NODE,!g)break;g&&t.add(e)}else t.add(e);break}case"first-child":{(d&&e===d.firstElementChild||e===n&&n.nodeType===o.ELEMENT_NODE)&&t.add(e);break}case"last-child":{(d&&e===d.lastElementChild||e===n&&n.nodeType===o.ELEMENT_NODE)&&t.add(e);break}case"only-child":{(d&&e===d.firstElementChild&&e===d.lastElementChild||e===n&&n.nodeType===o.ELEMENT_NODE)&&t.add(e);break}case"first-of-type":{if(d){const[p]=this._collectNthOfType({a:0,b:1},e);p&&t.add(p)}else e===n&&n.nodeType===o.ELEMENT_NODE&&t.add(e);break}case"last-of-type":{if(d){const[p]=this._collectNthOfType({a:0,b:1,reverse:!0},e);p&&t.add(p)}else e===n&&n.nodeType===o.ELEMENT_NODE&&t.add(e);break}case"only-of-type":{if(d){const[p]=this._collectNthOfType({a:0,b:1},e);if(p===e){const[g]=this._collectNthOfType({a:0,b:1,reverse:!0},e);g===e&&t.add(e)}}else e===n&&n.nodeType===o.ELEMENT_NODE&&t.add(e);break}case"host":case"host-context":break;case"after":case"before":case"first-letter":case"first-line":{if(this.#i)throw new DOMException(`Unsupported pseudo-element ::${l}`,o.NOT_SUPPORTED_ERR);break}case"active":case"autofill":case"blank":case"buffering":case"current":case"focus-visible":case"fullscreen":case"future":case"hover":case"modal":case"muted":case"past":case"paused":case"picture-in-picture":case"playing":case"seeking":case"stalled":case"user-invalid":case"user-valid":case"volume-locked":case"-webkit-autofill":{if(this.#i)throw new DOMException(`Unsupported pseudo-class :${l}`,o.NOT_SUPPORTED_ERR);break}default:if(l.startsWith("-webkit-")){if(this.#i)throw new DOMException(`Unsupported pseudo-class :${l}`,o.NOT_SUPPORTED_ERR)}else if(!m)throw new DOMException(`Unknown pseudo-class :${l}`,o.SYNTAX_ERR)}}return t}_matchAttributeSelector(a,e){const{flags:c,matcher:f,name:r,value:d}=a;if(typeof c=="string"&&!/^[is]$/i.test(c)){const t=(0,k.generateCSS)(a);throw new DOMException(`Invalid selector ${t}`,o.SYNTAX_ERR)}const{attributes:m}=e;let l;if(m&&m.length){const{document:t}=this.#s;let s;t.contentType==="text/html"?typeof c=="string"&&/^s$/i.test(c)?s=!1:s=!0:typeof c=="string"&&/^i$/i.test(c)?s=!0:s=!1;let n=(0,k.unescapeSelector)(r.name);s&&(n=n.toLowerCase());const b=new Set;if(n.indexOf("|")>-1){const{prefix:i,tagName:h}=(0,x.selectorToNodeProps)(n);for(let{name:u,value:w}of m)switch(s&&(u=u.toLowerCase(),w=w.toLowerCase()),i){case"":{h===u&&b.add(w);break}case"*":{u.indexOf(":")>-1?u.endsWith(`:${h}`)&&b.add(w):h===u&&b.add(w);break}default:if(u.indexOf(":")>-1){const[N,E]=u.split(":");i===N&&h===E&&(0,x.isNamespaceDeclared)(i,e)&&b.add(w)}}}else for(let{name:i,value:h}of m)if(s&&(i=i.toLowerCase(),h=h.toLowerCase()),i.indexOf(":")>-1){const[u,w]=i.split(":");if(u==="xml"&&w==="lang")continue;n===w&&b.add(h)}else n===i&&b.add(h);if(b.size){const{name:i,value:h}=d||{};let u;switch(i?s?u=i.toLowerCase():u=i:h?s?u=h.toLowerCase():u=h:h===""&&(u=h),f){case"=":{typeof u=="string"&&b.has(u)&&(l=e);break}case"~=":{if(u&&typeof u=="string"){for(const w of b)if(new Set(w.split(/\s+/)).has(u)){l=e;break}}break}case"|=":{if(u&&typeof u=="string"){let w;for(const N of b)if(N===u||N.startsWith(`${u}-`)){w=N;break}w&&(l=e)}break}case"^=":{if(u&&typeof u=="string"){let w;for(const N of b)if(N.startsWith(`${u}`)){w=N;break}w&&(l=e)}break}case"$=":{if(u&&typeof u=="string"){let w;for(const N of b)if(N.endsWith(`${u}`)){w=N;break}w&&(l=e)}break}case"*=":{if(u&&typeof u=="string"){let w;for(const N of b)if(N.includes(`${u}`)){w=N;break}w&&(l=e)}break}case null:default:l=e}}}return l??null}_matchClassSelector(a,e){const c=(0,k.unescapeSelector)(a.name);let f;return e.classList.contains(c)&&(f=e),f??null}_matchIDSelector(a,e){const c=(0,k.unescapeSelector)(a.name),{id:f}=e;let r;return c===f&&(r=e),r??null}_matchTypeSelector(a,e,c={}){const f=(0,k.unescapeSelector)(a.name),{localName:r,prefix:d}=e,{forgive:m}=c,{document:l}=this.#s;let{prefix:t,tagName:s}=(0,x.selectorToNodeProps)(f,e);l.contentType==="text/html"&&(t=t.toLowerCase(),s=s.toLowerCase());let n,b;r.indexOf(":")>-1?[n,b]=r.split(":"):(n=d||"",b=r);let i;if(t===""&&n==="")e.namespaceURI===null&&(s==="*"||s===b)&&(i=e);else if(t==="*")(s==="*"||s===b)&&(i=e);else if(t===n){if((0,x.isNamespaceDeclared)(t,e))(s==="*"||s===b)&&(i=e);else if(!m)throw new DOMException(`Undeclared namespace ${t}`,o.SYNTAX_ERR)}else if(t&&!m&&!(0,x.isNamespaceDeclared)(t,e))throw new DOMException(`Undeclared namespace ${t}`,o.SYNTAX_ERR);return i??null}_matchShadowHostPseudoClass(a,e){const{children:c}=a,f=(0,k.unescapeSelector)(a.name);let r;if(Array.isArray(c)){const[d]=(0,k.walkAST)(c[0]),[...m]=d,{host:l}=e;if(f==="host"){let t;for(const s of m){const{type:n}=s;if(n===o.COMBINATOR){const b=(0,k.generateCSS)(a);throw new DOMException(`Invalid selector ${b}`,o.SYNTAX_ERR)}if(t=this._matchSelector(s,l).has(l),!t)break}t&&(r=e)}else if(f==="host-context"){let t=l,s;for(;t;){for(const n of m){const{type:b}=n;if(b===o.COMBINATOR){const i=(0,k.generateCSS)(a);throw new DOMException(`Invalid selector ${i}`,o.SYNTAX_ERR)}if(s=this._matchSelector(n,t).has(t),!s)break}if(s)break;t=t.parentNode}s&&(r=e)}}else if(f==="host")r=e;else throw new DOMException(`Invalid selector :${f}`,o.SYNTAX_ERR);return r??null}_matchSelector(a,e,c){const{type:f}=a,r=(0,k.unescapeSelector)(a.name),{shadow:d}=this.#s;let m=new Set;if(e.nodeType===o.ELEMENT_NODE)switch(f){case o.SELECTOR_ATTR:{const l=this._matchAttributeSelector(a,e);l&&m.add(l);break}case o.SELECTOR_CLASS:{const l=this._matchClassSelector(a,e);l&&m.add(l);break}case o.SELECTOR_ID:{const l=this._matchIDSelector(a,e);l&&m.add(l);break}case o.SELECTOR_PSEUDO_CLASS:{const l=this._matchPseudoClassSelector(a,e,c);l.size&&(m=l);break}case o.SELECTOR_PSEUDO_ELEMENT:{this._matchPseudoElementSelector(r,c);break}case o.SELECTOR_TYPE:default:{const l=this._matchTypeSelector(a,e,c);l&&m.add(l)}}else if(d&&f===o.SELECTOR_PSEUDO_CLASS&&e.nodeType===o.DOCUMENT_FRAGMENT_NODE){if(r!=="has"&&o.REG_LOGICAL_PSEUDO.test(r)){const l=this._matchPseudoClassSelector(a,e,c);l.size&&(m=l)}else if(o.REG_SHADOW_HOST.test(r)){const l=this._matchShadowHostPseudoClass(a,e);l&&m.add(l)}}return m}_matchLeaves(a,e,c){let f;for(const r of a)if(f=this._matchSelector(r,e,c).has(e),!f)break;return!!f}_findDescendantNodes(a,e){const[c,...f]=a,{type:r}=c,d=(0,k.unescapeSelector)(c.name),m=f.length>0,{document:l,root:t,shadow:s}=this.#s;let n=new Set,b=!1;if(s)b=!0;else switch(r){case o.SELECTOR_ID:{if(t.nodeType===o.ELEMENT_NODE)b=!0;else{const i=t.getElementById(d);i&&i!==e&&e.contains(i)&&(m?this._matchLeaves(f,i)&&n.add(i):n.add(i))}break}case o.SELECTOR_CLASS:{const i=[].slice.call(e.getElementsByClassName(d));if(i.length)if(m)for(const h of i)this._matchLeaves(f,h)&&n.add(h);else n=new Set(i);break}case o.SELECTOR_TYPE:{if(l.contentType==="text/html"&&!/[*|]/.test(d)){const i=[].slice.call(e.getElementsByTagName(d));if(i.length)if(m)for(const h of i)this._matchLeaves(f,h)&&n.add(h);else n=new Set(i)}else b=!0;break}case o.SELECTOR_PSEUDO_ELEMENT:{this._matchPseudoElementSelector(d);break}default:b=!0}return{nodes:n,pending:b}}_matchCombinator(a,e,c={}){const{combo:f,leaves:r}=a,{name:d}=f,{find:m,forgive:l}=c;let t=new Set;if(m===C)switch(d){case"+":{const s=e.nextElementSibling;s&&this._matchLeaves(r,s,{forgive:l})&&t.add(s);break}case"~":{let s=e.nextElementSibling;for(;s;)this._matchLeaves(r,s,{forgive:l})&&t.add(s),s=s.nextElementSibling;break}case">":{const s=[].slice.call(e.children);for(const n of s)this._matchLeaves(r,n,{forgive:l})&&t.add(n);break}case" ":default:{const{nodes:s,pending:n}=this._findDescendantNodes(r,e);if(s.size)t=s;else if(n){const{document:b}=this.#s,i=b.createNodeIterator(e,o.SHOW_ELEMENT);let h=i.nextNode();for(h===e&&(h=i.nextNode());h;)this._matchLeaves(r,h,{forgive:l})&&t.add(h),h=i.nextNode()}}}else switch(d){case"+":{const s=e.previousElementSibling;s&&this._matchLeaves(r,s,{forgive:l})&&t.add(s);break}case"~":{const s=[];let n=e.previousElementSibling;for(;n;)this._matchLeaves(r,n,{forgive:l})&&s.push(n),n=n.previousElementSibling;s.length&&(t=new Set(s.reverse()));break}case">":{const s=e.parentNode;s&&this._matchLeaves(r,s,{forgive:l})&&t.add(s);break}case" ":default:{const s=[];let n=e.parentNode;for(;n;)this._matchLeaves(r,n,{forgive:l})&&s.push(n),n=n.parentNode;s.length&&(t=new Set(s.reverse()))}}return t}_findNodes(a,e){const{leaves:[c,...f]}=a,{type:r}=c,d=(0,k.unescapeSelector)(c.name),{document:m,root:l,shadow:t}=this.#s;let s=new Set,n=!1;switch(r){case o.SELECTOR_ID:{if(e===P)this._matchLeaves([c],this.#e)&&s.add(this.#e);else if(e===O){let i=this.#e;for(;i;){if(this._matchLeaves([c],i)){s.add(i);break}i=i.parentNode}}else if(e===$||l.nodeType===o.ELEMENT_NODE)n=!0;else{const i=l.getElementById(d);i&&s.add(i)}break}case o.SELECTOR_CLASS:{if(e===P)this.#e.nodeType===o.ELEMENT_NODE&&this.#e.classList.contains(d)&&s.add(this.#e);else if(e===O){let i=this.#e;for(;i&&i.nodeType===o.ELEMENT_NODE;)i.classList.contains(d)&&s.add(i),i=i.parentNode}else if(l.nodeType===o.DOCUMENT_FRAGMENT_NODE){const i=[].slice.call(l.children),h=[];for(const u of i){u.classList.contains(d)&&h.push(u);const w=[].slice.call(u.getElementsByClassName(d));h.push(...w)}h.length&&(s=new Set(h))}else{const i=[].slice.call(l.getElementsByClassName(d));if(this.#e.nodeType===o.ELEMENT_NODE)for(const h of i)(h===this.#e||(0,x.isInclusive)(h,this.#e))&&s.add(h);else i.length&&(s=new Set(i))}break}case o.SELECTOR_TYPE:{if(e===P)this.#e.nodeType===o.ELEMENT_NODE&&this._matchLeaves([c],this.#e)&&s.add(this.#e);else if(e===O){let i=this.#e;for(;i&&i.nodeType===o.ELEMENT_NODE;)this._matchLeaves([c],i)&&s.add(i),i=i.parentNode}else if(m.contentType!=="text/html"||/[*|]/.test(d))n=!0;else if(l.nodeType===o.DOCUMENT_FRAGMENT_NODE){const i=d.toLowerCase(),h=[].slice.call(l.children),u=[];for(const w of h){w.localName===i&&u.push(w);const N=[].slice.call(w.getElementsByTagName(d));u.push(...N)}u.length&&(s=new Set(u))}else{const i=[].slice.call(l.getElementsByTagName(d));if(this.#e.nodeType===o.ELEMENT_NODE)for(const h of i)(h===this.#e||(0,x.isInclusive)(h,this.#e))&&s.add(h);else i.length&&(s=new Set(i))}break}case o.SELECTOR_PSEUDO_ELEMENT:{this._matchPseudoElementSelector(d);break}default:if(e!==O&&o.REG_SHADOW_HOST.test(d)){if(t&&this.#e.nodeType===o.DOCUMENT_FRAGMENT_NODE){const i=this._matchShadowHostPseudoClass(c,this.#e);i&&s.add(i)}}else if(e===P)this._matchLeaves([c],this.#e)&&s.add(this.#e);else if(e===O){let i=this.#e;for(;i;)this._matchLeaves([c],i)&&s.add(i),i=i.parentNode}else n=!0}const b=f.length;if(!s.size&&!n&&b){const i=f[b-1],{type:h}=i;if(h===o.SELECTOR_PSEUDO_CLASS){let u;l.nodeType===o.ELEMENT_NODE?u=l:u=l.firstElementChild,this._matchPseudoClassSelector(i,u)}}return{compound:b>0,nodes:s,pending:n}}_getEntryTwig(a,e){const c=a.length,f=a[0];let r,d;if(c>1){const{leaves:[{type:m}]}=f,l=a[c-1],{leaves:[{type:t}]}=l;t===o.SELECTOR_PSEUDO_ELEMENT||t===o.SELECTOR_ID?(r=D,d=l):m===o.SELECTOR_PSEUDO_ELEMENT||m===o.SELECTOR_ID?(r=C,d=f):e===I&&c<o.BIT_04?(r=D,d=l):(r=C,d=f)}else r=D,d=f;return{find:r,twig:d}}_collectNodes(a){const e=this.#t.values();if(a===$||a===I){const c=new Set;let f=0;for(const{branch:r}of e){const{find:d,twig:m}=this._getEntryTwig(r,a),{compound:l,nodes:t,pending:s}=this._findNodes(m,a);t.size?this.#l[f]=t:s?c.add(new Map([["index",f],["twig",m]])):this.#t[f].skip=!0,this.#t[f].filtered=!l,this.#t[f].find=d,f++}if(c.size){const{document:r,root:d}=this.#s,m=r.createNodeIterator(d,o.SHOW_ELEMENT);let l=m.nextNode();for(;l;){let t=!1;if(this.#e.nodeType===o.ELEMENT_NODE?l===this.#e?t=!0:t=this.#e.contains(l):t=!0,t)for(const s of c){const{leaves:n}=s.get("twig");if(this._matchLeaves(n,l)){const i=s.get("index");this.#l[i].add(l),this.#t[i].filtered||(this.#t[i].filtered=!0)}}l=m.nextNode()}}}else{let c=0;for(const{branch:f}of e){const r=f[f.length-1],{compound:d,nodes:m}=this._findNodes(r,a);m.size?this.#l[c]=m:this.#t[c].skip=!0,this.#t[c].filtered=!d,this.#t[c].find=D,c++}}return[this.#t,this.#l]}_sortNodes(a){const e=[...a];return e.length>1&&e.sort((c,f)=>{let r;return(0,x.isPreceding)(f,c)?r=1:r=-1,r}),e}_matchNodes(a){const[...e]=this.#t,c=e.length;let f=new Set;for(let r=0;r<c;r++){const{branch:d,filtered:m,find:l,skip:t}=e[r],s=d.length;if(!t&&s){const n=this.#l[r],b=s-1;if(b===0){const{leaves:[,...i]}=d[0];if((a===$||a===I)&&this.#e.nodeType===o.ELEMENT_NODE){for(const h of n)if((m||this._matchLeaves(i,h))&&h!==this.#e&&this.#e.contains(h)&&(f.add(h),a!==$))break}else if(i.length){for(const h of n)if((m||this._matchLeaves(i,h))&&(f.add(h),a!==$))break}else if(a===$){const h=[...f];f=new Set([...h,...n])}else{const[h]=[...n];f.add(h)}}else if(l===C){let{combo:i,leaves:[,...h]}=d[0];for(const u of n){const w=m||this._matchLeaves(h,u);let N;if(w){let E=new Set([u]);for(let A=1;A<s;A++){const{combo:p,leaves:g}=d[A],y=[];for(const _ of E){const v={combo:i,leaves:g},T=this._matchCombinator(v,_,{find:l});T.size&&y.push(...T)}if(y.length)if(A===b){if(a===I){const[_]=this._sortNodes(y);f.add(_)}else{const _=[...f];f=new Set([..._,...y])}N=!0;break}else N=!1,i=p,E=new Set(y);else{N=!1;break}}}else N=!1;if(N&&a!==$)break}}else{const{leaves:[,...i]}=d[b];for(const h of n){const u=m||this._matchLeaves(i,h);let w;if(u){let N=new Set([h]);for(let E=b-1;E>=0;E--){const A=d[E],p=[];for(const g of N){const y=this._matchCombinator(A,g,{find:l});y.size&&p.push(...y)}if(p.length)if(E===0){f.add(h),w=!0;break}else w=!1,N=new Set(p);else{w=!1;break}}}else w=!1;if(w&&a!==$)break}}}}return f}_find(a){return this._collectNodes(a),this._matchNodes(a)}matches(){if(this.#e.nodeType!==o.ELEMENT_NODE)throw new TypeError(`Unexpected node ${this.#e.nodeName}`);let a;try{const e=this._find(P);e.size&&(a=e.has(this.#e))}catch(e){this._onError(e)}return!!a}closest(){if(this.#e.nodeType!==o.ELEMENT_NODE)throw new TypeError(`Unexpected node ${this.#e.nodeName}`);let a;try{const e=this._find(O);let c=this.#e;for(;c;){if(e.has(c)){a=c;break}c=c.parentNode}}catch(e){this._onError(e)}return a??null}querySelector(){let a;try{const e=this._find(I);e.delete(this.#e),e.size&&([a]=this._sortNodes(e))}catch(e){this._onError(e)}return a??null}querySelectorAll(){let a;try{const e=this._find($);e.delete(this.#e),e.size&&(a=this._sortNodes(e))}catch(e){this._onError(e)}return a??[]}}0&&(module.exports={Matcher});
//# sourceMappingURL=matcher.js.map
