var B=Object.create;var M=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var j=Object.getPrototypeOf,V=Object.prototype.hasOwnProperty;var W=(A,s)=>{for(var e in s)M(A,e,{get:s[e],enumerable:!0})},U=(A,s,e,o)=>{if(s&&typeof s=="object"||typeof s=="function")for(let c of F(s))!V.call(A,c)&&c!==e&&M(A,c,{get:()=>s[c],enumerable:!(o=z(s,c))||o.enumerable});return A};var H=(A,s,e)=>(e=A!=null?B(j(A)):{},U(s||!A||!A.__esModule?M(e,"default",{value:A,enumerable:!0}):e,A)),G=A=>U(M({},"__esModule",{value:!0}),A);var X={};W(X,{Matcher:()=>q});module.exports=G(X);var I=H(require("is-potential-custom-element-name"),1),S=require("./dom-util.js"),_=require("./parser.js"),l=require("./constant.js");const C="next",D="prev",T="all",L="first",O="lineal",P="self";class q{#i;#f;#o;#s;#e;#c;#t;#n;#l;#a;#r;constructor(s,e,o={}){const{warn:c}=o;this.#f=new Map([[l.SELECTOR_PSEUDO_ELEMENT,l.BIT_01],[l.SELECTOR_ID,l.BIT_02],[l.SELECTOR_CLASS,l.BIT_04],[l.SELECTOR_TYPE,l.BIT_08],[l.SELECTOR_ATTR,l.BIT_16],[l.SELECTOR_PSEUDO_CLASS,l.BIT_32]]),this.#o=new WeakMap,[this.#i,this.#c]=this._prepare(s),this.#e=e,[this.#s,this.#t,this.#a]=this._setup(e),this.#n=(0,S.isInShadowTree)(e),this.#r=!!c}_onError(s){if(s instanceof DOMException&&s.name===l.NOT_SUPPORTED_ERR)this.#r&&console.warn(s.message);else throw s}_setup(s){let e,o;switch(s.nodeType){case l.DOCUMENT_NODE:{e=s,o=s;break}case l.DOCUMENT_FRAGMENT_NODE:{e=s.ownerDocument,o=s;break}case l.ELEMENT_NODE:{if(s.ownerDocument.contains(s))e=s.ownerDocument,o=s.ownerDocument;else{let h=s;for(;h&&h.parentNode;)h=h.parentNode;e=h.ownerDocument,o=h}break}default:throw new TypeError(`Unexpected node ${s.nodeName}`)}const c=l.SHOW_DOCUMENT|l.SHOW_DOCUMENT_FRAGMENT|l.SHOW_ELEMENT,r=e.createTreeWalker(o,c);return[e,o,r]}_sortLeaves(s){const e=[...s];return e.length>1&&e.sort((o,c)=>{const{type:r}=o,{type:h}=c,d=this.#f.get(r),f=this.#f.get(h);let t;return d===f?t=0:d>f?t=1:t=-1,t}),e}_prepare(s){const e=(0,_.parseSelector)(s),o=(0,_.walkAST)(e),c=[],r=[];let h=0;for(const[...d]of o){const f=[];let t=d.shift();if(t&&t.type!==l.COMBINATOR){const i=new Set;for(;t;){if(t.type===l.COMBINATOR){const[n]=d;if(n.type===l.COMBINATOR){const a=`Invalid combinator ${t.name}${n.name}`;throw new DOMException(a,l.SYNTAX_ERR)}f.push({combo:t,leaves:this._sortLeaves(i)}),i.clear()}else t&&i.add(t);if(d.length)t=d.shift();else{f.push({combo:null,leaves:this._sortLeaves(i)}),i.clear();break}}}c.push({branch:f,filtered:!1,find:null,skip:!1}),r[h]=new Set,h++}return[c,r]}_traverse(s={},e=this.#a){let o,c=e.currentNode;if(s.nodeType===l.ELEMENT_NODE&&c===s)o=c;else{if(c!==e.root)for(;c&&!(c===e.root||s.nodeType===l.ELEMENT_NODE&&c===s);)c=e.parentNode();if(s.nodeType===l.ELEMENT_NODE)for(;c;){if(c===s){o=c;break}c=e.nextNode()}else o=c}return o??null}_collectNthChild(s,e){const{a:o,b:c,reverse:r,selector:h}=s,{parentNode:d}=e,f=new Set;let t;if(h&&(this.#o.has(h)?t=this.#o.get(h):(t=(0,_.walkAST)(h),this.#o.set(h,t))),d){const i=[].slice.call(d.childNodes).filter(a=>a.nodeType===l.ELEMENT_NODE),n=i.length;if(n){const a=new Set;if(t)for(const u of i){let b;for(const p of t)if(b=this._matchLeaves(p,u),!b)break;b&&a.add(u)}if(r&&i.reverse(),o===0){if(c>0&&c<=n){if(a.size){for(const u of i)if(a.has(u)){f.add(u);break}}else if(!h){const u=i[c-1];f.add(u)}}}else{let u=c-1;if(o>0)for(;u<0;)u+=o;if(u>=0&&u<n){let b=o>0?0:c-1;for(let p=0;p<n&&u>=0&&u<n;p++){const N=i[p];a.size?a.has(N)&&(b===u&&(f.add(N),u+=o),o>0?b++:b--):p===u&&(h||f.add(N),u+=o)}}}}}else if(e===this.#t&&this.#t.nodeType===l.ELEMENT_NODE&&o+c===1)if(t){let i;for(const n of t)if(i=this._matchLeaves(n,e),i)break;i&&f.add(e)}else f.add(e);return f}_collectNthOfType(s,e){const{a:o,b:c,reverse:r}=s,{localName:h,parentNode:d,prefix:f}=e,t=new Set;if(d){const i=[].slice.call(d.childNodes).filter(a=>a.nodeType===l.ELEMENT_NODE),n=i.length;if(n)if(r&&i.reverse(),o===0){if(c>0&&c<=n){let a=0;for(const u of i){const{localName:b,prefix:p}=u;if(b===h&&p===f){if(a===c-1){t.add(u);break}a++}}}}else{let a=c-1;if(o>0)for(;a<0;)a+=o;if(a>=0&&a<n){let u=o>0?0:c-1;for(const b of i){const{localName:p,prefix:N}=b;if(p===h&&N===f){if(u===a&&(t.add(b),a+=o),a<0||a>=n)break;o>0?u++:u--}}}}}else e===this.#t&&this.#t.nodeType===l.ELEMENT_NODE&&o+c===1&&t.add(e);return t}_matchAnPlusB(s,e,o){const{nth:{a:c,b:r,name:h},selector:d}=s,f=(0,_.unescapeSelector)(h),t=new Map;f?(f==="even"?(t.set("a",2),t.set("b",0)):f==="odd"&&(t.set("a",2),t.set("b",1)),o.indexOf("last")>-1&&t.set("reverse",!0)):(typeof c=="string"&&/-?\d+/.test(c)?t.set("a",c*1):t.set("a",0),typeof r=="string"&&/-?\d+/.test(r)?t.set("b",r*1):t.set("b",0),o.indexOf("last")>-1&&t.set("reverse",!0));let i=new Set;if(t.has("a")&&t.has("b")){if(/^nth-(?:last-)?child$/.test(o)){d&&t.set("selector",d);const n=Object.fromEntries(t),a=this._collectNthChild(n,e);a.size&&(i=a)}else if(/^nth-(?:last-)?of-type$/.test(o)){const n=Object.fromEntries(t),a=this._collectNthOfType(n,e);a.size&&(i=a)}}return i}_matchPseudoElementSelector(s,e={}){const{forgive:o}=e;switch(s){case"after":case"backdrop":case"before":case"cue":case"cue-region":case"first-letter":case"first-line":case"file-selector-button":case"marker":case"placeholder":case"selection":case"target-text":{if(this.#r)throw new DOMException(`Unsupported pseudo-element ::${s}`,l.NOT_SUPPORTED_ERR);break}case"part":case"slotted":{if(this.#r)throw new DOMException(`Unsupported pseudo-element ::${s}()`,l.NOT_SUPPORTED_ERR);break}default:if(s.startsWith("-webkit-")){if(this.#r)throw new DOMException(`Unsupported pseudo-element ::${s}`,l.NOT_SUPPORTED_ERR)}else if(!o)throw new DOMException(`Unknown pseudo-element ::${s}`,l.SYNTAX_ERR)}}_matchDirectionPseudoClass(s,e){const o=(0,_.unescapeSelector)(s.name),c=(0,S.getDirectionality)(e);let r;return o===c&&(r=e),r??null}_matchLanguagePseudoClass(s,e){const o=(0,_.unescapeSelector)(s.name);let c;if(o==="*")if(e.hasAttribute("lang"))e.getAttribute("lang")&&(c=e);else{let r=e.parentNode;for(;r&&r.nodeType===l.ELEMENT_NODE;){if(r.hasAttribute("lang")){r.getAttribute("lang")&&(c=e);break}r=r.parentNode}}else if(o){const r=`(?:-${l.ALPHA_NUM})*`;if(new RegExp(`^(?:\\*-)?${l.ALPHA_NUM}${r}$`,"i").test(o)){let d;if(o.indexOf("-")>-1){const[f,t,...i]=o.split("-");let n;f==="*"?n=`${l.ALPHA_NUM}${r}`:n=`${f}${r}`;const a=`-${t}${r}`,u=i.length;let b="";if(u)for(let p=0;p<u;p++)b+=`-${i[p]}${r}`;d=new RegExp(`^${n}${a}${b}$`,"i")}else d=new RegExp(`^${o}${r}$`,"i");if(e.hasAttribute("lang"))d.test(e.getAttribute("lang"))&&(c=e);else{let f=e.parentNode;for(;f&&f.nodeType===l.ELEMENT_NODE;){if(f.hasAttribute("lang")){const t=f.getAttribute("lang");d.test(t)&&(c=e);break}f=f.parentNode}}}}return c??null}_matchHasPseudoFunc(s,e){let o;if(Array.isArray(s)&&s.length){const[c]=s,{type:r}=c;let h;r===l.COMBINATOR?h=s.shift():h={name:" ",type:l.COMBINATOR};const d=[];for(;s.length;){const[i]=s,{type:n}=i;if(n===l.COMBINATOR)break;d.push(s.shift())}const f={combo:h,leaves:d},t=this._matchCombinator(f,e,{find:C});if(t.size)if(s.length){for(const i of t)if(o=this._matchHasPseudoFunc(Object.assign([],s),i),o)break}else o=!0}return!!o}_matchLogicalPseudoFunc(s,e){const{astName:o="",branches:c=[],selector:r="",twigBranches:h=[]}=s;let d;if(o==="has")if(r.includes(":has("))d=null;else{const f=c.length;let t;for(let i=0;i<f;i++){const n=c[i];if(t=this._matchHasPseudoFunc(Object.assign([],n),e),t)break}t&&(d=e)}else{const f=/^(?:is|where)$/.test(o),t=h.length;let i;for(let n=0;n<t;n++){const a=h[n],u=a.length-1,{leaves:b}=a[u];if(i=this._matchLeaves(b,e,{forgive:f}),i&&u>0){let p=new Set([e]);for(let N=u-1;N>=0;N--){const g=a[N],m=[];for(const w of p){const k=this._matchCombinator(g,w,{forgive:f,find:D});k.size&&m.push(...k)}if(m.length)if(N===0){i=!0;break}else p=new Set(m);else{i=!1;break}}}if(i)break}o==="not"?i||(d=e):i&&(d=e)}return d??null}_matchPseudoClassSelector(s,e,o={}){const{children:c}=s,{localName:r,parentNode:h}=e,{forgive:d}=o,f=(0,_.unescapeSelector)(s.name);let t=new Set;if(l.REG_LOGICAL_PSEUDO.test(f)){let i;if(this.#o.has(s))i=this.#o.get(s);else{const a=(0,_.walkAST)(s),u=[],b=[];for(const[...p]of a){for(const w of p){const k=(0,_.generateCSS)(w);u.push(k)}const N=[],g=new Set;let m=p.shift();for(;m;)if(m.type===l.COMBINATOR?(N.push({combo:m,leaves:[...g]}),g.clear()):m&&g.add(m),p.length)m=p.shift();else{N.push({combo:null,leaves:[...g]}),g.clear();break}b.push(N)}i={astName:f,branches:a,twigBranches:b,selector:u.join(",")},this.#o.set(s,i)}const n=this._matchLogicalPseudoFunc(i,e);n&&t.add(n)}else if(Array.isArray(c)){const[i]=c;if(/^nth-(?:last-)?(?:child|of-type)$/.test(f)){const n=this._matchAnPlusB(i,e,f);n.size&&(t=n)}else if(f==="dir"){const n=this._matchDirectionPseudoClass(i,e);n&&t.add(n)}else if(f==="lang"){const n=this._matchLanguagePseudoClass(i,e);n&&t.add(n)}else switch(f){case"current":case"nth-col":case"nth-last-col":{if(this.#r)throw new DOMException(`Unsupported pseudo-class :${f}()`,l.NOT_SUPPORTED_ERR);break}case"host":case"host-context":break;default:if(!d)throw new DOMException(`Unknown pseudo-class :${f}()`,l.SYNTAX_ERR)}}else{const i=/^a(?:rea)?$/,n=/^(?:(?:fieldse|inpu|selec)t|button|opt(?:group|ion)|textarea)$/,a=/^(?:(?:inpu|selec)t|button|form|textarea)$/,u=/^d(?:etails|ialog)$/,b=/^(?:checkbox|radio)$/,p=/^(?:date(?:time-local)?|month|time|week)$/,N=/(?:(?:rang|tim)e|date(?:time-local)?|month|number|week)$/,g=/^(?:(?:emai|te|ur)l|number|password|search|text)$/;switch(f){case"any-link":case"link":{i.test(r)&&e.hasAttribute("href")&&t.add(e);break}case"local-link":{if(i.test(r)&&e.hasAttribute("href")){const{href:m,origin:w,pathname:k}=new URL(this.#s.URL),y=new URL(e.getAttribute("href"),m);y.origin===w&&y.pathname===k&&t.add(e)}break}case"visited":break;case"target":{const{hash:m}=new URL(this.#s.URL);e.id&&m===`#${e.id}`&&this.#s.contains(e)&&t.add(e);break}case"target-within":{const{hash:m}=new URL(this.#s.URL);if(m){const w=m.replace(/^#/,"");let k=this.#s.getElementById(w);for(;k;){if(k===e){t.add(e);break}k=k.parentNode}}break}case"scope":{this.#e.nodeType===l.ELEMENT_NODE?e===this.#e&&t.add(e):e===this.#s.documentElement&&t.add(e);break}case"focus":{e===this.#s.activeElement&&t.add(e);break}case"focus-within":{let m=this.#s.activeElement;for(;m;){if(m===e){t.add(e);break}m=m.parentNode}break}case"open":{u.test(r)&&e.hasAttribute("open")&&t.add(e);break}case"closed":{u.test(r)&&!e.hasAttribute("open")&&t.add(e);break}case"disabled":{if(n.test(r)||(0,I.default)(r))if(e.disabled||e.hasAttribute("disabled"))t.add(e);else{let m=h;for(;m&&m.localName!=="fieldset";)m=m.parentNode;m&&h.localName!=="legend"&&m.hasAttribute("disabled")&&t.add(e)}break}case"enabled":{(n.test(r)||(0,I.default)(r))&&!(e.disabled&&e.hasAttribute("disabled"))&&t.add(e);break}case"read-only":{switch(r){case"textarea":{(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}case"input":{(!e.type||p.test(e.type)||g.test(e.type))&&(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}default:(0,S.isContentEditable)(e)||t.add(e)}break}case"read-write":{switch(r){case"textarea":{e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled")||t.add(e);break}case"input":{(!e.type||p.test(e.type)||g.test(e.type))&&!(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}default:(0,S.isContentEditable)(e)&&t.add(e)}break}case"placeholder-shown":{let m;r==="textarea"?m=e:r==="input"&&(e.hasAttribute("type")?g.test(e.getAttribute("type"))&&(m=e):m=e),m&&e.value===""&&e.hasAttribute("placeholder")&&e.getAttribute("placeholder").trim().length&&t.add(e);break}case"checked":{(e.checked&&r==="input"&&e.hasAttribute("type")&&b.test(e.getAttribute("type"))||e.selected&&r==="option")&&t.add(e);break}case"indeterminate":{if(e.indeterminate&&r==="input"&&e.type==="checkbox"||r==="progress"&&!e.hasAttribute("value"))t.add(e);else if(r==="input"&&e.type==="radio"&&!e.hasAttribute("checked")){const m=e.name;let w=e.parentNode;for(;w&&w.localName!=="form";)w=w.parentNode;w||(w=this.#s.documentElement);const k=[].slice.call(w.getElementsByTagName("input"));let y;for(const v of k)if(v.getAttribute("type")==="radio"&&(m?v.getAttribute("name")===m&&(y=!!v.checked):v.hasAttribute("name")||(y=!!v.checked),y))break;y||t.add(e)}break}case"default":{const m=/^(?:button|reset)$/,w=/^(?:image|submit)$/;if(r==="button"&&!(e.hasAttribute("type")&&m.test(e.getAttribute("type")))||r==="input"&&e.hasAttribute("type")&&w.test(e.getAttribute("type"))){let k=e.parentNode;for(;k&&k.localName!=="form";)k=k.parentNode;if(k){const y=this.#s.createNodeIterator(k,l.SHOW_ELEMENT);let v=y.nextNode();for(;v;){const E=v.localName;let x;if(E==="button"?x=!(v.hasAttribute("type")&&m.test(v.getAttribute("type"))):E==="input"&&(x=v.hasAttribute("type")&&w.test(v.getAttribute("type"))),x){v===e&&t.add(e);break}v=y.nextNode()}}}else if(r==="input"&&e.hasAttribute("type")&&b.test(e.getAttribute("type"))&&(e.checked||e.hasAttribute("checked")))t.add(e);else if(r==="option"){let k=!1,y=h;for(;y&&y.localName!=="datalist";){if(y.localName==="select"){(y.multiple||y.hasAttribute("multiple"))&&(k=!0);break}y=y.parentNode}if(k)(e.selected||e.hasAttribute("selected"))&&t.add(e);else{const v=h.firstElementChild,E=new Set;let x=v;for(;x;){if(x.selected||x.hasAttribute("selected")){E.add(x);break}x=x.nextElementSibling}E.size||E.add(v),E.has(e)&&t.add(e)}}break}case"valid":{if(a.test(r))e.checkValidity()&&t.add(e);else if(r==="fieldset"){let m=this._traverse(e);m===e&&(m=this.#a.nextNode());let w;for(;m&&!(a.test(m.localName)&&(w=m.checkValidity(),!w));)m=this.#a.nextNode();w&&t.add(e)}break}case"invalid":{if(a.test(r))e.checkValidity()||t.add(e);else if(r==="fieldset"){let m=this._traverse(e);m===e&&(m=this.#a.nextNode());let w;for(;m&&!(a.test(m.localName)&&(w=m.checkValidity(),!w));)m=this.#a.nextNode();w||t.add(e)}break}case"in-range":{r==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&N.test(e.getAttribute("type"))&&!(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&(e.hasAttribute("min")||e.hasAttribute("max")||e.getAttribute("type")==="range")&&t.add(e);break}case"out-of-range":{r==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&N.test(e.getAttribute("type"))&&(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&t.add(e);break}case"required":{let m;if(/^(?:select|textarea)$/.test(r))m=e;else if(r==="input")if(e.hasAttribute("type")){const w=e.getAttribute("type");(w==="file"||b.test(w)||p.test(w)||g.test(w))&&(m=e)}else m=e;m&&(e.required||e.hasAttribute("required"))&&t.add(e);break}case"optional":{let m;if(/^(?:select|textarea)$/.test(r))m=e;else if(r==="input")if(e.hasAttribute("type")){const w=e.getAttribute("type");(w==="file"||b.test(w)||p.test(w)||g.test(w))&&(m=e)}else m=e;m&&!(e.required||e.hasAttribute("required"))&&t.add(e);break}case"root":{e===this.#s.documentElement&&t.add(e);break}case"empty":{if(e.hasChildNodes()){const m=e.childNodes.values();let w;for(const k of m)if(w=k.nodeType!==l.ELEMENT_NODE&&k.nodeType!==l.TEXT_NODE,!w)break;w&&t.add(e)}else t.add(e);break}case"first-child":{(h&&e===h.firstElementChild||e===this.#t&&this.#t.nodeType===l.ELEMENT_NODE)&&t.add(e);break}case"last-child":{(h&&e===h.lastElementChild||e===this.#t&&this.#t.nodeType===l.ELEMENT_NODE)&&t.add(e);break}case"only-child":{(h&&e===h.firstElementChild&&e===h.lastElementChild||e===this.#t&&this.#t.nodeType===l.ELEMENT_NODE)&&t.add(e);break}case"first-of-type":{if(h){const[m]=this._collectNthOfType({a:0,b:1},e);m&&t.add(m)}else e===this.#t&&this.#t.nodeType===l.ELEMENT_NODE&&t.add(e);break}case"last-of-type":{if(h){const[m]=this._collectNthOfType({a:0,b:1,reverse:!0},e);m&&t.add(m)}else e===this.#t&&this.#t.nodeType===l.ELEMENT_NODE&&t.add(e);break}case"only-of-type":{if(h){const[m]=this._collectNthOfType({a:0,b:1},e);if(m===e){const[w]=this._collectNthOfType({a:0,b:1,reverse:!0},e);w===e&&t.add(e)}}else e===this.#t&&this.#t.nodeType===l.ELEMENT_NODE&&t.add(e);break}case"host":case"host-context":break;case"after":case"before":case"first-letter":case"first-line":{if(this.#r)throw new DOMException(`Unsupported pseudo-element ::${f}`,l.NOT_SUPPORTED_ERR);break}case"active":case"autofill":case"blank":case"buffering":case"current":case"focus-visible":case"fullscreen":case"future":case"hover":case"modal":case"muted":case"past":case"paused":case"picture-in-picture":case"playing":case"seeking":case"stalled":case"user-invalid":case"user-valid":case"volume-locked":case"-webkit-autofill":{if(this.#r)throw new DOMException(`Unsupported pseudo-class :${f}`,l.NOT_SUPPORTED_ERR);break}default:if(f.startsWith("-webkit-")){if(this.#r)throw new DOMException(`Unsupported pseudo-class :${f}`,l.NOT_SUPPORTED_ERR)}else if(!d)throw new DOMException(`Unknown pseudo-class :${f}`,l.SYNTAX_ERR)}}return t}_matchAttributeSelector(s,e){const{flags:o,matcher:c,name:r,value:h}=s;if(typeof o=="string"&&!/^[is]$/i.test(o)){const t=(0,_.generateCSS)(s);throw new DOMException(`Invalid selector ${t}`,l.SYNTAX_ERR)}const{attributes:d}=e;let f;if(d&&d.length){let t;this.#s.contentType==="text/html"?typeof o=="string"&&/^s$/i.test(o)?t=!1:t=!0:typeof o=="string"&&/^i$/i.test(o)?t=!0:t=!1;let i=(0,_.unescapeSelector)(r.name);t&&(i=i.toLowerCase());const n=new Set;if(i.indexOf("|")>-1){const{prefix:a,tagName:u}=(0,S.selectorToNodeProps)(i);for(let{name:b,value:p}of d)switch(t&&(b=b.toLowerCase(),p=p.toLowerCase()),a){case"":{u===b&&n.add(p);break}case"*":{b.indexOf(":")>-1?b.endsWith(`:${u}`)&&n.add(p):u===b&&n.add(p);break}default:if(b.indexOf(":")>-1){const[N,g]=b.split(":");a===N&&u===g&&(0,S.isNamespaceDeclared)(a,e)&&n.add(p)}}}else for(let{name:a,value:u}of d)if(t&&(a=a.toLowerCase(),u=u.toLowerCase()),a.indexOf(":")>-1){const[b,p]=a.split(":");if(b==="xml"&&p==="lang")continue;i===p&&n.add(u)}else i===a&&n.add(u);if(n.size){const{name:a,value:u}=h||{};let b;switch(a?t?b=a.toLowerCase():b=a:u?t?b=u.toLowerCase():b=u:u===""&&(b=u),c){case"=":{typeof b=="string"&&n.has(b)&&(f=e);break}case"~=":{if(b&&typeof b=="string"){for(const p of n)if(new Set(p.split(/\s+/)).has(b)){f=e;break}}break}case"|=":{if(b&&typeof b=="string"){let p;for(const N of n)if(N===b||N.startsWith(`${b}-`)){p=N;break}p&&(f=e)}break}case"^=":{if(b&&typeof b=="string"){let p;for(const N of n)if(N.startsWith(`${b}`)){p=N;break}p&&(f=e)}break}case"$=":{if(b&&typeof b=="string"){let p;for(const N of n)if(N.endsWith(`${b}`)){p=N;break}p&&(f=e)}break}case"*=":{if(b&&typeof b=="string"){let p;for(const N of n)if(N.includes(`${b}`)){p=N;break}p&&(f=e)}break}case null:default:f=e}}}return f??null}_matchClassSelector(s,e){const o=(0,_.unescapeSelector)(s.name);let c;return e.classList.contains(o)&&(c=e),c??null}_matchIDSelector(s,e){const o=(0,_.unescapeSelector)(s.name),{id:c}=e;let r;return o===c&&(r=e),r??null}_matchTypeSelector(s,e,o={}){const c=(0,_.unescapeSelector)(s.name),{localName:r,prefix:h}=e,{forgive:d}=o;let{prefix:f,tagName:t}=(0,S.selectorToNodeProps)(c,e);this.#s.contentType==="text/html"&&(f=f.toLowerCase(),t=t.toLowerCase());let i,n;r.indexOf(":")>-1?[i,n]=r.split(":"):(i=h||"",n=r);let a;if(f===""&&i==="")e.namespaceURI===null&&(t==="*"||t===n)&&(a=e);else if(f==="*")(t==="*"||t===n)&&(a=e);else if(f===i){if((0,S.isNamespaceDeclared)(f,e))(t==="*"||t===n)&&(a=e);else if(!d)throw new DOMException(`Undeclared namespace ${f}`,l.SYNTAX_ERR)}else if(f&&!d&&!(0,S.isNamespaceDeclared)(f,e))throw new DOMException(`Undeclared namespace ${f}`,l.SYNTAX_ERR);return a??null}_matchShadowHostPseudoClass(s,e){const{children:o}=s,c=(0,_.unescapeSelector)(s.name);let r;if(Array.isArray(o)){const[h]=(0,_.walkAST)(o[0]),[...d]=h,{host:f}=e;if(c==="host"){let t;for(const i of d){const{type:n}=i;if(n===l.COMBINATOR){const a=(0,_.generateCSS)(s);throw new DOMException(`Invalid selector ${a}`,l.SYNTAX_ERR)}if(t=this._matchSelector(i,f).has(f),!t)break}t&&(r=e)}else if(c==="host-context"){let t=f,i;for(;t;){for(const n of d){const{type:a}=n;if(a===l.COMBINATOR){const u=(0,_.generateCSS)(s);throw new DOMException(`Invalid selector ${u}`,l.SYNTAX_ERR)}if(i=this._matchSelector(n,t).has(t),!i)break}if(i)break;t=t.parentNode}i&&(r=e)}}else if(c==="host")r=e;else throw new DOMException(`Invalid selector :${c}`,l.SYNTAX_ERR);return r??null}_matchSelector(s,e,o){const{type:c}=s,r=(0,_.unescapeSelector)(s.name);let h=new Set;if(e.nodeType===l.ELEMENT_NODE)switch(c){case l.SELECTOR_ATTR:{const d=this._matchAttributeSelector(s,e);d&&h.add(d);break}case l.SELECTOR_CLASS:{const d=this._matchClassSelector(s,e);d&&h.add(d);break}case l.SELECTOR_ID:{const d=this._matchIDSelector(s,e);d&&h.add(d);break}case l.SELECTOR_PSEUDO_CLASS:{const d=this._matchPseudoClassSelector(s,e,o);d.size&&(h=d);break}case l.SELECTOR_PSEUDO_ELEMENT:{this._matchPseudoElementSelector(r,o);break}case l.SELECTOR_TYPE:default:{const d=this._matchTypeSelector(s,e,o);d&&h.add(d)}}else if(this.#n&&c===l.SELECTOR_PSEUDO_CLASS&&e.nodeType===l.DOCUMENT_FRAGMENT_NODE){if(r!=="has"&&l.REG_LOGICAL_PSEUDO.test(r)){const d=this._matchPseudoClassSelector(s,e,o);d.size&&(h=d)}else if(l.REG_SHADOW_HOST.test(r)){const d=this._matchShadowHostPseudoClass(s,e);d&&h.add(d)}}return h}_matchLeaves(s,e,o){let c;for(const r of s)if(c=this._matchSelector(r,e,o).has(e),!c)break;return!!c}_findDescendantNodes(s,e){const[o,...c]=s,{type:r}=o,h=(0,_.unescapeSelector)(o.name),d=c.length>0;let f=new Set,t=!1;if(this.#n)t=!0;else switch(r){case l.SELECTOR_ID:{if(this.#t.nodeType===l.ELEMENT_NODE)t=!0;else{const i=this.#t.getElementById(h);i&&i!==e&&e.contains(i)&&(d?this._matchLeaves(c,i)&&f.add(i):f.add(i))}break}case l.SELECTOR_CLASS:{const i=[].slice.call(e.getElementsByClassName(h));if(i.length)if(d)for(const n of i)this._matchLeaves(c,n)&&f.add(n);else f=new Set(i);break}case l.SELECTOR_TYPE:{if(this.#s.contentType==="text/html"&&!/[*|]/.test(h)){const i=[].slice.call(e.getElementsByTagName(h));if(i.length)if(d)for(const n of i)this._matchLeaves(c,n)&&f.add(n);else f=new Set(i)}else t=!0;break}case l.SELECTOR_PSEUDO_ELEMENT:{this._matchPseudoElementSelector(h);break}default:t=!0}return{nodes:f,pending:t}}_matchCombinator(s,e,o={}){const{combo:c,leaves:r}=s,{name:h}=c,{find:d,forgive:f}=o;let t=new Set;if(d===C)switch(h){case"+":{const i=e.nextElementSibling;i&&this._matchLeaves(r,i,{forgive:f})&&t.add(i);break}case"~":{let i=e.nextElementSibling;for(;i;)this._matchLeaves(r,i,{forgive:f})&&t.add(i),i=i.nextElementSibling;break}case">":{const i=e.childNodes.values();for(const n of i)n.nodeType===l.ELEMENT_NODE&&this._matchLeaves(r,n,{forgive:f})&&t.add(n);break}case" ":default:{const{nodes:i,pending:n}=this._findDescendantNodes(r,e);if(i.size)t=i;else if(n){let a=this._traverse(e);for(a===e&&(a=this.#a.nextNode());a;)this._matchLeaves(r,a,{forgive:f})&&t.add(a),a=this.#a.nextNode()}}}else switch(h){case"+":{const i=e.previousElementSibling;i&&this._matchLeaves(r,i,{forgive:f})&&t.add(i);break}case"~":{const i=[];let n=e.previousElementSibling;for(;n;)this._matchLeaves(r,n,{forgive:f})&&i.push(n),n=n.previousElementSibling;i.length&&(t=new Set(i.reverse()));break}case">":{const i=e.parentNode;i&&this._matchLeaves(r,i,{forgive:f})&&t.add(i);break}case" ":default:{const i=[];let n=e.parentNode;for(;n;)this._matchLeaves(r,n,{forgive:f})&&i.push(n),n=n.parentNode;i.length&&(t=new Set(i.reverse()))}}return t}_findNode(s,e={}){let{node:o,targetType:c,tree:r}=e;r||(r=this.#a);let h=this._traverse(o);(h.nodeType!==l.ELEMENT_NODE||h===o)&&(h=r.nextNode());let d;for(;h;){let f;if(this.#e.nodeType===l.ELEMENT_NODE?h===this.#e?f=!0:f=this.#e.contains(h):f=!0,f&&this._matchLeaves(s,h)){d=h;break}c===O?h=r.parentNode():h=r.nextNode()}return d??null}_findEntryNodes(s,e){const{leaves:o}=s,[c,...r]=o,{type:h}=c,d=(0,_.unescapeSelector)(c.name),f=r.length>0;let t=new Set,i=!1,n=!1;switch(h){case l.SELECTOR_ID:{if(e===P)this._matchLeaves(o,this.#e)&&(t.add(this.#e),i=!0);else if(e===O){let a=this.#e;for(;a;)this._matchLeaves(o,a)&&(t.add(a),i=!0),a=a.parentNode}else if(e===T||this.#t.nodeType===l.ELEMENT_NODE)n=!0;else{const a=this.#t.getElementById(d);a&&(t.add(a),i=!0)}break}case l.SELECTOR_CLASS:{if(e===P)this.#e.nodeType===l.ELEMENT_NODE&&this.#e.classList.contains(d)&&t.add(this.#e);else if(e===O){let a=this.#e;for(;a&&a.nodeType===l.ELEMENT_NODE;)a.classList.contains(d)&&t.add(a),a=a.parentNode}else if(e===L){const a=this._findNode(o,{node:this.#e,targetType:e,tree:this.#l});if(a){t.add(a),i=!0;break}}else if(this.#t.nodeType===l.DOCUMENT_FRAGMENT_NODE){const a=this.#t.childNodes.values(),u=[];for(const b of a)if(b.nodeType===l.ELEMENT_NODE){b.classList.contains(d)&&u.push(b);const p=[].slice.call(b.getElementsByClassName(d));u.push(...p)}u.length&&(t=new Set(u))}else{const a=[].slice.call(this.#t.getElementsByClassName(d));if(this.#e.nodeType===l.ELEMENT_NODE)for(const u of a)(u===this.#e||(0,S.isInclusive)(u,this.#e))&&t.add(u);else a.length&&(t=new Set(a))}break}case l.SELECTOR_TYPE:{if(e===P)this.#e.nodeType===l.ELEMENT_NODE&&this._matchLeaves(o,this.#e)&&(t.add(this.#e),i=!0);else if(e===O){let a=this.#e;for(;a&&a.nodeType===l.ELEMENT_NODE;)this._matchLeaves(o,a)&&(t.add(a),i=!0),a=a.parentNode}else if(e===L){const a=this._findNode(o,{node:this.#e,targetType:e,tree:this.#l});if(a){t.add(a),i=!0;break}}else if(this.#s.contentType!=="text/html"||/[*|]/.test(d))n=!0;else if(this.#t.nodeType===l.DOCUMENT_FRAGMENT_NODE){const a=d.toLowerCase(),u=this.#t.childNodes.values(),b=[];for(const p of u)if(p.nodeType===l.ELEMENT_NODE){p.localName===a&&b.push(p);const N=[].slice.call(p.getElementsByTagName(d));b.push(...N)}b.length&&(t=new Set(b))}else{const a=[].slice.call(this.#t.getElementsByTagName(d));if(this.#e.nodeType===l.ELEMENT_NODE)for(const u of a)(u===this.#e||(0,S.isInclusive)(u,this.#e))&&t.add(u);else a.length&&(t=new Set(a))}break}case l.SELECTOR_PSEUDO_ELEMENT:{this._matchPseudoElementSelector(d);break}default:if(e!==O&&l.REG_SHADOW_HOST.test(d)){if(this.#n&&this.#e.nodeType===l.DOCUMENT_FRAGMENT_NODE){const a=this._matchShadowHostPseudoClass(c,this.#e);a&&t.add(a)}}else if(e===P)this._matchLeaves(o,this.#e)&&(t.add(this.#e),i=!0);else if(e===O){let a=this.#e;for(;a;)this._matchLeaves(o,a)&&(t.add(a),i=!0),a=a.parentNode}else if(e===L){const a=this._findNode(o,{node:this.#e,targetType:e,tree:this.#l});if(a){t.add(a),i=!0;break}}else n=!0}if(!t.size&&!n&&f){const a=r[r.length-1],{type:u}=a;if(u===l.SELECTOR_PSEUDO_CLASS){let b;this.#t.nodeType===l.ELEMENT_NODE?b=this.#t:b=this.#t.firstElementChild,this._matchPseudoClassSelector(a,b)}}return{compound:f,filtered:i,nodes:t,pending:n}}_getEntryTwig(s,e){const o=s.length,c=o>1,r=s[0];let h,d;if(c){const{leaves:[{type:f}]}=r,t=s[o-1],{leaves:[{type:i}]}=t;if(i===l.SELECTOR_PSEUDO_ELEMENT||i===l.SELECTOR_ID)h=D,d=t;else if(f===l.SELECTOR_PSEUDO_ELEMENT||f===l.SELECTOR_ID||e===T)h=C,d=r;else{let n;for(const{combo:a,leaves:[u]}of s){const{type:b}=u,p=(0,_.unescapeSelector)(u.name);if(b===l.SELECTOR_PSEUDO_CLASS&&p==="dir"){n=!1;break}if(a){const{name:N}=a;if(/^[+~]$/.test(N)){n=!0;break}}}n?(h=C,d=r):(h=D,d=t)}}else h=D,d=r;return{complex:c,find:h,twig:d}}_collectNodes(s){const e=this.#i.values();if(s===T||s===L){s===L&&(this.#e.nodeType===l.ELEMENT_NODE?this.#l=this.#s.createTreeWalker(this.#e,l.SHOW_ELEMENT):this.#l=this.#a);const o=new Set;let c=0;for(const{branch:r}of e){const{find:h,twig:d}=this._getEntryTwig(r,s),{compound:f,filtered:t,nodes:i,pending:n}=this._findEntryNodes(d,s);i.size?this.#c[c]=i:n?o.add(new Map([["index",c],["twig",d]])):this.#i[c].skip=!0,this.#i[c].filtered=t||!f,this.#i[c].find=h,c++}if(o.size){let r=this._traverse();for(;r;){let h=!1;if(this.#e.nodeType===l.ELEMENT_NODE?r===this.#e?h=!0:h=this.#e.contains(r):h=!0,h)for(const d of o){const{leaves:f}=d.get("twig");if(this._matchLeaves(f,r)){const i=d.get("index");this.#c[i].add(r),this.#i[i].filtered=!0}}r=this.#a.nextNode()}}}else{let o=0;for(const{branch:c}of e){const r=c[c.length-1],{compound:h,filtered:d,nodes:f}=this._findEntryNodes(r,s);f.size?this.#c[o]=f:this.#i[o].skip=!0,this.#i[o].filtered=d||!h,this.#i[o].find=D,o++}}return[this.#i,this.#c]}_sortNodes(s){const e=[...s];return e.length>1&&e.sort((o,c)=>{let r;return(0,S.isPreceding)(c,o)?r=1:r=-1,r}),e}_matchNodes(s){const[...e]=this.#i,o=e.length;let c=new Set;for(let r=0;r<o;r++){const{branch:h,filtered:d,find:f,skip:t}=e[r],i=h.length;if(!t&&i){const n=this.#c[r],a=i-1;if(a===0){const{leaves:[,...u]}=h[0];if((s===T||s===L)&&this.#e.nodeType===l.ELEMENT_NODE){for(const b of n)if((d||this._matchLeaves(u,b))&&b!==this.#e&&this.#e.contains(b)&&(c.add(b),s!==T))break}else if(u.length){for(const b of n)if((d||this._matchLeaves(u,b))&&(c.add(b),s!==T))break}else if(s===T){const b=[...c];c=new Set([...b,...n])}else{const[b]=[...n];c.add(b)}}else if(f===C){let{combo:u,leaves:b}=h[0];const[,...p]=b;let N;for(const g of n){if(d||this._matchLeaves(p,g)){let w=new Set([g]);for(let k=1;k<i;k++){const{combo:y,leaves:v}=h[k],E=[];for(const x of w){const R={combo:u,leaves:v},$=this._matchCombinator(R,x,{find:f});$.size&&E.push(...$)}if(E.length)if(k===a){if(s===L){const[x]=this._sortNodes(E);c.add(x)}else{const x=[...c];c=new Set([...x,...E])}N=!0;break}else N=!1,u=y,w=new Set(E);else{N=!1;break}}}else N=!1;if(N&&s!==T)break}if(!N&&s===L){const[g]=[...n];let m=this._findNode(b,{targetType:s,node:g,tree:this.#l});for(;m;){let w=new Set([m]);for(let k=1;k<i;k++){const{combo:y,leaves:v}=h[k],E=[];for(const x of w){const R={combo:u,leaves:v},$=this._matchCombinator(R,x,{find:f});$.size&&E.push(...$)}if(E.length)if(k===a){const[x]=this._sortNodes(E);c.add(x),N=!0;break}else N=!1,u=y,w=new Set(E);else{N=!1;break}}if(N)break;m=this._findNode(b,{targetType:s,node:m,tree:this.#l}),w=new Set([m])}}}else{const{leaves:u}=h[a],[,...b]=u;let p;for(const N of n){if(d||this._matchLeaves(b,N)){let m=new Set([N]);for(let w=a-1;w>=0;w--){const k=h[w],y=[];for(const v of m){const E=this._matchCombinator(k,v,{find:f});E.size&&y.push(...E)}if(y.length)if(w===0){c.add(N),p=!0;break}else p=!1,m=new Set(y);else{p=!1;break}}}if(p&&s!==T)break}if(!p&&s===L){const[N]=[...n];let g=this._findNode(u,{targetType:s,node:N,tree:this.#l});for(;g;){let m=new Set([g]);for(let w=a-1;w>=0;w--){const k=h[w],y=[];for(const v of m){const E=this._matchCombinator(k,v,{find:f});E.size&&y.push(...E)}if(y.length)if(w===0){c.add(g),p=!0;break}else p=!1,m=new Set(y);else{p=!1;break}}if(p)break;g=this._findNode(u,{targetType:s,node:g,tree:this.#l}),m=new Set([g])}}}}}return c}_find(s){return this._collectNodes(s),this._matchNodes(s)}matches(){if(this.#e.nodeType!==l.ELEMENT_NODE)throw new TypeError(`Unexpected node ${this.#e.nodeName}`);let s;try{const e=this._find(P);e.size&&(s=e.has(this.#e))}catch(e){this._onError(e)}return!!s}closest(){if(this.#e.nodeType!==l.ELEMENT_NODE)throw new TypeError(`Unexpected node ${this.#e.nodeName}`);let s;try{const e=this._find(O);let o=this.#e;for(;o;){if(e.has(o)){s=o;break}o=o.parentNode}}catch(e){this._onError(e)}return s??null}querySelector(){let s;try{const e=this._find(L);e.delete(this.#e),e.size&&([s]=this._sortNodes(e))}catch(e){this._onError(e)}return s??null}querySelectorAll(){let s;try{const e=this._find(T);e.delete(this.#e),e.size&&(s=this._sortNodes(e))}catch(e){this._onError(e)}return s??[]}}0&&(module.exports={Matcher});
//# sourceMappingURL=matcher.js.map
