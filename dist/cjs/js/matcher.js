var z=Object.create;var R=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var F=Object.getPrototypeOf,V=Object.prototype.hasOwnProperty;var H=(T,l)=>{for(var e in l)R(T,e,{get:l[e],enumerable:!0})},W=(T,l,e,c)=>{if(l&&typeof l=="object"||typeof l=="function")for(let o of j(l))!V.call(T,o)&&o!==e&&R(T,o,{get:()=>l[o],enumerable:!(c=B(l,o))||c.enumerable});return T};var G=(T,l,e)=>(e=T!=null?z(F(T)):{},W(l||!T||!T.__esModule?R(e,"default",{value:T,enumerable:!0}):e,T)),q=T=>W(R({},"__esModule",{value:!0}),T);var X={};H(X,{Matcher:()=>Y});module.exports=q(X);var I=G(require("is-potential-custom-element-name"),1),E=require("./dom-util.js"),v=require("./parser.js"),r=require("./constant.js");const C="next",$="prev",A="all",L="first",O="lineal",D="self",U=r.SHOW_DOCUMENT|r.SHOW_DOCUMENT_FRAGMENT|r.SHOW_ELEMENT;class Y{#i;#d;#r;#s;#a;#e;#o;#t;#b;#n;#f;#h;#l;#c;constructor(){this.#d=new Map([[r.SELECTOR_PSEUDO_ELEMENT,r.BIT_01],[r.SELECTOR_ID,r.BIT_02],[r.SELECTOR_CLASS,r.BIT_04],[r.SELECTOR_TYPE,r.BIT_08],[r.SELECTOR_ATTR,r.BIT_16],[r.SELECTOR_PSEUDO_CLASS,r.BIT_32]]),this.#r=new WeakMap}_onError(l){if(l instanceof DOMException||this.#c&&l instanceof this.#c.DOMException)if(l.name===r.NOT_SUPPORTED_ERR)this.#l&&console.warn(l.message);else throw this.#c?new this.#c.DOMException(l.message,l.name):new DOMException(l.message,l.name);else throw l}_setup(l){let e,c;switch(l?.nodeType){case r.DOCUMENT_NODE:{e=l,c=l;break}case r.DOCUMENT_FRAGMENT_NODE:{e=l.ownerDocument,c=l;break}case r.ELEMENT_NODE:{if(l.ownerDocument.contains(l))e=l.ownerDocument,c=l.ownerDocument;else{let f=l;for(;f&&f.parentNode;)f=f.parentNode;e=f.ownerDocument,c=f}break}default:{let f;throw l?.nodeName?f=`Unexpected node ${l.nodeName}`:f=`Unexpected node ${Object.prototype.toString.call(l).slice(r.TYPE_FROM,r.TYPE_TO)}`,new TypeError(f)}}const o=e.createTreeWalker(c,U);return[e.defaultView,e,c,o]}_sortLeaves(l){const e=[...l];return e.length>1&&e.sort((c,o)=>{const{type:a}=c,{type:f}=o,n=this.#d.get(a),d=this.#d.get(f);let t;return n===d?t=0:n>d?t=1:t=-1,t}),e}_correspond(l){let e;try{e=(0,v.parseSelector)(l)}catch(n){this._onError(n)}const c=(0,v.walkAST)(e),o=[],a=[];let f=0;for(const[...n]of c){const d=[];let t=n.shift();if(t&&t.type!==r.COMBINATOR){const i=new Set;for(;t;){if(t.type===r.COMBINATOR){const[h]=n;if(h.type===r.COMBINATOR){const s=`Invalid combinator ${t.name}${h.name}`;throw new this.#c.DOMException(s,r.SYNTAX_ERR)}d.push({combo:t,leaves:this._sortLeaves(i)}),i.clear()}else t&&i.add(t);if(n.length)t=n.shift();else{d.push({combo:null,leaves:this._sortLeaves(i)}),i.clear();break}}}o.push({branch:d,dir:null,filtered:!1,find:!1}),a[f]=new Set,f++}return[o,a]}_traverse(l={},e=this.#h){let c,o=e.currentNode;if(l.nodeType===r.ELEMENT_NODE&&o===l)c=o;else{if(o!==e.root)for(;o&&!(o===e.root||l.nodeType===r.ELEMENT_NODE&&o===l);)o=e.parentNode();if(l.nodeType===r.ELEMENT_NODE)for(;o;){if(o===l){c=o;break}o=e.nextNode()}else c=o}return c??null}_collectNthChild(l,e){const{a:c,b:o,reverse:a,selector:f}=l,{parentNode:n}=e;let d=new Set,t;if(f&&(this.#r.has(f)?t=this.#r.get(f):(t=(0,v.walkAST)(f),this.#r.set(f,t))),n){const i=this.#s.createTreeWalker(n,U);let h=0,s=i.firstChild();for(;s;)h++,s=i.nextSibling();s=this._traverse(n,i);const m=new Set;if(t)for(s=this._traverse(n,i),s=i.firstChild();s;){let b;for(const p of t)if(b=this._matchLeaves(p,s),!b)break;b&&m.add(s),s=i.nextSibling()}if(c===0){if(o>0&&o<=h){if(m.size){let b=0;for(s=this._traverse(n,i),a?s=i.lastChild():s=i.firstChild();s;){if(m.has(s)){if(b===o-1){d.add(s);break}b++}a?s=i.previousSibling():s=i.nextSibling()}}else if(!f){let b=0;for(s=this._traverse(n,i),a?s=i.lastChild():s=i.firstChild();s;){if(b===o-1){d.add(s);break}a?s=i.previousSibling():s=i.nextSibling(),b++}}}}else{let b=o-1;if(c>0)for(;b<0;)b+=c;if(b>=0&&b<h){let p=0,k=c>0?0:o-1;for(s=this._traverse(n,i),a?s=i.lastChild():s=i.firstChild();s&&(s&&b>=0&&b<h);)m.size?m.has(s)&&(k===b&&(d.add(s),b+=c),c>0?k++:k--):p===b&&(f||d.add(s),b+=c),a?s=i.previousSibling():s=i.nextSibling(),p++}}if(a&&d.size>1){const b=[...d];d=new Set(b.reverse())}}else if(e===this.#t&&this.#t.nodeType===r.ELEMENT_NODE&&c+o===1)if(t){let i;for(const h of t)if(i=this._matchLeaves(h,e),i)break;i&&d.add(e)}else d.add(e);return d}_collectNthOfType(l,e){const{a:c,b:o,reverse:a}=l,{localName:f,parentNode:n,prefix:d}=e;let t=new Set;if(n){const i=this.#s.createTreeWalker(n,U);let h=0,s=i.firstChild();for(;s;)h++,s=i.nextSibling();if(c===0){if(o>0&&o<=h){let m=0;for(s=this._traverse(n,i),a?s=i.lastChild():s=i.firstChild();s;){const{localName:b,prefix:p}=s;if(b===f&&p===d){if(m===o-1){t.add(s);break}m++}a?s=i.previousSibling():s=i.nextSibling()}}}else{let m=o-1;if(c>0)for(;m<0;)m+=c;if(m>=0&&m<h){let b=c>0?0:o-1;for(s=this._traverse(n,i),a?s=i.lastChild():s=i.firstChild();s;){const{localName:p,prefix:k}=s;if(p===f&&k===d){if(b===m&&(t.add(s),m+=c),m<0||m>=h)break;c>0?b++:b--}a?s=i.previousSibling():s=i.nextSibling()}}}if(a&&t.size>1){const m=[...t];t=new Set(m.reverse())}}else e===this.#t&&this.#t.nodeType===r.ELEMENT_NODE&&c+o===1&&t.add(e);return t}_matchAnPlusB(l,e,c){const{nth:{a:o,b:a,name:f},selector:n}=l,d=(0,v.unescapeSelector)(f),t=new Map;d?(d==="even"?(t.set("a",2),t.set("b",0)):d==="odd"&&(t.set("a",2),t.set("b",1)),c.indexOf("last")>-1&&t.set("reverse",!0)):(typeof o=="string"&&/-?\d+/.test(o)?t.set("a",o*1):t.set("a",0),typeof a=="string"&&/-?\d+/.test(a)?t.set("b",a*1):t.set("b",0),c.indexOf("last")>-1&&t.set("reverse",!0));let i=new Set;if(t.has("a")&&t.has("b")){if(/^nth-(?:last-)?child$/.test(c)){n&&t.set("selector",n);const h=Object.fromEntries(t),s=this._collectNthChild(h,e);s.size&&(i=s)}else if(/^nth-(?:last-)?of-type$/.test(c)){const h=Object.fromEntries(t),s=this._collectNthOfType(h,e);s.size&&(i=s)}}return i}_matchPseudoElementSelector(l,e={}){const{forgive:c}=e;switch(l){case"after":case"backdrop":case"before":case"cue":case"cue-region":case"first-letter":case"first-line":case"file-selector-button":case"marker":case"placeholder":case"selection":case"target-text":{if(this.#l){const o=`Unsupported pseudo-element ::${l}`;throw new DOMException(o,r.NOT_SUPPORTED_ERR)}break}case"part":case"slotted":{if(this.#l){const o=`Unsupported pseudo-element ::${l}()`;throw new DOMException(o,r.NOT_SUPPORTED_ERR)}break}default:if(l.startsWith("-webkit-")){if(this.#l){const o=`Unsupported pseudo-element ::${l}`;throw new DOMException(o,r.NOT_SUPPORTED_ERR)}}else if(!c){const o=`Unknown pseudo-element ::${l}`;throw new DOMException(o,r.SYNTAX_ERR)}}}_matchDirectionPseudoClass(l,e){const c=(0,v.unescapeSelector)(l.name),o=(0,E.getDirectionality)(e);let a;return c===o&&(a=e),a??null}_matchLanguagePseudoClass(l,e){const c=(0,v.unescapeSelector)(l.name);let o;if(c==="*")if(e.hasAttribute("lang"))e.getAttribute("lang")&&(o=e);else{let a=e.parentNode;for(;a&&a.nodeType===r.ELEMENT_NODE;){if(a.hasAttribute("lang")){a.getAttribute("lang")&&(o=e);break}a=a.parentNode}}else if(c){const a=`(?:-${r.ALPHA_NUM})*`;if(new RegExp(`^(?:\\*-)?${r.ALPHA_NUM}${a}$`,"i").test(c)){let n;if(c.indexOf("-")>-1){const[d,t,...i]=c.split("-");let h;d==="*"?h=`${r.ALPHA_NUM}${a}`:h=`${d}${a}`;const s=`-${t}${a}`,m=i.length;let b="";if(m)for(let p=0;p<m;p++)b+=`-${i[p]}${a}`;n=new RegExp(`^${h}${s}${b}$`,"i")}else n=new RegExp(`^${c}${a}$`,"i");if(e.hasAttribute("lang"))n.test(e.getAttribute("lang"))&&(o=e);else{let d=e.parentNode;for(;d&&d.nodeType===r.ELEMENT_NODE;){if(d.hasAttribute("lang")){const t=d.getAttribute("lang");n.test(t)&&(o=e);break}d=d.parentNode}}}}return o??null}_matchHasPseudoFunc(l,e){let c;if(Array.isArray(l)&&l.length){const[o]=l,{type:a}=o;let f;a===r.COMBINATOR?f=l.shift():f={name:" ",type:r.COMBINATOR};const n=[];for(;l.length;){const[i]=l,{type:h}=i;if(h===r.COMBINATOR)break;n.push(l.shift())}const d={combo:f,leaves:n},t=this._matchCombinator(d,e,{dir:C});if(t.size)if(l.length){for(const i of t)if(c=this._matchHasPseudoFunc(Object.assign([],l),i),c)break}else c=!0}return!!c}_matchLogicalPseudoFunc(l,e){const{astName:c="",branches:o=[],selector:a="",twigBranches:f=[]}=l;let n;if(c==="has")if(a.includes(":has("))n=null;else{let d;for(const t of o)if(d=this._matchHasPseudoFunc(Object.assign([],t),e),d)break;d&&(n=e)}else{const d=/^(?:is|where)$/.test(c),t=f.length;let i;for(let h=0;h<t;h++){const s=f[h],m=s.length-1,{leaves:b}=s[m];if(i=this._matchLeaves(b,e,{forgive:d}),i&&m>0){let p=new Set([e]);for(let k=m-1;k>=0;k--){const N=s[k],u=[];for(const w of p){const g=this._matchCombinator(N,w,{forgive:d,dir:$});g.size&&u.push(...g)}if(u.length)k===0?i=!0:p=new Set(u);else{i=!1;break}}}if(i)break}c==="not"?i||(n=e):i&&(n=e)}return n??null}_matchPseudoClassSelector(l,e,c={}){const{children:o}=l,{localName:a,parentNode:f}=e,{forgive:n}=c,d=(0,v.unescapeSelector)(l.name);let t=new Set;if(r.REG_LOGICAL_PSEUDO.test(d)){let i;if(this.#r.has(l))i=this.#r.get(l);else{const s=(0,v.walkAST)(l),m=[],b=[];for(const[...p]of s){for(const w of p){const g=(0,v.generateCSS)(w);m.push(g)}const k=[],N=new Set;let u=p.shift();for(;u;)if(u.type===r.COMBINATOR?(k.push({combo:u,leaves:[...N]}),N.clear()):u&&N.add(u),p.length)u=p.shift();else{k.push({combo:null,leaves:[...N]}),N.clear();break}b.push(k)}i={astName:d,branches:s,twigBranches:b,selector:m.join(",")},this.#r.set(l,i)}const h=this._matchLogicalPseudoFunc(i,e);h&&t.add(h)}else if(Array.isArray(o)){const[i]=o;if(/^nth-(?:last-)?(?:child|of-type)$/.test(d)){const h=this._matchAnPlusB(i,e,d);h.size&&(t=h)}else if(d==="dir"){const h=this._matchDirectionPseudoClass(i,e);h&&t.add(h)}else if(d==="lang"){const h=this._matchLanguagePseudoClass(i,e);h&&t.add(h)}else switch(d){case"current":case"nth-col":case"nth-last-col":{if(this.#l){const h=`Unsupported pseudo-class :${d}()`;throw new DOMException(h,r.NOT_SUPPORTED_ERR)}break}case"host":case"host-context":break;default:if(!n){const h=`Unknown pseudo-class :${d}()`;throw new DOMException(h,r.SYNTAX_ERR)}}}else{const i=/^a(?:rea)?$/,h=/^(?:(?:fieldse|inpu|selec)t|button|opt(?:group|ion)|textarea)$/,s=/^(?:(?:inpu|selec)t|button|form|textarea)$/,m=/^d(?:etails|ialog)$/,b=/^(?:checkbox|radio)$/,p=/^(?:date(?:time-local)?|month|time|week)$/,k=/(?:(?:rang|tim)e|date(?:time-local)?|month|number|week)$/,N=/^(?:(?:emai|te|ur)l|number|password|search|text)$/;switch(d){case"any-link":case"link":{i.test(a)&&e.hasAttribute("href")&&t.add(e);break}case"local-link":{if(i.test(a)&&e.hasAttribute("href")){const{href:u,origin:w,pathname:g}=new URL(this.#s.URL),y=new URL(e.getAttribute("href"),u);y.origin===w&&y.pathname===g&&t.add(e)}break}case"visited":break;case"target":{const{hash:u}=new URL(this.#s.URL);e.id&&u===`#${e.id}`&&this.#s.contains(e)&&t.add(e);break}case"target-within":{const{hash:u}=new URL(this.#s.URL);if(u){const w=u.replace(/^#/,"");let g=this.#s.getElementById(w);for(;g;){if(g===e){t.add(e);break}g=g.parentNode}}break}case"scope":{this.#e.nodeType===r.ELEMENT_NODE?e===this.#e&&t.add(e):e===this.#s.documentElement&&t.add(e);break}case"focus":{e===this.#s.activeElement&&t.add(e);break}case"focus-within":{let u=this.#s.activeElement;for(;u;){if(u===e){t.add(e);break}u=u.parentNode}break}case"open":{m.test(a)&&e.hasAttribute("open")&&t.add(e);break}case"closed":{m.test(a)&&!e.hasAttribute("open")&&t.add(e);break}case"disabled":{if(h.test(a)||(0,I.default)(a))if(e.disabled||e.hasAttribute("disabled"))t.add(e);else{let u=f;for(;u&&u.localName!=="fieldset";)u=u.parentNode;u&&f.localName!=="legend"&&u.hasAttribute("disabled")&&t.add(e)}break}case"enabled":{(h.test(a)||(0,I.default)(a))&&!(e.disabled&&e.hasAttribute("disabled"))&&t.add(e);break}case"read-only":{switch(a){case"textarea":{(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}case"input":{(!e.type||p.test(e.type)||N.test(e.type))&&(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}default:(0,E.isContentEditable)(e)||t.add(e)}break}case"read-write":{switch(a){case"textarea":{e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled")||t.add(e);break}case"input":{(!e.type||p.test(e.type)||N.test(e.type))&&!(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}default:(0,E.isContentEditable)(e)&&t.add(e)}break}case"placeholder-shown":{let u;a==="textarea"?u=e:a==="input"&&(e.hasAttribute("type")?N.test(e.getAttribute("type"))&&(u=e):u=e),u&&e.value===""&&e.hasAttribute("placeholder")&&e.getAttribute("placeholder").trim().length&&t.add(e);break}case"checked":{(e.checked&&a==="input"&&e.hasAttribute("type")&&b.test(e.getAttribute("type"))||e.selected&&a==="option")&&t.add(e);break}case"indeterminate":{if(e.indeterminate&&a==="input"&&e.type==="checkbox"||a==="progress"&&!e.hasAttribute("value"))t.add(e);else if(a==="input"&&e.type==="radio"&&!e.hasAttribute("checked")){const u=e.name;let w=e.parentNode;for(;w&&w.localName!=="form";)w=w.parentNode;w||(w=this.#s.documentElement);let g;const y=[].slice.call(w.getElementsByTagName("input"));for(const _ of y)if(_.getAttribute("type")==="radio"&&(u?_.getAttribute("name")===u&&(g=!!_.checked):_.hasAttribute("name")||(g=!!_.checked),g))break;g||t.add(e)}break}case"default":{const u=/^(?:button|reset)$/,w=/^(?:image|submit)$/;if(a==="button"&&!(e.hasAttribute("type")&&u.test(e.getAttribute("type")))||a==="input"&&e.hasAttribute("type")&&w.test(e.getAttribute("type"))){let g=e.parentNode;for(;g&&g.localName!=="form";)g=g.parentNode;if(g){const y=this.#s.createTreeWalker(g,r.SHOW_ELEMENT);let _=y.firstChild();for(;_;){const x=_.localName;let S;if(x==="button"?S=!(_.hasAttribute("type")&&u.test(_.getAttribute("type"))):x==="input"&&(S=_.hasAttribute("type")&&w.test(_.getAttribute("type"))),S){_===e&&t.add(e);break}_=y.nextNode()}}}else if(a==="input"&&e.hasAttribute("type")&&b.test(e.getAttribute("type"))&&(e.checked||e.hasAttribute("checked")))t.add(e);else if(a==="option"){let g=!1,y=f;for(;y&&y.localName!=="datalist";){if(y.localName==="select"){(y.multiple||y.hasAttribute("multiple"))&&(g=!0);break}y=y.parentNode}if(g)(e.selected||e.hasAttribute("selected"))&&t.add(e);else{const _=new Set,x=this.#s.createTreeWalker(f,r.SHOW_ELEMENT);let S=x.firstChild();for(;S;){if(S.selected||S.hasAttribute("selected")){_.add(S);break}S=x.nextSibling()}_.size&&_.has(e)&&t.add(e)}}break}case"valid":{if(s.test(a))e.checkValidity()&&t.add(e);else if(a==="fieldset"){let u;const w=this.#s.createTreeWalker(e,r.SHOW_ELEMENT);let g=w.firstChild();for(;g&&!(s.test(g.localName)&&(u=g.checkValidity(),!u));)g=w.nextNode();u&&t.add(e)}break}case"invalid":{if(s.test(a))e.checkValidity()||t.add(e);else if(a==="fieldset"){let u;const w=this.#s.createTreeWalker(e,r.SHOW_ELEMENT);let g=w.firstChild();for(;g&&!(s.test(g.localName)&&(u=g.checkValidity(),!u));)g=w.nextNode();u||t.add(e)}break}case"in-range":{a==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&k.test(e.getAttribute("type"))&&!(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&(e.hasAttribute("min")||e.hasAttribute("max")||e.getAttribute("type")==="range")&&t.add(e);break}case"out-of-range":{a==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&k.test(e.getAttribute("type"))&&(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&t.add(e);break}case"required":{let u;if(/^(?:select|textarea)$/.test(a))u=e;else if(a==="input")if(e.hasAttribute("type")){const w=e.getAttribute("type");(w==="file"||b.test(w)||p.test(w)||N.test(w))&&(u=e)}else u=e;u&&(e.required||e.hasAttribute("required"))&&t.add(e);break}case"optional":{let u;if(/^(?:select|textarea)$/.test(a))u=e;else if(a==="input")if(e.hasAttribute("type")){const w=e.getAttribute("type");(w==="file"||b.test(w)||p.test(w)||N.test(w))&&(u=e)}else u=e;u&&!(e.required||e.hasAttribute("required"))&&t.add(e);break}case"root":{e===this.#s.documentElement&&t.add(e);break}case"empty":{if(e.hasChildNodes()){let u;const w=this.#s.createTreeWalker(e,r.SHOW_ALL);let g=w.firstChild();for(;g&&(u=g.nodeType!==r.ELEMENT_NODE&&g.nodeType!==r.TEXT_NODE,!!u);)g=w.nextSibling();u&&t.add(e)}else t.add(e);break}case"first-child":{(f&&e===f.firstElementChild||e===this.#t&&this.#t.nodeType===r.ELEMENT_NODE)&&t.add(e);break}case"last-child":{(f&&e===f.lastElementChild||e===this.#t&&this.#t.nodeType===r.ELEMENT_NODE)&&t.add(e);break}case"only-child":{(f&&e===f.firstElementChild&&e===f.lastElementChild||e===this.#t&&this.#t.nodeType===r.ELEMENT_NODE)&&t.add(e);break}case"first-of-type":{if(f){const[u]=this._collectNthOfType({a:0,b:1},e);u&&t.add(u)}else e===this.#t&&this.#t.nodeType===r.ELEMENT_NODE&&t.add(e);break}case"last-of-type":{if(f){const[u]=this._collectNthOfType({a:0,b:1,reverse:!0},e);u&&t.add(u)}else e===this.#t&&this.#t.nodeType===r.ELEMENT_NODE&&t.add(e);break}case"only-of-type":{if(f){const[u]=this._collectNthOfType({a:0,b:1},e);if(u===e){const[w]=this._collectNthOfType({a:0,b:1,reverse:!0},e);w===e&&t.add(e)}}else e===this.#t&&this.#t.nodeType===r.ELEMENT_NODE&&t.add(e);break}case"host":case"host-context":break;case"after":case"before":case"first-letter":case"first-line":{if(this.#l){const u=`Unsupported pseudo-element ::${d}`;throw new DOMException(u,r.NOT_SUPPORTED_ERR)}break}case"active":case"autofill":case"blank":case"buffering":case"current":case"defined":case"focus-visible":case"fullscreen":case"future":case"hover":case"modal":case"muted":case"past":case"paused":case"picture-in-picture":case"playing":case"seeking":case"stalled":case"user-invalid":case"user-valid":case"volume-locked":case"-webkit-autofill":{if(this.#l){const u=`Unsupported pseudo-class :${d}`;throw new DOMException(u,r.NOT_SUPPORTED_ERR)}break}default:if(d.startsWith("-webkit-")){if(this.#l){const u=`Unsupported pseudo-class :${d}`;throw new DOMException(u,r.NOT_SUPPORTED_ERR)}}else if(!n){const u=`Unknown pseudo-class :${d}`;throw new DOMException(u,r.SYNTAX_ERR)}}}return t}_matchAttributeSelector(l,e){const{flags:c,matcher:o,name:a,value:f}=l;if(typeof c=="string"&&!/^[is]$/i.test(c)){const i=`Invalid selector ${(0,v.generateCSS)(l)}`;throw new DOMException(i,r.SYNTAX_ERR)}const{attributes:n}=e;let d;if(n&&n.length){let t;this.#s.contentType==="text/html"?typeof c=="string"&&/^s$/i.test(c)?t=!1:t=!0:typeof c=="string"&&/^i$/i.test(c)?t=!0:t=!1;let i=(0,v.unescapeSelector)(a.name);t&&(i=i.toLowerCase());const h=new Set;if(i.indexOf("|")>-1){const{prefix:s,tagName:m}=(0,E.selectorToNodeProps)(i);for(let{name:b,value:p}of n)switch(t&&(b=b.toLowerCase(),p=p.toLowerCase()),s){case"":{m===b&&h.add(p);break}case"*":{b.indexOf(":")>-1?b.endsWith(`:${m}`)&&h.add(p):m===b&&h.add(p);break}default:if(b.indexOf(":")>-1){const[k,N]=b.split(":");s===k&&m===N&&(0,E.isNamespaceDeclared)(s,e)&&h.add(p)}}}else for(let{name:s,value:m}of n)if(t&&(s=s.toLowerCase(),m=m.toLowerCase()),s.indexOf(":")>-1){const[b,p]=s.split(":");if(b==="xml"&&p==="lang")continue;i===p&&h.add(m)}else i===s&&h.add(m);if(h.size){const{name:s,value:m}=f||{};let b;switch(s?t?b=s.toLowerCase():b=s:m?t?b=m.toLowerCase():b=m:m===""&&(b=m),o){case"=":{typeof b=="string"&&h.has(b)&&(d=e);break}case"~=":{if(b&&typeof b=="string"){for(const p of h)if(new Set(p.split(/\s+/)).has(b)){d=e;break}}break}case"|=":{if(b&&typeof b=="string"){let p;for(const k of h)if(k===b||k.startsWith(`${b}-`)){p=k;break}p&&(d=e)}break}case"^=":{if(b&&typeof b=="string"){let p;for(const k of h)if(k.startsWith(`${b}`)){p=k;break}p&&(d=e)}break}case"$=":{if(b&&typeof b=="string"){let p;for(const k of h)if(k.endsWith(`${b}`)){p=k;break}p&&(d=e)}break}case"*=":{if(b&&typeof b=="string"){let p;for(const k of h)if(k.includes(`${b}`)){p=k;break}p&&(d=e)}break}case null:default:d=e}}}return d??null}_matchClassSelector(l,e){const c=(0,v.unescapeSelector)(l.name);let o;return e.classList.contains(c)&&(o=e),o??null}_matchIDSelector(l,e){const c=(0,v.unescapeSelector)(l.name),{id:o}=e;let a;return c===o&&(a=e),a??null}_matchTypeSelector(l,e,c={}){const o=(0,v.unescapeSelector)(l.name),{localName:a,prefix:f}=e,{forgive:n}=c;let{prefix:d,tagName:t}=(0,E.selectorToNodeProps)(o,e);this.#s.contentType==="text/html"&&(d=d.toLowerCase(),t=t.toLowerCase());let i,h;a.indexOf(":")>-1?[i,h]=a.split(":"):(i=f||"",h=a);let s;if(d===""&&i==="")e.namespaceURI===null&&(t==="*"||t===h)&&(s=e);else if(d==="*")(t==="*"||t===h)&&(s=e);else if(d===i){if((0,E.isNamespaceDeclared)(d,e))(t==="*"||t===h)&&(s=e);else if(!n){const m=`Undeclared namespace ${d}`;throw new DOMException(m,r.SYNTAX_ERR)}}else if(d&&!n&&!(0,E.isNamespaceDeclared)(d,e)){const m=`Undeclared namespace ${d}`;throw new DOMException(m,r.SYNTAX_ERR)}return s??null}_matchShadowHostPseudoClass(l,e){const{children:c}=l,o=(0,v.unescapeSelector)(l.name);let a;if(Array.isArray(c)){const[f]=(0,v.walkAST)(c[0]),[...n]=f,{host:d}=e;if(o==="host"){let t;for(const i of n){const{type:h}=i;if(h===r.COMBINATOR){const m=`Invalid selector ${(0,v.generateCSS)(l)}`;throw new DOMException(m,r.SYNTAX_ERR)}if(t=this._matchSelector(i,d).has(d),!t)break}t&&(a=e)}else if(o==="host-context"){let t,i=d;for(;i;){for(const h of n){const{type:s}=h;if(s===r.COMBINATOR){const b=`Invalid selector ${(0,v.generateCSS)(l)}`;throw new DOMException(b,r.SYNTAX_ERR)}if(t=this._matchSelector(h,i).has(i),!t)break}if(t)break;i=i.parentNode}t&&(a=e)}}else if(o==="host")a=e;else{const f=`Invalid selector :${o}`;throw new DOMException(f,r.SYNTAX_ERR)}return a??null}_matchSelector(l,e,c){const{type:o}=l,a=(0,v.unescapeSelector)(l.name);let f=new Set;if(e.nodeType===r.ELEMENT_NODE)switch(o){case r.SELECTOR_ATTR:{const n=this._matchAttributeSelector(l,e);n&&f.add(n);break}case r.SELECTOR_CLASS:{const n=this._matchClassSelector(l,e);n&&f.add(n);break}case r.SELECTOR_ID:{const n=this._matchIDSelector(l,e);n&&f.add(n);break}case r.SELECTOR_PSEUDO_CLASS:{const n=this._matchPseudoClassSelector(l,e,c);n.size&&(f=n);break}case r.SELECTOR_PSEUDO_ELEMENT:{this._matchPseudoElementSelector(a,c);break}case r.SELECTOR_TYPE:default:{const n=this._matchTypeSelector(l,e,c);n&&f.add(n)}}else if(this.#n&&o===r.SELECTOR_PSEUDO_CLASS&&e.nodeType===r.DOCUMENT_FRAGMENT_NODE){if(a!=="has"&&r.REG_LOGICAL_PSEUDO.test(a)){const n=this._matchPseudoClassSelector(l,e,c);n.size&&(f=n)}else if(r.REG_SHADOW_HOST.test(a)){const n=this._matchShadowHostPseudoClass(l,e);n&&f.add(n)}}return f}_matchLeaves(l,e,c){let o;for(const a of l)if(o=this._matchSelector(a,e,c).has(e),!o)break;return!!o}_findDescendantNodes(l,e){const[c,...o]=l,{type:a}=c,f=(0,v.unescapeSelector)(c.name),n=o.length>0;let d=new Set,t=!1;if(this.#n)t=!0;else switch(a){case r.SELECTOR_ID:{if(this.#t.nodeType===r.ELEMENT_NODE)t=!0;else{const i=this.#t.getElementById(f);i&&i!==e&&e.contains(i)&&(n?this._matchLeaves(o,i)&&d.add(i):d.add(i))}break}case r.SELECTOR_CLASS:{const i=[].slice.call(e.getElementsByClassName(f));if(i.length)if(n)for(const h of i)this._matchLeaves(o,h)&&d.add(h);else d=new Set(i);break}case r.SELECTOR_TYPE:{if(this.#s.contentType==="text/html"&&!/[*|]/.test(f)){const i=[].slice.call(e.getElementsByTagName(f));if(i.length)if(n)for(const h of i)this._matchLeaves(o,h)&&d.add(h);else d=new Set(i)}else t=!0;break}case r.SELECTOR_PSEUDO_ELEMENT:{this._matchPseudoElementSelector(f);break}default:t=!0}return{nodes:d,pending:t}}_matchCombinator(l,e,c={}){const{combo:o,leaves:a}=l,{name:f}=o,{dir:n,forgive:d}=c;let t=new Set;if(n===C)switch(f){case"+":{const i=e.nextElementSibling;i&&this._matchLeaves(a,i,{forgive:d})&&t.add(i);break}case"~":{const{parentNode:i}=e;if(i){const h=this.#s.createTreeWalker(i,r.SHOW_ELEMENT);let s=this._traverse(e,h);for(s===e&&(s=h.nextSibling());s;)this._matchLeaves(a,s,{forgive:d})&&t.add(s),s=h.nextSibling()}break}case">":{const i=this.#s.createTreeWalker(e,r.SHOW_ELEMENT);let h=i.firstChild();for(;h;)this._matchLeaves(a,h,{forgive:d})&&t.add(h),h=i.nextSibling();break}case" ":default:{const{nodes:i,pending:h}=this._findDescendantNodes(a,e);if(i.size)t=i;else if(h){const s=this.#s.createTreeWalker(e,r.SHOW_ELEMENT);let m=s.nextNode();for(;m;)this._matchLeaves(a,m,{forgive:d})&&t.add(m),m=s.nextNode()}}}else switch(f){case"+":{const i=e.previousElementSibling;i&&this._matchLeaves(a,i,{forgive:d})&&t.add(i);break}case"~":{const i=this.#s.createTreeWalker(e.parentNode,r.SHOW_ELEMENT);let h=i.firstChild();for(;h&&h!==e;)this._matchLeaves(a,h,{forgive:d})&&t.add(h),h=i.nextSibling();break}case">":{const i=e.parentNode;i&&this._matchLeaves(a,i,{forgive:d})&&t.add(i);break}case" ":default:{const i=[];let h=e.parentNode;for(;h;)this._matchLeaves(a,h,{forgive:d})&&i.push(h),h=h.parentNode;i.length&&(t=new Set(i.reverse()))}}return t}_findNode(l,e={}){let{node:c,walker:o}=e;o||(o=this.#h);let a,f=this._traverse(c,o);if(f)for((f.nodeType!==r.ELEMENT_NODE||f===c&&f!==this.#t)&&(f=o.nextNode());f;){let n;if(this.#e.nodeType===r.ELEMENT_NODE?f===this.#e?n=!0:n=this.#e.contains(f):n=!0,n&&this._matchLeaves(l,f)){a=f;break}f=o.nextNode()}return a??null}_findEntryNodes(l,e){const{leaves:c}=l,[o,...a]=c,{type:f}=o,n=(0,v.unescapeSelector)(o.name),d=a.length>0;let t=new Set,i=!1,h=!1;switch(f){case r.SELECTOR_ID:{if(e===D)this._matchLeaves(c,this.#e)&&(t.add(this.#e),i=!0);else if(e===O){let s=this.#e;for(;s;)this._matchLeaves(c,s)&&(t.add(s),i=!0),s=s.parentNode}else if(e===A||this.#t.nodeType===r.ELEMENT_NODE)h=!0;else{const s=this.#t.getElementById(n);s&&(t.add(s),i=!0)}break}case r.SELECTOR_CLASS:{if(e===D)this.#e.nodeType===r.ELEMENT_NODE&&this.#e.classList.contains(n)&&t.add(this.#e);else if(e===O){let s=this.#e;for(;s&&s.nodeType===r.ELEMENT_NODE;)s.classList.contains(n)&&t.add(s),s=s.parentNode}else if(e===L){const s=this._findNode(c,{node:this.#e,walker:this.#a});s&&(t.add(s),i=!0)}else if(this.#t.nodeType===r.DOCUMENT_FRAGMENT_NODE||this.#t.nodeType===r.ELEMENT_NODE)h=!0;else{const s=[].slice.call(this.#t.getElementsByClassName(n));if(this.#e.nodeType===r.ELEMENT_NODE)for(const m of s)(m===this.#e||(0,E.isInclusive)(m,this.#e))&&t.add(m);else s.length&&(t=new Set(s))}break}case r.SELECTOR_TYPE:{if(e===D)this.#e.nodeType===r.ELEMENT_NODE&&this._matchLeaves(c,this.#e)&&(t.add(this.#e),i=!0);else if(e===O){let s=this.#e;for(;s&&s.nodeType===r.ELEMENT_NODE;)this._matchLeaves(c,s)&&(t.add(s),i=!0),s=s.parentNode}else if(e===L){const s=this._findNode(c,{node:this.#e,walker:this.#a});s&&(t.add(s),i=!0)}else if(this.#s.contentType!=="text/html"||/[*|]/.test(n)||this.#t.nodeType===r.DOCUMENT_FRAGMENT_NODE||this.#t.nodeType===r.ELEMENT_NODE)h=!0;else{const s=[].slice.call(this.#t.getElementsByTagName(n));if(this.#e.nodeType===r.ELEMENT_NODE)for(const m of s)(m===this.#e||(0,E.isInclusive)(m,this.#e))&&t.add(m);else s.length&&(t=new Set(s))}break}case r.SELECTOR_PSEUDO_ELEMENT:{this._matchPseudoElementSelector(n);break}default:if(e!==O&&r.REG_SHADOW_HOST.test(n)){if(this.#n&&this.#e.nodeType===r.DOCUMENT_FRAGMENT_NODE){const s=this._matchShadowHostPseudoClass(o,this.#e);s&&t.add(s)}}else if(e===D)this._matchLeaves(c,this.#e)&&(t.add(this.#e),i=!0);else if(e===O){let s=this.#e;for(;s;)this._matchLeaves(c,s)&&(t.add(s),i=!0),s=s.parentNode}else if(e===L){const s=this._findNode(c,{node:this.#e,walker:this.#a});s&&(t.add(s),i=!0)}else h=!0}return{compound:d,filtered:i,nodes:t,pending:h}}_getEntryTwig(l,e){const c=l.length,o=c>1,a=l[0];let f,n;if(o){const{combo:d,leaves:[{type:t}]}=a,i=l[c-1],{leaves:[{type:h}]}=i;if(h===r.SELECTOR_PSEUDO_ELEMENT||h===r.SELECTOR_ID)f=$,n=i;else if(t===r.SELECTOR_PSEUDO_ELEMENT||t===r.SELECTOR_ID)f=C,n=a;else if(e===A)if(c===2){const{name:s}=d;/^[+~]$/.test(s)?(f=$,n=i):(f=C,n=a)}else f=C,n=a;else{let s,m;for(const{combo:b,leaves:[p]}of l){const{type:k}=p,N=(0,v.unescapeSelector)(p.name);if(k===r.SELECTOR_PSEUDO_CLASS&&N==="dir"){s=!1;break}if(b&&!m){const{name:u}=b;/^[+~]$/.test(u)&&(s=!0,m=!0)}}s?(f=C,n=a):(f=$,n=i)}}else f=$,n=a;return{complex:o,dir:f,twig:n}}_collectNodes(l){const e=this.#i.values();if(l===A||l===L){const c=new Set;let o=0;for(const{branch:a}of e){const{dir:f,twig:n}=this._getEntryTwig(a,l),{compound:d,filtered:t,nodes:i,pending:h}=this._findEntryNodes(n,l);i.size?(this.#i[o].find=!0,this.#o[o]=i):h&&c.add(new Map([["index",o],["twig",n]])),this.#i[o].dir=f,this.#i[o].filtered=t||!d,o++}if(c.size){let a,f;this.#e!==this.#t&&this.#e.nodeType===r.ELEMENT_NODE?(a=this.#e,f=this.#a):(a=this.#t,f=this.#h);let n=this._traverse(a,f);for(;n;){let d=!1;if(this.#e.nodeType===r.ELEMENT_NODE?n===this.#e?d=!0:d=this.#e.contains(n):d=!0,d)for(const t of c){const{leaves:i}=t.get("twig");if(this._matchLeaves(i,n)){const s=t.get("index");this.#i[s].filtered=!0,this.#i[s].find=!0,this.#o[s].add(n)}}n=f.nextNode()}}}else{let c=0;for(const{branch:o}of e){const a=o[o.length-1],{compound:f,filtered:n,nodes:d}=this._findEntryNodes(a,l);d.size&&(this.#i[c].find=!0,this.#o[c]=d),this.#i[c].dir=$,this.#i[c].filtered=n||!f,c++}}return[this.#i,this.#o]}_sortNodes(l){const e=[...l];return e.length>1&&e.sort((c,o)=>{let a;return(0,E.isPreceding)(o,c)?a=1:a=-1,a}),e}_matchNodes(l){const[...e]=this.#i,c=e.length;let o=new Set;for(let a=0;a<c;a++){const{branch:f,dir:n,filtered:d,find:t}=e[a],i=f.length;if(i&&t){const h=this.#o[a],s=i-1;if(s===0){const{leaves:[,...m]}=f[0];if((l===A||l===L)&&this.#e.nodeType===r.ELEMENT_NODE){for(const b of h)if((d||this._matchLeaves(m,b))&&b!==this.#e&&this.#e.contains(b)&&(o.add(b),l!==A))break}else if(m.length){for(const b of h)if((d||this._matchLeaves(m,b))&&(o.add(b),l!==A))break}else if(l===A)if(o.size){const b=[...o];o=new Set([...b,...h]),this.#f=!0}else o=new Set([...h]);else{const[b]=[...h];o.add(b)}}else if(n===C){let{combo:m,leaves:b}=f[0];const[,...p]=b;let k;for(const N of h){if(d||this._matchLeaves(p,N)){let w=new Set([N]);for(let g=1;g<i;g++){const{combo:y,leaves:_}=f[g],x=[];for(const S of w){const P={combo:m,leaves:_},M=this._matchCombinator(P,S,{dir:n});M.size&&x.push(...M)}if(x.length)if(g===s){if(l===A)if(o.size){const S=[...o];o=new Set([...S,...x]),this.#f=!0}else o=new Set([...x]);else{const[S]=this._sortNodes(x);o.add(S)}k=!0}else m=y,w=new Set(x),k=!1;else{k=!1;break}}}else k=!1;if(k&&l!==A)break}if(!k&&l===L){const[N]=[...h];let u=this._findNode(b,{node:N,walker:this.#a});for(;u;){let w=new Set([u]);for(let g=1;g<i;g++){const{combo:y,leaves:_}=f[g],x=[];for(const S of w){const P={combo:m,leaves:_},M=this._matchCombinator(P,S,{dir:n});M.size&&x.push(...M)}if(x.length)if(g===s){const[S]=this._sortNodes(x);o.add(S),k=!0}else m=y,w=new Set(x),k=!1;else{k=!1;break}}if(k)break;u=this._findNode(b,{node:u,walker:this.#a}),w=new Set([u])}}}else{const{leaves:m}=f[s],[,...b]=m;let p;for(const k of h){if(d||this._matchLeaves(b,k)){let u=new Set([k]);for(let w=s-1;w>=0;w--){const g=f[w],y=[];for(const _ of u){const x=this._matchCombinator(g,_,{dir:n});x.size&&y.push(...x)}if(y.length)w===0?(o.add(k),p=!0):(u=new Set(y),p=!1);else{p=!1;break}}}if(p&&l!==A)break}if(!p&&l===L){const[k]=[...h];let N=this._findNode(m,{node:k,walker:this.#a});for(;N;){let u=new Set([N]);for(let w=s-1;w>=0;w--){const g=f[w],y=[];for(const _ of u){const x=this._matchCombinator(g,_,{dir:n});x.size&&y.push(...x)}if(y.length)w===0?(o.add(N),p=!0):(u=new Set(y),p=!1);else{p=!1;break}}if(p)break;N=this._findNode(m,{node:N,walker:this.#a}),u=new Set([N])}}}}}return o}_find(l,e,c,o={}){const{warn:a}=o;if(this.#l=!!a,e){if(e.nodeType!==r.DOCUMENT_NODE&&e.nodeType!==r.DOCUMENT_FRAGMENT_NODE&&e.nodeType!==r.ELEMENT_NODE){const n=`Unexpected node ${e.nodeName}`;throw new TypeError(n)}else if((l===D||l===O)&&e.nodeType!==r.ELEMENT_NODE){const n=`Unexpected node ${e.nodeName}`;throw new TypeError(n)}}else{const d=`Unexpected node ${Object.prototype.toString.call(e).slice(r.TYPE_FROM,r.TYPE_TO)}`;throw new TypeError(d)}if(this.#r=new WeakMap,this.#e=e,[this.#c,this.#s,this.#t,this.#h]=this._setup(e),this.#n=(0,E.isInShadowTree)(e),c&&c===this.#b)for(const n of this.#o)n.clear();else this.#b=c,[this.#i,this.#o]=this._correspond(c);return(l===A||l===L)&&(this.#a=this.#s.createTreeWalker(this.#e,r.SHOW_ELEMENT),this.#f=!1),this._collectNodes(l),this._matchNodes(l)}matches(l,e,c){let o;try{const a=this._find(D,l,e,c);a.size&&(o=a.has(this.#e))}catch(a){this._onError(a)}return!!o}closest(l,e,c){let o;try{const a=this._find(O,l,e,c);let f=this.#e;for(;f;){if(a.has(f)){o=f;break}f=f.parentNode}}catch(a){this._onError(a)}return o??null}querySelector(l,e,c){let o;try{const a=this._find(L,l,e,c);a.delete(this.#e),a.size&&([o]=this._sortNodes(a))}catch(a){this._onError(a)}return o??null}querySelectorAll(l,e,c){let o;try{const a=this._find(A,l,e,c);a.delete(this.#e),a.size&&(this.#f?o=this._sortNodes(a):o=[...a])}catch(a){this._onError(a)}return o??[]}}0&&(module.exports={Matcher});
//# sourceMappingURL=matcher.js.map
