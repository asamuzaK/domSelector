var W=Object.create;var L=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var Y=Object.getOwnPropertyNames;var X=Object.getPrototypeOf,K=Object.prototype.hasOwnProperty;var Z=(_,i)=>{for(var e in i)L(_,e,{get:i[e],enumerable:!0})},R=(_,i,e,c)=>{if(i&&typeof i=="object"||typeof i=="function")for(let d of Y(i))!K.call(_,d)&&d!==e&&L(_,d,{get:()=>i[d],enumerable:!(c=q(i,d))||c.enumerable});return _};var J=(_,i,e)=>(e=_!=null?W(X(_)):{},R(i||!_||!_.__esModule?L(e,"default",{value:_,enumerable:!0}):e,_)),Q=_=>R(L({},"__esModule",{value:!0}),_);var ie={};Z(ie,{Matcher:()=>se});module.exports=Q(ie);var P=J(require("is-potential-custom-element-name"),1),k=require("./dom-util.js"),g=require("./parser.js"),h=require("./constant.js");const D="[A-Z\\d]+",A=`(?:-${D})*`,$="all",T="first",S="lineal",v="self",U=/^(?:(?:fieldse|inpu|selec)t|button|opt(?:group|ion)|textarea)$/,C=/^(?:(?:(?:in|out)pu|selec)t|button|form|textarea)$/,B=/^a(?:rea)?$/,z=/^d(?:etails|ialog)$/,O=/^(?:checkbox|radio)$/,x=/^(?:(?:emai|te|ur)l|number|password|search|text)$/,H=/(?:(?:rang|tim)e|date(?:time-local)?|month|number|week)$/,F=/^(?:button|reset)$/,V=/^(?:image|submit)$/,I=/^(?:date(?:time-local)?|month|time|week)$/,j=/^(?:(?:ha|i)s|not|where)$/,ee=/^nth-(?:last-)?(?:child|of-type)$/,G=/^host(?:-context)?$/,te=new RegExp(`^(?:\\*-)?${D}${A}$`,"i");class se{#i;#r;#a;#e;#l;#t;#o;#c;#s;constructor(i,e,c={}){const{sort:d,warn:r}=c;this.#r=new Map([[h.PSEUDO_ELEMENT_SELECTOR,h.BIT_1],[h.ID_SELECTOR,h.BIT_10],[h.CLASS_SELECTOR,h.BIT_100],[h.TYPE_SELECTOR,h.BIT_1000],[h.ATTRIBUTE_SELECTOR,h.BIT_10000],[h.PSEUDO_CLASS_SELECTOR,h.BIT_100000]]),this.#a=new WeakMap,this.#o=i,this.#e=e,this.#c=!!d,this.#s=!!r,[this.#i,this.#l]=this._prepare(i),this.#t=this._getRoot(e)}_onError(i){if(i instanceof DOMException&&i.name===h.NOT_SUPPORTED_ERR)this.#s&&console.warn(i.message);else throw i}_getRoot(i=this.#e){let e,c;switch(i.nodeType){case h.DOCUMENT_NODE:{e=i,c=i;break}case h.DOCUMENT_FRAGMENT_NODE:{e=i.ownerDocument,c=i;break}case h.ELEMENT_NODE:{if((0,k.isSameOrDescendant)(i))e=i.ownerDocument,c=i.ownerDocument;else{let r=i;for(;r&&r.parentNode;)r=r.parentNode;e=r.ownerDocument,c=r}break}default:throw new TypeError(`Unexpected node ${i.nodeName}`)}const d=(0,k.isInShadowTree)(i);return{document:e,root:c,shadow:d}}_sortLeaves(i){const e=[...i];return e.length>1&&e.sort((c,d)=>{const{type:r}=c,{type:b}=d,m=this.#r.get(r),f=this.#r.get(b);let s;return m===f?s=0:m>f?s=1:s=-1,s}),e}_prepare(i=this.#o){const e=(0,g.parseSelector)(i),c=(0,g.walkAST)(e),d=[],r=[];let b=0;for(const[...m]of c){const f=[];let s=m.shift();if(s&&s.type!==h.COMBINATOR){const l=new Set;for(;s;){if(s.type===h.COMBINATOR){const[o]=m;if(o.type===h.COMBINATOR){const u=`Invalid combinator ${s.name}${o.name}`;throw new DOMException(u,h.SYNTAX_ERR)}f.push({combo:s,leaves:this._sortLeaves(l)}),l.clear()}else s&&l.add(s);if(m.length)s=m.shift();else{f.push({combo:null,leaves:this._sortLeaves(l)}),l.clear();break}}}d.push({branch:f,find:null,skip:!1}),r[b]=new Set,b++}return[d,r]}_collectNthChild(i,e){const{a:c,b:d,reverse:r,selector:b}=i,{parentNode:m}=e,f=new Set;let s;if(b&&(this.#a.has(b)?s=this.#a.get(b):(s=(0,g.walkAST)(b),this.#a.set(b,s))),m){const l=[...m.children],o=l.length;if(o){const u=new Set;if(s){const n=s.length;for(const t of l){let a;for(let p=0;p<n;p++){const N=s[p];if(a=this._matchLeaves(N,t),!a)break}a&&u.add(t)}}if(r&&l.reverse(),c===0){if(d>0&&d<=o){if(u.size)for(let n=0;n<o;n++){const t=l[n];if(u.has(t)){f.add(t);break}}else if(!b){const n=l[d-1];f.add(n)}}}else{let n=d-1;if(c>0)for(;n<0;)n+=c;if(n>=0&&n<o){let t=c>0?0:d-1;for(let a=0;a<o&&n>=0&&n<o;a++){const p=l[a];u.size?u.has(p)&&(t===n&&(f.add(p),n+=c),c>0?t++:t--):a===n&&(b||f.add(p),n+=c)}}}}}else{const{root:l}=this.#t;if(e===l&&l.nodeType===h.ELEMENT_NODE&&c+d===1)if(s){const o=s.length;let u;for(let n=0;n<o;n++){const t=s[n];if(u=this._matchLeaves(t,e),u)break}u&&f.add(e)}else f.add(e)}return f}_collectNthOfType(i,e){const{a:c,b:d,reverse:r}=i,{localName:b,parentNode:m,prefix:f}=e,s=new Set;if(m){const l=[...m.children],o=l.length;if(o)if(r&&l.reverse(),c===0){if(d>0&&d<=o){let u=0;for(let n=0;n<o;n++){const t=l[n],{localName:a,prefix:p}=t;if(a===b&&p===f){if(u===d-1){s.add(t);break}u++}}}}else{let u=d-1;if(c>0)for(;u<0;)u+=c;if(u>=0&&u<o){let n=c>0?0:d-1;for(let t=0;t<o;t++){const a=l[t],{localName:p,prefix:N}=a;if(p===b&&N===f){if(n===u&&(s.add(a),u+=c),u<0||u>=o)break;c>0?n++:n--}}}}}else{const{root:l}=this.#t;e===l&&l.nodeType===h.ELEMENT_NODE&&c+d===1&&s.add(e)}return s}_matchAnPlusB(i,e,c){const{nth:{a:d,b:r,name:b},selector:m}=i,f=(0,g.unescapeSelector)(b),s=new Map;f?(f==="even"?(s.set("a",2),s.set("b",0)):f==="odd"&&(s.set("a",2),s.set("b",1)),/last/.test(c)&&s.set("reverse",!0)):(typeof d=="string"&&/-?\d+/.test(d)?s.set("a",d*1):s.set("a",0),typeof r=="string"&&/-?\d+/.test(r)?s.set("b",r*1):s.set("b",0),/last/.test(c)&&s.set("reverse",!0));let l=new Set;if(s.has("a")&&s.has("b")){if(/^nth-(?:last-)?child$/.test(c)){m&&s.set("selector",m);const o=Object.fromEntries(s),u=this._collectNthChild(o,e);u.size&&(l=u)}else if(/^nth-(?:last-)?of-type$/.test(c)){const o=Object.fromEntries(s),u=this._collectNthOfType(o,e);u.size&&(l=u)}}return l}_matchPseudoElementSelector(i,e={}){const{forgive:c}=e;switch(i){case"after":case"backdrop":case"before":case"cue":case"cue-region":case"first-letter":case"first-line":case"file-selector-button":case"marker":case"placeholder":case"selection":case"target-text":{if(this.#s)throw new DOMException(`Unsupported pseudo-element ::${i}`,h.NOT_SUPPORTED_ERR);break}case"part":case"slotted":{if(this.#s)throw new DOMException(`Unsupported pseudo-element ::${i}()`,h.NOT_SUPPORTED_ERR);break}default:if(i.startsWith("-webkit-")){if(this.#s)throw new DOMException(`Unsupported pseudo-element ::${i}`,h.NOT_SUPPORTED_ERR)}else if(!c)throw new DOMException(`Unknown pseudo-element ::${i}`,h.SYNTAX_ERR)}}_matchDirectionPseudoClass(i,e){const c=(0,g.unescapeSelector)(i.name),d=(0,k.getDirectionality)(e);let r;return c===d&&(r=e),r??null}_matchLanguagePseudoClass(i,e){const c=(0,g.unescapeSelector)(i.name);let d;if(c){if(c==="*")if(e.hasAttribute("lang"))e.getAttribute("lang")&&(d=e);else{let r=e.parentNode;for(;r;){if(r.hasAttribute("lang")){r.getAttribute("lang")&&(d=e);break}r=r.parentNode}}else if(te.test(c)){let r;if(/-/.test(c)){const[b,m,...f]=c.split("-");let s;b==="*"?s=`${D}${A}`:s=`${b}${A}`;const l=`-${m}${A}`,o=f.length;let u="";if(o)for(let n=0;n<o;n++)u+=`-${f[n]}${A}`;r=new RegExp(`^${s}${l}${u}$`,"i")}else r=new RegExp(`^${c}${A}$`,"i");if(e.hasAttribute("lang"))r.test(e.getAttribute("lang"))&&(d=e);else{let b=e.parentNode;for(;b;){if(b.hasAttribute("lang")){const m=b.getAttribute("lang");r.test(m)&&(d=e);break}b=b.parentNode}}}}return d??null}_matchHasPseudoFunc(i,e){let c;if(Array.isArray(i)&&i.length){const[d]=i,{type:r}=d;let b;r===h.COMBINATOR?b=i.shift():b={name:" ",type:h.COMBINATOR};const m=[];for(;i.length;){const[l]=i,{type:o}=l;if(o===h.COMBINATOR)break;m.push(i.shift())}const f={combo:b,leaves:m},s=this._matchCombinator(f,e,{find:"next"});if(s.size)if(i.length){for(const l of s)if(c=this._matchHasPseudoFunc(Object.assign([],i),l),c)break}else c=!0}return!!c}_matchLogicalPseudoFunc(i,e){const{astName:c="",branches:d=[],selector:r="",twigBranches:b=[]}=i;let m;if(c==="has")if(r.includes(":has("))m=null;else{const f=d.length;let s;for(let l=0;l<f;l++){const o=d[l];if(s=this._matchHasPseudoFunc(Object.assign([],o),e),s)break}s&&(m=e)}else{const f=/^(?:is|where)$/.test(c),s=b.length;let l;for(let o=0;o<s;o++){const u=b[o],n=u.length-1,{leaves:t}=u[n];if(l=this._matchLeaves(t,e,{forgive:f}),l&&n>0){let a=new Set([e]);for(let p=n-1;p>=0;p--){const N=u[p],w=[];for(const y of a){const E=this._matchCombinator(N,y,{forgive:f,find:"prev"});E.size&&w.push(...E)}if(w.length)if(p===0){l=!0;break}else a=new Set(w);else{l=!1;break}}}if(l)break}c==="not"?l||(m=e):l&&(m=e)}return m??null}_matchPseudoClassSelector(i,e,c={}){const{children:d}=i,{localName:r,parentNode:b}=e,{forgive:m}=c,f=(0,g.unescapeSelector)(i.name);let s=new Set;if(j.test(f)){let l;if(this.#a.has(i))l=this.#a.get(i);else{const u=(0,g.walkAST)(i),n=[],t=[];for(const[...a]of u){for(const y of a){const E=(0,g.generateCSS)(y);n.push(E)}const p=[],N=new Set;let w=a.shift();for(;w;)if(w.type===h.COMBINATOR?(p.push({combo:w,leaves:[...N]}),N.clear()):w&&N.add(w),a.length)w=a.shift();else{p.push({combo:null,leaves:[...N]}),N.clear();break}t.push(p)}l={astName:f,branches:u,twigBranches:t,selector:n.join(",")},this.#a.set(i,l)}const o=this._matchLogicalPseudoFunc(l,e);o&&s.add(o)}else if(Array.isArray(d)){const[l]=d;if(ee.test(f)){const o=this._matchAnPlusB(l,e,f);o.size&&(s=o)}else if(f==="dir"){const o=this._matchDirectionPseudoClass(l,e);o&&s.add(o)}else if(f==="lang"){const o=this._matchLanguagePseudoClass(l,e);o&&s.add(o)}else switch(f){case"current":case"nth-col":case"nth-last-col":{if(this.#s)throw new DOMException(`Unsupported pseudo-class :${f}()`,h.NOT_SUPPORTED_ERR);break}default:if(!m)throw new DOMException(`Unknown pseudo-class :${f}()`,h.SYNTAX_ERR)}}else{const{document:l,root:o}=this.#t,{documentElement:u}=l,n=new URL(l.URL);switch(f){case"any-link":case"link":{B.test(r)&&e.hasAttribute("href")&&s.add(e);break}case"local-link":{if(B.test(r)&&e.hasAttribute("href")){const t=new URL(e.getAttribute("href"),n.href);t.origin===n.origin&&t.pathname===n.pathname&&s.add(e)}break}case"visited":break;case"target":{e.id&&n.hash&&n.hash===`#${e.id}`&&(0,k.isSameOrDescendant)(e)&&s.add(e);break}case"target-within":{if(n.hash){const t=n.hash.replace(/^#/,"");let a=l.getElementById(t);for(;a;){if(a===e){s.add(e);break}a=a.parentNode}}break}case"scope":{this.#e.nodeType===h.ELEMENT_NODE?e===this.#e&&s.add(e):e===u&&s.add(e);break}case"focus":{e===l.activeElement&&s.add(e);break}case"focus-within":{let t=l.activeElement;for(;t;){if(t===e){s.add(e);break}t=t.parentNode}break}case"open":{z.test(r)&&e.hasAttribute("open")&&s.add(e);break}case"closed":{z.test(r)&&!e.hasAttribute("open")&&s.add(e);break}case"disabled":{if(U.test(r)||(0,P.default)(r))if(e.disabled||e.hasAttribute("disabled"))s.add(e);else{let t=b;for(;t&&t.localName!=="fieldset";)t=t.parentNode;t&&b.localName!=="legend"&&t.hasAttribute("disabled")&&s.add(e)}break}case"enabled":{(U.test(r)||(0,P.default)(r))&&!(e.disabled&&e.hasAttribute("disabled"))&&s.add(e);break}case"read-only":{switch(r){case"textarea":{(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&s.add(e);break}case"input":{(!e.type||x.test(e.type)||I.test(e.type))&&(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&s.add(e);break}default:(0,k.isContentEditable)(e)||s.add(e)}break}case"read-write":{switch(r){case"textarea":{e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled")||s.add(e);break}case"input":{(!e.type||x.test(e.type)||I.test(e.type))&&!(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&s.add(e);break}default:(0,k.isContentEditable)(e)&&s.add(e)}break}case"placeholder-shown":{let t;r==="textarea"?t=e:r==="input"&&(e.hasAttribute("type")?x.test(e.getAttribute("type"))&&(t=e):t=e),t&&e.value===""&&e.hasAttribute("placeholder")&&e.getAttribute("placeholder").trim().length&&s.add(e);break}case"checked":{(e.checked&&r==="input"&&e.hasAttribute("type")&&O.test(e.getAttribute("type"))||e.selected&&r==="option")&&s.add(e);break}case"indeterminate":{if(e.indeterminate&&r==="input"&&e.type==="checkbox"||r==="progress"&&!e.hasAttribute("value"))s.add(e);else if(r==="input"&&e.type==="radio"&&!e.hasAttribute("checked")){const t=e.name;let a=e.parentNode;for(;a&&a.localName!=="form";)a=a.parentNode;a||(a=u);const p=[...a.getElementsByTagName("input")];let N;for(const w of p)if(w.getAttribute("type")==="radio"&&(t?w.getAttribute("name")===t&&(N=!!w.checked):w.hasAttribute("name")||(N=!!w.checked),N))break;N||s.add(e)}break}case"default":{if(r==="button"&&!(e.hasAttribute("type")&&F.test(e.getAttribute("type")))||r==="input"&&e.hasAttribute("type")&&V.test(e.getAttribute("type"))){let t=e.parentNode;for(;t&&t.localName!=="form";)t=t.parentNode;if(t){const a=l.createNodeIterator(t,h.SHOW_ELEMENT);let p=a.nextNode();for(;p;){const N=p.localName;let w;if(N==="button"?w=!(p.hasAttribute("type")&&F.test(p.getAttribute("type"))):N==="input"&&(w=p.hasAttribute("type")&&V.test(p.getAttribute("type"))),w){p===e&&s.add(e);break}p=a.nextNode()}}}else if(r==="input"&&e.hasAttribute("type")&&O.test(e.getAttribute("type"))&&(e.checked||e.hasAttribute("checked")))s.add(e);else if(r==="option"){let t=!1,a=b;for(;a&&a.localName!=="datalist";){if(a.localName==="select"){(a.multiple||a.hasAttribute("multiple"))&&(t=!0);break}a=a.parentNode}if(t)(e.selected||e.hasAttribute("selected"))&&s.add(e);else{const p=b.firstElementChild,N=new Set;let w=p;for(;w;){if(w.selected||w.hasAttribute("selected")){N.add(w);break}w=w.nextElementSibling}N.size||N.add(p),N.has(e)&&s.add(e)}}break}case"valid":{if(C.test(r))e.checkValidity()&&s.add(e);else if(/^fieldset$/.test(r)){const t=l.createNodeIterator(e,h.SHOW_ELEMENT);let a=t.nextNode();a===e&&(a=t.nextNode());let p;for(;a&&!(C.test(a.localName)&&(p=a.checkValidity(),!p));)a=t.nextNode();p&&s.add(e)}break}case"invalid":{if(C.test(r))e.checkValidity()||s.add(e);else if(/^fieldset$/.test(r)){const t=l.createNodeIterator(e,h.SHOW_ELEMENT);let a=t.nextNode();a===e&&(a=t.nextNode());let p;for(;a&&!(C.test(a.localName)&&(p=a.checkValidity(),!p));)a=t.nextNode();p||s.add(e)}break}case"in-range":{r==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&H.test(e.getAttribute("type"))&&!(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&(e.hasAttribute("min")||e.hasAttribute("max")||e.getAttribute("type")==="range")&&s.add(e);break}case"out-of-range":{r==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&H.test(e.getAttribute("type"))&&(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&s.add(e);break}case"required":{let t;if(/^(?:select|textarea)$/.test(r))t=e;else if(r==="input")if(e.hasAttribute("type")){const a=e.getAttribute("type");(a==="file"||x.test(a)||O.test(a)||I.test(a))&&(t=e)}else t=e;t&&(e.required||e.hasAttribute("required"))&&s.add(e);break}case"optional":{let t;if(/^(?:select|textarea)$/.test(r))t=e;else if(r==="input")if(e.hasAttribute("type")){const a=e.getAttribute("type");(a==="file"||x.test(a)||O.test(a)||I.test(a))&&(t=e)}else t=e;t&&!(e.required||e.hasAttribute("required"))&&s.add(e);break}case"root":{e===u&&s.add(e);break}case"empty":{if(e.hasChildNodes()){const t=e.childNodes.values();let a;for(const p of t)if(a=p.nodeType!==h.ELEMENT_NODE&&p.nodeType!==h.TEXT_NODE,!a)break;a&&s.add(e)}else s.add(e);break}case"first-child":{(b&&e===b.firstElementChild||e===o&&o.nodeType===h.ELEMENT_NODE)&&s.add(e);break}case"last-child":{(b&&e===b.lastElementChild||e===o&&o.nodeType===h.ELEMENT_NODE)&&s.add(e);break}case"only-child":{(b&&e===b.firstElementChild&&e===b.lastElementChild||e===o&&o.nodeType===h.ELEMENT_NODE)&&s.add(e);break}case"first-of-type":{if(b){const[t]=this._collectNthOfType({a:0,b:1},e);t&&s.add(t)}else e===o&&o.nodeType===h.ELEMENT_NODE&&s.add(e);break}case"last-of-type":{if(b){const[t]=this._collectNthOfType({a:0,b:1,reverse:!0},e);t&&s.add(t)}else e===o&&o.nodeType===h.ELEMENT_NODE&&s.add(e);break}case"only-of-type":{if(b){const[t]=this._collectNthOfType({a:0,b:1},e);if(t===e){const[a]=this._collectNthOfType({a:0,b:1,reverse:!0},e);a===e&&s.add(e)}}else e===o&&o.nodeType===h.ELEMENT_NODE&&s.add(e);break}case"host":case"host-context":break;case"after":case"before":case"first-letter":case"first-line":{if(this.#s)throw new DOMException(`Unsupported pseudo-element ::${f}`,h.NOT_SUPPORTED_ERR);break}case"active":case"autofill":case"blank":case"buffering":case"current":case"focus-visible":case"fullscreen":case"future":case"hover":case"modal":case"muted":case"past":case"paused":case"picture-in-picture":case"playing":case"seeking":case"stalled":case"user-invalid":case"user-valid":case"volume-locked":case"-webkit-autofill":{if(this.#s)throw new DOMException(`Unsupported pseudo-class :${f}`,h.NOT_SUPPORTED_ERR);break}default:if(f.startsWith("-webkit-")){if(this.#s)throw new DOMException(`Unsupported pseudo-class :${f}`,h.NOT_SUPPORTED_ERR)}else if(!m)throw new DOMException(`Unknown pseudo-class :${f}`,h.SYNTAX_ERR)}}return s}_matchAttributeSelector(i,e){const{flags:c,matcher:d,name:r,value:b}=i;if(typeof c=="string"&&!/^[is]$/i.test(c)){const s=(0,g.generateCSS)(i);throw new DOMException(`Invalid selector ${s}`,h.SYNTAX_ERR)}const{attributes:m}=e;let f;if(m&&m.length){const{document:s}=this.#t;let l;s.contentType==="text/html"?typeof c=="string"&&/^s$/i.test(c)?l=!1:l=!0:typeof c=="string"&&/^i$/i.test(c)?l=!0:l=!1;let{name:o}=r;o=(0,g.unescapeSelector)(o),l&&(o=o.toLowerCase());const u=new Set;if(/\|/.test(o)){const{prefix:n,tagName:t}=(0,k.selectorToNodeProps)(o);for(let{name:a,value:p}of m)switch(l&&(a=a.toLowerCase(),p=p.toLowerCase()),n){case"":{t===a&&u.add(p);break}case"*":{/:/.test(a)?a.endsWith(`:${t}`)&&u.add(p):t===a&&u.add(p);break}default:if(/:/.test(a)){const[N,w]=a.split(":");n===N&&t===w&&(0,k.isNamespaceDeclared)(n,e)&&u.add(p)}}}else for(let{name:n,value:t}of m)if(l&&(n=n.toLowerCase(),t=t.toLowerCase()),/:/.test(n)){const[a,p]=n.split(":");if(a==="xml"&&p==="lang")continue;o===p&&u.add(t)}else o===n&&u.add(t);if(u.size){const{name:n,value:t}=b||{};let a;switch(n?l?a=n.toLowerCase():a=n:t?l?a=t.toLowerCase():a=t:t===""&&(a=t),d){case"=":{typeof a=="string"&&u.has(a)&&(f=e);break}case"~=":{if(a&&typeof a=="string"){for(const p of u)if(new Set(p.split(/\s+/)).has(a)){f=e;break}}break}case"|=":{if(a&&typeof a=="string"){let p;for(const N of u)if(N===a||N.startsWith(`${a}-`)){p=N;break}p&&(f=e)}break}case"^=":{if(a&&typeof a=="string"){let p;for(const N of u)if(N.startsWith(`${a}`)){p=N;break}p&&(f=e)}break}case"$=":{if(a&&typeof a=="string"){let p;for(const N of u)if(N.endsWith(`${a}`)){p=N;break}p&&(f=e)}break}case"*=":{if(a&&typeof a=="string"){let p;for(const N of u)if(N.includes(`${a}`)){p=N;break}p&&(f=e)}break}case null:default:f=e}}}return f??null}_matchClassSelector(i,e){const c=(0,g.unescapeSelector)(i.name);let d;return e.classList.contains(c)&&(d=e),d??null}_matchIDSelector(i,e){const c=(0,g.unescapeSelector)(i.name),{id:d}=e;let r;return c===d&&(r=e),r??null}_matchTypeSelector(i,e){const c=(0,g.unescapeSelector)(i.name),{localName:d,prefix:r}=e,{document:b}=this.#t;let{prefix:m,tagName:f}=(0,k.selectorToNodeProps)(c,e);b.contentType==="text/html"&&(m=m.toLowerCase(),f=f.toLowerCase());let s,l;/:/.test(d)?[s,l]=d.split(":"):(s=r||"",l=d);let o;return m===""&&s===""?e.namespaceURI===null&&(f==="*"||f===l)&&(o=e):m==="*"?(f==="*"||f===l)&&(o=e):m===s&&(0,k.isNamespaceDeclared)(m,e)&&(f==="*"||f===l)&&(o=e),o??null}_matchShadowHostPseudoClass(i,e){const{children:c}=i,d=(0,g.unescapeSelector)(i.name);let r;if(Array.isArray(c)){const[b]=(0,g.walkAST)(c[0]),[...m]=b,{host:f}=e;if(d==="host"){let s;for(const l of m){const{type:o}=l;if(o===h.COMBINATOR){const u=(0,g.generateCSS)(i);throw new DOMException(`Invalid selector ${u}`,h.SYNTAX_ERR)}if(s=this._matchSelector(l,f).has(f),!s)break}s&&(r=e)}else if(d==="host-context"){let s=f,l;for(;s;){for(const o of m){const{type:u}=o;if(u===h.COMBINATOR){const n=(0,g.generateCSS)(i);throw new DOMException(`Invalid selector ${n}`,h.SYNTAX_ERR)}if(l=this._matchSelector(o,s).has(s),!l)break}if(l)break;s=s.parentNode}l&&(r=e)}}else d==="host"&&(r=e);return r??null}_matchSelector(i,e,c){const{type:d}=i,r=(0,g.unescapeSelector)(i.name),{shadow:b}=this.#t;let m=new Set;if(e.nodeType===h.ELEMENT_NODE)switch(d){case h.ATTRIBUTE_SELECTOR:{const f=this._matchAttributeSelector(i,e);f&&m.add(f);break}case h.CLASS_SELECTOR:{const f=this._matchClassSelector(i,e);f&&m.add(f);break}case h.ID_SELECTOR:{const f=this._matchIDSelector(i,e);f&&m.add(f);break}case h.PSEUDO_CLASS_SELECTOR:{const f=this._matchPseudoClassSelector(i,e,c);f.size&&(m=f);break}case h.PSEUDO_ELEMENT_SELECTOR:{this._matchPseudoElementSelector(r,c);break}case h.TYPE_SELECTOR:default:{const f=this._matchTypeSelector(i,e);f&&m.add(f)}}else if(b&&d===h.PSEUDO_CLASS_SELECTOR&&e.nodeType===h.DOCUMENT_FRAGMENT_NODE){if(r!=="has"&&j.test(r)){const f=this._matchPseudoClassSelector(i,e,c);f.size&&(m=f)}else if(G.test(r)){const f=this._matchShadowHostPseudoClass(i,e);f&&m.add(f)}}return m}_matchLeaves(i,e,c){let d;for(const r of i)if(d=this._matchSelector(r,e,c).has(e),!d)break;return!!d}_findDescendantNodes(i,e){const[c,...d]=i,{type:r}=c,b=(0,g.unescapeSelector)(c.name),m=d.length>0,f=new Set;let s=!1;switch(r){case h.ID_SELECTOR:{const{root:l}=this.#t;if(l.nodeType===h.ELEMENT_NODE)s=!0;else{const o=l.getElementById(b);if(o&&o!==e){const u=(0,k.isSameOrDescendant)(o,e);let n;u&&(n=o),n&&(m?this._matchLeaves(d,n)&&f.add(n):f.add(n))}}break}case h.PSEUDO_ELEMENT_SELECTOR:{this._matchPseudoElementSelector(b);break}default:s=!0}return{nodes:f,pending:s}}_matchCombinator(i,e,c={}){const{combo:d,leaves:r}=i,{name:b}=d,{find:m,forgive:f}=c;let s=new Set;if(m==="next")switch(b){case"+":{const l=e.nextElementSibling;l&&this._matchLeaves(r,l,{forgive:f})&&s.add(l);break}case"~":{let l=e.nextElementSibling;for(;l;)this._matchLeaves(r,l,{forgive:f})&&s.add(l),l=l.nextElementSibling;break}case">":{const l=[...e.children];for(const o of l)this._matchLeaves(r,o,{forgive:f})&&s.add(o);break}case" ":default:{const{nodes:l,pending:o}=this._findDescendantNodes(r,e);if(l.size)s=l;else if(o){const{document:u}=this.#t,n=u.createNodeIterator(e,h.SHOW_ELEMENT);let t=n.nextNode();for(t===e&&(t=n.nextNode());t;)this._matchLeaves(r,t,{forgive:f})&&s.add(t),t=n.nextNode()}}}else switch(b){case"+":{const l=e.previousElementSibling;l&&this._matchLeaves(r,l,{forgive:f})&&s.add(l);break}case"~":{const l=[];let o=e.previousElementSibling;for(;o;)this._matchLeaves(r,o,{forgive:f})&&l.push(o),o=o.previousElementSibling;l.length&&(s=new Set(l.reverse()));break}case">":{const l=e.parentNode;l&&this._matchLeaves(r,l,{forgive:f})&&s.add(l);break}case" ":default:{const l=[];let o=e.parentNode;for(;o;)this._matchLeaves(r,o,{forgive:f})&&l.push(o),o=o.parentNode;l.length&&(s=new Set(l.reverse()))}}return s}_findNodes(i,e){const{leaves:[c,...d]}=i,{type:r}=c,b=(0,g.unescapeSelector)(c.name),m=d.length>0,{document:f,root:s,shadow:l}=this.#t;let o=new Set,u=!1;switch(r){case h.ID_SELECTOR:{let n;if(e===v)this._matchLeaves([c],this.#e)&&(n=this.#e);else if(e===S){let t=this.#e;for(;t;){if(this._matchLeaves([c],t)){n=t;break}t=t.parentNode}}else s.nodeType===h.ELEMENT_NODE?u=!0:n=s.getElementById(b);n&&(m?this._matchLeaves(d,n)&&o.add(n):o.add(n));break}case h.CLASS_SELECTOR:{const n=[];if(e===v)this.#e.nodeType===h.ELEMENT_NODE&&this.#e.classList.contains(b)&&n.push(this.#e);else if(e===S){let t=this.#e;for(;t&&t.nodeType===h.ELEMENT_NODE;)t.classList.contains(b)&&n.push(t),t=t.parentNode}else if(s.nodeType===h.DOCUMENT_FRAGMENT_NODE){const t=[...s.children];for(const a of t){a.classList.contains(b)&&n.push(a);const p=[...a.getElementsByClassName(b)];n.push(...p)}}else{const t=[...s.getElementsByClassName(b)];n.push(...t)}if(n.length)if(m)for(const t of n)this._matchLeaves(d,t)&&o.add(t);else o=new Set(n);break}case h.TYPE_SELECTOR:{const n=[];if(e===v)this.#e.nodeType===h.ELEMENT_NODE&&this._matchLeaves([c],this.#e)&&n.push(this.#e);else if(e===S){let t=this.#e;for(;t&&t.nodeType===h.ELEMENT_NODE;)this._matchLeaves([c],t)&&n.push(t),t=t.parentNode}else if(f.contentType!=="text/html"||/[*|]/.test(b))u=!0;else if(s.nodeType===h.DOCUMENT_FRAGMENT_NODE){const t=b.toLowerCase(),a=[...s.children];for(const p of a){p.localName===t&&n.push(p);const N=[...p.getElementsByTagName(b)];n.push(...N)}}else{const t=[...s.getElementsByTagName(b)];n.push(...t)}if(n.length)if(m)for(const t of n)this._matchLeaves(d,t)&&o.add(t);else o=new Set(n);break}case h.PSEUDO_ELEMENT_SELECTOR:{this._matchPseudoElementSelector(b);break}default:{const n=[];if(e!==S&&G.test(b)){if(l&&this.#e.nodeType===h.DOCUMENT_FRAGMENT_NODE){const t=this._matchShadowHostPseudoClass(c,this.#e);t&&n.push(t)}}else if(e===v)this._matchLeaves([c],this.#e)&&n.push(this.#e);else if(e===S){let t=this.#e;for(;t;)this._matchLeaves([c],t)&&n.push(t),t=t.parentNode}else u=!0;if(n.length)if(m)for(const t of n)this._matchLeaves(d,t)&&o.add(t);else o=new Set(n)}}return{nodes:o,pending:u}}_getFirstTwig(i){const e=i.length-1,c=i[0];let d,r;if(e){const b=i[e],{leaves:[{type:m}]}=b;m===h.PSEUDO_ELEMENT_SELECTOR||m===h.ID_SELECTOR?(d="prev",r=b):(d="next",r=c)}else d="prev",r=c;return{find:d,twig:r}}_collectNodes(i){const e=this.#i.values();if(i===$||i===T){const c=new Set;let d=0;for(const{branch:r}of e){const{find:b,twig:m}=this._getFirstTwig(r),{nodes:f,pending:s}=this._findNodes(m,i);f.size?this.#l[d]=f:s?c.add(new Map([["index",d],["twig",m]])):this.#i[d].skip=!0,this.#i[d].find=b,d++}if(c.size){const{document:r,root:b}=this.#t,m=r.createNodeIterator(b,h.SHOW_ELEMENT);let f=m.nextNode();for(;f;){let s=!1;if(this.#e.nodeType===h.ELEMENT_NODE?s=(0,k.isSameOrDescendant)(f,this.#e):s=!0,s)for(const l of c){const{leaves:o}=l.get("twig");if(this._matchLeaves(o,f)){const n=l.get("index");this.#l[n].add(f)}}f=m.nextNode()}}}else{let c=0;for(const{branch:d}of e){const r=d[d.length-1],{nodes:b}=this._findNodes(r,i);b.size?this.#l[c]=b:this.#i[c].skip=!0,this.#i[c].find="prev",c++}}return[this.#i,this.#l]}_sortNodes(i){const e=[...i];return e.length>1&&e.sort((c,d)=>{const r=c.compareDocumentPosition(d);let b;return r&h.DOCUMENT_POSITION_PRECEDING||r&h.DOCUMENT_POSITION_CONTAINS?b=1:b=-1,b}),e}_matchNodes(i){const[...e]=this.#i,c=e.length;let d=new Set;for(let r=0;r<c;r++){const{branch:b,find:m,skip:f}=e[r],s=b.length;if(!f&&s){const l=this.#l[r],o=s-1;if(o===0)if((i===$||i===T)&&this.#e.nodeType===h.ELEMENT_NODE){for(const u of l)if(u!==this.#e&&(0,k.isSameOrDescendant)(u,this.#e)&&(d.add(u),i===T))break}else if(i===T){const[u]=this._sortNodes(l);d.add(u)}else{const u=[...d],n=[...l];d=new Set([...u,...n])}else if(m==="next"){let{combo:u}=b[0];for(const n of l){let t=new Set([n]);for(let a=1;a<s;a++){const{combo:p,leaves:N}=b[a],w=[];for(const y of t){const E={combo:u,leaves:N},M=this._matchCombinator(E,y,{find:m});M.size&&w.push(...M)}if(w.length)if(a===o){if(i===T){const[y]=this._sortNodes(w);d.add(y)}else{const y=[...d];d=new Set([...y,...w])}break}else u=p,t=new Set(w);else break}}}else for(const u of l){let n=new Set([u]),t;for(let a=o-1;a>=0;a--){const p=b[a],N=[];for(const w of n){const y=this._matchCombinator(p,w,{find:m});y.size&&N.push(...y)}if(N.length)if(t=!0,a===0){d.add(u);break}else n=new Set(N);else{t=!1;break}}if(t&&i!==$)break}}}return d}_find(i){return this._collectNodes(i),this._matchNodes(i)}matches(){if(this.#e.nodeType!==h.ELEMENT_NODE)throw new TypeError(`Unexpected node ${this.#e.nodeName}`);let i;try{i=this._find(v).has(this.#e)}catch(e){this._onError(e)}return!!i}closest(){if(this.#e.nodeType!==h.ELEMENT_NODE)throw new TypeError(`Unexpected node ${this.#e.nodeName}`);let i;try{const e=this._find(S);let c=this.#e;for(;c;){if(e.has(c)){i=c;break}c=c.parentNode}}catch(e){this._onError(e)}return i??null}querySelector(){let i;try{const e=this._find(T);e.delete(this.#e),e.size>1?[i]=this._sortNodes(e):e.size&&([i]=[...e])}catch(e){this._onError(e)}return i??null}querySelectorAll(){const i=[];try{const e=this._find($);e.delete(this.#e),e.size>1&&this.#c?i.push(...this._sortNodes(e)):e.size&&i.push(...e)}catch(e){this._onError(e)}return i}}0&&(module.exports={Matcher});
//# sourceMappingURL=matcher.js.map
