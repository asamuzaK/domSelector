var B=Object.create;var I=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var V=Object.getPrototypeOf,j=Object.prototype.hasOwnProperty;var H=(T,i)=>{for(var e in i)I(T,e,{get:i[e],enumerable:!0})},U=(T,i,e,n)=>{if(i&&typeof i=="object"||typeof i=="function")for(let h of F(i))!j.call(T,h)&&h!==e&&I(T,h,{get:()=>i[h],enumerable:!(n=z(i,h))||n.enumerable});return T};var W=(T,i,e)=>(e=T!=null?B(V(T)):{},U(i||!T||!T.__esModule?I(e,"default",{value:T,enumerable:!0}):e,T)),G=T=>U(I({},"__esModule",{value:!0}),T);var X={};H(X,{Matcher:()=>q});module.exports=G(X);var M=W(require("is-potential-custom-element-name"),1),E=require("./dom-util.js"),k=require("./parser.js"),r=require("./constant.js");const P="next",R="prev",C="all",$="first",O="lineal",D="self";class q{#i;#r;#a;#e;#l;#t;#o;#s;constructor(i,e,n={}){const{warn:h}=n;this.#r=new Map([[r.SELECTOR_PSEUDO_ELEMENT,r.BIT_01],[r.SELECTOR_ID,r.BIT_02],[r.SELECTOR_CLASS,r.BIT_04],[r.SELECTOR_TYPE,r.BIT_08],[r.SELECTOR_ATTR,r.BIT_16],[r.SELECTOR_PSEUDO_CLASS,r.BIT_32]]),this.#a=new WeakMap,this.#o=i,this.#e=e,this.#s=!!h,[this.#i,this.#l]=this._prepare(i),this.#t=this._getRoot(e)}_onError(i){if(i instanceof DOMException&&i.name===r.NOT_SUPPORTED_ERR)this.#s&&console.warn(i.message);else throw i}_getRoot(i=this.#e){let e,n;switch(i.nodeType){case r.DOCUMENT_NODE:{e=i,n=i;break}case r.DOCUMENT_FRAGMENT_NODE:{e=i.ownerDocument,n=i;break}case r.ELEMENT_NODE:{if(i.ownerDocument.contains(i))e=i.ownerDocument,n=i.ownerDocument;else{let l=i;for(;l&&l.parentNode;)l=l.parentNode;e=l.ownerDocument,n=l}break}default:throw new TypeError(`Unexpected node ${i.nodeName}`)}const h=(0,E.isInShadowTree)(i);return{document:e,root:n,shadow:h}}_sortLeaves(i){const e=[...i];return e.length>1&&e.sort((n,h)=>{const{type:l}=n,{type:u}=h,m=this.#r.get(l),f=this.#r.get(u);let t;return m===f?t=0:m>f?t=1:t=-1,t}),e}_prepare(i=this.#o){const e=(0,k.parseSelector)(i),n=(0,k.walkAST)(e),h=[],l=[];let u=0;for(const[...m]of n){const f=[];let t=m.shift();if(t&&t.type!==r.COMBINATOR){const s=new Set;for(;t;){if(t.type===r.COMBINATOR){const[o]=m;if(o.type===r.COMBINATOR){const b=`Invalid combinator ${t.name}${o.name}`;throw new DOMException(b,r.SYNTAX_ERR)}f.push({combo:t,leaves:this._sortLeaves(s)}),s.clear()}else t&&s.add(t);if(m.length)t=m.shift();else{f.push({combo:null,leaves:this._sortLeaves(s)}),s.clear();break}}}h.push({branch:f,find:null,skip:!1}),l[u]=new Set,u++}return[h,l]}_collectNthChild(i,e){const{a:n,b:h,reverse:l,selector:u}=i,{parentNode:m}=e,f=new Set;let t;if(u&&(this.#a.has(u)?t=this.#a.get(u):(t=(0,k.walkAST)(u),this.#a.set(u,t))),m){const s=[].slice.call(m.children),o=s.length;if(o){const b=new Set;if(t){const a=t.length;for(const c of s){let d;for(let w=0;w<a;w++){const N=t[w];if(d=this._matchLeaves(N,c),!d)break}d&&b.add(c)}}if(l&&s.reverse(),n===0){if(h>0&&h<=o){if(b.size)for(let a=0;a<o;a++){const c=s[a];if(b.has(c)){f.add(c);break}}else if(!u){const a=s[h-1];f.add(a)}}}else{let a=h-1;if(n>0)for(;a<0;)a+=n;if(a>=0&&a<o){let c=n>0?0:h-1;for(let d=0;d<o&&a>=0&&a<o;d++){const w=s[d];b.size?b.has(w)&&(c===a&&(f.add(w),a+=n),n>0?c++:c--):d===a&&(u||f.add(w),a+=n)}}}}}else{const{root:s}=this.#t;if(e===s&&s.nodeType===r.ELEMENT_NODE&&n+h===1)if(t){const o=t.length;let b;for(let a=0;a<o;a++){const c=t[a];if(b=this._matchLeaves(c,e),b)break}b&&f.add(e)}else f.add(e)}return f}_collectNthOfType(i,e){const{a:n,b:h,reverse:l}=i,{localName:u,parentNode:m,prefix:f}=e,t=new Set;if(m){const s=[].slice.call(m.children),o=s.length;if(o)if(l&&s.reverse(),n===0){if(h>0&&h<=o){let b=0;for(let a=0;a<o;a++){const c=s[a],{localName:d,prefix:w}=c;if(d===u&&w===f){if(b===h-1){t.add(c);break}b++}}}}else{let b=h-1;if(n>0)for(;b<0;)b+=n;if(b>=0&&b<o){let a=n>0?0:h-1;for(let c=0;c<o;c++){const d=s[c],{localName:w,prefix:N}=d;if(w===u&&N===f){if(a===b&&(t.add(d),b+=n),b<0||b>=o)break;n>0?a++:a--}}}}}else{const{root:s}=this.#t;e===s&&s.nodeType===r.ELEMENT_NODE&&n+h===1&&t.add(e)}return t}_matchAnPlusB(i,e,n){const{nth:{a:h,b:l,name:u},selector:m}=i,f=(0,k.unescapeSelector)(u),t=new Map;f?(f==="even"?(t.set("a",2),t.set("b",0)):f==="odd"&&(t.set("a",2),t.set("b",1)),n.indexOf("last")>-1&&t.set("reverse",!0)):(typeof h=="string"&&/-?\d+/.test(h)?t.set("a",h*1):t.set("a",0),typeof l=="string"&&/-?\d+/.test(l)?t.set("b",l*1):t.set("b",0),n.indexOf("last")>-1&&t.set("reverse",!0));let s=new Set;if(t.has("a")&&t.has("b")){if(/^nth-(?:last-)?child$/.test(n)){m&&t.set("selector",m);const o=Object.fromEntries(t),b=this._collectNthChild(o,e);b.size&&(s=b)}else if(/^nth-(?:last-)?of-type$/.test(n)){const o=Object.fromEntries(t),b=this._collectNthOfType(o,e);b.size&&(s=b)}}return s}_matchPseudoElementSelector(i,e={}){const{forgive:n}=e;switch(i){case"after":case"backdrop":case"before":case"cue":case"cue-region":case"first-letter":case"first-line":case"file-selector-button":case"marker":case"placeholder":case"selection":case"target-text":{if(this.#s)throw new DOMException(`Unsupported pseudo-element ::${i}`,r.NOT_SUPPORTED_ERR);break}case"part":case"slotted":{if(this.#s)throw new DOMException(`Unsupported pseudo-element ::${i}()`,r.NOT_SUPPORTED_ERR);break}default:if(i.startsWith("-webkit-")){if(this.#s)throw new DOMException(`Unsupported pseudo-element ::${i}`,r.NOT_SUPPORTED_ERR)}else if(!n)throw new DOMException(`Unknown pseudo-element ::${i}`,r.SYNTAX_ERR)}}_matchDirectionPseudoClass(i,e){const n=(0,k.unescapeSelector)(i.name),h=(0,E.getDirectionality)(e);let l;return n===h&&(l=e),l??null}_matchLanguagePseudoClass(i,e){const n=(0,k.unescapeSelector)(i.name);let h;if(n==="*")if(e.hasAttribute("lang"))e.getAttribute("lang")&&(h=e);else{let l=e.parentNode;for(;l&&l.nodeType===r.ELEMENT_NODE;){if(l.hasAttribute("lang")){l.getAttribute("lang")&&(h=e);break}l=l.parentNode}}else if(n){const l=`(?:-${r.ALPHA_NUM})*`;if(new RegExp(`^(?:\\*-)?${r.ALPHA_NUM}${l}$`,"i").test(n)){let m;if(n.indexOf("-")>-1){const[f,t,...s]=n.split("-");let o;f==="*"?o=`${r.ALPHA_NUM}${l}`:o=`${f}${l}`;const b=`-${t}${l}`,a=s.length;let c="";if(a)for(let d=0;d<a;d++)c+=`-${s[d]}${l}`;m=new RegExp(`^${o}${b}${c}$`,"i")}else m=new RegExp(`^${n}${l}$`,"i");if(e.hasAttribute("lang"))m.test(e.getAttribute("lang"))&&(h=e);else{let f=e.parentNode;for(;f&&f.nodeType===r.ELEMENT_NODE;){if(f.hasAttribute("lang")){const t=f.getAttribute("lang");m.test(t)&&(h=e);break}f=f.parentNode}}}}return h??null}_matchHasPseudoFunc(i,e){let n;if(Array.isArray(i)&&i.length){const[h]=i,{type:l}=h;let u;l===r.COMBINATOR?u=i.shift():u={name:" ",type:r.COMBINATOR};const m=[];for(;i.length;){const[s]=i,{type:o}=s;if(o===r.COMBINATOR)break;m.push(i.shift())}const f={combo:u,leaves:m},t=this._matchCombinator(f,e,{find:P});if(t.size)if(i.length){for(const s of t)if(n=this._matchHasPseudoFunc(Object.assign([],i),s),n)break}else n=!0}return!!n}_matchLogicalPseudoFunc(i,e){const{astName:n="",branches:h=[],selector:l="",twigBranches:u=[]}=i;let m;if(n==="has")if(l.includes(":has("))m=null;else{const f=h.length;let t;for(let s=0;s<f;s++){const o=h[s];if(t=this._matchHasPseudoFunc(Object.assign([],o),e),t)break}t&&(m=e)}else{const f=/^(?:is|where)$/.test(n),t=u.length;let s;for(let o=0;o<t;o++){const b=u[o],a=b.length-1,{leaves:c}=b[a];if(s=this._matchLeaves(c,e,{forgive:f}),s&&a>0){let d=new Set([e]);for(let w=a-1;w>=0;w--){const N=b[w],_=[];for(const x of d){const p=this._matchCombinator(N,x,{forgive:f,find:R});p.size&&_.push(...p)}if(_.length)if(w===0){s=!0;break}else d=new Set(_);else{s=!1;break}}}if(s)break}n==="not"?s||(m=e):s&&(m=e)}return m??null}_matchPseudoClassSelector(i,e,n={}){const{children:h}=i,{localName:l,parentNode:u}=e,{forgive:m}=n,f=(0,k.unescapeSelector)(i.name);let t=new Set;if(r.REG_LOGICAL_PSEUDO.test(f)){let s;if(this.#a.has(i))s=this.#a.get(i);else{const b=(0,k.walkAST)(i),a=[],c=[];for(const[...d]of b){for(const x of d){const p=(0,k.generateCSS)(x);a.push(p)}const w=[],N=new Set;let _=d.shift();for(;_;)if(_.type===r.COMBINATOR?(w.push({combo:_,leaves:[...N]}),N.clear()):_&&N.add(_),d.length)_=d.shift();else{w.push({combo:null,leaves:[...N]}),N.clear();break}c.push(w)}s={astName:f,branches:b,twigBranches:c,selector:a.join(",")},this.#a.set(i,s)}const o=this._matchLogicalPseudoFunc(s,e);o&&t.add(o)}else if(Array.isArray(h)){const[s]=h;if(/^nth-(?:last-)?(?:child|of-type)$/.test(f)){const o=this._matchAnPlusB(s,e,f);o.size&&(t=o)}else if(f==="dir"){const o=this._matchDirectionPseudoClass(s,e);o&&t.add(o)}else if(f==="lang"){const o=this._matchLanguagePseudoClass(s,e);o&&t.add(o)}else switch(f){case"current":case"nth-col":case"nth-last-col":{if(this.#s)throw new DOMException(`Unsupported pseudo-class :${f}()`,r.NOT_SUPPORTED_ERR);break}case"host":case"host-context":break;default:if(!m)throw new DOMException(`Unknown pseudo-class :${f}()`,r.SYNTAX_ERR)}}else{const{document:s,root:o}=this.#t,b=/^a(?:rea)?$/,a=/^(?:(?:fieldse|inpu|selec)t|button|opt(?:group|ion)|textarea)$/,c=/^(?:(?:inpu|selec)t|button|form|textarea)$/,d=/^d(?:etails|ialog)$/,w=/^(?:checkbox|radio)$/,N=/^(?:date(?:time-local)?|month|time|week)$/,_=/(?:(?:rang|tim)e|date(?:time-local)?|month|number|week)$/,x=/^(?:(?:emai|te|ur)l|number|password|search|text)$/;switch(f){case"any-link":case"link":{b.test(l)&&e.hasAttribute("href")&&t.add(e);break}case"local-link":{if(b.test(l)&&e.hasAttribute("href")){const{href:p,origin:g,pathname:y}=new URL(s.URL),A=new URL(e.getAttribute("href"),p);A.origin===g&&A.pathname===y&&t.add(e)}break}case"visited":break;case"target":{const{hash:p}=new URL(s.URL);e.id&&p===`#${e.id}`&&s.contains(e)&&t.add(e);break}case"target-within":{const{hash:p}=new URL(s.URL);if(p){const g=p.replace(/^#/,"");let y=s.getElementById(g);for(;y;){if(y===e){t.add(e);break}y=y.parentNode}}break}case"scope":{this.#e.nodeType===r.ELEMENT_NODE?e===this.#e&&t.add(e):e===s.documentElement&&t.add(e);break}case"focus":{e===s.activeElement&&t.add(e);break}case"focus-within":{let p=s.activeElement;for(;p;){if(p===e){t.add(e);break}p=p.parentNode}break}case"open":{d.test(l)&&e.hasAttribute("open")&&t.add(e);break}case"closed":{d.test(l)&&!e.hasAttribute("open")&&t.add(e);break}case"disabled":{if(a.test(l)||(0,M.default)(l))if(e.disabled||e.hasAttribute("disabled"))t.add(e);else{let p=u;for(;p&&p.localName!=="fieldset";)p=p.parentNode;p&&u.localName!=="legend"&&p.hasAttribute("disabled")&&t.add(e)}break}case"enabled":{(a.test(l)||(0,M.default)(l))&&!(e.disabled&&e.hasAttribute("disabled"))&&t.add(e);break}case"read-only":{switch(l){case"textarea":{(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}case"input":{(!e.type||N.test(e.type)||x.test(e.type))&&(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}default:(0,E.isContentEditable)(e)||t.add(e)}break}case"read-write":{switch(l){case"textarea":{e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled")||t.add(e);break}case"input":{(!e.type||N.test(e.type)||x.test(e.type))&&!(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}default:(0,E.isContentEditable)(e)&&t.add(e)}break}case"placeholder-shown":{let p;l==="textarea"?p=e:l==="input"&&(e.hasAttribute("type")?x.test(e.getAttribute("type"))&&(p=e):p=e),p&&e.value===""&&e.hasAttribute("placeholder")&&e.getAttribute("placeholder").trim().length&&t.add(e);break}case"checked":{(e.checked&&l==="input"&&e.hasAttribute("type")&&w.test(e.getAttribute("type"))||e.selected&&l==="option")&&t.add(e);break}case"indeterminate":{if(e.indeterminate&&l==="input"&&e.type==="checkbox"||l==="progress"&&!e.hasAttribute("value"))t.add(e);else if(l==="input"&&e.type==="radio"&&!e.hasAttribute("checked")){const p=e.name;let g=e.parentNode;for(;g&&g.localName!=="form";)g=g.parentNode;g||(g=s.documentElement);const y=[].slice.call(g.getElementsByTagName("input"));let A;for(const v of y)if(v.getAttribute("type")==="radio"&&(p?v.getAttribute("name")===p&&(A=!!v.checked):v.hasAttribute("name")||(A=!!v.checked),A))break;A||t.add(e)}break}case"default":{const p=/^(?:button|reset)$/,g=/^(?:image|submit)$/;if(l==="button"&&!(e.hasAttribute("type")&&p.test(e.getAttribute("type")))||l==="input"&&e.hasAttribute("type")&&g.test(e.getAttribute("type"))){let y=e.parentNode;for(;y&&y.localName!=="form";)y=y.parentNode;if(y){const A=s.createNodeIterator(y,r.SHOW_ELEMENT);let v=A.nextNode();for(;v;){const L=v.localName;let S;if(L==="button"?S=!(v.hasAttribute("type")&&p.test(v.getAttribute("type"))):L==="input"&&(S=v.hasAttribute("type")&&g.test(v.getAttribute("type"))),S){v===e&&t.add(e);break}v=A.nextNode()}}}else if(l==="input"&&e.hasAttribute("type")&&w.test(e.getAttribute("type"))&&(e.checked||e.hasAttribute("checked")))t.add(e);else if(l==="option"){let y=!1,A=u;for(;A&&A.localName!=="datalist";){if(A.localName==="select"){(A.multiple||A.hasAttribute("multiple"))&&(y=!0);break}A=A.parentNode}if(y)(e.selected||e.hasAttribute("selected"))&&t.add(e);else{const v=u.firstElementChild,L=new Set;let S=v;for(;S;){if(S.selected||S.hasAttribute("selected")){L.add(S);break}S=S.nextElementSibling}L.size||L.add(v),L.has(e)&&t.add(e)}}break}case"valid":{if(c.test(l))e.checkValidity()&&t.add(e);else if(l==="fieldset"){const p=s.createNodeIterator(e,r.SHOW_ELEMENT);let g=p.nextNode();g===e&&(g=p.nextNode());let y;for(;g&&!(c.test(g.localName)&&(y=g.checkValidity(),!y));)g=p.nextNode();y&&t.add(e)}break}case"invalid":{if(c.test(l))e.checkValidity()||t.add(e);else if(l==="fieldset"){const p=s.createNodeIterator(e,r.SHOW_ELEMENT);let g=p.nextNode();g===e&&(g=p.nextNode());let y;for(;g&&!(c.test(g.localName)&&(y=g.checkValidity(),!y));)g=p.nextNode();y||t.add(e)}break}case"in-range":{l==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&_.test(e.getAttribute("type"))&&!(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&(e.hasAttribute("min")||e.hasAttribute("max")||e.getAttribute("type")==="range")&&t.add(e);break}case"out-of-range":{l==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&_.test(e.getAttribute("type"))&&(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&t.add(e);break}case"required":{let p;if(/^(?:select|textarea)$/.test(l))p=e;else if(l==="input")if(e.hasAttribute("type")){const g=e.getAttribute("type");(g==="file"||w.test(g)||N.test(g)||x.test(g))&&(p=e)}else p=e;p&&(e.required||e.hasAttribute("required"))&&t.add(e);break}case"optional":{let p;if(/^(?:select|textarea)$/.test(l))p=e;else if(l==="input")if(e.hasAttribute("type")){const g=e.getAttribute("type");(g==="file"||w.test(g)||N.test(g)||x.test(g))&&(p=e)}else p=e;p&&!(e.required||e.hasAttribute("required"))&&t.add(e);break}case"root":{e===s.documentElement&&t.add(e);break}case"empty":{if(e.hasChildNodes()){const p=e.childNodes.values();let g;for(const y of p)if(g=y.nodeType!==r.ELEMENT_NODE&&y.nodeType!==r.TEXT_NODE,!g)break;g&&t.add(e)}else t.add(e);break}case"first-child":{(u&&e===u.firstElementChild||e===o&&o.nodeType===r.ELEMENT_NODE)&&t.add(e);break}case"last-child":{(u&&e===u.lastElementChild||e===o&&o.nodeType===r.ELEMENT_NODE)&&t.add(e);break}case"only-child":{(u&&e===u.firstElementChild&&e===u.lastElementChild||e===o&&o.nodeType===r.ELEMENT_NODE)&&t.add(e);break}case"first-of-type":{if(u){const[p]=this._collectNthOfType({a:0,b:1},e);p&&t.add(p)}else e===o&&o.nodeType===r.ELEMENT_NODE&&t.add(e);break}case"last-of-type":{if(u){const[p]=this._collectNthOfType({a:0,b:1,reverse:!0},e);p&&t.add(p)}else e===o&&o.nodeType===r.ELEMENT_NODE&&t.add(e);break}case"only-of-type":{if(u){const[p]=this._collectNthOfType({a:0,b:1},e);if(p===e){const[g]=this._collectNthOfType({a:0,b:1,reverse:!0},e);g===e&&t.add(e)}}else e===o&&o.nodeType===r.ELEMENT_NODE&&t.add(e);break}case"host":case"host-context":break;case"after":case"before":case"first-letter":case"first-line":{if(this.#s)throw new DOMException(`Unsupported pseudo-element ::${f}`,r.NOT_SUPPORTED_ERR);break}case"active":case"autofill":case"blank":case"buffering":case"current":case"focus-visible":case"fullscreen":case"future":case"hover":case"modal":case"muted":case"past":case"paused":case"picture-in-picture":case"playing":case"seeking":case"stalled":case"user-invalid":case"user-valid":case"volume-locked":case"-webkit-autofill":{if(this.#s)throw new DOMException(`Unsupported pseudo-class :${f}`,r.NOT_SUPPORTED_ERR);break}default:if(f.startsWith("-webkit-")){if(this.#s)throw new DOMException(`Unsupported pseudo-class :${f}`,r.NOT_SUPPORTED_ERR)}else if(!m)throw new DOMException(`Unknown pseudo-class :${f}`,r.SYNTAX_ERR)}}return t}_matchAttributeSelector(i,e){const{flags:n,matcher:h,name:l,value:u}=i;if(typeof n=="string"&&!/^[is]$/i.test(n)){const t=(0,k.generateCSS)(i);throw new DOMException(`Invalid selector ${t}`,r.SYNTAX_ERR)}const{attributes:m}=e;let f;if(m&&m.length){const{document:t}=this.#t;let s;t.contentType==="text/html"?typeof n=="string"&&/^s$/i.test(n)?s=!1:s=!0:typeof n=="string"&&/^i$/i.test(n)?s=!0:s=!1;let o=(0,k.unescapeSelector)(l.name);s&&(o=o.toLowerCase());const b=new Set;if(o.indexOf("|")>-1){const{prefix:a,tagName:c}=(0,E.selectorToNodeProps)(o);for(let{name:d,value:w}of m)switch(s&&(d=d.toLowerCase(),w=w.toLowerCase()),a){case"":{c===d&&b.add(w);break}case"*":{d.indexOf(":")>-1?d.endsWith(`:${c}`)&&b.add(w):c===d&&b.add(w);break}default:if(d.indexOf(":")>-1){const[N,_]=d.split(":");a===N&&c===_&&(0,E.isNamespaceDeclared)(a,e)&&b.add(w)}}}else for(let{name:a,value:c}of m)if(s&&(a=a.toLowerCase(),c=c.toLowerCase()),a.indexOf(":")>-1){const[d,w]=a.split(":");if(d==="xml"&&w==="lang")continue;o===w&&b.add(c)}else o===a&&b.add(c);if(b.size){const{name:a,value:c}=u||{};let d;switch(a?s?d=a.toLowerCase():d=a:c?s?d=c.toLowerCase():d=c:c===""&&(d=c),h){case"=":{typeof d=="string"&&b.has(d)&&(f=e);break}case"~=":{if(d&&typeof d=="string"){for(const w of b)if(new Set(w.split(/\s+/)).has(d)){f=e;break}}break}case"|=":{if(d&&typeof d=="string"){let w;for(const N of b)if(N===d||N.startsWith(`${d}-`)){w=N;break}w&&(f=e)}break}case"^=":{if(d&&typeof d=="string"){let w;for(const N of b)if(N.startsWith(`${d}`)){w=N;break}w&&(f=e)}break}case"$=":{if(d&&typeof d=="string"){let w;for(const N of b)if(N.endsWith(`${d}`)){w=N;break}w&&(f=e)}break}case"*=":{if(d&&typeof d=="string"){let w;for(const N of b)if(N.includes(`${d}`)){w=N;break}w&&(f=e)}break}case null:default:f=e}}}return f??null}_matchClassSelector(i,e){const n=(0,k.unescapeSelector)(i.name);let h;return e.classList.contains(n)&&(h=e),h??null}_matchIDSelector(i,e){const n=(0,k.unescapeSelector)(i.name),{id:h}=e;let l;return n===h&&(l=e),l??null}_matchTypeSelector(i,e,n={}){const h=(0,k.unescapeSelector)(i.name),{localName:l,prefix:u}=e,{forgive:m}=n,{document:f}=this.#t;let{prefix:t,tagName:s}=(0,E.selectorToNodeProps)(h,e);f.contentType==="text/html"&&(t=t.toLowerCase(),s=s.toLowerCase());let o,b;l.indexOf(":")>-1?[o,b]=l.split(":"):(o=u||"",b=l);let a;if(t===""&&o==="")e.namespaceURI===null&&(s==="*"||s===b)&&(a=e);else if(t==="*")(s==="*"||s===b)&&(a=e);else if(t===o){if((0,E.isNamespaceDeclared)(t,e))(s==="*"||s===b)&&(a=e);else if(!m)throw new DOMException(`Undeclared namespace ${t}`,r.SYNTAX_ERR)}else if(t&&!m&&!(0,E.isNamespaceDeclared)(t,e))throw new DOMException(`Undeclared namespace ${t}`,r.SYNTAX_ERR);return a??null}_matchShadowHostPseudoClass(i,e){const{children:n}=i,h=(0,k.unescapeSelector)(i.name);let l;if(Array.isArray(n)){const[u]=(0,k.walkAST)(n[0]),[...m]=u,{host:f}=e;if(h==="host"){let t;for(const s of m){const{type:o}=s;if(o===r.COMBINATOR){const b=(0,k.generateCSS)(i);throw new DOMException(`Invalid selector ${b}`,r.SYNTAX_ERR)}if(t=this._matchSelector(s,f).has(f),!t)break}t&&(l=e)}else if(h==="host-context"){let t=f,s;for(;t;){for(const o of m){const{type:b}=o;if(b===r.COMBINATOR){const a=(0,k.generateCSS)(i);throw new DOMException(`Invalid selector ${a}`,r.SYNTAX_ERR)}if(s=this._matchSelector(o,t).has(t),!s)break}if(s)break;t=t.parentNode}s&&(l=e)}}else if(h==="host")l=e;else throw new DOMException(`Invalid selector :${h}`,r.SYNTAX_ERR);return l??null}_matchSelector(i,e,n){const{type:h}=i,l=(0,k.unescapeSelector)(i.name),{shadow:u}=this.#t;let m=new Set;if(e.nodeType===r.ELEMENT_NODE)switch(h){case r.SELECTOR_ATTR:{const f=this._matchAttributeSelector(i,e);f&&m.add(f);break}case r.SELECTOR_CLASS:{const f=this._matchClassSelector(i,e);f&&m.add(f);break}case r.SELECTOR_ID:{const f=this._matchIDSelector(i,e);f&&m.add(f);break}case r.SELECTOR_PSEUDO_CLASS:{const f=this._matchPseudoClassSelector(i,e,n);f.size&&(m=f);break}case r.SELECTOR_PSEUDO_ELEMENT:{this._matchPseudoElementSelector(l,n);break}case r.SELECTOR_TYPE:default:{const f=this._matchTypeSelector(i,e,n);f&&m.add(f)}}else if(u&&h===r.SELECTOR_PSEUDO_CLASS&&e.nodeType===r.DOCUMENT_FRAGMENT_NODE){if(l!=="has"&&r.REG_LOGICAL_PSEUDO.test(l)){const f=this._matchPseudoClassSelector(i,e,n);f.size&&(m=f)}else if(r.REG_SHADOW_HOST.test(l)){const f=this._matchShadowHostPseudoClass(i,e);f&&m.add(f)}}return m}_matchLeaves(i,e,n){let h;for(const l of i)if(h=this._matchSelector(l,e,n).has(e),!h)break;return!!h}_findDescendantNodes(i,e){const[n,...h]=i,{type:l}=n,u=(0,k.unescapeSelector)(n.name),m=h.length>0,{document:f,root:t,shadow:s}=this.#t;let o=new Set,b=!1;if(s)b=!0;else switch(l){case r.SELECTOR_ID:{if(t.nodeType===r.ELEMENT_NODE)b=!0;else{const a=t.getElementById(u);a&&a!==e&&e.contains(a)&&(m?this._matchLeaves(h,a)&&o.add(a):o.add(a))}break}case r.SELECTOR_CLASS:{const a=[].slice.call(e.getElementsByClassName(u));if(a.length)if(m)for(const c of a)this._matchLeaves(h,c)&&o.add(c);else o=new Set(a);break}case r.SELECTOR_TYPE:{if(f.contentType==="text/html"&&!/[*|]/.test(u)){const a=[].slice.call(e.getElementsByTagName(u));if(a.length)if(m)for(const c of a)this._matchLeaves(h,c)&&o.add(c);else o=new Set(a)}else b=!0;break}case r.SELECTOR_PSEUDO_ELEMENT:{this._matchPseudoElementSelector(u);break}default:b=!0}return{nodes:o,pending:b}}_matchCombinator(i,e,n={}){const{combo:h,leaves:l}=i,{name:u}=h,{find:m,forgive:f}=n;let t=new Set;if(m===P)switch(u){case"+":{const s=e.nextElementSibling;s&&this._matchLeaves(l,s,{forgive:f})&&t.add(s);break}case"~":{let s=e.nextElementSibling;for(;s;)this._matchLeaves(l,s,{forgive:f})&&t.add(s),s=s.nextElementSibling;break}case">":{const s=[].slice.call(e.children);for(const o of s)this._matchLeaves(l,o,{forgive:f})&&t.add(o);break}case" ":default:{const{nodes:s,pending:o}=this._findDescendantNodes(l,e);if(s.size)t=s;else if(o){const{document:b}=this.#t,a=b.createNodeIterator(e,r.SHOW_ELEMENT);let c=a.nextNode();for(c===e&&(c=a.nextNode());c;)this._matchLeaves(l,c,{forgive:f})&&t.add(c),c=a.nextNode()}}}else switch(u){case"+":{const s=e.previousElementSibling;s&&this._matchLeaves(l,s,{forgive:f})&&t.add(s);break}case"~":{const s=[];let o=e.previousElementSibling;for(;o;)this._matchLeaves(l,o,{forgive:f})&&s.push(o),o=o.previousElementSibling;s.length&&(t=new Set(s.reverse()));break}case">":{const s=e.parentNode;s&&this._matchLeaves(l,s,{forgive:f})&&t.add(s);break}case" ":default:{const s=[];let o=e.parentNode;for(;o;)this._matchLeaves(l,o,{forgive:f})&&s.push(o),o=o.parentNode;s.length&&(t=new Set(s.reverse()))}}return t}_findNodes(i,e){const{leaves:[n,...h]}=i,{type:l}=n,u=(0,k.unescapeSelector)(n.name),m=h.length>0,{document:f,root:t,shadow:s}=this.#t;let o=new Set,b=!1;switch(l){case r.SELECTOR_ID:{let a;if(e===D)this._matchLeaves([n],this.#e)&&(a=this.#e);else if(e===O){let c=this.#e;for(;c;){if(this._matchLeaves([n],c)){a=c;break}c=c.parentNode}}else e===C||t.nodeType===r.ELEMENT_NODE?b=!0:a=t.getElementById(u);a&&(m?this._matchLeaves(h,a)&&o.add(a):o.add(a));break}case r.SELECTOR_CLASS:{let a=[];if(e===D)this.#e.nodeType===r.ELEMENT_NODE&&this.#e.classList.contains(u)&&a.push(this.#e);else if(e===O){let c=this.#e;for(;c&&c.nodeType===r.ELEMENT_NODE;)c.classList.contains(u)&&a.push(c),c=c.parentNode}else if(t.nodeType===r.DOCUMENT_FRAGMENT_NODE){const c=[].slice.call(t.children);for(const d of c){d.classList.contains(u)&&a.push(d);const w=[].slice.call(d.getElementsByClassName(u));a.push(...w)}}else{const c=[].slice.call(t.getElementsByClassName(u));if(this.#e.nodeType===r.ELEMENT_NODE)for(const d of c)(d===this.#e||(0,E.isInclusive)(d,this.#e))&&a.push(d);else a=c}if(a.length)if(m)for(const c of a)this._matchLeaves(h,c)&&o.add(c);else o=new Set(a);break}case r.SELECTOR_TYPE:{let a=[];if(e===D)this.#e.nodeType===r.ELEMENT_NODE&&this._matchLeaves([n],this.#e)&&a.push(this.#e);else if(e===O){let c=this.#e;for(;c&&c.nodeType===r.ELEMENT_NODE;)this._matchLeaves([n],c)&&a.push(c),c=c.parentNode}else if(f.contentType!=="text/html"||/[*|]/.test(u))b=!0;else if(t.nodeType===r.DOCUMENT_FRAGMENT_NODE){const c=u.toLowerCase(),d=[].slice.call(t.children);for(const w of d){w.localName===c&&a.push(w);const N=[].slice.call(w.getElementsByTagName(u));a.push(...N)}}else{const c=[].slice.call(t.getElementsByTagName(u));if(this.#e.nodeType===r.ELEMENT_NODE)for(const d of c)(d===this.#e||(0,E.isInclusive)(d,this.#e))&&a.push(d);else a=c}if(a.length)if(m)for(const c of a)this._matchLeaves(h,c)&&o.add(c);else o=new Set(a);break}case r.SELECTOR_PSEUDO_ELEMENT:{this._matchPseudoElementSelector(u);break}default:{const a=[];if(e!==O&&r.REG_SHADOW_HOST.test(u)){if(s&&this.#e.nodeType===r.DOCUMENT_FRAGMENT_NODE){const c=this._matchShadowHostPseudoClass(n,this.#e);c&&a.push(c)}}else if(e===D)this._matchLeaves([n],this.#e)&&a.push(this.#e);else if(e===O){let c=this.#e;for(;c;)this._matchLeaves([n],c)&&a.push(c),c=c.parentNode}else b=!0;if(a.length)if(m)for(const c of a)this._matchLeaves(h,c)&&o.add(c);else o=new Set(a)}}if(m&&!b&&!o.size){const a=h[h.length-1],{type:c}=a;if(c===r.SELECTOR_PSEUDO_CLASS){let d;t.nodeType===r.ELEMENT_NODE?d=t:d=t.firstElementChild,this._matchPseudoClassSelector(a,d)}}return{nodes:o,pending:b}}_getFirstTwig(i){const e=i.length-1,n=i[0];let h,l;if(e){const u=i[e],{leaves:[{type:m}]}=u;m===r.SELECTOR_PSEUDO_ELEMENT||m===r.SELECTOR_ID?(h=R,l=u):(h=P,l=n)}else h=R,l=n;return{find:h,twig:l}}_collectNodes(i){const e=this.#i.values();if(i===C||i===$){const n=new Set;let h=0;for(const{branch:l}of e){const{find:u,twig:m}=this._getFirstTwig(l),{nodes:f,pending:t}=this._findNodes(m,i);f.size?this.#l[h]=f:t?n.add(new Map([["index",h],["twig",m]])):this.#i[h].skip=!0,this.#i[h].find=u,h++}if(n.size){const{document:l,root:u}=this.#t,m=l.createNodeIterator(u,r.SHOW_ELEMENT);let f=m.nextNode();for(;f;){let t=!1;if(this.#e.nodeType===r.ELEMENT_NODE?f===this.#e?t=!0:t=this.#e.contains(f):t=!0,t)for(const s of n){const{leaves:o}=s.get("twig");if(this._matchLeaves(o,f)){const a=s.get("index");this.#l[a].add(f)}}f=m.nextNode()}}}else{let n=0;for(const{branch:h}of e){const l=h[h.length-1],{nodes:u}=this._findNodes(l,i);u.size?this.#l[n]=u:this.#i[n].skip=!0,this.#i[n].find=R,n++}}return[this.#i,this.#l]}_sortNodes(i){const e=[...i];return e.length>1&&e.sort((n,h)=>{let l;return(0,E.isPreceding)(h,n)?l=1:l=-1,l}),e}_matchNodes(i){const[...e]=this.#i,n=e.length;let h=new Set;for(let l=0;l<n;l++){const{branch:u,find:m,skip:f}=e[l],t=u.length;if(!f&&t){const s=this.#l[l],o=t-1;if(o===0)if((i===C||i===$)&&this.#e.nodeType===r.ELEMENT_NODE){for(const b of s)if(b!==this.#e&&this.#e.contains(b)&&(h.add(b),i===$))break}else if(i===$){const[b]=this._sortNodes(s);h.add(b)}else{const b=[...h],a=[...s];h=new Set([...b,...a])}else if(m===P){let{combo:b}=u[0];for(const a of s){let c=new Set([a]);for(let d=1;d<t;d++){const{combo:w,leaves:N}=u[d],_=[];for(const x of c){const p={combo:b,leaves:N},g=this._matchCombinator(p,x,{find:m});g.size&&_.push(...g)}if(_.length)if(d===o){if(i===$){const[x]=this._sortNodes(_);h.add(x)}else{const x=[...h];h=new Set([...x,..._])}break}else b=w,c=new Set(_);else break}}}else for(const b of s){let a=new Set([b]),c;for(let d=o-1;d>=0;d--){const w=u[d],N=[];for(const _ of a){const x=this._matchCombinator(w,_,{find:m});x.size&&N.push(...x)}if(N.length)if(c=!0,d===0){h.add(b);break}else a=new Set(N);else{c=!1;break}}if(c&&i!==C)break}}}return h}_find(i){return this._collectNodes(i),this._matchNodes(i)}matches(){if(this.#e.nodeType!==r.ELEMENT_NODE)throw new TypeError(`Unexpected node ${this.#e.nodeName}`);let i;try{i=this._find(D).has(this.#e)}catch(e){this._onError(e)}return!!i}closest(){if(this.#e.nodeType!==r.ELEMENT_NODE)throw new TypeError(`Unexpected node ${this.#e.nodeName}`);let i;try{const e=this._find(O);let n=this.#e;for(;n;){if(e.has(n)){i=n;break}n=n.parentNode}}catch(e){this._onError(e)}return i??null}querySelector(){let i;try{const e=this._find($);e.delete(this.#e),e.size&&([i]=this._sortNodes(e))}catch(e){this._onError(e)}return i??null}querySelectorAll(){let i;try{const e=this._find(C);e.delete(this.#e),e.size&&(i=this._sortNodes(e))}catch(e){this._onError(e)}return i??[]}}0&&(module.exports={Matcher});
//# sourceMappingURL=matcher.js.map
