var j=Object.create;var L=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var W=Object.getOwnPropertyNames;var q=Object.getPrototypeOf,G=Object.prototype.hasOwnProperty;var Y=(y,a)=>{for(var e in a)L(y,e,{get:a[e],enumerable:!0})},R=(y,a,e,o)=>{if(a&&typeof a=="object"||typeof a=="function")for(let h of W(a))!G.call(y,h)&&h!==e&&L(y,h,{get:()=>a[h],enumerable:!(o=H(a,h))||o.enumerable});return y};var X=(y,a,e)=>(e=y!=null?j(q(y)):{},R(a||!y||!y.__esModule?L(e,"default",{value:y,enumerable:!0}):e,y)),Z=y=>R(L({},"__esModule",{value:!0}),y);var ee={};Y(ee,{Matcher:()=>Q});module.exports=Z(ee);var D=X(require("is-potential-custom-element-name"),1),k=require("./dom-util.js"),g=require("./parser.js"),b=require("./constant.js");const $="all",T="first",v="lineal",S="self",U=/^(?:(?:fieldse|inpu|selec)t|button|opt(?:group|ion)|textarea)$/,C=/^(?:(?:(?:in|out)pu|selec)t|button|form|textarea)$/,M=/^a(?:rea)?$/,B=/^d(?:etails|ialog)$/,O=/^(?:checkbox|radio)$/,x=/^(?:(?:emai|te|ur)l|number|password|search|text)$/,z=/(?:(?:rang|tim)e|date(?:time-local)?|month|number|week)$/,F=/^(?:button|reset)$/,V=/^(?:image|submit)$/,I=/^(?:date(?:time-local)?|month|time|week)$/,K=/^(?:(?:ha|i)s|not|where)$/,J=/^nth-(?:last-)?(?:child|of-type)$/;class Q{#s;#l;#a;#e;#r;#t;#o;#c;#i;constructor(a,e,o={}){const{sort:h,warn:c}=o;this.#l=new Map([[b.PSEUDO_ELEMENT_SELECTOR,b.BIT_1],[b.ID_SELECTOR,b.BIT_10],[b.CLASS_SELECTOR,b.BIT_100],[b.TYPE_SELECTOR,b.BIT_1000],[b.ATTRIBUTE_SELECTOR,b.BIT_10000],[b.PSEUDO_CLASS_SELECTOR,b.BIT_100000]]),this.#a=new WeakMap,this.#o=a,this.#e=e,this.#c=!!h,this.#i=!!c,[this.#s,this.#r]=this._prepare(a),this.#t=this._getRoot(e)}_onError(a){if(a instanceof DOMException&&a.name===b.NOT_SUPPORTED_ERR)this.#i&&console.warn(a.message);else throw a}_getRoot(a=this.#e){let e,o;switch(a.nodeType){case b.DOCUMENT_NODE:{e=a,o=a;break}case b.DOCUMENT_FRAGMENT_NODE:{e=a.ownerDocument,o=a;break}case b.ELEMENT_NODE:{if((0,k.isSameOrDescendant)(a))e=a.ownerDocument,o=a.ownerDocument;else{let h=a;for(;h&&h.parentNode;)h=h.parentNode;e=h.ownerDocument,o=h}break}default:throw new TypeError(`Unexpected node ${a.nodeName}`)}return{document:e,root:o}}_sortLeaves(a){const e=[...a];return e.length>1&&e.sort((o,h)=>{const{type:c}=o,{type:d}=h,p=this.#l.get(c),u=this.#l.get(d);let t;return p===u?t=0:p>u?t=1:t=-1,t}),e}_prepare(a=this.#o){const e=(0,g.parseSelector)(a),o=(0,g.walkAST)(e),h=[],c=[];let d=0;for(const[...p]of o){const u=[];let t=p.shift();if(t&&t.type!==b.COMBINATOR){const l=new Set;for(;t;){if(t.type===b.COMBINATOR){const[n]=p;if(n.type===b.COMBINATOR){const f=`Invalid combinator ${t.name}${n.name}`;throw new DOMException(f,b.SYNTAX_ERR)}u.push({combo:t,leaves:this._sortLeaves(l)}),l.clear()}else t&&l.add(t);if(p.length)t=p.shift();else{u.push({combo:null,leaves:this._sortLeaves(l)}),l.clear();break}}}h.push({branch:u,find:null,skip:!1}),c[d]=new Set,d++}return[h,c]}_collectNthChild(a,e){const{a:o,b:h,reverse:c,selector:d}=a,{parentNode:p}=e,u=new Set;let t;if(d&&(this.#a.has(d)?t=this.#a.get(d):(t=(0,g.walkAST)(d),this.#a.set(d,t))),p){const l=[...p.children],n=l.length;if(n){const f=new Set;if(t){const r=t.length;for(const s of l){let i;for(let m=0;m<r;m++){const N=t[m];if(i=this._matchLeaves(N,s),!i)break}i&&f.add(s)}}if(c&&l.reverse(),o===0){if(h>0&&h<=n){if(f.size)for(let r=0;r<n;r++){const s=l[r];if(f.has(s)){u.add(s);break}}else if(!d){const r=l[h-1];u.add(r)}}}else{let r=h-1;if(o>0)for(;r<0;)r+=o;if(r>=0&&r<n){let s=o>0?0:h-1;for(let i=0;i<n&&r>=0&&r<n;i++){const m=l[i];f.size?f.has(m)&&(s===r&&(u.add(m),r+=o),o>0?s++:s--):i===r&&(d||u.add(m),r+=o)}}}}}else{const{root:l}=this.#t;if(l.nodeType===b.ELEMENT_NODE&&e===l&&o+h===1)if(t){const n=t.length;let f;for(let r=0;r<n;r++){const s=t[r];if(f=this._matchLeaves(s,e),f)break}f&&u.add(e)}else u.add(e)}return u}_collectNthOfType(a,e){const{a:o,b:h,reverse:c}=a,{localName:d,parentNode:p,prefix:u}=e,t=new Set;if(p){const l=[...p.children],n=l.length;if(n)if(c&&l.reverse(),o===0){if(h>0&&h<=n){let f=0;for(let r=0;r<n;r++){const s=l[r],{localName:i,prefix:m}=s;if(i===d&&m===u){if(f===h-1){t.add(s);break}f++}}}}else{let f=h-1;if(o>0)for(;f<0;)f+=o;if(f>=0&&f<n){let r=o>0?0:h-1;for(let s=0;s<n;s++){const i=l[s],{localName:m,prefix:N}=i;if(m===d&&N===u){if(r===f&&(t.add(i),f+=o),f<0||f>=n)break;o>0?r++:r--}}}}}else{const{root:l}=this.#t;l.nodeType===b.ELEMENT_NODE&&e===l&&o+h===1&&t.add(e)}return t}_matchAnPlusB(a,e,o){const{nth:{a:h,b:c,name:d},selector:p}=a,u=(0,g.unescapeSelector)(d),t=new Map;u?(u==="even"?(t.set("a",2),t.set("b",0)):u==="odd"&&(t.set("a",2),t.set("b",1)),/last/.test(o)&&t.set("reverse",!0)):(typeof h=="string"&&/-?\d+/.test(h)?t.set("a",h*1):t.set("a",0),typeof c=="string"&&/-?\d+/.test(c)?t.set("b",c*1):t.set("b",0),/last/.test(o)&&t.set("reverse",!0));let l=new Set;if(t.has("a")&&t.has("b")){if(/^nth-(?:last-)?child$/.test(o)){p&&t.set("selector",p);const n=Object.fromEntries(t),f=this._collectNthChild(n,e);f.size&&(l=f)}else if(/^nth-(?:last-)?of-type$/.test(o)){const n=Object.fromEntries(t),f=this._collectNthOfType(n,e);f.size&&(l=f)}}return l}_matchPseudoElementSelector(a,e={}){const{forgive:o}=e;switch(a){case"after":case"backdrop":case"before":case"cue":case"cue-region":case"first-letter":case"first-line":case"file-selector-button":case"marker":case"part":case"placeholder":case"selection":case"slotted":case"target-text":{if(this.#i)throw new DOMException(`Unsupported pseudo-element ::${a}`,b.NOT_SUPPORTED_ERR);break}default:if(a.startsWith("-webkit-")){if(this.#i)throw new DOMException(`Unsupported pseudo-element ::${a}`,b.NOT_SUPPORTED_ERR)}else if(!o)throw new DOMException(`Unknown pseudo-element ::${a}`,b.SYNTAX_ERR)}}_matchDirectionPseudoClass(a,e){const o=(0,g.unescapeSelector)(a.name),h=(0,k.getDirectionality)(e);let c;return o===h&&(c=e),c??null}_matchLanguagePseudoClass(a,e){const o=(0,g.unescapeSelector)(a.name);let h;if(o){if(o==="*")if(e.hasAttribute("lang"))e.getAttribute("lang")&&(h=e);else{let c=e.parentNode;for(;c;){if(c.hasAttribute("lang")){c.getAttribute("lang")&&(h=e);break}c=c.parentNode}}else if(/[A-Z\d-]+/i.test(o)){const c="[A-Z\\d]+",d=`(?:-${c})*`;let p;if(/-/.test(o)){const[u,t,...l]=o.split("-");let n;u==="*"?n=`${c}${d}`:n=`${u}${d}`;const f=`-${t}${d}`,r=l.length;let s="";if(r)for(let i=0;i<r;i++)s+=`-${l[i]}${d}`;p=new RegExp(`^${n}${f}${s}$`,"i")}else p=new RegExp(`^${o}${d}$`,"i");if(e.hasAttribute("lang"))p.test(e.getAttribute("lang"))&&(h=e);else{let u=e.parentNode;for(;u;){if(u.hasAttribute("lang")){const t=u.getAttribute("lang");p.test(t)&&(h=e);break}u=u.parentNode}}}}return h??null}_matchHasPseudoFunc(a,e){let o;if(Array.isArray(a)&&a.length){const[h]=a,{type:c}=h;let d;c===b.COMBINATOR?d=a.shift():d={name:" ",type:b.COMBINATOR};const p=[];for(;a.length;){const[l]=a,{type:n}=l;if(n===b.COMBINATOR)break;p.push(a.shift())}const u={combo:d,leaves:p},t=this._matchCombinator(u,e,{find:"next"});if(t.size)if(a.length){for(const l of t)if(o=this._matchHasPseudoFunc(Object.assign([],a),l),o)break}else o=!0}return!!o}_matchLogicalPseudoFunc(a,e){const{astName:o="",branches:h=[],selector:c="",twigBranches:d=[]}=a;let p;if(o==="has")if(c.includes(":has("))p=null;else{let u;const t=h.length;for(let l=0;l<t;l++){const n=h[l];if(u=this._matchHasPseudoFunc(Object.assign([],n),e),u)break}u&&(p=e)}else{const u=/^(?:is|where)$/.test(o);let t;const l=d.length;for(let n=0;n<l;n++){const f=d[n],r=f.length-1,{leaves:s}=f[r];if(t=this._matchLeaves(s,e,{forgive:u}),t&&r>0){let i=new Set([e]);for(let m=r-1;m>=0;m--){const N=f[m],w=[];for(const _ of i){const A=this._matchCombinator(N,_,{forgive:u,find:"prev"});A.size&&w.push(...A)}const E=new Set(w);if(E.size)if(m===0){t=!0;break}else i=E;else{t=!1;break}}}if(t)break}o==="not"?t||(p=e):t&&(p=e)}return p??null}_matchPseudoClassSelector(a,e,o={}){const{children:h}=a,{localName:c,parentNode:d}=e,{forgive:p}=o,u=(0,g.unescapeSelector)(a.name);let t=new Set;if(K.test(u)){let l;if(this.#a.has(a))l=this.#a.get(a);else{const f=(0,g.walkAST)(a),r=[],s=[];for(const[...i]of f){for(const E of i){const _=(0,g.generateCSS)(E);r.push(_)}const m=[],N=new Set;let w=i.shift();for(;w;)if(w.type===b.COMBINATOR?(m.push({combo:w,leaves:[...N]}),N.clear()):w&&N.add(w),i.length)w=i.shift();else{m.push({combo:null,leaves:[...N]}),N.clear();break}s.push(m)}l={astName:u,branches:f,twigBranches:s,selector:r.join(",")},this.#a.set(a,l)}const n=this._matchLogicalPseudoFunc(l,e);n&&t.add(n)}else if(Array.isArray(h)){const[l]=h;if(J.test(u)){const n=this._matchAnPlusB(l,e,u);n.size&&(t=n)}else if(u==="dir"){const n=this._matchDirectionPseudoClass(l,e);n&&t.add(n)}else if(u==="lang"){const n=this._matchLanguagePseudoClass(l,e);n&&t.add(n)}else switch(u){case"current":case"nth-col":case"nth-last-col":{if(this.#i)throw new DOMException(`Unsupported pseudo-class :${u}()`,b.NOT_SUPPORTED_ERR);break}default:if(!p)throw new DOMException(`Unknown pseudo-class :${u}()`,b.SYNTAX_ERR)}}else{const{document:l,root:n}=this.#t,{documentElement:f}=l,r=new URL(l.URL);switch(u){case"any-link":case"link":{M.test(c)&&e.hasAttribute("href")&&t.add(e);break}case"local-link":{if(M.test(c)&&e.hasAttribute("href")){const s=new URL(e.getAttribute("href"),r.href);s.origin===r.origin&&s.pathname===r.pathname&&t.add(e)}break}case"visited":break;case"target":{(0,k.isSameOrDescendant)(e)&&r.hash&&e.id&&r.hash===`#${e.id}`&&t.add(e);break}case"target-within":{if(r.hash){const s=r.hash.replace(/^#/,"");let i=l.getElementById(s);for(;i;){if(i===e){t.add(e);break}i=i.parentNode}}break}case"scope":{this.#e.nodeType===b.ELEMENT_NODE?e===this.#e&&t.add(e):e===f&&t.add(e);break}case"focus":{e===l.activeElement&&t.add(e);break}case"focus-within":{let s=l.activeElement;for(;s;){if(s===e){t.add(e);break}s=s.parentNode}break}case"open":{B.test(c)&&e.hasAttribute("open")&&t.add(e);break}case"closed":{B.test(c)&&!e.hasAttribute("open")&&t.add(e);break}case"disabled":{if(U.test(c)||(0,D.default)(c))if(e.disabled||e.hasAttribute("disabled"))t.add(e);else{let s=d;for(;s&&s.localName!=="fieldset";)s=s.parentNode;s&&s.hasAttribute("disabled")&&d.localName!=="legend"&&t.add(e)}break}case"enabled":{(U.test(c)||(0,D.default)(c))&&!(e.disabled&&e.hasAttribute("disabled"))&&t.add(e);break}case"read-only":{switch(c){case"textarea":{(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}case"input":{(!e.type||x.test(e.type)||I.test(e.type))&&(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}default:(0,k.isContentEditable)(e)||t.add(e)}break}case"read-write":{switch(c){case"textarea":{e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled")||t.add(e);break}case"input":{(!e.type||x.test(e.type)||I.test(e.type))&&!(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}default:(0,k.isContentEditable)(e)&&t.add(e)}break}case"placeholder-shown":{let s;c==="textarea"?s=e:c==="input"&&(e.hasAttribute("type")?x.test(e.getAttribute("type"))&&(s=e):s=e),s&&e.hasAttribute("placeholder")&&e.getAttribute("placeholder").trim().length&&e.value===""&&t.add(e);break}case"checked":{(c==="input"&&e.hasAttribute("type")&&O.test(e.getAttribute("type"))&&e.checked||c==="option"&&e.selected)&&t.add(e);break}case"indeterminate":{if(c==="input"&&e.type==="checkbox"&&e.indeterminate||c==="progress"&&!e.hasAttribute("value"))t.add(e);else if(c==="input"&&e.type==="radio"&&!e.hasAttribute("checked")){const s=e.name;let i=e.parentNode;for(;i&&i.localName!=="form";)i=i.parentNode;i||(i=f);const m=[...i.getElementsByTagName("input")];let N;for(const w of m)if(w.getAttribute("type")==="radio"&&(s?w.getAttribute("name")===s&&(N=!!w.checked):w.hasAttribute("name")||(N=!!w.checked),N))break;N||t.add(e)}break}case"default":{if(c==="button"&&!(e.hasAttribute("type")&&F.test(e.getAttribute("type")))||c==="input"&&e.hasAttribute("type")&&V.test(e.getAttribute("type"))){let s=e.parentNode;for(;s&&s.localName!=="form";)s=s.parentNode;if(s){const i=l.createNodeIterator(s,b.SHOW_ELEMENT);let m=i.nextNode();for(;m;){const N=m.localName;let w;if(N==="button"?w=!(m.hasAttribute("type")&&F.test(m.getAttribute("type"))):N==="input"&&(w=m.hasAttribute("type")&&V.test(m.getAttribute("type"))),w){m===e&&t.add(e);break}m=i.nextNode()}}}else if(c==="input"&&e.hasAttribute("type")&&O.test(e.getAttribute("type"))&&(e.checked||e.hasAttribute("checked")))t.add(e);else if(c==="option"){let s=!1,i=d;for(;i&&i.localName!=="datalist";){if(i.localName==="select"){(i.multiple||i.hasAttribute("multiple"))&&(s=!0);break}i=i.parentNode}if(s)(e.selected||e.hasAttribute("selected"))&&t.add(e);else{const m=d.firstElementChild,N=new Set;let w=m;for(;w;){if(w.selected||w.hasAttribute("selected")){N.add(w);break}w=w.nextElementSibling}N.size||N.add(m),N.has(e)&&t.add(e)}}break}case"valid":{if(C.test(c))e.checkValidity()&&t.add(e);else if(/^fieldset$/.test(c)){const s=l.createNodeIterator(e,b.SHOW_ELEMENT);let i=s.nextNode();i===e&&(i=s.nextNode());let m;for(;i&&!(C.test(i.localName)&&(m=i.checkValidity(),!m));)i=s.nextNode();m&&t.add(e)}break}case"invalid":{if(C.test(c))e.checkValidity()||t.add(e);else if(/^fieldset$/.test(c)){const s=l.createNodeIterator(e,b.SHOW_ELEMENT);let i=s.nextNode();i===e&&(i=s.nextNode());let m;for(;i&&!(C.test(i.localName)&&(m=i.checkValidity(),!m));)i=s.nextNode();m||t.add(e)}break}case"in-range":{c==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&z.test(e.getAttribute("type"))&&!(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&(e.hasAttribute("min")||e.hasAttribute("max")||e.getAttribute("type")==="range")&&t.add(e);break}case"out-of-range":{c==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&z.test(e.getAttribute("type"))&&(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&t.add(e);break}case"required":{let s;if(/^(?:select|textarea)$/.test(c))s=e;else if(c==="input")if(e.hasAttribute("type")){const i=e.getAttribute("type");(x.test(i)||O.test(i)||I.test(i)||i==="file")&&(s=e)}else s=e;s&&(e.required||e.hasAttribute("required"))&&t.add(e);break}case"optional":{let s;if(/^(?:select|textarea)$/.test(c))s=e;else if(c==="input")if(e.hasAttribute("type")){const i=e.getAttribute("type");(x.test(i)||O.test(i)||I.test(i)||i==="file")&&(s=e)}else s=e;s&&!(e.required||e.hasAttribute("required"))&&t.add(e);break}case"root":{e===f&&t.add(e);break}case"empty":{if(e.hasChildNodes()){const s=e.childNodes.values();let i;for(const m of s)if(i=m.nodeType!==b.ELEMENT_NODE&&m.nodeType!==b.TEXT_NODE,!i)break;i&&t.add(e)}else t.add(e);break}case"first-child":{(d&&e===d.firstElementChild||n.nodeType===b.ELEMENT_NODE&&e===n)&&t.add(e);break}case"last-child":{(d&&e===d.lastElementChild||n.nodeType===b.ELEMENT_NODE&&e===n)&&t.add(e);break}case"only-child":{(d&&e===d.firstElementChild&&e===d.lastElementChild||n.nodeType===b.ELEMENT_NODE&&e===n)&&t.add(e);break}case"first-of-type":{if(d){const[s]=this._collectNthOfType({a:0,b:1},e);s&&t.add(s)}else n.nodeType===b.ELEMENT_NODE&&e===n&&t.add(e);break}case"last-of-type":{if(d){const[s]=this._collectNthOfType({a:0,b:1,reverse:!0},e);s&&t.add(s)}else n.nodeType===b.ELEMENT_NODE&&e===n&&t.add(e);break}case"only-of-type":{if(d){const[s]=this._collectNthOfType({a:0,b:1},e);if(s===e){const[i]=this._collectNthOfType({a:0,b:1,reverse:!0},e);i===e&&t.add(e)}}else n.nodeType===b.ELEMENT_NODE&&e===n&&t.add(e);break}case"after":case"before":case"first-letter":case"first-line":{if(this.#i)throw new DOMException(`Unsupported pseudo-element ::${u}`,b.NOT_SUPPORTED_ERR);break}case"active":case"autofill":case"blank":case"buffering":case"current":case"focus-visible":case"fullscreen":case"future":case"hover":case"modal":case"muted":case"past":case"paused":case"picture-in-picture":case"playing":case"seeking":case"stalled":case"user-invalid":case"user-valid":case"volume-locked":case"-webkit-autofill":{if(this.#i)throw new DOMException(`Unsupported pseudo-class :${u}`,b.NOT_SUPPORTED_ERR);break}default:if(u.startsWith("-webkit-")){if(this.#i)throw new DOMException(`Unsupported pseudo-class :${u}`,b.NOT_SUPPORTED_ERR)}else if(!p)throw new DOMException(`Unknown pseudo-class :${u}`,b.SYNTAX_ERR)}}return t}_matchAttributeSelector(a,e){const{flags:o,matcher:h,name:c,value:d}=a;if(typeof o=="string"&&!/^[is]$/i.test(o))throw new DOMException("Invalid attribute selector",b.SYNTAX_ERR);const{attributes:p}=e;let u;if(p&&p.length){const{document:t}=this.#t;let l;t.contentType==="text/html"?typeof o=="string"&&/^s$/i.test(o)?l=!1:l=!0:typeof o=="string"&&/^i$/i.test(o)?l=!0:l=!1;let{name:n}=c;n=(0,g.unescapeSelector)(n),l&&(n=n.toLowerCase());const f=new Set;if(/\|/.test(n)){const{prefix:r,tagName:s}=(0,k.selectorToNodeProps)(n);for(let{name:i,value:m}of p)switch(l&&(i=i.toLowerCase(),m=m.toLowerCase()),r){case"":{s===i&&f.add(m);break}case"*":{/:/.test(i)?i.endsWith(`:${s}`)&&f.add(m):s===i&&f.add(m);break}default:if(/:/.test(i)){const[N,w]=i.split(":");r===N&&s===w&&(0,k.isNamespaceDeclared)(r,e)&&f.add(m)}}}else for(let{name:r,value:s}of p)if(l&&(r=r.toLowerCase(),s=s.toLowerCase()),/:/.test(r)){const[i,m]=r.split(":");if(i==="xml"&&m==="lang")continue;n===m&&f.add(s)}else n===r&&f.add(s);if(f.size){const{name:r,value:s}=d||{};let i;switch(r?l?i=r.toLowerCase():i=r:s?l?i=s.toLowerCase():i=s:s===""&&(i=s),h){case"=":{typeof i=="string"&&f.has(i)&&(u=e);break}case"~=":{if(i&&typeof i=="string"){for(const m of f)if(new Set(m.split(/\s+/)).has(i)){u=e;break}}break}case"|=":{if(i&&typeof i=="string"){let m;for(const N of f)if(N===i||N.startsWith(`${i}-`)){m=N;break}m&&(u=e)}break}case"^=":{if(i&&typeof i=="string"){let m;for(const N of f)if(N.startsWith(`${i}`)){m=N;break}m&&(u=e)}break}case"$=":{if(i&&typeof i=="string"){let m;for(const N of f)if(N.endsWith(`${i}`)){m=N;break}m&&(u=e)}break}case"*=":{if(i&&typeof i=="string"){let m;for(const N of f)if(N.includes(`${i}`)){m=N;break}m&&(u=e)}break}case null:default:u=e}}}return u??null}_matchClassSelector(a,e){const o=(0,g.unescapeSelector)(a.name);let h;return e.classList.contains(o)&&(h=e),h??null}_matchIDSelector(a,e){const{id:o}=e,h=(0,g.unescapeSelector)(a.name);let c;return h===o&&(c=e),c??null}_matchTypeSelector(a,e){const o=(0,g.unescapeSelector)(a.name),{localName:h,prefix:c}=e,{document:d}=this.#t;let{prefix:p,tagName:u}=(0,k.selectorToNodeProps)(o,e);d.contentType==="text/html"&&(p=p.toLowerCase(),u=u.toLowerCase());let t,l;/:/.test(h)?[t,l]=h.split(":"):(t=c||"",l=h);let n;return p===""&&t===""?e.namespaceURI===null&&(u==="*"||u===l)&&(n=e):p==="*"?(u==="*"||u===l)&&(n=e):p===t&&(0,k.isNamespaceDeclared)(p,e)&&(u==="*"||u===l)&&(n=e),n??null}_matchSelector(a,e,o){const{type:h}=a;let c=new Set;if(e.nodeType===b.ELEMENT_NODE)switch(h){case b.ATTRIBUTE_SELECTOR:{const d=this._matchAttributeSelector(a,e);d&&c.add(d);break}case b.CLASS_SELECTOR:{const d=this._matchClassSelector(a,e);d&&c.add(d);break}case b.ID_SELECTOR:{const d=this._matchIDSelector(a,e);d&&c.add(d);break}case b.PSEUDO_CLASS_SELECTOR:{const d=this._matchPseudoClassSelector(a,e,o);d.size&&(c=d);break}case b.PSEUDO_ELEMENT_SELECTOR:{const d=(0,g.unescapeSelector)(a.name);this._matchPseudoElementSelector(d,o);break}case b.TYPE_SELECTOR:default:{const d=this._matchTypeSelector(a,e);d&&c.add(d)}}return c}_matchLeaves(a,e,o){let h;for(const c of a)if(h=this._matchSelector(c,e,o).has(e),!h)break;return!!h}_findDescendantNodes(a,e){const[o,...h]=a,{type:c}=o,d=(0,g.unescapeSelector)(o.name),p=h.length>0,u=new Set;let t=!1;switch(c){case b.ID_SELECTOR:{const{root:l}=this.#t;if(l.nodeType===b.ELEMENT_NODE)t=!0;else{const n=l.getElementById(d);if(n&&n!==e){const f=(0,k.isSameOrDescendant)(n,e);let r;f&&(r=n),r&&(p?this._matchLeaves(h,r)&&u.add(r):u.add(r))}}break}case b.PSEUDO_ELEMENT_SELECTOR:{this._matchPseudoElementSelector(d);break}default:t=!0}return{nodes:u,pending:t}}_matchCombinator(a,e,o={}){const{combo:h,leaves:c}=a,{name:d}=h,{find:p,forgive:u}=o;let t=new Set;if(p==="next")switch(d){case"+":{const l=e.nextElementSibling;l&&this._matchLeaves(c,l,{forgive:u})&&t.add(l);break}case"~":{let l=e.nextElementSibling;for(;l;)this._matchLeaves(c,l,{forgive:u})&&t.add(l),l=l.nextElementSibling;break}case">":{const l=[...e.children];for(const n of l)this._matchLeaves(c,n,{forgive:u})&&t.add(n);break}case" ":default:{const{nodes:l,pending:n}=this._findDescendantNodes(c,e);if(l.size)t=l;else if(n){const{document:f}=this.#t,r=f.createNodeIterator(e,b.SHOW_ELEMENT);let s=r.nextNode();for(s===e&&(s=r.nextNode());s;)this._matchLeaves(c,s,{forgive:u})&&t.add(s),s=r.nextNode()}}}else switch(d){case"+":{const l=e.previousElementSibling;l&&this._matchLeaves(c,l,{forgive:u})&&t.add(l);break}case"~":{const l=[];let n=e.previousElementSibling;for(;n;)this._matchLeaves(c,n,{forgive:u})&&l.push(n),n=n.previousElementSibling;l.length&&(t=new Set(l.reverse()));break}case">":{const l=e.parentNode;l&&this._matchLeaves(c,l,{forgive:u})&&t.add(l);break}case" ":default:{const l=[];let n=e.parentNode;for(;n;)this._matchLeaves(c,n,{forgive:u})&&l.push(n),n=n.parentNode;l.length&&(t=new Set(l.reverse()))}}return t}_findNodes(a,e){const{leaves:[o,...h]}=a,{type:c}=o,d=(0,g.unescapeSelector)(o.name),p=h.length>0,{document:u,root:t}=this.#t;let l=new Set,n=!1;switch(c){case b.ID_SELECTOR:{let f;if(e===S)this._matchLeaves([o],this.#e)&&(f=this.#e);else if(e===v){let r=this.#e;for(;r;){if(this._matchLeaves([o],r)){f=r;break}r=r.parentNode}}else t.nodeType===b.ELEMENT_NODE?n=!0:f=t.getElementById(d);f&&(p?this._matchLeaves(h,f)&&l.add(f):l.add(f));break}case b.CLASS_SELECTOR:{const f=[];if(e===S)this.#e.nodeType===b.ELEMENT_NODE&&this.#e.classList.contains(d)&&f.push(this.#e);else if(e===v){let r=this.#e;for(;r&&r.nodeType===b.ELEMENT_NODE;)r.classList.contains(d)&&f.push(r),r=r.parentNode}else if(t.nodeType===b.DOCUMENT_FRAGMENT_NODE){const r=[...t.children];for(const s of r){s.classList.contains(d)&&f.push(s);const i=[...s.getElementsByClassName(d)];f.push(...i)}}else{const r=[...t.getElementsByClassName(d)];f.push(...r)}if(f.length)if(p)for(const r of f)this._matchLeaves(h,r)&&l.add(r);else l=new Set(f);break}case b.TYPE_SELECTOR:{const f=[];if(e===S)this.#e.nodeType===b.ELEMENT_NODE&&this._matchLeaves([o],this.#e)&&f.push(this.#e);else if(e===v){let r=this.#e;for(;r&&r.nodeType===b.ELEMENT_NODE;)this._matchLeaves([o],r)&&f.push(r),r=r.parentNode}else if(u.contentType!=="text/html"||/[*|]/.test(d))n=!0;else if(t.nodeType===b.DOCUMENT_FRAGMENT_NODE){const r=d.toLowerCase(),s=[...t.children];for(const i of s){i.localName===r&&f.push(i);const m=[...i.getElementsByTagName(d)];f.push(...m)}}else{const r=[...t.getElementsByTagName(d)];f.push(...r)}if(f.length)if(p)for(const r of f)this._matchLeaves(h,r)&&l.add(r);else l=new Set(f);break}case b.PSEUDO_ELEMENT_SELECTOR:{this._matchPseudoElementSelector(d);break}default:{const f=[];if(e===S)this._matchLeaves([o],this.#e)&&f.push(this.#e);else if(e===v){let r=this.#e;for(;r;)this._matchLeaves([o],r)&&f.push(r),r=r.parentNode}else n=!0;if(f.length)if(p)for(const r of f)this._matchLeaves(h,r)&&l.add(r);else l=new Set(f)}}return{nodes:l,pending:n}}_getFirstTwig(a){const e=a.length-1,o=a[0];let h,c;if(e){const d=a[e],{leaves:[{type:p}]}=d;p===b.PSEUDO_ELEMENT_SELECTOR||p===b.ID_SELECTOR?(h="prev",c=d):(h="next",c=o)}else h="prev",c=o;return{find:h,twig:c}}_collectNodes(a){const e=this.#s.values();if(a===$||a===T){const o=new Set;let h=0;for(const{branch:c}of e){const{find:d,twig:p}=this._getFirstTwig(c),{nodes:u,pending:t}=this._findNodes(p,a);u.size?this.#r[h]=u:t?o.add(new Map([["index",h],["twig",p]])):this.#s[h].skip=!0,this.#s[h].find=d,h++}if(o.size){const{document:c,root:d}=this.#t,p=c.createNodeIterator(d,b.SHOW_ELEMENT);let u=p.nextNode();for(;u;){let t=!1;if(this.#e.nodeType===b.ELEMENT_NODE?t=(0,k.isSameOrDescendant)(u,this.#e):t=!0,t)for(const l of o){const{leaves:n}=l.get("twig");if(this._matchLeaves(n,u)){const r=l.get("index");this.#r[r].add(u)}}u=p.nextNode()}}}else{let o=0;for(const{branch:h}of e){const c=h[h.length-1],{nodes:d}=this._findNodes(c,a);d.size?this.#r[o]=d:this.#s[o].skip=!0,this.#s[o].find="prev",o++}}return[this.#s,this.#r]}_matchNodes(a){const[...e]=this.#s,o=e.length;let h=new Set;for(let c=0;c<o;c++){const{branch:d,find:p,skip:u}=e[c],t=d.length;if(!u&&t){const l=this.#r[c],n=t-1;if(n===0)if((a===$||a===T)&&this.#e.nodeType===b.ELEMENT_NODE){for(const f of l)if(f!==this.#e&&(0,k.isSameOrDescendant)(f,this.#e)&&(h.add(f),a===T))break}else if(a===T){const[f]=[...l];h.add(f)}else{const f=[...h],r=[...l];h=new Set([...f,...r])}else if(p==="next"){let{combo:f}=d[0];for(const r of l){let s=new Set([r]);for(let i=1;i<t;i++){const{combo:m,leaves:N}=d[i],w=[];for(const _ of s){const A={combo:f,leaves:N},P=this._matchCombinator(A,_,{find:p});P.size&&w.push(...P)}const E=new Set(w);if(E.size)if(i===n){if(a===T){const[_]=[...E];h.add(_)}else{const _=[...h],A=[...E];h=new Set([..._,...A])}break}else f=m,s=E;else break}}}else for(const f of l){let r=new Set([f]),s;for(let i=n-1;i>=0;i--){const m=d[i],N=[];for(const E of r){const _=this._matchCombinator(m,E,{find:p});_.size&&N.push(..._)}const w=new Set(N);if(w.size)if(s=!0,i===0){h.add(f);break}else r=w;else{s=!1;break}}if(s&&a!==$)break}}}return h}_find(a){return this._collectNodes(a),this._matchNodes(a)}_sortNodes(a){const e=[...a];return e.length>1&&e.sort((o,h)=>{let c;const d=o.compareDocumentPosition(h);return d&b.DOCUMENT_POSITION_PRECEDING||d&b.DOCUMENT_POSITION_CONTAINS?c=1:c=-1,c}),e}matches(){if(this.#e.nodeType!==b.ELEMENT_NODE)throw new TypeError(`Unexpected node ${this.#e.nodeName}`);let a;try{a=this._find(S).has(this.#e)}catch(e){this._onError(e)}return!!a}closest(){if(this.#e.nodeType!==b.ELEMENT_NODE)throw new TypeError(`Unexpected node ${this.#e.nodeName}`);let a;try{const e=this._find(v);let o=this.#e;for(;o;){if(e.has(o)){a=o;break}o=o.parentNode}}catch(e){this._onError(e)}return a??null}querySelector(){let a;try{const e=this._find(T);e.delete(this.#e),e.size>1?[a]=this._sortNodes(e):e.size&&([a]=[...e])}catch(e){this._onError(e)}return a??null}querySelectorAll(){const a=[];try{const e=this._find($);e.delete(this.#e),e.size>1&&this.#c?a.push(...this._sortNodes(e)):e.size&&a.push(...e)}catch(e){this._onError(e)}return a}}0&&(module.exports={Matcher});
//# sourceMappingURL=matcher.js.map
