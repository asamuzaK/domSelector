var F=Object.create;var P=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var H=Object.getPrototypeOf,G=Object.prototype.hasOwnProperty;var W=(S,s)=>{for(var e in s)P(S,e,{get:s[e],enumerable:!0})},z=(S,s,e,c)=>{if(s&&typeof s=="object"||typeof s=="function")for(let h of j(s))!G.call(S,h)&&h!==e&&P(S,h,{get:()=>s[h],enumerable:!(c=V(s,h))||c.enumerable});return S};var q=(S,s,e)=>(e=S!=null?F(H(S)):{},z(s||!S||!S.__esModule?P(e,"default",{value:S,enumerable:!0}):e,S)),X=S=>z(P({},"__esModule",{value:!0}),S);var J={};W(J,{Matcher:()=>Y});module.exports=X(J);var B=q(require("is-potential-custom-element-name"),1),E=require("./dom-util.js"),y=require("./parser.js"),l=require("./constant.js");const R="next",M="prev",U="all",C="first",D="lineal",I="self";class Y{#i;#l;#a;#e;#r;#t;#o;#c;#s;constructor(s,e,c={}){const{sort:h,warn:a}=c;this.#l=new Map([[l.SELECTOR_PSEUDO_ELEMENT,l.BIT_01],[l.SELECTOR_ID,l.BIT_02],[l.SELECTOR_CLASS,l.BIT_04],[l.SELECTOR_TYPE,l.BIT_08],[l.SELECTOR_ATTR,l.BIT_16],[l.SELECTOR_PSEUDO_CLASS,l.BIT_32]]),this.#a=new WeakMap,this.#o=s,this.#e=e,this.#c=!!h,this.#s=!!a,[this.#i,this.#r]=this._prepare(s),this.#t=this._getRoot(e)}_onError(s){if(s instanceof DOMException&&s.name===l.NOT_SUPPORTED_ERR)this.#s&&console.warn(s.message);else throw s}_getRoot(s=this.#e){let e,c;switch(s.nodeType){case l.DOCUMENT_NODE:{e=s,c=s;break}case l.DOCUMENT_FRAGMENT_NODE:{e=s.ownerDocument,c=s;break}case l.ELEMENT_NODE:{if((0,E.isSameOrDescendant)(s))e=s.ownerDocument,c=s.ownerDocument;else{let a=s;for(;a&&a.parentNode;)a=a.parentNode;e=a.ownerDocument,c=a}break}default:throw new TypeError(`Unexpected node ${s.nodeName}`)}const h=(0,E.isInShadowTree)(s);return{document:e,root:c,shadow:h}}_sortLeaves(s){const e=[...s];return e.length>1&&e.sort((c,h)=>{const{type:a}=c,{type:b}=h,p=this.#l.get(a),r=this.#l.get(b);let t;return p===r?t=0:p>r?t=1:t=-1,t}),e}_prepare(s=this.#o){const e=(0,y.parseSelector)(s),c=(0,y.walkAST)(e),h=[],a=[];let b=0;for(const[...p]of c){const r=[];let t=p.shift();if(t&&t.type!==l.COMBINATOR){const i=new Set;for(;t;){if(t.type===l.COMBINATOR){const[o]=p;if(o.type===l.COMBINATOR){const d=`Invalid combinator ${t.name}${o.name}`;throw new DOMException(d,l.SYNTAX_ERR)}r.push({combo:t,leaves:this._sortLeaves(i)}),i.clear()}else t&&i.add(t);if(p.length)t=p.shift();else{r.push({combo:null,leaves:this._sortLeaves(i)}),i.clear();break}}}h.push({branch:r,find:null,skip:!1}),a[b]=new Set,b++}return[h,a]}_collectNthChild(s,e){const{a:c,b:h,reverse:a,selector:b}=s,{parentNode:p}=e,r=new Set;let t;if(b&&(this.#a.has(b)?t=this.#a.get(b):(t=(0,y.walkAST)(b),this.#a.set(b,t))),p){const i=[...p.children],o=i.length;if(o){const d=new Set;if(t){const n=t.length;for(const f of i){let u;for(let m=0;m<n;m++){const w=t[m];if(u=this._matchLeaves(w,f),!u)break}u&&d.add(f)}}if(a&&i.reverse(),c===0){if(h>0&&h<=o){if(d.size)for(let n=0;n<o;n++){const f=i[n];if(d.has(f)){r.add(f);break}}else if(!b){const n=i[h-1];r.add(n)}}}else{let n=h-1;if(c>0)for(;n<0;)n+=c;if(n>=0&&n<o){let f=c>0?0:h-1;for(let u=0;u<o&&n>=0&&n<o;u++){const m=i[u];d.size?d.has(m)&&(f===n&&(r.add(m),n+=c),c>0?f++:f--):u===n&&(b||r.add(m),n+=c)}}}}}else{const{root:i}=this.#t;if(e===i&&i.nodeType===l.ELEMENT_NODE&&c+h===1)if(t){const o=t.length;let d;for(let n=0;n<o;n++){const f=t[n];if(d=this._matchLeaves(f,e),d)break}d&&r.add(e)}else r.add(e)}return r}_collectNthOfType(s,e){const{a:c,b:h,reverse:a}=s,{localName:b,parentNode:p,prefix:r}=e,t=new Set;if(p){const i=[...p.children],o=i.length;if(o)if(a&&i.reverse(),c===0){if(h>0&&h<=o){let d=0;for(let n=0;n<o;n++){const f=i[n],{localName:u,prefix:m}=f;if(u===b&&m===r){if(d===h-1){t.add(f);break}d++}}}}else{let d=h-1;if(c>0)for(;d<0;)d+=c;if(d>=0&&d<o){let n=c>0?0:h-1;for(let f=0;f<o;f++){const u=i[f],{localName:m,prefix:w}=u;if(m===b&&w===r){if(n===d&&(t.add(u),d+=c),d<0||d>=o)break;c>0?n++:n--}}}}}else{const{root:i}=this.#t;e===i&&i.nodeType===l.ELEMENT_NODE&&c+h===1&&t.add(e)}return t}_matchAnPlusB(s,e,c){const{nth:{a:h,b:a,name:b},selector:p}=s,r=(0,y.unescapeSelector)(b),t=new Map;r?(r==="even"?(t.set("a",2),t.set("b",0)):r==="odd"&&(t.set("a",2),t.set("b",1)),c.indexOf("last")>-1&&t.set("reverse",!0)):(typeof h=="string"&&/-?\d+/.test(h)?t.set("a",h*1):t.set("a",0),typeof a=="string"&&/-?\d+/.test(a)?t.set("b",a*1):t.set("b",0),c.indexOf("last")>-1&&t.set("reverse",!0));let i=new Set;if(t.has("a")&&t.has("b")){if(/^nth-(?:last-)?child$/.test(c)){p&&t.set("selector",p);const o=Object.fromEntries(t),d=this._collectNthChild(o,e);d.size&&(i=d)}else if(/^nth-(?:last-)?of-type$/.test(c)){const o=Object.fromEntries(t),d=this._collectNthOfType(o,e);d.size&&(i=d)}}return i}_matchPseudoElementSelector(s,e={}){const{forgive:c}=e;switch(s){case"after":case"backdrop":case"before":case"cue":case"cue-region":case"first-letter":case"first-line":case"file-selector-button":case"marker":case"placeholder":case"selection":case"target-text":{if(this.#s)throw new DOMException(`Unsupported pseudo-element ::${s}`,l.NOT_SUPPORTED_ERR);break}case"part":case"slotted":{if(this.#s)throw new DOMException(`Unsupported pseudo-element ::${s}()`,l.NOT_SUPPORTED_ERR);break}default:if(s.startsWith("-webkit-")){if(this.#s)throw new DOMException(`Unsupported pseudo-element ::${s}`,l.NOT_SUPPORTED_ERR)}else if(!c)throw new DOMException(`Unknown pseudo-element ::${s}`,l.SYNTAX_ERR)}}_matchDirectionPseudoClass(s,e){const c=(0,y.unescapeSelector)(s.name),h=(0,E.getDirectionality)(e);let a;return c===h&&(a=e),a??null}_matchLanguagePseudoClass(s,e){const c=(0,y.unescapeSelector)(s.name);let h;if(c)if(c==="*")if(e.hasAttribute("lang"))e.getAttribute("lang")&&(h=e);else{let a=e.parentNode;for(;a;){if(a.hasAttribute("lang")){a.getAttribute("lang")&&(h=e);break}a=a.parentNode}}else{const a=`(?:-${l.ALPHA_NUM})*`;if(new RegExp(`^(?:\\*-)?${l.ALPHA_NUM}${a}$`,"i").test(c)){let p;if(c.indexOf("-")>-1){const[r,t,...i]=c.split("-");let o;r==="*"?o=`${l.ALPHA_NUM}${a}`:o=`${r}${a}`;const d=`-${t}${a}`,n=i.length;let f="";if(n)for(let u=0;u<n;u++)f+=`-${i[u]}${a}`;p=new RegExp(`^${o}${d}${f}$`,"i")}else p=new RegExp(`^${c}${a}$`,"i");if(e.hasAttribute("lang"))p.test(e.getAttribute("lang"))&&(h=e);else{let r=e.parentNode;for(;r;){if(r.hasAttribute("lang")){const t=r.getAttribute("lang");p.test(t)&&(h=e);break}r=r.parentNode}}}}return h??null}_matchHasPseudoFunc(s,e){let c;if(Array.isArray(s)&&s.length){const[h]=s,{type:a}=h;let b;a===l.COMBINATOR?b=s.shift():b={name:" ",type:l.COMBINATOR};const p=[];for(;s.length;){const[i]=s,{type:o}=i;if(o===l.COMBINATOR)break;p.push(s.shift())}const r={combo:b,leaves:p},t=this._matchCombinator(r,e,{find:R});if(t.size)if(s.length){for(const i of t)if(c=this._matchHasPseudoFunc(Object.assign([],s),i),c)break}else c=!0}return!!c}_matchLogicalPseudoFunc(s,e){const{astName:c="",branches:h=[],selector:a="",twigBranches:b=[]}=s;let p;if(c==="has")if(a.includes(":has("))p=null;else{const r=h.length;let t;for(let i=0;i<r;i++){const o=h[i];if(t=this._matchHasPseudoFunc(Object.assign([],o),e),t)break}t&&(p=e)}else{const r=/^(?:is|where)$/.test(c),t=b.length;let i;for(let o=0;o<t;o++){const d=b[o],n=d.length-1,{leaves:f}=d[n];if(i=this._matchLeaves(f,e,{forgive:r}),i&&n>0){let u=new Set([e]);for(let m=n-1;m>=0;m--){const w=d[m],k=[];for(const A of u){const L=this._matchCombinator(w,A,{forgive:r,find:M});L.size&&k.push(...L)}if(k.length)if(m===0){i=!0;break}else u=new Set(k);else{i=!1;break}}}if(i)break}c==="not"?i||(p=e):i&&(p=e)}return p??null}_matchPseudoClassSelector(s,e,c={}){const{children:h}=s,{localName:a,parentNode:b}=e,{forgive:p}=c,r=(0,y.unescapeSelector)(s.name);let t=new Set;if(l.REG_LOGICAL_PSEUDO.test(r)){let i;if(this.#a.has(s))i=this.#a.get(s);else{const d=(0,y.walkAST)(s),n=[],f=[];for(const[...u]of d){for(const A of u){const L=(0,y.generateCSS)(A);n.push(L)}const m=[],w=new Set;let k=u.shift();for(;k;)if(k.type===l.COMBINATOR?(m.push({combo:k,leaves:[...w]}),w.clear()):k&&w.add(k),u.length)k=u.shift();else{m.push({combo:null,leaves:[...w]}),w.clear();break}f.push(m)}i={astName:r,branches:d,twigBranches:f,selector:n.join(",")},this.#a.set(s,i)}const o=this._matchLogicalPseudoFunc(i,e);o&&t.add(o)}else if(Array.isArray(h)){const[i]=h;if(/^nth-(?:last-)?(?:child|of-type)$/.test(r)){const o=this._matchAnPlusB(i,e,r);o.size&&(t=o)}else if(r==="dir"){const o=this._matchDirectionPseudoClass(i,e);o&&t.add(o)}else if(r==="lang"){const o=this._matchLanguagePseudoClass(i,e);o&&t.add(o)}else switch(r){case"current":case"nth-col":case"nth-last-col":{if(this.#s)throw new DOMException(`Unsupported pseudo-class :${r}()`,l.NOT_SUPPORTED_ERR);break}default:if(!p)throw new DOMException(`Unknown pseudo-class :${r}()`,l.SYNTAX_ERR)}}else{const{document:i,root:o}=this.#t,{documentElement:d}=i,n=new URL(i.URL),f=/^a(?:rea)?$/,u=/^(?:(?:fieldse|inpu|selec)t|button|opt(?:group|ion)|textarea)$/,m=/^(?:(?:(?:in|out)pu|selec)t|button|form|textarea)$/,w=/^d(?:etails|ialog)$/,k=/^(?:checkbox|radio)$/,A=/^(?:date(?:time-local)?|month|time|week)$/,L=/(?:(?:rang|tim)e|date(?:time-local)?|month|number|week)$/,O=/^(?:(?:emai|te|ur)l|number|password|search|text)$/;switch(r){case"any-link":case"link":{f.test(a)&&e.hasAttribute("href")&&t.add(e);break}case"local-link":{if(f.test(a)&&e.hasAttribute("href")){const N=new URL(e.getAttribute("href"),n.href);N.origin===n.origin&&N.pathname===n.pathname&&t.add(e)}break}case"visited":break;case"target":{e.id&&n.hash&&n.hash===`#${e.id}`&&(0,E.isSameOrDescendant)(e)&&t.add(e);break}case"target-within":{if(n.hash){const N=n.hash.replace(/^#/,"");let g=i.getElementById(N);for(;g;){if(g===e){t.add(e);break}g=g.parentNode}}break}case"scope":{this.#e.nodeType===l.ELEMENT_NODE?e===this.#e&&t.add(e):e===d&&t.add(e);break}case"focus":{e===i.activeElement&&t.add(e);break}case"focus-within":{let N=i.activeElement;for(;N;){if(N===e){t.add(e);break}N=N.parentNode}break}case"open":{w.test(a)&&e.hasAttribute("open")&&t.add(e);break}case"closed":{w.test(a)&&!e.hasAttribute("open")&&t.add(e);break}case"disabled":{if(u.test(a)||(0,B.default)(a))if(e.disabled||e.hasAttribute("disabled"))t.add(e);else{let N=b;for(;N&&N.localName!=="fieldset";)N=N.parentNode;N&&b.localName!=="legend"&&N.hasAttribute("disabled")&&t.add(e)}break}case"enabled":{(u.test(a)||(0,B.default)(a))&&!(e.disabled&&e.hasAttribute("disabled"))&&t.add(e);break}case"read-only":{switch(a){case"textarea":{(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}case"input":{(!e.type||A.test(e.type)||O.test(e.type))&&(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}default:(0,E.isContentEditable)(e)||t.add(e)}break}case"read-write":{switch(a){case"textarea":{e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled")||t.add(e);break}case"input":{(!e.type||A.test(e.type)||O.test(e.type))&&!(e.readonly||e.hasAttribute("readonly")||e.disabled||e.hasAttribute("disabled"))&&t.add(e);break}default:(0,E.isContentEditable)(e)&&t.add(e)}break}case"placeholder-shown":{let N;a==="textarea"?N=e:a==="input"&&(e.hasAttribute("type")?O.test(e.getAttribute("type"))&&(N=e):N=e),N&&e.value===""&&e.hasAttribute("placeholder")&&e.getAttribute("placeholder").trim().length&&t.add(e);break}case"checked":{(e.checked&&a==="input"&&e.hasAttribute("type")&&k.test(e.getAttribute("type"))||e.selected&&a==="option")&&t.add(e);break}case"indeterminate":{if(e.indeterminate&&a==="input"&&e.type==="checkbox"||a==="progress"&&!e.hasAttribute("value"))t.add(e);else if(a==="input"&&e.type==="radio"&&!e.hasAttribute("checked")){const N=e.name;let g=e.parentNode;for(;g&&g.localName!=="form";)g=g.parentNode;g||(g=d);const _=[...g.getElementsByTagName("input")];let T;for(const x of _)if(x.getAttribute("type")==="radio"&&(N?x.getAttribute("name")===N&&(T=!!x.checked):x.hasAttribute("name")||(T=!!x.checked),T))break;T||t.add(e)}break}case"default":{const N=/^(?:button|reset)$/,g=/^(?:image|submit)$/;if(a==="button"&&!(e.hasAttribute("type")&&N.test(e.getAttribute("type")))||a==="input"&&e.hasAttribute("type")&&g.test(e.getAttribute("type"))){let _=e.parentNode;for(;_&&_.localName!=="form";)_=_.parentNode;if(_){const T=i.createNodeIterator(_,l.SHOW_ELEMENT);let x=T.nextNode();for(;x;){const $=x.localName;let v;if($==="button"?v=!(x.hasAttribute("type")&&N.test(x.getAttribute("type"))):$==="input"&&(v=x.hasAttribute("type")&&g.test(x.getAttribute("type"))),v){x===e&&t.add(e);break}x=T.nextNode()}}}else if(a==="input"&&e.hasAttribute("type")&&k.test(e.getAttribute("type"))&&(e.checked||e.hasAttribute("checked")))t.add(e);else if(a==="option"){let _=!1,T=b;for(;T&&T.localName!=="datalist";){if(T.localName==="select"){(T.multiple||T.hasAttribute("multiple"))&&(_=!0);break}T=T.parentNode}if(_)(e.selected||e.hasAttribute("selected"))&&t.add(e);else{const x=b.firstElementChild,$=new Set;let v=x;for(;v;){if(v.selected||v.hasAttribute("selected")){$.add(v);break}v=v.nextElementSibling}$.size||$.add(x),$.has(e)&&t.add(e)}}break}case"valid":{if(m.test(a))e.checkValidity()&&t.add(e);else if(a==="fieldset"){const N=i.createNodeIterator(e,l.SHOW_ELEMENT);let g=N.nextNode();g===e&&(g=N.nextNode());let _;for(;g&&!(m.test(g.localName)&&(_=g.checkValidity(),!_));)g=N.nextNode();_&&t.add(e)}break}case"invalid":{if(m.test(a))e.checkValidity()||t.add(e);else if(a==="fieldset"){const N=i.createNodeIterator(e,l.SHOW_ELEMENT);let g=N.nextNode();g===e&&(g=N.nextNode());let _;for(;g&&!(m.test(g.localName)&&(_=g.checkValidity(),!_));)g=N.nextNode();_||t.add(e)}break}case"in-range":{a==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&L.test(e.getAttribute("type"))&&!(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&(e.hasAttribute("min")||e.hasAttribute("max")||e.getAttribute("type")==="range")&&t.add(e);break}case"out-of-range":{a==="input"&&!(e.readonly||e.hasAttribute("readonly"))&&!(e.disabled||e.hasAttribute("disabled"))&&e.hasAttribute("type")&&L.test(e.getAttribute("type"))&&(e.validity.rangeUnderflow||e.validity.rangeOverflow)&&t.add(e);break}case"required":{let N;if(/^(?:select|textarea)$/.test(a))N=e;else if(a==="input")if(e.hasAttribute("type")){const g=e.getAttribute("type");(g==="file"||k.test(g)||A.test(g)||O.test(g))&&(N=e)}else N=e;N&&(e.required||e.hasAttribute("required"))&&t.add(e);break}case"optional":{let N;if(/^(?:select|textarea)$/.test(a))N=e;else if(a==="input")if(e.hasAttribute("type")){const g=e.getAttribute("type");(g==="file"||k.test(g)||A.test(g)||O.test(g))&&(N=e)}else N=e;N&&!(e.required||e.hasAttribute("required"))&&t.add(e);break}case"root":{e===d&&t.add(e);break}case"empty":{if(e.hasChildNodes()){const N=e.childNodes.values();let g;for(const _ of N)if(g=_.nodeType!==l.ELEMENT_NODE&&_.nodeType!==l.TEXT_NODE,!g)break;g&&t.add(e)}else t.add(e);break}case"first-child":{(b&&e===b.firstElementChild||e===o&&o.nodeType===l.ELEMENT_NODE)&&t.add(e);break}case"last-child":{(b&&e===b.lastElementChild||e===o&&o.nodeType===l.ELEMENT_NODE)&&t.add(e);break}case"only-child":{(b&&e===b.firstElementChild&&e===b.lastElementChild||e===o&&o.nodeType===l.ELEMENT_NODE)&&t.add(e);break}case"first-of-type":{if(b){const[N]=this._collectNthOfType({a:0,b:1},e);N&&t.add(N)}else e===o&&o.nodeType===l.ELEMENT_NODE&&t.add(e);break}case"last-of-type":{if(b){const[N]=this._collectNthOfType({a:0,b:1,reverse:!0},e);N&&t.add(N)}else e===o&&o.nodeType===l.ELEMENT_NODE&&t.add(e);break}case"only-of-type":{if(b){const[N]=this._collectNthOfType({a:0,b:1},e);if(N===e){const[g]=this._collectNthOfType({a:0,b:1,reverse:!0},e);g===e&&t.add(e)}}else e===o&&o.nodeType===l.ELEMENT_NODE&&t.add(e);break}case"host":case"host-context":break;case"after":case"before":case"first-letter":case"first-line":{if(this.#s)throw new DOMException(`Unsupported pseudo-element ::${r}`,l.NOT_SUPPORTED_ERR);break}case"active":case"autofill":case"blank":case"buffering":case"current":case"focus-visible":case"fullscreen":case"future":case"hover":case"modal":case"muted":case"past":case"paused":case"picture-in-picture":case"playing":case"seeking":case"stalled":case"user-invalid":case"user-valid":case"volume-locked":case"-webkit-autofill":{if(this.#s)throw new DOMException(`Unsupported pseudo-class :${r}`,l.NOT_SUPPORTED_ERR);break}default:if(r.startsWith("-webkit-")){if(this.#s)throw new DOMException(`Unsupported pseudo-class :${r}`,l.NOT_SUPPORTED_ERR)}else if(!p)throw new DOMException(`Unknown pseudo-class :${r}`,l.SYNTAX_ERR)}}return t}_matchAttributeSelector(s,e){const{flags:c,matcher:h,name:a,value:b}=s;if(typeof c=="string"&&!/^[is]$/i.test(c)){const t=(0,y.generateCSS)(s);throw new DOMException(`Invalid selector ${t}`,l.SYNTAX_ERR)}const{attributes:p}=e;let r;if(p&&p.length){const{document:t}=this.#t;let i;t.contentType==="text/html"?typeof c=="string"&&/^s$/i.test(c)?i=!1:i=!0:typeof c=="string"&&/^i$/i.test(c)?i=!0:i=!1;let o=(0,y.unescapeSelector)(a.name);i&&(o=o.toLowerCase());const d=new Set;if(o.indexOf("|")>-1){const{prefix:n,tagName:f}=(0,E.selectorToNodeProps)(o);for(let{name:u,value:m}of p)switch(i&&(u=u.toLowerCase(),m=m.toLowerCase()),n){case"":{f===u&&d.add(m);break}case"*":{u.indexOf(":")>-1?u.endsWith(`:${f}`)&&d.add(m):f===u&&d.add(m);break}default:if(u.indexOf(":")>-1){const[w,k]=u.split(":");n===w&&f===k&&(0,E.isNamespaceDeclared)(n,e)&&d.add(m)}}}else for(let{name:n,value:f}of p)if(i&&(n=n.toLowerCase(),f=f.toLowerCase()),n.indexOf(":")>-1){const[u,m]=n.split(":");if(u==="xml"&&m==="lang")continue;o===m&&d.add(f)}else o===n&&d.add(f);if(d.size){const{name:n,value:f}=b||{};let u;switch(n?i?u=n.toLowerCase():u=n:f?i?u=f.toLowerCase():u=f:f===""&&(u=f),h){case"=":{typeof u=="string"&&d.has(u)&&(r=e);break}case"~=":{if(u&&typeof u=="string"){for(const m of d)if(new Set(m.split(/\s+/)).has(u)){r=e;break}}break}case"|=":{if(u&&typeof u=="string"){let m;for(const w of d)if(w===u||w.startsWith(`${u}-`)){m=w;break}m&&(r=e)}break}case"^=":{if(u&&typeof u=="string"){let m;for(const w of d)if(w.startsWith(`${u}`)){m=w;break}m&&(r=e)}break}case"$=":{if(u&&typeof u=="string"){let m;for(const w of d)if(w.endsWith(`${u}`)){m=w;break}m&&(r=e)}break}case"*=":{if(u&&typeof u=="string"){let m;for(const w of d)if(w.includes(`${u}`)){m=w;break}m&&(r=e)}break}case null:default:r=e}}}return r??null}_matchClassSelector(s,e){const c=(0,y.unescapeSelector)(s.name);let h;return e.classList.contains(c)&&(h=e),h??null}_matchIDSelector(s,e){const c=(0,y.unescapeSelector)(s.name),{id:h}=e;let a;return c===h&&(a=e),a??null}_matchTypeSelector(s,e){const c=(0,y.unescapeSelector)(s.name),{localName:h,prefix:a}=e,{document:b}=this.#t;let{prefix:p,tagName:r}=(0,E.selectorToNodeProps)(c,e);b.contentType==="text/html"&&(p=p.toLowerCase(),r=r.toLowerCase());let t,i;h.indexOf(":")>-1?[t,i]=h.split(":"):(t=a||"",i=h);let o;return p===""&&t===""?e.namespaceURI===null&&(r==="*"||r===i)&&(o=e):p==="*"?(r==="*"||r===i)&&(o=e):p===t&&(0,E.isNamespaceDeclared)(p,e)&&(r==="*"||r===i)&&(o=e),o??null}_matchShadowHostPseudoClass(s,e){const{children:c}=s,h=(0,y.unescapeSelector)(s.name);let a;if(Array.isArray(c)){const[b]=(0,y.walkAST)(c[0]),[...p]=b,{host:r}=e;if(h==="host"){let t;for(const i of p){const{type:o}=i;if(o===l.COMBINATOR){const d=(0,y.generateCSS)(s);throw new DOMException(`Invalid selector ${d}`,l.SYNTAX_ERR)}if(t=this._matchSelector(i,r).has(r),!t)break}t&&(a=e)}else if(h==="host-context"){let t=r,i;for(;t;){for(const o of p){const{type:d}=o;if(d===l.COMBINATOR){const n=(0,y.generateCSS)(s);throw new DOMException(`Invalid selector ${n}`,l.SYNTAX_ERR)}if(i=this._matchSelector(o,t).has(t),!i)break}if(i)break;t=t.parentNode}i&&(a=e)}}else h==="host"&&(a=e);return a??null}_matchSelector(s,e,c){const{type:h}=s,a=(0,y.unescapeSelector)(s.name),{shadow:b}=this.#t;let p=new Set;if(e.nodeType===l.ELEMENT_NODE)switch(h){case l.SELECTOR_ATTR:{const r=this._matchAttributeSelector(s,e);r&&p.add(r);break}case l.SELECTOR_CLASS:{const r=this._matchClassSelector(s,e);r&&p.add(r);break}case l.SELECTOR_ID:{const r=this._matchIDSelector(s,e);r&&p.add(r);break}case l.SELECTOR_PSEUDO_CLASS:{const r=this._matchPseudoClassSelector(s,e,c);r.size&&(p=r);break}case l.SELECTOR_PSEUDO_ELEMENT:{this._matchPseudoElementSelector(a,c);break}case l.SELECTOR_TYPE:default:{const r=this._matchTypeSelector(s,e);r&&p.add(r)}}else if(b&&h===l.SELECTOR_PSEUDO_CLASS&&e.nodeType===l.DOCUMENT_FRAGMENT_NODE){if(a!=="has"&&l.REG_LOGICAL_PSEUDO.test(a)){const r=this._matchPseudoClassSelector(s,e,c);r.size&&(p=r)}else if(l.REG_SHADOW_HOST.test(a)){const r=this._matchShadowHostPseudoClass(s,e);r&&p.add(r)}}return p}_matchLeaves(s,e,c){let h;for(const a of s)if(h=this._matchSelector(a,e,c).has(e),!h)break;return!!h}_findDescendantNodes(s,e){const[c,...h]=s,{type:a}=c,b=(0,y.unescapeSelector)(c.name),p=h.length>0,r=new Set;let t=!1;switch(a){case l.SELECTOR_ID:{const{root:i}=this.#t;if(i.nodeType===l.ELEMENT_NODE)t=!0;else{const o=i.getElementById(b);if(o&&o!==e){const d=(0,E.isSameOrDescendant)(o,e);let n;d&&(n=o),n&&(p?this._matchLeaves(h,n)&&r.add(n):r.add(n))}}break}case l.SELECTOR_PSEUDO_ELEMENT:{this._matchPseudoElementSelector(b);break}default:t=!0}return{nodes:r,pending:t}}_matchCombinator(s,e,c={}){const{combo:h,leaves:a}=s,{name:b}=h,{find:p,forgive:r}=c;let t=new Set;if(p===R)switch(b){case"+":{const i=e.nextElementSibling;i&&this._matchLeaves(a,i,{forgive:r})&&t.add(i);break}case"~":{let i=e.nextElementSibling;for(;i;)this._matchLeaves(a,i,{forgive:r})&&t.add(i),i=i.nextElementSibling;break}case">":{const i=[...e.children];for(const o of i)this._matchLeaves(a,o,{forgive:r})&&t.add(o);break}case" ":default:{const{nodes:i,pending:o}=this._findDescendantNodes(a,e);if(i.size)t=i;else if(o){const{document:d}=this.#t,n=d.createNodeIterator(e,l.SHOW_ELEMENT);let f=n.nextNode();for(f===e&&(f=n.nextNode());f;)this._matchLeaves(a,f,{forgive:r})&&t.add(f),f=n.nextNode()}}}else switch(b){case"+":{const i=e.previousElementSibling;i&&this._matchLeaves(a,i,{forgive:r})&&t.add(i);break}case"~":{const i=[];let o=e.previousElementSibling;for(;o;)this._matchLeaves(a,o,{forgive:r})&&i.push(o),o=o.previousElementSibling;i.length&&(t=new Set(i.reverse()));break}case">":{const i=e.parentNode;i&&this._matchLeaves(a,i,{forgive:r})&&t.add(i);break}case" ":default:{const i=[];let o=e.parentNode;for(;o;)this._matchLeaves(a,o,{forgive:r})&&i.push(o),o=o.parentNode;i.length&&(t=new Set(i.reverse()))}}return t}_findNodes(s,e){const{leaves:[c,...h]}=s,{type:a}=c,b=(0,y.unescapeSelector)(c.name),p=h.length>0,{document:r,root:t,shadow:i}=this.#t;let o=new Set,d=!1;switch(a){case l.SELECTOR_ID:{let n;if(e===I)this._matchLeaves([c],this.#e)&&(n=this.#e);else if(e===D){let f=this.#e;for(;f;){if(this._matchLeaves([c],f)){n=f;break}f=f.parentNode}}else t.nodeType===l.ELEMENT_NODE?d=!0:n=t.getElementById(b);n&&(p?this._matchLeaves(h,n)&&o.add(n):o.add(n));break}case l.SELECTOR_CLASS:{const n=[];if(e===I)this.#e.nodeType===l.ELEMENT_NODE&&this.#e.classList.contains(b)&&n.push(this.#e);else if(e===D){let f=this.#e;for(;f&&f.nodeType===l.ELEMENT_NODE;)f.classList.contains(b)&&n.push(f),f=f.parentNode}else if(t.nodeType===l.DOCUMENT_FRAGMENT_NODE){const f=[...t.children];for(const u of f){u.classList.contains(b)&&n.push(u);const m=[...u.getElementsByClassName(b)];n.push(...m)}}else{const f=[...t.getElementsByClassName(b)];n.push(...f)}if(n.length)if(p)for(const f of n)this._matchLeaves(h,f)&&o.add(f);else o=new Set(n);break}case l.SELECTOR_TYPE:{const n=[];if(e===I)this.#e.nodeType===l.ELEMENT_NODE&&this._matchLeaves([c],this.#e)&&n.push(this.#e);else if(e===D){let f=this.#e;for(;f&&f.nodeType===l.ELEMENT_NODE;)this._matchLeaves([c],f)&&n.push(f),f=f.parentNode}else if(r.contentType!=="text/html"||/[*|]/.test(b))d=!0;else if(t.nodeType===l.DOCUMENT_FRAGMENT_NODE){const f=b.toLowerCase(),u=[...t.children];for(const m of u){m.localName===f&&n.push(m);const w=[...m.getElementsByTagName(b)];n.push(...w)}}else{const f=[...t.getElementsByTagName(b)];n.push(...f)}if(n.length)if(p)for(const f of n)this._matchLeaves(h,f)&&o.add(f);else o=new Set(n);break}case l.SELECTOR_PSEUDO_ELEMENT:{this._matchPseudoElementSelector(b);break}default:{const n=[];if(e!==D&&l.REG_SHADOW_HOST.test(b)){if(i&&this.#e.nodeType===l.DOCUMENT_FRAGMENT_NODE){const f=this._matchShadowHostPseudoClass(c,this.#e);f&&n.push(f)}}else if(e===I)this._matchLeaves([c],this.#e)&&n.push(this.#e);else if(e===D){let f=this.#e;for(;f;)this._matchLeaves([c],f)&&n.push(f),f=f.parentNode}else d=!0;if(n.length)if(p)for(const f of n)this._matchLeaves(h,f)&&o.add(f);else o=new Set(n)}}return{nodes:o,pending:d}}_getFirstTwig(s){const e=s.length-1,c=s[0];let h,a;if(e){const b=s[e],{leaves:[{type:p}]}=b;p===l.SELECTOR_PSEUDO_ELEMENT||p===l.SELECTOR_ID?(h=M,a=b):(h=R,a=c)}else h=M,a=c;return{find:h,twig:a}}_collectNodes(s){const e=this.#i.values();if(s===U||s===C){const c=new Set;let h=0;for(const{branch:a}of e){const{find:b,twig:p}=this._getFirstTwig(a),{nodes:r,pending:t}=this._findNodes(p,s);r.size?this.#r[h]=r:t?c.add(new Map([["index",h],["twig",p]])):this.#i[h].skip=!0,this.#i[h].find=b,h++}if(c.size){const{document:a,root:b}=this.#t,p=a.createNodeIterator(b,l.SHOW_ELEMENT);let r=p.nextNode();for(;r;){let t=!1;if(this.#e.nodeType===l.ELEMENT_NODE?t=(0,E.isSameOrDescendant)(r,this.#e):t=!0,t)for(const i of c){const{leaves:o}=i.get("twig");if(this._matchLeaves(o,r)){const n=i.get("index");this.#r[n].add(r)}}r=p.nextNode()}}}else{let c=0;for(const{branch:h}of e){const a=h[h.length-1],{nodes:b}=this._findNodes(a,s);b.size?this.#r[c]=b:this.#i[c].skip=!0,this.#i[c].find=M,c++}}return[this.#i,this.#r]}_sortNodes(s){const e=[...s];return e.length>1&&e.sort((c,h)=>{const a=c.compareDocumentPosition(h);let b;return a&l.DOCUMENT_POSITION_PRECEDING||a&l.DOCUMENT_POSITION_CONTAINS?b=1:b=-1,b}),e}_matchNodes(s){const[...e]=this.#i,c=e.length;let h=new Set;for(let a=0;a<c;a++){const{branch:b,find:p,skip:r}=e[a],t=b.length;if(!r&&t){const i=this.#r[a],o=t-1;if(o===0)if((s===U||s===C)&&this.#e.nodeType===l.ELEMENT_NODE){for(const d of i)if(d!==this.#e&&(0,E.isSameOrDescendant)(d,this.#e)&&(h.add(d),s===C))break}else if(s===C){const[d]=this._sortNodes(i);h.add(d)}else{const d=[...h],n=[...i];h=new Set([...d,...n])}else if(p===R){let{combo:d}=b[0];for(const n of i){let f=new Set([n]);for(let u=1;u<t;u++){const{combo:m,leaves:w}=b[u],k=[];for(const A of f){const L={combo:d,leaves:w},O=this._matchCombinator(L,A,{find:p});O.size&&k.push(...O)}if(k.length)if(u===o){if(s===C){const[A]=this._sortNodes(k);h.add(A)}else{const A=[...h];h=new Set([...A,...k])}break}else d=m,f=new Set(k);else break}}}else for(const d of i){let n=new Set([d]),f;for(let u=o-1;u>=0;u--){const m=b[u],w=[];for(const k of n){const A=this._matchCombinator(m,k,{find:p});A.size&&w.push(...A)}if(w.length)if(f=!0,u===0){h.add(d);break}else n=new Set(w);else{f=!1;break}}if(f&&s!==U)break}}}return h}_find(s){return this._collectNodes(s),this._matchNodes(s)}matches(){if(this.#e.nodeType!==l.ELEMENT_NODE)throw new TypeError(`Unexpected node ${this.#e.nodeName}`);let s;try{s=this._find(I).has(this.#e)}catch(e){this._onError(e)}return!!s}closest(){if(this.#e.nodeType!==l.ELEMENT_NODE)throw new TypeError(`Unexpected node ${this.#e.nodeName}`);let s;try{const e=this._find(D);let c=this.#e;for(;c;){if(e.has(c)){s=c;break}c=c.parentNode}}catch(e){this._onError(e)}return s??null}querySelector(){let s;try{const e=this._find(C);e.delete(this.#e),e.size>1?[s]=this._sortNodes(e):e.size&&([s]=[...e])}catch(e){this._onError(e)}return s??null}querySelectorAll(){const s=[];try{const e=this._find(U);e.delete(this.#e),e.size>1&&this.#c?s.push(...this._sortNodes(e)):e.size&&s.push(...e)}catch(e){this._onError(e)}return s}}0&&(module.exports={Matcher});
//# sourceMappingURL=matcher.js.map
